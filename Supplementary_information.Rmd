---
title: "Supplementary Information"
author: "Camille Crapart"
date: "2023-02-09"
output: 
   bookdown::html_document2:
     code_folding: hide
     toc_float: true
     toc: true
     number_sections: true
     fig_caption: true
     keep_tex: true

bibliography: C:\\Users\\raine\\Documents\\UiO\\Bibtex\\fCO2.bib
link-citations: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, message = F, warning = F, results = F)
```

```{r libraries}
library(dplyr)

library(ggplot2)
library(ggforce)
library(ggpubr)
library(cowplot)
library(gridExtra)
library(colorspace)

library(gamlss)

library(kableExtra)

library(rsq)

fCO2.atm.2020 <- 411.51 * 1e-6 # oct 2020
fCO2.atm.2019 <- 408.75 * 1e-6 # oct 2019
fCO2.atm.2004 <- 374.63 * 1e-6 # oct 2004
fCO2.atm.1995 <- 360.17 * 1e-6
```

# Bookdown documentation

<https://bookdown.org/yihui/bookdown/a-single-document.html>

# Import data

```{r import-data}

norway <- readRDS("norway.rds")
nlss <- readRDS("nlss.rds")

norway$TOC_mg <- norway$TOC*12.011*1e3
norway$TOC_umol <- norway$TOC*1e6
norway$TA_ueq <- norway$TA * 1e6
norway$CA_ueq <- norway$CA * 1e6
norway$DIC_mg <- norway$DIC*12.011*1e3
norway$DIC_umol <- norway$DIC * 1e6
norway$CA_ueq <- norway$CA * 1e6
norway$Hplus_umol <- norway$Hplus *1e6
norway$invHplus_umol <- 1/norway$Hplus *1e6
norway$invHplus <- 1/norway$Hplus


```

```{r map-nls}

nlss <- readRDS("nlss.rds")
nlss$invHplus <- 1/nlss$Hplus
nlss$TOC_mg <- nlss$TOC*12.011*1e3

ggplot(nlss)+geom_point(aes(x=long, y = lat, col = TOC))+
  borders(regions = c("Norway","Sweden","Finland"))+ylim(55,72)+xlim(4,32)+
  scale_fill_continuous_divergingx(palette = "RdYlBu", aesthetics = c("fill","col"), mid = 0.001, rev = T)+ 
  theme_minimal()
```

# Estimation of organic and carbonate alkalinity

## Carbonate speciation N112 / CBA

The concentration of the carbonate species in the N112 and CBA survey is calculated directly from the measured partial pressure of $CO_2$ [@Appelo2005]:

$pCO_2 = [H_2CO_3]/K_0$

$[HCO3^-] = K_1 \times [H_2CO_3]/[H^+]$

$[CO_3^{2-}] = K_2 \times [HCO_3 ^- ] / [H ^+]$

$[TIC] = [H_2CO_3] + [HCO_3^-]+[CO_3 ^{2-}]$

$K_0$ is Henry's constant from @Weiss1974. $K_1$ and $K_2$ are ionization constants of $H_2CO_3$ and $HCO_3^-$ , respectively obtained from @Harned1943 and @Harned1941 and are adjusted for temperature.

In freshwater samples, the chemical activity of carbonate species is assumed to be equal to the molar concentration. Therefore, molar concentration is used in all equilibrium equations.

@Liu2020 reported that in water with low ionic strength, the pH is underestimated by 0.1 to 0.5 units.  We chose to not correct pH in this study because the ionic strength was not available for the N112 survey. Since only one lake in the Northern Lakes Survey had a pH inferior to 5, we assumed that the measurement errors would be minimal.

```{r measured-carbonate-speciation}

ggplot(norway, aes(x = pH))+
  geom_point(aes(y = H2CO3, col = "H2CO3"), alpha = 0.5)+
  geom_point(aes(y = HCO3, col = "HCO3"), alpha = 0.5)+
  geom_point(aes(y = CO3, col = "CO3"), alpha = 0.5)+
  labs(y = "Carbonate species (mol/L)", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3","orange"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

ggplot(norway, aes(x = pH))+
  geom_point(aes(y = H2CO3, col = "H2CO3"), alpha = 0.5)+
  geom_point(aes(y = HCO3, col = "HCO3"), alpha = 0.5)+
  geom_point(aes(y = CO3, col = "CO3"), alpha = 0.5)+
  geom_point(aes(y = Ca, col = "Ca"))+
  labs(y = "Carbonate species (mol/L)", col = "")+
  scale_color_manual(values = c( "firebrick","black","dodgerblue3","orange"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")
```

```{r fCO2-from-TA}
ggplot(norway,aes(x= pH))+geom_point(aes(y = ta_fCO2, col = "pCO2 from TA"), alpha = 0.5)+
  geom_point(aes(y = fCO2, col = "Measured pCO2"), alpha = 0.5)+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_bw(base_size = 15)+
  theme(legend.position = "bottom")

```

```{r compare-cba-n112}
toc_boxplot <- ggplot(norway)+
  geom_boxplot(aes(x = "TOC", y = TOC, col = survey))+
  geom_boxplot(aes(x = "DIC", y = DIC, col = survey))+
  labs(x = "", y = "concentration, mol/L")+
  scale_color_manual(values = c("firebrick", "dodgerblue"))+
  theme_minimal()+
  theme(legend.position = "bottom")

```

## Organic alkalinity as OA = TA - CA

```{r measured-oa}
norway$OA <- with(norway, TA-CA)

ggplot(norway)+geom_point(aes(x = pH, y = CA))
ggplot(norway)+geom_point(aes(x = fCO2, y = fCO2))
ggplot(norway)+geom_point(aes(x = pH, y = OA))+ylim(-1e-4, 1e-4)
ggplot(norway)+geom_point(aes(x = TOC, y = OA))
ggplot(norway)+geom_point(aes(x = TA, y = OA))

```

## Organic alkalinity according to @Hruska2003

Hruska et al. suggest that the organic alkalinity (OA) can be computed as a triprotic model. OA is the defined as the concentration of organic bases $[RCOO^-]$ in the solution, minus the concentration of organic bases at pH = 4.5, as for an end-point titration. $[RCOO^-]$ depends on three $pK_a$ that were measured in @Hruska2003:

$$[RCOO^-]=\alpha_1 \times \frac{m \times [TOC]}{3}+ \alpha_2 \times \frac{m \times [TOC]}{3} + \alpha_3 \times \frac{m \times [TOC]}{3}$$

Where α is the ionization fraction of each acid/base couple:

$$\alpha = \frac{[RCOO^-]}{[RCOOH]}=\frac{K_a}{[H^+} = \frac{10^{-pK_a}}{[H^+]}$$

And $m$ is the site density of carboxylic group on the organic matter:

$$m = 10.2 \; \pm \;  0.6 \; \mu eq/mg \; DOC \Leftrightarrow 0.12 \; eq/mol \; DOC$$

$m$ is supposed to be equally divided between the three acids with their respective $pK_a$.

```{r organic-acids, eval = T}

pKa1 <- 3.04
Ka1 <- 10^(-pKa1)

pKa2 <- 4.42
Ka2 <- 10^(-pKa2)

pKa3 <- 6.46
Ka3 <- 10^(-pKa3)

m <- 10.2*1e-6*12.011*1e3*1e-3# ueq/mg to eq/mol, site density BUT THERE IS A 1e3 PB: have to multiply by 1e-3 to stay in the range
norway$RCOO <- with(norway, (Ka1/Hplus + 2*Ka2/Hplus + 3*Ka3/Hplus)* m/3 * TOC) # estimated in eq/L

norway$RCOO_4.5 <- with(norway, (Ka1/10^(-4.5) + 2*Ka2/10^(-4.5) + 3*Ka3/10^(-4.5))* m/3 * TOC)

norway$OA_hruska <- with(norway, RCOO-RCOO_4.5)

ggplot(norway)+
  geom_point(aes(x = pH, y = RCOO, col = survey))+
  scale_color_manual(values = c("firebrick","dodgerblue3"))+
  theme_minimal()+
  theme(legend.position = "bottom")


norway$CA_hruska <- with(norway, TA - OA_hruska - OH + Hplus) 

norway$CO3_hruska <- with(norway,CA_hruska / (Hplus/K2 +2)) # in mol/L
norway$HCO3_hruska <- with(norway, CO3_hruska*Hplus/K2)
norway$H2CO3_hruska <- with(norway, HCO3_hruska*Hplus/K1)
norway$fCO2_hruska <- with(norway,H2CO3_hruska/K0)
```

```{r fCO2-from-hruska}
ggplot(norway,aes(x= pH))+geom_point(aes(y = fCO2_hruska, col = "pCO2 from calculated from Hruska et al"), alpha = 0.5)+
  geom_point(aes(y = fCO2, col = "Measured pCO2"), alpha = 0.5)+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal(base_size = 15)+
  theme(legend.position = "bottom")
```

## Organic alkalinity according to @Liu2020

A simplifying approach was suggested by @Liu2020 , building on @Cai1998 and @Lozovik2005, where the organic alkalinity can be calculated directly from TOC as:

$OA = 80 \% \times 10\% \times [TOC]$

80% being the proportion of DOC that is an organic acid [\@Cai1998], and 10% the maximum fraction of anions contributing to alkalinity [@Lozovik2005]. This last value was calculated for DOC in humic lakes, but overall this equation is designed to be applicable to all kinds of lakes, tropical or temperate.

```{r fix-pH-OA-with-Liu}

#norway$pH_Liu <- with(norway, pH - (0.03+0.05*log10(IS))) 
#norway$Hplus_Liu <- 10^(-norway$pH_Liu) 
#norway$OH_Liu <- with(norway,Kw*Hplus_Liu)

norway$OA_Liu <- 0.08 * norway$TOC
norway$CA_Liu <- with(norway, TA-OA_Liu - OH + Hplus)

norway$CO3_Liu <- with(norway,CA_Liu / (Hplus/K2 +2)) # in mol/L
norway$HCO3_Liu <- with(norway, CO3_Liu*Hplus/K2)
norway$H2CO3_Liu <- with(norway, HCO3_Liu*Hplus/K1)
norway$fCO2_Liu <- with(norway,H2CO3_Liu/K0)

norway$DIC_Liu <- with(norway, H2CO3_Liu + HCO3_Liu + CO3_Liu)
```

```{r fCO2-from-liu}
ggplot(norway,aes(x= pH))+geom_point(aes(y = fCO2_Liu, col = "pCO2 from calculated from Liu et al."), alpha = 0.5)+
  geom_point(aes(y = fCO2, col = "Measured pCO2"), alpha = 0.5)+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal(base_size = 15)+
  theme(legend.position = "bottom")
```

# Model TIC

## Theory

TIC can be expressed as a function of \$TA\$ , $[H^+]$ and $TOC$. First we have to express it depending on $pCO_2$, $HCO_3^-$ or $CO_3^{2-}$.

$TIC = H_2CO_3 + HCO_3^- + CO_3^{2-}$

$$ K_0 = [H_2CO_3]/ pCO_2 \Leftrightarrow H_2CO_3 = pCO_2 \times K_0$$

$$K_1 = \frac{HCO_3^- \times [H^+]}{[H_2CO_3]} \Leftrightarrow [HCO_3^-] = \frac{[H_2CO_3] \times K_1}{[H^+]} $$

$K_2 = \frac{[CO_3^{2-}] \times [H^+]}{[HCO_3^-]} \Leftrightarrow [CO_3^{2-}] = \frac{[HCO_3^-] \times K_2}{[H^+]}$

Therfore

$TIC = pCO_2 \times K_0 \times \left( 1 + \frac{K_1}{H^+} + \frac{K_2K_1}{[H^+]^2} \right)$

$TIC = [HCO_3] \times \left( 1 + \frac{[H^+]}{K_1}+\frac{K_2}{[H^+]} \right) \Leftrightarrow [HCO_3^-] = TIC / K_{tot1}$

$TIC = [CO_3^{2-}] \times \left( 1 + \frac{([H^+]^2}{K_2K_1}+\frac{[H^+]}{K_2} \right) \Leftrightarrow [CO_3^{2-}] = TIC / K_{tot2}$

-   TA is expressed as:

$TA = [HCO_3-] + 2 \times [CO_3^{2-}] + [OH] - [H^+] + OA$

$TA = TIC \times (1/K_{tot1} + 2/K_{tot2}) + [OH] - [H^+] + OA$

-   Organic alkalinity is proportional to $[TOC]/[H^+]$:

$K_a = \frac{[RCOO^-][H^+]}{[RCOOH]} \Leftrightarrow [RCOO^-]=\frac{K_a \times [RCOOH]}{[H^+]} \Leftrightarrow [RCOOH] = \frac{[RCOO^-][H^+]}{K_a}$

Where $K_a$ is the average, or apparent, dissociation constant for organic acids. The part of TOC that can dissociate is $\alpha \times TOC$ . At all pH:

$\alpha TOC = [RCOO^-]+[RCOOH] = [RCOO^-] + \frac{[RCOO^-][H^+]}{K_a} = [RCOO^-] \left( 1 + \frac{[H^+]}{K_a} \right) \Leftrightarrow [RCOO^-] = \alpha TOC \frac{1}{1 + \frac{[H^+]}{K_a}}$

The organic alkalinity is

$OA - OA_{pH = 4.5} = [RCOO^-]-[RCOOH] - ([RCOO^-]_{pH=4.5} - [RCOOH]_{pH=4.5})$

$= [RCOO^-] \left(1- \frac{[H^+]}{K_a} \right) - [RCOO^-]_{4.5} \left(1- \frac{10^{-4.5}}{K_a} \right) = \alpha TOC \l2eft( \frac{1-\frac{[H^+]}{K_a}}{1+\frac{[H^+]}{K_a}} - \frac{1-\frac{10^{-4.5}}{K_a}}{1+\frac{10^{-4.5}}{K_a}} \right)$

\$=\alpha TOC \left( \frac{K_a - [H^+]}{K_a + [H^+]} -

\frac{K_a - 10^{-4.5}}{K_a + 10^{-4.5}} \right)\$

TIC can be expressed as :

$TIC \propto (TA-[OH]+[H^+]-OA)\times \frac{1}{\frac{1}{1+\frac{[H^+]}{K_1}+\frac{K_2}{[H^+]}}+\frac{2}{1+\frac{[H^+]^2}{K_1K_2}+\frac{[H^+]}{K_2}}}$

$TIC \propto (TA-[OH]+[H^+]-OA) \times \left( \frac{[H^+]^2 + K_1[H^+]+K_1K_2}{3K_1K_2} \right)$

$CA = [HCO_3^-] + 2 \times [CO_3^{2-}]$

$[CO_3^{2-}] = \frac{[HCO_3^-] \times K_2} {[H^+]}$

$CA = [HCO_3^-] \times \left( 1 + \frac{2 \times K_2}{[H^+]} \right) \Leftrightarrow [HCO_3^{-}] = CA / \left( 1 + \frac{2 \times K_2}{[H^+]} \right)$

So

$pCO_2 = [H_2CO_3]/K_0 = \frac{[HCO_3^-] \times [H^+]} {K_1 \times K_0} = \frac{CA \times [H^+]}{ \left( 1 + \frac{2 \times K_2}{[H^+]} \right) \times K_1 \times K_0}$

## TA

```{r glm-dic-ta, fig.dim = c(10,8), results = T}
dic.ta <- glm(formula = DIC~TA, data = norway, family = Gamma(link = "identity"))

dic.ta.sum <- summary(dic.ta)$coefficients %>% as.data.frame() 
dic.ta.sp <- rownames(dic.ta.sum)[which(dic.ta.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
dic.ta.sum <- dic.ta.sum %>% format(scientific = T, digits = 2)

kable(dic.ta.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$DIC_pred <- fitted(dic.ta)
norway$DIC_pred_res <- residuals(dic.ta)
dic.ta.r2 <- with(summary(dic.ta), 1 - deviance/null.deviance) %>% round(2)

g1 <- ggplot(norway)+geom_point(aes(x=DIC,y=DIC_pred))+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",dic.ta.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=DIC_pred,y=DIC_pred_res))+
   coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
  theme_minimal()

norway$pCO2_calc <- with(norway, DIC_pred/(K0*(1+K1*Hplus+K2*K1*Hplus^2)))


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))

nlss$dic_pred <- predict(dic.ta, newdata = nlss, type = "response")
nlss$pCO2_calc <- with(nlss, dic_pred/(K0+K0*K1/Hplus+K0*K1*K2/Hplus))

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_calc, col = "pCO2 from modelled DIC"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

```{r glm-pco2-ta, fig.dim = c(10,8), results = T}
pco2.ta <- glm(formula = fCO2~TA+0+offset(fCO2.atm), data = norway, family = Gamma(link = "identity"))

pco2.ta.sum <- summary(pco2.ta)$coefficients %>% as.data.frame() 
pco2.ta.sp <- rownames(pco2.ta.sum)[which(pco2.ta.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.ta.sum <- pco2.ta.sum %>% format(scientific = T, digits = 2)

kable(pco2.ta.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$pCO2_pred <- fitted(pco2.ta)
norway$pCO2_pred_res <- residuals(pco2.ta)
pco2.ta.r2 <- with(summary(pco2.ta), 1 - deviance/null.deviance) %>% round(2)

g1 <- ggplot(norway)+geom_point(aes(x=fCO2,y=pCO2_pred))+   
  labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.ta.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))

nlss$pCO2_pred <- predict(pco2.ta, newdata = nlss, type = "response")

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_pred, col = "predicted pCO2 NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

## 1/TA

```{r glm-dic-invta, fig.dim = c(10,8), results = T}
norway$invTA <- with(norway, ifelse(TA == 0, 0, 1/TA))

dic.invTA <- glm(formula = DIC~invTA, data = norway, family = Gamma(link = "identity"))

dic.invTA.sum <- summary(dic.invTA)$coefficients %>% as.data.frame() 
dic.invTA.sp <- rownames(dic.invTA.sum)[which(dic.invTA.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
dic.invTA.sum <- dic.invTA.sum %>% format(scientific = T, digits = 2)

kable(dic.invTA.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$DIC_pred <- fitted(dic.invTA)
norway$DIC_pred_res <- residuals(dic.invTA)
dic.invTA.r2 <- with(summary(dic.invTA), 1 - deviance/null.deviance) %>% round(2)

g1 <- ggplot(norway)+geom_point(aes(x=DIC,y=DIC_pred))+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",dic.invTA.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=DIC_pred,y=DIC_pred_res))+
   coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
  theme_minimal()

norway$pCO2_calc <- with(norway, DIC_pred/(K0*(1+K1*Hplus+K2*K1*Hplus^2)))


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))

nlss$invTA <- with(nlss, ifelse(TA == 0, 0, 1/TA))

nlss$dic_pred <- predict(dic.invTA, newdata = nlss, type = "response")
nlss$pCO2_calc <- with(nlss, dic_pred/(K0+K0*K1/Hplus+K0*K1*K2/Hplus))

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_calc, col = "pCO2 from modelled DIC"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

```{r glm-pco2-invTA, fig.dim = c(10,8), results = T}
pco2.invTA <- glm(formula = fCO2~invTA+0+offset(fCO2.atm), data = norway, family = Gamma(link = "identity"))

pco2.invTA.sum <- summary(pco2.invTA)$coefficients %>% as.data.frame() 
pco2.invTA.sp <- rownames(pco2.invTA.sum)[which(pco2.invTA.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.invTA.sum <- pco2.invTA.sum %>% format(scientific = T, digits = 2)

kable(pco2.invTA.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$pCO2_pred <- fitted(pco2.invTA)
norway$pCO2_pred_res <- residuals(pco2.invTA)
pco2.invTA.r2 <- with(summary(pco2.invTA), 1 - deviance/null.deviance) %>% round(2)

g1 <- ggplot(norway)+geom_point(aes(x=fCO2,y=pCO2_pred))+   
  labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.invTA.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))


nlss$pCO2_pred <- predict(pco2.invTA, newdata = nlss, type = "response")

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_pred, col = "predicted pCO2 NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

## TOC

```{r glm-dic-toc, fig.dim = c(10,8), results = T}

dic.toc <- glm(formula = DIC~TOC, data = norway, family = Gamma(link = "identity"))
dic.toc.sum <- summary(dic.toc)$coefficients %>% as.data.frame() 
dic.toc.sp <- rownames(dic.toc.sum)[which(dic.toc.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
dic.toc.sum <- dic.toc.sum %>% format(scientific = T, digits = 2)

kable(dic.toc.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$DIC_pred <- fitted(dic.toc)
norway$DIC_pred_res <- residuals(dic.toc)
dic.toc.r2 <- with(summary(dic.toc), 1 - deviance/null.deviance) %>% round(2)

g1 <- ggplot(norway)+geom_point(aes(x=DIC,y=DIC_pred))+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",dic.toc.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=DIC_pred,y=DIC_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

norway$pCO2_calc <- with(norway, DIC_pred/(K0+K0*K1/Hplus+K0*K1*K2/(Hplus^2)))


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))

nlss$dic_pred <- predict(dic.toc, newdata = nlss, type = "response")
nlss$pCO2_calc <- with(nlss, dic_pred/(K0+K0*K1/Hplus+K0*K1*K2/Hplus))

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_calc, col = "pCO2 from predicted DIC, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

```{r glm-pCO2-toc, fig.dim = c(10,8), results = T}

pco2.toc <- glm(formula = fCO2~TOC+0+offset(fCO2.atm), data = norway, family = Gamma(link = "identity"))

pco2.toc.sum <- summary(pco2.toc)$coefficients %>% as.data.frame() 
pco2.toc.sp <- rownames(pco2.toc.sum)[which(pco2.toc.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.toc.sum <- pco2.toc.sum %>% format(scientific = T, digits = 2)

kable(pco2.toc.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$pCO2_pred <- fitted(pco2.toc)
norway$pCO2_pred_res <- residuals(pco2.toc)
pco2.toc.r2 <- with(summary(pco2.toc), 1 - deviance/null.deviance) %>% round(2)

g1 <- ggplot(norway)+geom_point(aes(x=fCO2,y=pCO2_pred))+   labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.toc.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))

nlss$pCO2_pred <- predict(pco2.toc, newdata = nlss, type = "response")

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_pred, col = "Predicted pCO2"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

```{r for-article}
ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"), alpha = 0.5)+
  geom_point(aes(y = fCO2, col = "Measured pCO2"), alpha = 0.5)+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_bw(base_size = 15)+
  theme(legend.position = "bottom")
```

## TA + TOC

```{r glm-dic-toc-ta, fig.dim = c(10,8), results = T}

dic.toc.ta <- glm(formula = DIC~TOC+TA, data = norway, family = Gamma(link = "identity"))
dic.toc.ta.sum <- summary(dic.toc.ta)$coefficients %>% as.data.frame() 
dic.toc.ta.sp <- rownames(dic.toc.ta.sum)[which(dic.toc.ta.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
dic.toc.ta.sum <- dic.toc.ta.sum %>% format(scientific = T, digits = 2)

kable(dic.toc.ta.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$DIC_pred <- fitted(dic.toc.ta)
norway$DIC_pred_res <- residuals(dic.toc.ta)
dic.toc.ta.r2 <- with(summary(dic.toc.ta), 1 - deviance/null.deviance) %>% round(2)

g1 <- ggplot(norway)+geom_point(aes(x=DIC,y=DIC_pred))+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",dic.toc.ta.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=DIC_pred,y=DIC_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

norway$pCO2_calc <- with(norway, DIC_pred/(K0+K0*K1/Hplus+K0*K1*K2/(Hplus^2)))


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))

nlss$dic_pred <- predict(dic.toc.ta, newdata = nlss, type = "response")
nlss$pCO2_calc <- with(nlss, dic_pred/(K0+K0*K1/Hplus+K0*K1*K2/Hplus))

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_calc, col = "pCO2 from predicted DIC, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

```{r glm-pCO2-toc-ta, fig.dim = c(10,8),results = T}

pco2.toc.ta <- glm(formula = fCO2~TOC+TA+0+offset(fCO2.atm), data = norway, family = Gamma(link = "identity"))

pco2.toc.ta.sum <- summary(pco2.toc.ta)$coefficients %>% as.data.frame() 
pco2.toc.ta.sp <- rownames(pco2.toc.ta.sum)[which(pco2.toc.ta.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.toc.ta.sum <- pco2.toc.ta.sum %>% format(scientific = T, digits = 2)

kable(pco2.toc.ta.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$pCO2_pred <- fitted(pco2.toc.ta)
norway$pCO2_pred_res <- residuals(pco2.toc.ta)
pco2.toc.ta.r2 <- with(summary(pco2.toc.ta), 1 - deviance/null.deviance) %>% round(2)

g1 <- ggplot(norway)+geom_point(aes(x=fCO2,y=pCO2_pred))+   labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.toc.ta.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))

nlss$pCO2_pred <- predict(pco2.toc.ta, newdata = nlss, type = "response")

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_pred, col = "Predicted pCO2, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

## TA\*TOC + Hplus

```{r glm-dic-toc-ta-hplus, fig.dim = c(10,8), results = T}

dic.tocta.Hplus <- glm(formula = DIC~TOC+TA+Hplus, data = norway, family = Gamma(link = "identity"))
  dic.tocta.Hplus.sum <- summary(dic.tocta.Hplus)$coefficients %>% as.data.frame() 
  dic.tocta.Hplus.sp <- rownames(dic.tocta.Hplus.sum)[which(dic.tocta.Hplus.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
  dic.tocta.Hplus.sum <- dic.tocta.Hplus.sum %>% format(scientific = T, digits = 2)

kable(dic.tocta.Hplus.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$DIC_pred <- fitted(dic.tocta.Hplus)
norway$DIC_pred_res <- residuals(dic.tocta.Hplus)
dic.tocta.Hplus.r2 <- with(summary(dic.tocta.Hplus), 1 - deviance/null.deviance) %>% round(2)

g1 <- ggplot(norway)+geom_point(aes(x=DIC,y=DIC_pred))+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",dic.tocta.Hplus.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=DIC_pred,y=DIC_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

norway$pCO2_calc <- with(norway, DIC_pred/(K0+K0*K1/Hplus+K0*K1*K2/(Hplus^2)))


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))

nlss$dic_pred <- predict(dic.tocta.Hplus, newdata = nlss, type = "response")
nlss$pCO2_calc <- with(nlss, dic_pred/(K0+K0*K1/Hplus+K0*K1*K2/Hplus))

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_calc, col = "pCO2 from predicted DIC, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

```{r glm-pCO2-toc-ta-hplus, fig.dim = c(10,8),results = T}

pco2.tocta.Hplus <- glm(formula = fCO2~TOC+TA+Hplus+0+offset(fCO2.atm), data = norway, family = Gamma(link = "identity"))

pco2.tocta.Hplus.sum <- summary(pco2.tocta.Hplus)$coefficients %>% as.data.frame() 
pco2.tocta.Hplus.sp <- rownames(pco2.tocta.Hplus.sum)[which(pco2.tocta.Hplus.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.tocta.Hplus.sum <- pco2.tocta.Hplus.sum %>% format(scientific = T, digits = 2)

kable(pco2.tocta.Hplus.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$pCO2_pred <- fitted(pco2.tocta.Hplus)
norway$pCO2_pred_res <- residuals(pco2.tocta.Hplus)
pco2.tocta.Hplus.r2 <- with(summary(pco2.tocta.Hplus), 1 - deviance/null.deviance) %>% round(2)

g1 <- ggplot(norway)+geom_point(aes(x=fCO2,y=pCO2_pred))+   labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.tocta.Hplus.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))

nlss$pCO2_pred <- predict(pco2.tocta.Hplus, newdata = nlss, type = "response")

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_pred, col = "Predicted pCO2, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

## TOC + pH

```{r glm-dic-toc-Hplus, fig.dim = c(10,8), results = T}

dic.toc.Hplus <- glm(formula = DIC~TOC+Hplus, data = norway, family = Gamma(link = "identity"))
dic.toc.Hplus.sum <- summary(dic.toc.Hplus)$coefficients %>% as.data.frame() 
dic.toc.Hplus.sp <- rownames(dic.toc.Hplus.sum)[which(dic.toc.Hplus.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
dic.toc.Hplus.sum <- dic.toc.Hplus.sum %>% format(scientific = T, digits = 2)

kable(dic.toc.Hplus.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$DIC_pred <- fitted(dic.toc.Hplus)
norway$DIC_pred_res <- residuals(dic.toc.Hplus)
dic.toc.Hplus.r2 <- with(summary(dic.toc.Hplus), 1 - deviance/null.deviance) %>% round(2)

g1 <- ggplot(norway)+geom_point(aes(x=DIC,y=DIC_pred))+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",dic.toc.Hplus.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=DIC_pred,y=DIC_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

norway$pCO2_calc <- with(norway, DIC_pred/(K0+K0*K1/Hplus+K0*K1*K2/(Hplus^2)))


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "Hplus", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))

nlss$dic_pred <- predict(dic.toc.Hplus, newdata = nlss, type = "response")
nlss$pCO2_calc <- with(nlss, dic_pred/(K0+K0*K1/Hplus+K0*K1*K2/Hplus))

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_calc, col = "pCO2 from predicted DIC, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

```{r glm-pCO2-toc-Hplus, fig.dim = c(10,8),results = T}

pco2.toc.Hplus <- glm(formula = fCO2~TOC+Hplus+0+offset(fCO2.atm), data = norway, family = Gamma(link = "identity"))

pco2.toc.Hplus.sum <- summary(pco2.toc.Hplus)$coefficients %>% as.data.frame() 
pco2.toc.Hplus.sp <- rownames(pco2.toc.Hplus.sum)[which(pco2.toc.Hplus.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.toc.Hplus.sum <- pco2.toc.Hplus.sum %>% format(scientific = T, digits = 2)

kable(pco2.toc.Hplus.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$pCO2_pred <- fitted(pco2.toc.Hplus)
norway$pCO2_pred_res <- residuals(pco2.toc.Hplus)
pco2.toc.Hplus.r2 <- with(summary(pco2.toc.Hplus), 1 - deviance/null.deviance) %>% round(2)

g1 <- ggplot(norway)+geom_point(aes(x=fCO2,y=pCO2_pred))+   labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.toc.Hplus.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))

nlss$pCO2_pred <- predict(pco2.toc.Hplus, newdata = nlss, type = "response")

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_pred, col = "Predicted pCO2, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

## TA \* TOC

```{r glm-dic-tocta, fig.dim = c(10,8), results = T}

dic.tocta <- glm(formula = DIC~TOC*TA, data = norway, family = Gamma(link = "identity"))
dic.tocta.sum <- summary(dic.tocta)$coefficients %>% as.data.frame() 
dic.tocta.sp <- rownames(dic.tocta.sum)[which(dic.toc.ta.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
dic.tocta.sum <- dic.tocta.sum %>% format(scientific = T, digits = 2)

kable(dic.tocta.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$DIC_pred <- fitted(dic.tocta)
norway$DIC_pred_res <- residuals(dic.tocta)
dic.tocta.r2 <- with(summary(dic.tocta), 1 - deviance/null.deviance) %>% round(2)

g1 <- ggplot(norway)+geom_point(aes(x=DIC,y=DIC_pred))+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",dic.tocta.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=DIC_pred,y=DIC_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

norway$pCO2_calc <- with(norway, DIC_pred/(K0+K0*K1/Hplus+K0*K1*K2/(Hplus^2)))


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2", size = DIC))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))

nlss$dic_pred <- predict(dic.toc.ta, newdata = nlss, type = "response")
nlss$pCO2_calc <- with(nlss, dic_pred/(K0+K0*K1/Hplus+K0*K1*K2/Hplus))

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_calc, col = "pCO2 from predicted DIC, NLS", size = dic_pred), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

```{r glm-pCO2-tocta, fig.dim = c(10,8),results = T}

pco2.tocta <- glm(formula = fCO2~TOC+TA+0+offset(fCO2.atm), data = norway, family = Gamma(link = "identity"))

pco2.tocta.sum <- summary(pco2.tocta)$coefficients %>% as.data.frame() 
pco2.tocta.sp <- rownames(pco2.tocta.sum)[which(pco2.tocta.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.tocta.sum <- pco2.tocta.sum %>% format(scientific = T, digits = 2)

kable(pco2.tocta.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$pCO2_pred <- fitted(pco2.tocta)
norway$pCO2_pred_res <- residuals(pco2.tocta)
pco2.tocta.r2 <- with(summary(pco2.tocta), 1 - deviance/null.deviance) %>% round(2)

g1 <- ggplot(norway)+geom_point(aes(x=fCO2,y=pCO2_pred))+   labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.tocta.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))

nlss$pCO2_pred <- predict(pco2.tocta, newdata = nlss, type = "response")

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_pred, col = "Predicted pCO2, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")

```

## TA\*Hplus

```{r glm-dic-taHplus, fig.dim = c(10,8),results = T}

dic.taHplus <- glm(formula = DIC~TA*Hplus, data = norway, family = Gamma(link = "identity"))

dic.taHplus.sum <- summary(dic.taHplus)$coefficients %>% as.data.frame() 
dic.taHplus.sp <- rownames(dic.taHplus.sum)[which(dic.taHplus.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
dic.taHplus.sum <- dic.taHplus.sum %>% format(scientific = T, digits = 2)

kable(dic.taHplus.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$DIC_pred <- fitted(dic.taHplus)
norway$DIC_pred_res <- residuals(dic.taHplus)
dic.taHplus.r2 <- with(summary(dic.taHplus), 1 - deviance/null.deviance) %>% round(2)

g1 <- ggplot(norway)+geom_point(aes(x=DIC,y=DIC_pred))+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",dic.taHplus.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=DIC_pred,y=DIC_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

norway$pCO2_calc <- with(norway, DIC_pred/(K0+K0*K1/Hplus+K0*K1*K2/(Hplus^2)))


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))

nlss$dic_pred <- predict(dic.taHplus, newdata = nlss, type = "response")
nlss$pCO2_calc <- with(nlss, dic_pred/(K0+K0*K1/Hplus+K0*K1*K2/Hplus))

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_calc, col = "pCO2 from predicted DIC, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

```{r glm-pco2-tahplus, fig.dim = c(10,8),results = T}

pco2.taHplus <- glm(formula = fCO2~TA*Hplus+0+offset(fCO2.atm), data = norway, family = Gamma(link = "identity"))

pco2.taHplus.sum <- summary(pco2.taHplus)$coefficients %>% as.data.frame() 
pco2.taHplus.sp <- rownames(pco2.taHplus.sum)[which(pco2.taHplus.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.taHplus.sum <- pco2.taHplus.sum %>% format(scientific = T, digits = 2)

kable(pco2.taHplus.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$pCO2_pred <- fitted(pco2.taHplus)
norway$pCO2_pred_res <- residuals(pco2.taHplus)
pco2.taHplus.r2 <- with(summary(pco2.taHplus), 1 - deviance/null.deviance) %>% round(2)

g1 <- ggplot(norway)+geom_point(aes(x=fCO2,y=pCO2_pred))+   labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.taHplus.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))

nlss$pCO2_pred <- predict(pco2.taHplus, newdata = nlss, type = "response")

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_pred, col = "Predicted pCO2, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")

```

## TA + TOC\*Hplus

```{r glm-dic-tocHplus-ta, fig.dim = c(10,8),results = T}

dic.tocHplus.ta <- glm(formula = DIC~TOC*Hplus+TA, data = norway, family = Gamma(link = "identity"))
dic.tocHplus.ta.sum <- summary(dic.tocHplus.ta)$coefficients %>% as.data.frame() 
dic.tocHplus.ta.sp <- rownames(dic.tocHplus.ta.sum)[which(dic.tocHplus.ta.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
dic.tocHplus.ta.sum <- dic.tocHplus.ta.sum %>% format(scientific = T, digits = 2)

kable(dic.tocHplus.ta.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$DIC_pred <- fitted(dic.tocHplus.ta)
norway$DIC_pred_res <- residuals(dic.tocHplus.ta)
dic.tocHplus.ta.r2 <- with(summary(dic.tocHplus.ta), 1 - deviance/null.deviance) %>% round(2)

g1 <- ggplot(norway)+geom_point(aes(x=DIC,y=DIC_pred))+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",dic.tocHplus.ta.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=DIC_pred,y=DIC_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

norway$pCO2_calc <- with(norway, DIC_pred/(K0+K0*K1/Hplus+K0*K1*K2/(Hplus^2)))


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))

nlss$dic_pred <- predict(dic.tocHplus.ta, newdata = nlss, type = "response")
nlss$pCO2_calc <- with(nlss, dic_pred/(K0+K0*K1/Hplus+K0*K1*K2/Hplus))

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_calc, col = "pCO2 from predicted DIC, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

```{r glm-pco2-tochplus-ta, fig.dim = c(10,8),results = T}

pco2.tocHplus.ta <- glm(formula = fCO2~TOC*Hplus+TA+0+offset(fCO2.atm), data = norway, family = Gamma(link = "identity"))

pco2.tocHplus.ta.sum <- summary(pco2.tocHplus.ta)$coefficients %>% as.data.frame() 
pco2.tocHplus.ta.sp <- rownames(pco2.tocHplus.ta.sum)[which(pco2.tocHplus.ta.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.tocHplus.ta.sum <- pco2.tocHplus.ta.sum %>% format(scientific = T, digits = 2)

kable(pco2.tocHplus.ta.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$pCO2_pred <- fitted(pco2.tocHplus.ta)
norway$pCO2_pred_res <- residuals(pco2.tocHplus.ta)
pco2.tocHplus.ta.r2 <- with(summary(pco2.tocHplus.ta), 1- deviance/null.deviance) %>% round(2)

g1 <- ggplot(norway)+geom_point(aes(x=fCO2,y=pCO2_pred))+   labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.tocHplus.ta.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))

nlss$pCO2_pred <- predict(pco2.tocHplus.ta, newdata = nlss, type = "response")

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_pred, col = "Predicted pCO2, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")

```

## TOC + TA\*Hplus

```{r glm-dic-toc-taHplus, fig.dim = c(10,8),results = T}

dic.toc.taHplus <- glm(formula = DIC~TOC+TA*Hplus, data = norway, family = Gamma(link = "identity"))

dic.toc.taHplus.sum <- summary(dic.toc.taHplus)$coefficients %>% as.data.frame() 
dic.toc.taHplus.sp <- rownames(dic.toc.taHplus.sum)[which(dic.toc.taHplus.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
dic.toc.taHplus.sum <- dic.toc.taHplus.sum %>% format(scientific = T, digits = 2)
kable(dic.toc.taHplus.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$DIC_pred <- fitted(dic.toc.taHplus)
norway$DIC_pred_res <- residuals(dic.toc.taHplus)
dic.toc.taHplus.r2 <- with(summary(dic.toc.taHplus), 1 - deviance/null.deviance) %>% round(2)

g1 <- ggplot(norway)+geom_point(aes(x=DIC,y=DIC_pred))+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",dic.toc.taHplus.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=DIC_pred,y=DIC_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

norway$pCO2_calc <- with(norway, DIC_pred/(K0+K0*K1/Hplus+K0*K1*K2/(Hplus^2)))


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))

nlss$dic_pred <- predict(dic.toc.taHplus, newdata = nlss, type = "response")
nlss$pCO2_calc <- with(nlss, dic_pred/(K0+K0*K1/Hplus+K0*K1*K2/Hplus))

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_calc, col = "pCO2 from predicted DIC, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

```{r glm-pco2-toc-tahplus, fig.dim = c(10,8),results = T}

pco2.toc.taHplus <- glm(formula = fCO2~TOC+TA*Hplus+0+offset(fCO2.atm), data = norway, family = Gamma(link = "identity"))

pco2.toc.taHplus.sum <- summary(pco2.toc.taHplus)$coefficients %>% as.data.frame()
pco2.toc.taHplus.sp <- rownames(pco2.toc.taHplus.sum)[which(pco2.toc.taHplus.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.toc.taHplus.sum <- pco2.toc.taHplus.sum %>% format(scientific = T, digits = 2)

kable(pco2.toc.taHplus.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$pCO2_pred <- fitted(pco2.toc.taHplus)
norway$pCO2_pred_res <- residuals(pco2.toc.taHplus)
pco2.toc.taHplus.r2 <- with(summary(pco2.toc.taHplus), 1 - deviance/null.deviance) %>% round(2)

g1 <- ggplot(norway)+geom_point(aes(x=fCO2,y=pCO2_pred))+   labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.toc.taHplus.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))

nlss$pCO2_pred <- predict(pco2.toc.ta, newdata = nlss, type = "response")

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_pred, col = "Predicted pCO2, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")

```

## TOC + TA\*invHplus

```{r glm-dic-toc-tainvhplus, fig.dim = c(10,8),results = T}

norway$invHplus <- with(norway, 1/Hplus)

dic.toc.tainvHplus <- glm(formula = DIC~TOC+TA*invHplus, data = norway, family = Gamma(link = "identity"))

dic.toc.tainvHplus.sum <- summary(dic.toc.tainvHplus)$coefficients %>% as.data.frame()
dic.toc.tainvHplus.sp <- rownames(dic.toc.tainvHplus.sum)[which(dic.toc.tainvHplus.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
dic.toc.tainvHplus.sum <- dic.toc.tainvHplus.sum %>% format(scientific = T, digits = 2)

kable(dic.toc.tainvHplus.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$DIC_pred <- fitted(dic.toc.tainvHplus)
norway$DIC_pred_res <- residuals(dic.toc.tainvHplus)
dic.toc.tainvHplus.r2 <- with(summary(dic.toc.tainvHplus), 1 - deviance/null.deviance) %>% round(2)

g1 <- ggplot(norway)+geom_point(aes(x=DIC,y=DIC_pred))+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",dic.toc.tainvHplus.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=DIC_pred,y=DIC_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

norway$pCO2_calc <- with(norway, DIC_pred/(K0+K0*K1/Hplus+K0*K1*K2/(Hplus^2)))


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))

nlss$dic_pred <- predict(dic.toc.tainvHplus, newdata = nlss, type = "response")
nlss$pCO2_calc <- with(nlss, dic_pred/(K0+K0*K1/Hplus+K0*K1*K2/Hplus))

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_calc, col = "pCO2 from predicted DIC, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

```{r plot-article-2}
ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 calculated from DIC~TOC + TA/Hplus"), alpha = 0.5)+
  geom_point(aes(y = fCO2, col = "Measured pCO2"), alpha = 0.5)+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal(base_size = 15)+
  theme(legend.position = "bottom")
```

```{r glm-pco2-toc-tainvhplus, fig.dim = c(10,8),results = T}

norway$invHplus <- with(norway, 1/Hplus)

pco2.toc.tainvHplus <- glm(formula = fCO2~TOC+TA*invHplus+0+offset(fCO2.atm), data = norway, family = Gamma(link = "identity"))

pco2.toc.tainvHplus.sum <- summary(pco2.toc.tainvHplus)$coefficients %>% as.data.frame() 
pco2.toc.tainvHplus.sp <- rownames(pco2.toc.tainvHplus.sum)[which(pco2.toc.tainvHplus.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.toc.tainvHplus.sum <- pco2.toc.tainvHplus.sum %>% format(scientific = T, digits = 2)

kable(pco2.toc.tainvHplus.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$pCO2_pred <- fitted(pco2.toc.tainvHplus)
norway$pCO2_pred_res <- residuals(pco2.toc.tainvHplus)
pco2.toc.tainvHplus.r2 <- with(summary(pco2.toc.tainvHplus), 1 - deviance / null.deviance) %>% round(2)

g1 <- ggplot(norway)+geom_point(aes(x=fCO2,y=pCO2_pred))+   labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.toc.tainvHplus.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
   coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))

nlss$pCO2_pred <- predict(pco2.toc.tainvHplus, newdata = nlss, type = "response")

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_pred, col = "Predicted pCO2, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")

```

## TA + TOC\*invHplus

```{r glm-dic-tocinvhplus-ta, fig.dim = c(10,8),results = T}

norway$invHplus <- with(norway, 1/Hplus)

dic.tocinvHplus.ta <- glm(formula = DIC~TOC*invHplus+TA, data = norway, family = Gamma(link = "identity"))

dic.tocinvHplus.ta.sum <- summary(dic.tocinvHplus.ta)$coefficients %>% as.data.frame() 
dic.tocinvHplus.ta.sp <- rownames(dic.tocinvHplus.ta.sum)[which(dic.tocinvHplus.ta.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
dic.tocinvHplus.ta.sum <- dic.tocinvHplus.ta.sum %>% format(scientific = T, digits = 2)

kable(dic.tocinvHplus.ta.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$DIC_pred <- fitted(dic.tocinvHplus.ta)
norway$DIC_pred_res <- residuals(dic.tocinvHplus.ta)
dic.tocinvHplus.ta.r2 <- with(summary(dic.tocinvHplus.ta), 1 - deviance/null.deviance) %>% round(2)

g1 <- ggplot(norway)+geom_point(aes(x=DIC,y=DIC_pred))+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",dic.tocinvHplus.ta.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=DIC_pred,y=DIC_pred_res))+   
    coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

norway$pCO2_calc <- with(norway, DIC_pred/(K0+K0*K1/Hplus+K0*K1*K2/(Hplus^2)))


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))

nlss$dic_pred <- predict(dic.tocinvHplus.ta, newdata = nlss, type = "response")
nlss$pCO2_calc <- with(nlss, dic_pred/(K0+K0*K1/Hplus+K0*K1*K2/Hplus))

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_calc, col = "pCO2 from predicted DIC, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

```{r glm-pco2-tocinvhplus-ta, fig.dim = c(10,8),results = T}

norway$invHplus <- with(norway, 1/Hplus)

pco2.tocinvHplus.ta <- glm(formula = fCO2~TOC*invHplus+TA+0+offset(fCO2.atm), data = norway, family = Gamma(link = "identity"))

pco2.tocinvHplus.ta.sum <- summary(pco2.tocinvHplus.ta)$coefficients %>% as.data.frame() 
pco2.tocinvHplus.ta.sp <- rownames(pco2.tocinvHplus.ta.sum)[which(pco2.tocinvHplus.ta.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.tocinvHplus.ta.sum <- pco2.tocinvHplus.ta.sum %>% format(scientific = T, digits = 2)
  

kable(pco2.tocinvHplus.ta.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$pCO2_pred <- fitted(pco2.tocinvHplus.ta)
norway$pCO2_pred_res <- residuals(pco2.tocinvHplus.ta)
pco2.tocinvHplus.ta.r2 <- with(summary(pco2.tocinvHplus.ta), 1 - deviance/null.deviance) %>% round(2)

g1 <- ggplot(norway)+geom_point(aes(x=fCO2,y=pCO2_pred))+   labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.tocinvHplus.ta.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))

nlss$pCO2_pred <- predict(pco2.tocinvHplus.ta, newdata = nlss, type = "response")

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_pred, col = "Predicted pCO2, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")

```

## Tableau recap

```{r table-results,results = T}
kable(cbind(data.frame(Predictors = c("TA",
                                      "1/TA",
                                "TOC",
                                "TA + TOC",
                                "TA*TOC",
                                "TA*Hplus",
                                "TA*Hplus + TOC", 
                                "TA + TOC*Hplus",
                                "TA/Hplus + TOC",
                                "TA + TOC/Hplus"),
                        R2 = c(pco2.ta.r2,
                               pco2.invTA.r2,
                                 pco2.toc.r2,
                                 pco2.toc.ta.r2,
                               pco2.tocta.r2,
                                 pco2.taHplus.r2,
                                 pco2.toc.taHplus.r2,
                                 pco2.tocHplus.ta.r2,
                                 pco2.toc.tainvHplus.r2,
                                 pco2.tocinvHplus.ta.r2),
                        significant  = c(pco2.ta.sp,
                                         pco2.invTA.sp,
                                 pco2.toc.sp,
                                 pco2.toc.ta.sp,
                                 pco2.tocta.sp,
                                 pco2.taHplus.sp,
                                 pco2.toc.taHplus.sp,
                                 pco2.tocHplus.ta.sp,
                                 pco2.toc.tainvHplus.sp,
                                 pco2.tocinvHplus.ta.sp)),
                data.frame(R2 = c(dic.ta.r2,
                                  dic.invTA.r2,
                                dic.toc.r2,
                                dic.toc.ta.r2,
                                dic.tocta.r2,
                                dic.taHplus.r2,
                                dic.toc.taHplus.r2,
                                dic.tocHplus.ta.r2,
                                dic.toc.tainvHplus.r2,
                                dic.tocinvHplus.ta.r2),
                      significant  = c(dic.ta.sp,
                                       dic.invTA.sp,
                                dic.toc.sp,
                                dic.toc.ta.sp,
                                dic.tocta.sp,
                                dic.taHplus.sp,
                                dic.toc.taHplus.sp,
                                dic.tocHplus.ta.sp,
                                dic.toc.tainvHplus.sp,
                                dic.tocinvHplus.ta.sp))),
             digits = 2) %>% 
  add_header_above(c(" "= 1, "pCO2" = 2, "DIC" = 2),italic = T) %>%
  column_spec(column = c(2,4), bold = T) %>% 
  kable_styling(bootstrap_options = "bordered")


```

# Northern European Lakes Survey

```{r compare-boxplots, fig.dim = c(10,10)}
g1 <- ggplot()+geom_boxplot(data = nlss, aes(x="TA\nNorthern European Lakes Survey, 1995", y=TA, col = "NLS_1995"))+
  geom_boxplot(data = norway, aes(x = "TA\n CBA (2019) and N112 (2004) surveys", y = TA, col = survey))+
  scale_color_manual(values = c("firebrick","orange","dodgerblue"))+
  labs(x = "", col = "",y = "Total alkalinity, eq/L")+
  theme_minimal(base_size = 15)+
  theme(legend.position = "bottom")

g2 <- ggplot()+geom_boxplot(data = nlss, aes(x="TOC\nNorthern European Lakes Survey, 1995", y=TOC, col = "NLS_1995"))+
  geom_boxplot(data = norway, aes(x = "TOC\n CBA (2019) and N112 (2004) surveys", y = TOC, col = survey))+
  scale_color_manual(values = c("firebrick","orange","dodgerblue"))+
  labs(x = "", col = "",y = "Total organic carbon, mol/L")+
  theme_minimal(base_size = 15)+
  theme(legend.position = "bottom")

g3 <- ggplot()+geom_boxplot(data = nlss, aes(x="pH\nNorthern European Lakes Survey, 1995", y=pH, col = "NLS_1995"))+
  geom_boxplot(data = norway, aes(x = "pH\n CBA (2019) and N112 (2004) surveys", y = pH, col = survey))+
  scale_color_manual(values = c("firebrick","orange","dodgerblue"))+
  labs(x = "", col = "",y = "pH")+
  theme_minimal(base_size = 15)+
  theme(legend.position = "bottom")

ggarrange(g1,g2,g3, common.legend = T, nrow = 3)
```

```{r nls-pCO2-TA}
nlss$ta_CO3 <- with(nlss,(TA - OH + Hplus) / (Hplus/K2 +2)) # in mol/L
nlss$ta_HCO3 <- with(nlss, ta_CO3*Hplus/K2)
nlss$ta_H2CO3 <- with(nlss, ta_HCO3*Hplus/K1)
nlss$pCO2_ta <- with(nlss,ta_H2CO3/K0)

g1 <- ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_ta), alpha = 0.5, col = "firebrick")+
  labs(x = "pH", y = "pCO2 from TA, atm")+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  facet_zoom(y = pCO2_ta > 0, zoom.size = 1)+
  theme_bw(base_size = 15)
```

```{r nls-pCO2-toc, fid.dim = c(15,13)}

nlss$pCO2_toc <- predict(pco2.toc, newdata = nlss, type = "response")

g1 <- ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_ta, col = "pCO2 from carbonate equilibrium"), alpha = 0.5)+
  geom_point(aes(y = pCO2_toc, col = "pCO2 modelled with TOC"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "")+
  scale_color_manual(values = c("firebrick","dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")+
  facet_zoom(y = pCO2_ta > 0, zoom.size = 2)


g2 <- ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_ta, col = "pCO2 from carbonate equilibrium"), alpha = 0.5)+
  geom_point(aes(y = pCO2_toc, col = "pCO2 modelled with TOC"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("firebrick","dodgerblue"))+
  ylim(0,0.006)+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")

ggarrange(g2,g1, common.legend = T)
```

```{r can-there-be-h2co3-at-high-pH}

temp_k <- 4+273.5 # temperature 4 degrees

K0 <- exp(-58.0931+90.5069*100/temp_k+22.2940*log(temp_k/100)) # Weiss 1974
K1 <- 10^-((3404.71/temp_k)- 14.8435 + 0.032786*temp_k) # Harned and Davis, 1943
K2 <- 10^-((2902.39/temp_k) - 6.4980 + 0.02379*temp_k) # Harned and Scholes, 1941

test <- data.frame(pH = seq(from = 3, to = 10, by = 0.1))
test$Hplus <- 10^(-test$pH)
DIC_1 <- rep(1,71) # mol/L
test$pCO2_1 <- with(test,DIC_1/(K0+K1*K0/Hplus+K0*K1*K2/(Hplus^2)))
test$H2CO3_1 <- with(test,pCO2_1*K0)
test$HCO3_1 <- with(test, K1*H2CO3_1/Hplus)
test$CO3_1 <- with(test,K2*HCO3_1/Hplus)

DIC_2 <- rep(2,71) # mol/L
test$pCO2_2 <- with(test,DIC_2/(K0+K1*K0/Hplus+K0*K1*K2/(Hplus^2)))
test$H2CO3_2 <- with(test,pCO2_2*K0)
test$HCO3_2 <- with(test, K1*H2CO3_2/Hplus)
test$CO3_2 <- with(test,K2*HCO3_2/Hplus)

DIC_3 <- rep(3,71) # mol/L
test$pCO2_3 <- with(test,DIC_3/(K0+K1*K0/Hplus+K0*K1*K2/(Hplus^2)))
test$H2CO3_3 <- with(test,pCO2_3*K0)
test$HCO3_3 <- with(test, K1*H2CO3_3/Hplus)
test$CO3_3 <- with(test,K2*HCO3_3/Hplus)

ggplot(test, aes(x=pH))+geom_point(aes(y=H2CO3_1, col = "DIC = 1"))+
  geom_point(aes(y=H2CO3_2, col = "DIC = 2"))+
  geom_point(aes(y=H2CO3_3, col = "DIC = 3"))+
  scale_color_manual(values = c("firebrick","orange","dodgerblue"))+
  geom_vline(xintercept = -log10(K1))+
  geom_vline(xintercept = -log10(K2))+
  theme_minimal()
```

# Evasion rate of CO2

Wind speed <https://wcrp-cmip.github.io/CMIP6_CVs/docs/CMIP6_institution_id.html>

Data downloaded from Copernicus <https://cds.climate.copernicus.eu/cdsapp#!/dataset/derived-near-surface-meteorological-variables?tab=overview>

See part 1

Theory from @Hastie2018

$$FCO_2 = A_{lake}*k*\Delta CO_2$$

$FCO_2$ in mol/day, $A_{lake}$ = lake area in m2, $\Delta CO_2$ in mol/m3 is the difference between water and air pCO2.

According to @Vachon2013:

$$k_{600} = 2.51 + 1.48 \times U_{10} + 0.39 \times U_{10} \times log_{10} (A_{lake})$$

with $A$ in km2 and $U_{10}$ in m/s

$k_{CO_2}$ has to be adjusted for temperature. @Vachon2020:

$$k_{600} = k_{CO_2}\times \left( \frac{600}{Sc_{CO_2}} \right) ^{-n}$$ The Schmidt $Sc_{CO_2}$ number is calculated from @Wanninkhof2014.

```{r norway-schmidt}

norway$Sc <- with(norway, 1923.6-125.06*temp_c+4.3733*temp_c^2-0.086781*temp_c^3) #@wanningkhof

norway$n <- NA
for(i in 1:length(norway$n)){
  if(norway$nws_m.s[i] < 3.7 & is.na(norway$nws_m.s[i]) == F){
    norway$n[i] = 2/3
  }else if(norway$nws_m.s[i] > 3.7 & is.na(norway$nws_m.s[i]) == F){
    norway$n[i] = 1/2
  } else if(is.na(norway$nws_m.s[i]) == T){
    norway$n[i] = NA
  }
} # adjusted n from Vachon


norway$k600 <- with(norway, 2.51+1.48*nws_m.s+0.39*nws_m.s*log10(lake.area)) # lake.area already in km2
                    
norway$kCO2 <- with(norway, k600*(600/Sc)^n) #m/day

norway$FCO2 <- with(norway, lake.area*1e6*kCO2*((fCO2 - fCO2.atm)*K0*1e3)) #-> lake.area in m2, dCO2 in mol/m3, k in m/day -> mol/day. K0 is in mol/L <- mol/1e-3 m3

norway$ECO2 <- with(norway, kCO2*(fCO2-fCO2.atm)*K0*1e3 * 12.011) # in gC/m2/day

norway$mgC.m2.day <- with(norway, kCO2*(fCO2-fCO2.atm)*K0*1e3 * 12.011 * 1e3) # in mgC/m2/day


```

```{r NLSS-schmidt-number}

nlss$Sc <- with(nlss, 1923.6-125.06*temp_c+4.3733*temp_c^2-0.086781*temp_c^3) #@wanningkhof

nlss$n <- NA
for(i in 1:length(nlss$n)){
  if(nlss$nws_m.s[i] < 3.7 & is.na(nlss$nws_m.s[i]) == F){
    nlss$n[i] = 2/3
  }else if(nlss$nws_m.s[i] > 3.7 & is.na(nlss$nws_m.s[i]) == F){
    nlss$n[i] = 1/2
  } else if(is.na(nlss$nws_m.s[i]) == T){
    nlss$n[i] = NA
  }
}


nlss$k600 <- with(nlss, 2.51+1.48*nws_m.s+0.39*nws_m.s*log10(lake.area)) # lake area in km2
                    
nlss$kCO2 <- with(nlss, k600*(600/Sc)^n)
```

```{r evasion-calculated-toc}

nlss$FCO2_toc <- with(nlss, lake.area*1e6*kCO2*((pCO2_toc - fCO2.atm)*K0*1e3)) #-> mol/day, lake.area in m2, dfCO2 in mol/day

nlss$ECO2_toc <- with(nlss, kCO2*(pCO2_toc-fCO2.atm)*K0*1e3 * 12.011) # in gC/m2/day

nlss$mgC.m2.day_toc <- with(nlss, kCO2*(pCO2_toc-fCO2.atm)*K0*1e3 * 12.011 * 1e3) # in mgC/m2/day

```

```{r evasion-calculated-ta}

nlss$FCO2_ta <- with(nlss, lake.area*1e6*kCO2*((pCO2_ta - fCO2.atm)*K0*1e3)) #-> mol/day, lake.area in m2, dfCO2 in mol/day

nlss$ECO2_ta <- with(nlss, kCO2*(pCO2_ta-fCO2.atm)*K0*1e3 * 12.011) # in gC/m2/day

nlss$mgC.m2.day_ta <- with(nlss, kCO2*(pCO2_ta-fCO2.atm)*K0*1e3 * 12.011 * 1e3) # in mgC/m2/day

```

```{r summary-evasion, results = T}

df <- subset(norway, survey == "N112_2004")

summary_n112 <- c(min(df$ECO2), median(df$ECO2), max(df$ECO2), mean(df$ECO2), sd(df$ECO2))

df <- subset(norway, survey == "CBA_2019")

summary_cba <- c(min(df$ECO2), median(df$ECO2), max(df$ECO2), mean(df$ECO2), sd(df$ECO2))

df <- nlss

summary_nlss_toc <- c(min(df$ECO2_toc, na.rm = T), median(df$ECO2_toc, na.rm = T), max(df$ECO2_toc, na.rm = T),  mean(df$ECO2_toc, na.rm = T), sd(df$ECO2_toc, na.rm = T))

summary_nlss_ta <- c(min(df$ECO2_ta, na.rm = T), median(df$ECO2_ta, na.rm = T), max(df$ECO2_ta, na.rm = T),  mean(df$ECO2_ta, na.rm = T), sd(df$ECO2_ta, na.rm = T))

df <- nlss %>% filter(nation == "Norway") %>% filter(lat < 63)

summary_snorway_1995_toc <- c(min(df$ECO2_toc, na.rm = T), median(df$ECO2_toc, na.rm = T),  max(df$ECO2_toc, na.rm = T), mean(df$ECO2_toc, na.rm = T), sd(df$ECO2_toc, na.rm = T))

summary_snorway_1995_ta <- c(min(df$ECO2_ta, na.rm = T), median(df$ECO2_ta, na.rm = T),  max(df$ECO2_ta, na.rm = T), mean(df$ECO2_ta, na.rm = T), sd(df$ECO2_ta, na.rm = T))

df <- nlss %>% filter(nation == "Norway")

summary_norway_1995_toc <- c(min(df$ECO2_toc, na.rm = T), median(df$ECO2_toc, na.rm = T),  max(df$ECO2_toc, na.rm = T), mean(df$ECO2_toc, na.rm = T), sd(df$ECO2_toc, na.rm = T))

summary_norway_1995_ta <- c(min(df$ECO2_ta, na.rm = T), median(df$ECO2_ta, na.rm = T),  max(df$ECO2_ta, na.rm = T), mean(df$ECO2_ta, na.rm = T), sd(df$ECO2_ta, na.rm = T))

df <- nlss %>% filter(nation == "Sweden") 

summary_sweden_1995_toc <- c(min(df$ECO2_toc, na.rm = T), median(df$ECO2_toc, na.rm = T),  max(df$ECO2_toc, na.rm = T), mean(df$ECO2_toc, na.rm = T))

summary_sweden_1995_ta <- c(min(df$ECO2_ta, na.rm = T), median(df$ECO2_ta, na.rm = T),  max(df$ECO2_ta, na.rm = T), mean(df$ECO2_ta, na.rm = T))

df <- nlss %>% filter(nation == "Finland") 

summary_finland_1995_toc <- c(min(df$ECO2_toc, na.rm = T), median(df$ECO2_toc, na.rm = T),  max(df$ECO2_toc, na.rm = T), mean(df$ECO2_toc, na.rm = T))

summary_finland_1995_ta <- c(min(df$ECO2_ta, na.rm = T), median(df$ECO2_ta, na.rm = T),  max(df$ECO2_ta, na.rm = T), mean(df$ECO2_ta, na.rm = T))

summary.df <- rbind(summary_n112, summary_cba, summary_nlss_ta, summary_sweden_1995_ta, summary_finland_1995_ta, summary_norway_1995_ta, summary_snorway_1995_ta, summary_nlss_toc, summary_sweden_1995_toc, summary_finland_1995_toc, summary_norway_1995_toc, summary_snorway_1995_toc) %>% as.data.frame()

rownames(summary.df) <- c("N112, 2004", "CBA, 2019","Northern Lake Survey, TA", "Sweden, TA", "Finland, TA", "Norway, TA", "South Norway, TA", "Northern Lake Survey, TOC", "Sweden, TOC", "Finland, TOC", "Norway, TOC", "South Norway, TOC")

colnames(summary.df) <- c("Min", "Median","Max","Mean","Sd")

knitr::kable(summary.df, digits = 2) %>% kable_styling(full_width= T, font_size = 11) %>% 
  group_rows(group_label = "ECO2 from measured pCO2", start_row = 1,end_row=2) %>%
  group_rows(group_label = "ECO2 computed with TA", start_row = 3,end_row=7) %>%
  group_rows(group_label = "ECO2 computed with TOC", start_row = 8,end_row=12) %>% 
  column_spec(column = c(3,5), bold = T) 
```

# Maps

## CBA / N112 summaries

```{r map-fCO2-norway}

map1 <- ggplot()+
  borders(region = c("Norway"), fill = "seashell2", col = "white")+xlim(4,13)+ylim(58,63)+
  geom_point(data = filter(norway, dfCO2 > 0), aes(x=long, y = lat, size = fCO2, col = survey, shape = "Supersaturated"))+
  geom_point(data = filter(norway, dfCO2 < 0), aes(x=long, y = lat, size =fCO2, col = survey, shape = "Undersaturated"))+
  labs(size = "fCO2 (atm)", col = "Survey", shape = "Saturation") +
  scale_color_manual(values = c("firebrick","dodgerblue4"))+
  scale_shape_manual(values = c(1,16))+
  #scale_size(range = c(1,6))+
  theme_void(base_size = 15)
```

```{r map-ECO2-norway}

map2 <- ggplot()+
  borders(region = c("Norway"), fill = "seashell2", col = "white")+xlim(4,13)+ylim(58,63)+
  geom_point(data = filter(norway, dfCO2 > 0), aes(x=long, y = lat, size = ECO2, col = survey, shape = "Supersaturated"))+
  geom_point(data = filter(norway, dfCO2 < 0), aes(x=long, y = lat, size = ECO2, col = survey, shape = "Undersaturated"))+
  labs(size = "Evasion rate of CO2 \n(g/m2/day)", col = "Survey", shape = "Saturation") +
  scale_color_manual(values = c("firebrick","dodgerblue4"))+
  scale_shape_manual(values = c(1,16))+
  #scale_size(range = c(1,6), breaks = c(1000,2000,3000,4000))+
  theme_void(base_size = 15)
```

```{r combine, fig.dim = c(16,8)}
ggarrange(map1, map2, common.legend = T, ncol = 2)
```

## pCO2

```{r map-CBA, fig.dim = c(8,4)}

fCO2_lims <- c(min(log10(norway$fCO2*1e6)), max(log10(norway$fCO2*1e6)))

cba_fCO2 <- ggplot()+
  borders(region = c("Norway"), fill = "seashell2", col = "seashell2")+xlim(4,13)+ylim(58,63)+
  geom_point(data = subset(norway, survey == "CBA_2019"), aes(x=long, y = lat, col = log10(fCO2*1e6),size = log10(fCO2*1e6)), shape = 16)+
  labs(col = "fCO2 (uatm), log scale", size = "fCO2 (uatm), log scale") +
  scale_color_continuous_sequential(rev = F, palette = "OrRd", end = 0.8, limits = fCO2_lims)+
  scale_size(range = c(0.5,3), limits = fCO2_lims)+
  guides(color = guide_legend())+
  theme_void(base_size = 15)+
  theme(legend.position = "right")

n112_fCO2 <- ggplot()+
  borders(region = c("Norway"), fill = "seashell2", col = "seashell2")+xlim(4,13)+ylim(58,63)+
  geom_point(data = subset(norway, survey == "N112_2004"), aes(x=long, y = lat, col = log10(fCO2*1e6),size = log10(fCO2*1e6)), shape = 16)+
  labs(col = "fCO2 (uatm), log scale", size = "fCO2 (uatm), log scale") +
  scale_color_continuous_sequential(rev = F, palette = "OrRd", end = 0.8, limits = fCO2_lims)+
  scale_size(range = c(0.5,3), limits = fCO2_lims)+
  guides(color = guide_legend())+
  theme_void(base_size = 15)+
  theme(legend.position = "right")

ggarrange(n112_fCO2,cba_fCO2, common.legend = T, ncol = 2, legend = "bottom")

```

```{r map-nls-fCO2}

ggplot()+
  borders(region = c("Norway", "Sweden","Finland"), fill = "seashell2", col = "seashell2")+xlim(4,35)+ylim(55,72)+
  geom_point(data = nlss, aes(x=long, y = lat, col = log10(pCO2_toc*1e6)), shape = 16, size = 1)+
  labs(col = "fCO2 (uatm), \nlog scale") +
  scale_color_continuous_sequential(rev = F, palette = "OrRd", end = 0.8)+
#  scale_size(range = c(0.5,2), breaks = c(2,3,4,5))+
  guides(color = guide_legend())+
  theme_void(base_size = 15)+
  theme(legend.position = "right")

```

## ECO2

```{r map-ECO2-cba, fig.dim = c(8,4)}

ECO2_lims <- c(-2,25)
leg <- "Evasion rate of CO2,\ng/m2/day"

cba_ECO2 <- ggplot()+
  borders(region = c("Norway"), fill = "seashell2", col = "seashell2")+xlim(4,13)+ylim(58,63)+
  geom_point(data = subset(norway, survey == "CBA_2019"), aes(x=long, y = lat, col = ECO2,size = ECO2), shape = 16)+
  labs(col = leg, size = leg) +
  scale_color_continuous_sequential(rev = F, palette = "Oslo", begin = 0.2, limits = ECO2_lims)+
  scale_size(range = c(0.5,2.5), limits = ECO2_lims)+
  guides(color = guide_legend())+
  theme_void(base_size = 15)+
  theme(legend.position = "right")

n112_ECO2 <- ggplot()+
  borders(region = c("Norway"), fill = "seashell2", col = "seashell2")+xlim(4,13)+ylim(58,63)+
  geom_point(data = subset(norway, survey == "N112_2004"), aes(x=long, y = lat, col = ECO2,size = ECO2), shape = 16)+
  labs(col = leg, size = leg) +
  scale_color_continuous_sequential(rev = F, palette = "Oslo", begin = 0.2, limits = ECO2_lims)+
  scale_size(range = c(0.5,2.5), limits = ECO2_lims)+
  guides(color = guide_legend())+
  theme_void(base_size = 15)+
  theme(legend.position = "right")

ggarrange(n112_ECO2,cba_ECO2, common.legend = T, ncol = 2, legend = "top")

```

```{r map-nls-ECO2}

nls_ECO2 <- ggplot()+
  borders(region = c("Norway", "Sweden","Finland"), fill = "seashell2", col = "seashell2")+xlim(4,35)+ylim(55,72)+
  geom_point(data = subset(nlss, ECO2_toc < 100), aes(x=long, y = lat, col = ECO2_toc, size = ECO2_toc), shape = 16)+
  labs(col = leg, size = leg) +
  scale_color_continuous_sequential(rev = F, palette = "Oslo", begin = 0.2, limits = ECO2_lims)+
  scale_size(range = c(0.5,2.5), limits = ECO2_lims)+
  guides(color = guide_legend())+
  theme_void(base_size = 15)+
  theme(legend.position = "right")

print(nls_ECO2)

```

```{r figure-maps, fig.dim = c(8,8)}
cba_ECO2 <- cba_ECO2 + theme(legend.position = "")
n112_ECO2 <- n112_ECO2 + theme(legend.position = "")
nls_ECO2 <- nls_ECO2 + theme(legend.position = "bottom")
ggarrange(ggarrange(n112_ECO2,cba_ECO2, ncol = 2, labels = c("a) N112, 2004", "b) CBA, 2019")), nls_ECO2, nrow = 2, heights = c(2,3), labels =  c("", "c) NLS, 1995"))

```

## South Norway

```{r map-norway-1995}

df <- nlss %>% filter(nation == "Norway") %>% filter(lat < 63)


fCO2_lims <- c(min(log10(norway$fCO2*1e6)), max(log10(norway$fCO2*1e6)))

n1995_fCO2 <- ggplot()+
  borders(region = c("Norway"), fill = "seashell2", col = "seashell2")+xlim(4,13)+ylim(58,63)+
  geom_point(data = df, aes(x=long, y = lat, col = log10(pCO2_toc*1e6), size = log10(pCO2_toc*2e6)), shape = 16)+
  labs(col = "fCO2 (uatm), \nlog scale", size = "fCO2 (uatm), \nlog scale") +
  scale_color_continuous_sequential(rev = F, palette = "OrRd", end = 0.8, limits = fCO2_lims)+
  scale_size(range = c(0.5,2), limits = fCO2_lims)+
  guides(color = guide_legend())+
  theme_void(base_size = 20)+
  theme(legend.position = "right")


ECO2_lims <- c(-2,25)

n1995_ECO2 <- ggplot()+
  borders(region = c("Norway"), fill = "seashell2", col = "seashell2")+xlim(4,13)+ylim(58,63)+
  geom_point(data = subset(df, ECO2_toc < 100), aes(x=long, y = lat, col = ECO2_toc, size = ECO2_toc), shape = 16)+
  geom_point(data = subset(df, ECO2_toc > 100), aes(x=long, y = lat), col = "firebrick", shape = 16, size = 1.5)+
  labs(col = "Evasion rate\n(gC/m2/day)", size = "Evasion rate\n(gC/m2/day)") +
  scale_color_continuous_sequential(rev = F, palette = "Oslo", begin = 0.2, limits = ECO2_lims)+
  scale_size(range = c(0.5,2), limits = ECO2_lims)+
  guides(color = guide_legend())+
  theme_void(base_size = 20)+
  theme(legend.position = "right")

```

```{r map-compare, fig.dim = c(12,4)}
ggarrange(n1995_fCO2, n112_fCO2, cba_fCO2, labels = c("1995","2004","2019"), common.legend = T, ncol = 3, legend = "bottom")

ggarrange(n1995_ECO2, n112_ECO2,cba_ECO2, labels = c("1995","2004","2019"), common.legend = T, ncol = 3, legend = "bottom")
```

`r knitr::knit_exit()`

```{r boxplots-ECO2}

ggplot()+
  geom_boxplot(aes(x = "2004", y = subset(norway, survey == "N112_2004")$ECO2, col = "2004"))+
  geom_boxplot(aes(x = "2019", y = subset(norway, survey =="CBA_2019")$ECO2, col = "2019"))+
    geom_boxplot(aes(x="1995", y = subset(nlss, nation == "Norway" & lat < 63)$ECO2_toc, col = "1995"))+
    theme_minimal()

ggplot()+
  geom_boxplot(aes(x = "2004", y = with(subset(norway, survey == "N112_2004"),fCO2/TOC), col = "2004"))+
  geom_boxplot(aes(x = "2019", y = with(subset(norway, survey =="CBA_2019"), fCO2/TOC), col = "2019"))+
    geom_boxplot(aes(x="1995", y = with(subset(nlss, nation == "Norway" & lat < 63),pCO2_toc/TOC), col = "1995"))+
  coord_trans(y = "log10")+
    theme_minimal()

ggplot()+
  geom_boxplot(aes(x = "2004", y = with(subset(norway, survey == "N112_2004"),DIC/TOC), col = "2004"))+
  geom_boxplot(aes(x = "2019", y = with(subset(norway, survey =="CBA_2019"), DIC/TOC), col = "2019"))+
    geom_boxplot(aes(x="1995", y = with(subset(nlss, nation == "Norway" & lat < 63),DIC/TOC), col = "1995"))+
  coord_trans(y = "log10")+
    theme_minimal()

ggplot()+
  geom_boxplot(aes(x = "2004", y = with(subset(norway, survey == "N112_2004"),pH), col = "2004"))+
  geom_boxplot(aes(x = "2019", y = with(subset(norway, survey =="CBA_2019"), pH), col = "2019"))+
    geom_boxplot(aes(x="1995", y = with(subset(nlss, nation == "Norway" & lat < 63),pH), col = "1995"))+
    theme_minimal()
```

# Predict fCO2 from TOC

R-squared: <https://rdrr.io/cran/rsq/man/rsq.html> <https://www.sciencedirect.com/science/article/pii/S0304407696018180>

```{r fCO2-toc-norway}

df <- norway

summary(glmfCO2norway <- glm(fCO2~TOC+0+offset(fCO2.atm), data = df, family = Gamma(link = "identity")))
coef.glmfCO2norway <- summary(glmfCO2norway)$coefficients
r2norway <- with(summary(glmfCO2norway), 1 - deviance/null.deviance) %>% round(2)
r2norway <- rsq::rsq(glmfCO2norway,adj = T, type = "kl") %>% round(2)

df$predfCO2_offset <- predict(glmfCO2norway, se = T)[1] %>% unlist
df$predfCO2_se <- predict(glmfCO2norway, se = T)[2] %>% unlist

m.norway <- ggplot(df, aes(x = TOC))+
  geom_point(aes(y = fCO2))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  geom_hline(yintercept = fCO2.atm.2004, col = "pink")+
  geom_hline(yintercept = fCO2.atm.2019, col = "pink")+
  annotate(x = 0.00005, y = 0.002, geom = "label", 
           label = paste("Slope = ", round(coef.glmfCO2norway[1],2), "\n R2 = ", r2norway))+
  #xlim(0,0.004)+ylim(0,0.2)+
  coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "N112 and CBA surveys, 2004 and 2019", col = "")+
  theme_minimal(base_size = 15)+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
  

m.norway

```

```{r check-dic-toc}

norway$DIC.TIC <- with(norway, DIC/TOC)


summary(glmfCO2norway <- glm(fCO2~TOC+0+offset(fCO2.atm), data = df, family = Gamma(link = "identity")))
coef.glmfCO2norway <- summary(glmfCO2norway)$coefficients
r2norway <- with(summary(glmfCO2norway), 1 - deviance/null.deviance) %>% round(2)

df$predfCO2_offset <- predict(glmfCO2norway, se = T)[1] %>% unlist
df$predfCO2_se <- predict(glmfCO2norway, se = T)[2] %>% unlist


m.norway <- ggplot(df, aes(x = TOC))+
  geom_point(aes(y = fCO2))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  geom_hline(yintercept = fCO2.atm.2004, col = "pink")+
  geom_hline(yintercept = fCO2.atm.2019, col = "pink")+
  annotate(x = 0.00005, y = 0.002, geom = "label", 
           label = paste("Slope = ", round(coef.glmfCO2norway[1],2), "\n R2 = ", r2norway))+
  #xlim(0,0.004)+ylim(0,0.2)+
  coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "N112 and CBA surveys, 2004 and 2019", col = "")+
  theme_minimal(base_size = 15)+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
  

m.norway
```

```{r fCO2-toc-n112}

df <- subset(norway, survey == "N112_2004")

summary(glmfCO2n112 <- glm(fCO2~TOC+0+offset(fCO2.atm), data = df, family = Gamma(link = "identity")))
coef.glmfCO2n112 <- summary(glmfCO2n112)$coefficients
r2n112 <- with(summary(glmfCO2n112), 1 - deviance/null.deviance) %>% round(2)

df$predfCO2_offset <- predict(glmfCO2n112, se = T)[1] %>% unlist
df$predfCO2_se <- predict(glmfCO2n112, se = T)[2] %>% unlist


m.n112 <- ggplot(df, aes(x = TOC))+
  geom_point(aes(y = fCO2))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  geom_hline(yintercept = fCO2.atm.2004, col = "pink")+
  annotate(x = 3.5e-5, y = 35e-3, geom = "label", 
           label = paste("Intercept =", fCO2.atm.2004*1e6," uatm","\n Slope = ", round(coef.glmfCO2n112[1],2), "\n R2 = ", r2n112))+
  xlim(1.5e-5,3.5e-3)+ylim(9e-5,0.2)+
  coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "N112 survey, 2004", col = "")+
  theme_minimal(base_size = 15)+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
  

print(m.n112)
```

```{r fCO2-toc-cba}

df <- subset(norway, survey == "CBA_2019")

summary(glmfCO2cba <- glm(fCO2~TOC+0+offset(fCO2.atm), data = df, family = Gamma(link = "identity")))
coef.glmfCO2cba <- summary(glmfCO2cba)$coefficients
r2cba <- with(summary(glmfCO2cba), 1 - deviance/null.deviance) %>% round(2)

df$predfCO2_offset <- predict(glmfCO2cba, se = T)[1] %>% unlist
df$predfCO2_se <- predict(glmfCO2cba, se = T)[2] %>% unlist


m.cba <- ggplot(df, aes(x = TOC))+
  geom_point(aes(y = fCO2))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  geom_hline(yintercept = fCO2.atm.2019, col = "pink")+
  annotate(x = 3.5e-5, y = 35e-3, geom = "label", 
           label = paste("Intercept =", fCO2.atm.2019*1e6," uatm","\n Slope = ", round(coef.glmfCO2cba[1],2), "\n R2 = ", r2cba))+
  xlim(1.5e-5,3.5e-3)+ylim(9e-5,0.2)+
  coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "CBA survey, 2019", col = "")+
  theme_minimal(base_size = 15)+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

print(m.cba)
```

```{r fCO2-toc-nlss}

summary(glmfCO2nlss <- glm(pCO2_dic~TOC+0+offset(fCO2.atm), data = nlss, family = Gamma(link = "identity")))
coef.glmfCO2nlss <- summary(glmfCO2nlss)$coefficients
r2nlss <- with(summary(glmfCO2nlss), 1 - deviance/null.deviance) %>% round(2)

nlss$predfCO2_offset <- predict(glmfCO2nlss, se = T)[1] %>% unlist
nlss$predfCO2_se <- predict(glmfCO2nlss, se = T)[2] %>% unlist


m.nlss <- ggplot(nlss, aes(x = TOC))+
  geom_point(aes(y = pCO2_dic))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  geom_hline(yintercept = fCO2.atm.1995, col = "pink")+
  annotate(x = 3.5e-5, y = 0.035, geom = "label", 
           label = paste("Intercept =", fCO2.atm.1995*1e6," uatm","\n Slope = ", round(coef.glmfCO2nlss[1],2), "\n R2 = ", r2nlss))+
  xlim(1.5e-5,3.5e-3)+ylim(9e-5,0.2)+
  coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "NLS survey, 1995", col = "")+
  theme_minimal(base_size = 15)+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

print(m.nlss)
```

```{r fCO2-toc-lowtoc-nlss, eval = F}

df <- subset(nlss, TOC < max(norway$TOC) & fCO2 < max(norway$fCO2))

summary(glmfCO2nlss <- glm(fCO2~TOC+0+offset(fCO2.atm), data = df, family = Gamma(link = "identity")))
coef.glmfCO2nlss <- summary(glmfCO2nlss)$coefficients
r2nlss <- with(summary(glmfCO2nlss), 1 - deviance/null.deviance) %>% round(2)

df$predfCO2_offset <- predict(glmfCO2nlss, se = T)[1] %>% unlist
df$predfCO2_se <- predict(glmfCO2nlss, se = T)[2] %>% unlist


m.nlss.2 <- ggplot(df, aes(x = TOC))+
  geom_point(aes(y = pCO2_dic))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  geom_hline(yintercept = fCO2.atm.1995, col = "pink")+
  annotate(x = 0.00003, y = 0.004, geom = "label", 
           label = paste("Intercept =", fCO2.atm.1995*1e6," uatm","\n Slope = ", round(coef.glmfCO2nlss[1],2), "\n R2 = ", r2nlss))+
  coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "NLS survey, 1995", col = "")+
  theme_minimal(base_size = 15)+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

m.nlss.2
```

```{r fCO2total}
 total <- data.frame(fCO2 = c(norway$fCO2, nlss$pCO2_dic),
                     fCO2.atm = c(norway$fCO2.atm, nlss$fCO2.atm),
                     TOC = c(norway$TOC, nlss$TOC),
                     pH = c(norway$pH, nlss$pH))

summary(glmfCO2total <- glm(fCO2~TOC+0+offset(fCO2.atm), data = total, family = Gamma(link = "identity")))
coef.glmfCO2total <- summary(glmfCO2total)$coefficients
r2total <- with(summary(glmfCO2total), 1 - deviance/null.deviance) %>% round(2)
r2total <- rsq(glmfCO2total, type = "kl")

total$predfCO2_offset <- predict(glmfCO2total, se = T)[1] %>% unlist
total$predfCO2_se <- predict(glmfCO2total, se = T)[2] %>% unlist


m.total <- ggplot(total, aes(x = TOC))+
  geom_point(aes(y = fCO2))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
#  geom_hline(yintercept = fCO2.atm.1995, col = "pink")+
  annotate(x = 3.5e-5, y = 0.035, geom = "label", 
           label = paste("Slope = ", round(coef.glmfCO2total[1],2), "\n R2 = ", round(r2total,2)))+
  xlim(1.5e-5,3.5e-3)+ylim(9e-5,0.2)+
  coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "All surveys", col = "")+
  theme_minimal(base_size = 15)+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

print(m.total)
```

```{r all-models, fig.dim = c(12,12)}
ggarrange(m.n112,m.cba, m.nlss, m.total, nrow = 2, ncol = 2, common.legend = T)

```

```{r fCO2-toc-nlss-gaussian, fig.dim = c(10,10)}
nlss$TOC2 <- nlss$TOC^2

summary(glmfCO2nlss <- glm(pCO2_dic~TOC+0+offset(fCO2.atm), data = nlss, family = Gamma(link = "sqrt")))
coef.glmfCO2nlss <- summary(glmfCO2nlss)$coefficients
r2nlss <- with(summary(glmfCO2nlss), 1 - deviance/null.deviance) %>% round(2)

nlss$predfCO2_offset <- predict(glmfCO2nlss, se = T)[1] %>% unlist
nlss$predfCO2_se <- predict(glmfCO2nlss, se = T)[2] %>% unlist

ggplot(nlss, aes(x = TOC))+
  geom_point(aes(y = pCO2_dic))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  geom_hline(yintercept = fCO2.atm.1995, col = "pink")+
  annotate(x = 3e-5, y = 0.035, geom = "label", 
           label = paste("Intercept =", fCO2.atm.1995*1e6," uatm","\n Slope = ", round(coef.glmfCO2nlss[1],2), "\n R2 = ", r2nlss))+
  xlim(1.5e-5,3.5e-3)+ylim(9e-5,0.2)+
  coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "NLS survey, 1995", col = "")+
  theme_minimal(base_size = 15)+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

```{r fCO2-toc-loglink}
total <- data.frame(fCO2 = c(norway$fCO2, nlss$pCO2_dic),
                     fCO2.atm = c(norway$fCO2.atm, nlss$fCO2.atm),
                     TOC = c(norway$TOC, nlss$TOC),
                     pH = c(norway$pH, nlss$pH))

summary(glmfCO2total <- glm(fCO2~TOC, data = total, family = Gamma(link = "log")))

coef.glmfCO2total <- summary(glmfCO2total)$coefficients
r2total <- with(summary(glmfCO2total), 1 - deviance/null.deviance) %>% round(2)
r2total <- rsq(glmfCO2total, type = "kl")

total$predfCO2_offset <- predict(glmfCO2total, se = T)[1] %>% unlist %>% exp()
total$predfCO2_se <- predict(glmfCO2total, se = T)[2] %>% unlist


m.total <- ggplot(total, aes(x = TOC))+
  geom_point(aes(y = fCO2))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
#  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
#  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
#  geom_hline(yintercept = fCO2.atm.1995, col = "pink")+
 annotate(x = 3.5e-5, y = 0.035, geom = "label", 
           label = paste("Slope (log) = ", round(coef.glmfCO2total[1],2), "\n R2 = ", round(r2total,2)))+
 # xlim(1.5e-5,3.5e-3)+ylim(9e-5,0.2)+
  coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "All surveys", col = "")+
  theme_minimal(base_size = 15)+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

print(m.total)
```

### NLSS fCO2-CO2 model with uncorrected TA

```{r glm-ta-fCO2, eval = F}


summary(glmfCO2nlss <- glm(ta_fCO2~TOC+0+offset(fCO2.atm), data = filter(nlss, ta_pCO2 > 0), family = Gamma(link = "identity")))
coef.glmfCO2nlss <- summary(glmfCO2nlss)$coefficients
r2nlss <- with(summary(glmfCO2nlss), 1 - deviance/null.deviance) %>% round(2)

nlss$predfCO2_offset <- predict(glmfCO2nlss, newdata = nlss, se = T)[1] %>% unlist
nlss$predfCO2_se <- predict(glmfCO2nlss, newdata = nlss, se = T)[2] %>% unlist


ggplot(nlss, aes(x = TOC))+
  geom_point(aes(y = ta_pCO2))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  geom_hline(yintercept = fCO2.atm.1995, col = "pink")+
  annotate(x = 0.001, y = -0.4, geom = "label", 
           label = paste("Intercept =", fCO2.atm.1995*1e6," uatm","\n Slope = ", round(coef.glmfCO2nlss[1],2), "\n R2 = ", r2nlss))+
 # coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm (uncorrected)", x = "TOC, mol/L", title = "NLS survey, 1995", col = "")+
  theme_minimal(base_size = 15)+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

```{r fit-evasion-rate-toc-cba}
df <- subset(norway, survey == "CBA_2019")

summary(glmECO2 <- glm(ECO2~TOC_mg+0+offset(K0*fCO2.atm), data = df, family = gaussian(link = "identity")))
coef.glmECO2 <- summary(glmECO2)$coefficients
r2ECO2 <- with(summary(glmECO2), 1 - deviance/null.deviance) %>% round(2)

df$predECO2 <- predict(glmECO2, se = T)[1] %>% unlist
df$predECO2_se <- predict(glmECO2, se = T)[2] %>% unlist


ggplot(df, aes(x = TOC_mg))+
  geom_point(aes(y = ECO2))+
    geom_line(aes(y = (predECO2), col = "predict"))+
  geom_line(aes(y = (predECO2+predECO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predECO2-predECO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  annotate(x = 3, y = 15, geom = "label", 
          label = paste("Slope = ", round(coef.glmECO2[2],2), "\n R2 = ", r2ECO2))+
  coord_trans(x="log10")+
  labs(y = "Evasion of CO2, g/m2/day", x = "TOC, mg/L", title = "CBA", col = "")+
  theme_minimal()+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

```{r fit-evasion-rate-toc-n112}
df <- subset(norway, survey == "N112_2004")

summary(glmECO2 <- glm(ECO2~TOC_mg+0+offset(K0*fCO2.atm), data = df, family = gaussian(link = "identity")))
coef.glmECO2 <- summary(glmECO2)$coefficients
r2ECO2 <- with(summary(glmECO2), 1 - deviance/null.deviance) %>% round(2)

df$predECO2 <- predict(glmECO2, se = T)[1] %>% unlist
df$predECO2_se <- predict(glmECO2, se = T)[2] %>% unlist


ggplot(df, aes(x = TOC_mg))+
  geom_point(aes(y = ECO2))+
    geom_line(aes(y = (predECO2), col = "predict"))+
  geom_line(aes(y = (predECO2+predECO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predECO2-predECO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  annotate(x = 0.5, y = 3, geom = "label", 
           label = paste("Slope = ", round(coef.glmECO2[2],2), "\n R2 = ", r2ECO2))+
  coord_trans(x="log10")+
  labs(y = "Evasion of CO2, g/m2/day", x = "TOC, mg/L", title = "N112", col = "")+
  theme_minimal()+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```
