---
title: "Supplementary Information"
author: "Camille Crapart"
date: "2023-02-09"
output: 
   bookdown::html_document2:
     code_folding: hide
     toc_float: true
     toc: true
     number_sections: true
     fig_caption: true
     keep_tex: true

bibliography: C:\\Users\\raine\\Documents\\UiO\\Bibtex\\fCO2.bib
link-citations: yes
---

html version: [Supplementary information](https://camilmc.github.io/fCO2/Supplementary_information.html)

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, message = F, warning = F, results = F)
options(knitr.kable.NA = '')
```

```{r libraries}
library(dplyr)

library(ggplot2)
library(ggforce)
library(ggpubr)
library(cowplot)
library(gridExtra)
library(colorspace)

library(gamlss)

library(kableExtra)

library(rsq)

fCO2.atm.2020 <- 411.51 * 1e-6 # oct 2020
fCO2.atm.2019 <- 408.75 * 1e-6 # oct 2019
fCO2.atm.2004 <- 374.63 * 1e-6 # oct 2004
fCO2.atm.1995 <- 360.17 * 1e-6
```

```{r fig-num-function}
library(captioner)
fig_nums <- captioner() 
tab_nums <- captioner(prefix = "Table")
```



# Import data

The data was prepared in [Data preparation](https://camilmc.github.io/fCO2/Data_preparation.html)

```{r import-data}

norway <- readRDS("norway.rds")
nlss <- readRDS("nlss.rds")

norway$TOC_mg <- norway$TOC*12.011*1e3
norway$TOC_umol <- norway$TOC*1e6
norway$TA_ueq <- norway$TA * 1e6
norway$CA_ueq <- norway$CA * 1e6
norway$DIC_mg <- norway$DIC*12.011*1e3
norway$DIC_umol <- norway$DIC * 1e6
norway$CA_ueq <- norway$CA * 1e6
norway$Hplus_umol <- norway$Hplus *1e6
norway$invHplus_umol <- 1/norway$Hplus *1e6
norway$invHplus <- 1/norway$Hplus

ggplot()+
   geom_point(data = filter(norway, fCO2 > 2500*1e-6),aes(x=long, y = lat, col = survey), size = 6, shape = 1)+
  geom_point(data = filter(norway, fCO2 < 2500*1e-6),aes(x=long, y = lat, col = survey, size = fCO2*1e6))+
  borders(regions = c("Norway"))+ylim(57,63)+xlim(4,13)+
  scale_color_manual(values = c("firebrick","dodgerblue3"))+
 # scale_fill_continuous_divergingx(palette = "RdYlBu", aesthetics = c("fill","col"), mid = 30, rev = T)+ 
  labs(col="Survey", size = "pCO2, uatm")+
  theme_void()

```

```{r map-nls}

nlss <- readRDS("nlss.rds")
nlss$invHplus <- 1/nlss$Hplus
nlss$TOC_mg <- nlss$TOC*12.011*1e3

ggplot(nlss)+geom_point(aes(x=long, y = lat, col = TOC_mg))+
  borders(regions = c("Norway","Sweden","Finland"))+ylim(55,72)+xlim(4,32)+
  scale_fill_continuous_divergingx(palette = "RdYlBu", aesthetics = c("fill","col"), mid = 10, rev = T)+
  labs(x="TOC, mg/L")+
  theme_void()
```

*`r fig_nums("map-nls", "Map of TOC in mg/L in the Northern Lake Survey")`*

# Estimation of organic and carbonate alkalinity

In this section, we investigate several ways of estimating the share of organic alkalinity in our samples.

## Carbonate speciation N112 / CBA

The concentration of the carbonate species in the N112 and CBA survey is calculated directly from the measured partial pressure of $CO_2$ [@Appelo2005]:

$pCO_2 = [H_2CO_3]/K_0$

$[HCO3^-] = K_1 \times [H_2CO_3]/[H^+]$

$[CO_3^{2-}] = K_2 \times [HCO_3 ^- ] / [H ^+]$

$[TIC] = [H_2CO_3] + [HCO_3^-]+[CO_3 ^{2-}]$

$K_0$ is Henry's constant from @Weiss1974. $K_1$ and $K_2$ are ionization constants of $H_2CO_3$ and $HCO_3^-$ , respectively obtained from @Harned1943 and @Harned1941 and are adjusted for temperature.

In freshwater samples, the chemical activity of carbonate species is assumed to be equal to the molar concentration. Therefore, molar concentration is used in all equilibrium equations.

@Liu2020 reported that in water with low ionic strength, the pH is underestimated by 0.1 to 0.5 units.  We chose to not correct pH in this study because the ionic strength was not available for the N112 survey. Since only one lake in the Northern Lakes Survey had a pH inferior to 5, we assumed that the measurement errors would be minimal.

```{r measured-carbonate-speciation}

ggplot(norway, aes(x = pH))+
  geom_point(aes(y = H2CO3, col = "H2CO3"), alpha = 0.5)+
  geom_point(aes(y = HCO3, col = "HCO3"), alpha = 0.5)+
  geom_point(aes(y = CO3, col = "CO3"), alpha = 0.5)+
  labs(y = "Carbonate species (mol/L)", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3","orange"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")
```
*`r fig_nums("carbonates-norway", "Concentration of carbonate species in mol/L in the CBA and N112 surveys")`*

```{r fCO2-from-TA}
ggplot(norway,aes(x= pH))+geom_point(aes(y = ta_fCO2, col = "pCO2 from TA"), alpha = 0.5)+
  geom_point(aes(y = fCO2, col = "Measured pCO2"), alpha = 0.5)+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_bw(base_size = 15)+
  theme(legend.position = "bottom")

```
*`r fig_nums("map-pCo2", "Measured (red) and calculated (blue) pCO2 in atm for the CBA and N112 surveys")`*

```{r compare-cba-n112}
toc_boxplot <- ggplot(norway)+
  geom_boxplot(aes(x = "TOC", y = TOC, col = survey))+
  geom_boxplot(aes(x = "DIC", y = DIC, col = survey))+
  labs(x = "", y = "concentration, mol/L")+
  scale_color_manual(values = c("firebrick", "dodgerblue"))+
  theme_minimal()+
  theme(legend.position = "bottom")

toc_boxplot
```

*`r fig_nums("boxplot-toc-dic", "Boxplot of DIC and TOC in mol/L for the CBA survey (red) and N112 survey (blue)")`*

## Organic alkalinity as OA = TA - CA

A simple method to estimate the organic alkalinity would be to substract the carbonate alkalinity, known thanks to the DIC measurement, to the total alkalinity. In a second step, one can investigate the link between the TOC concentration and this calculated organic alkalinity. This method is used in @Couturier2022.

```{r measured-oa}
norway$OA <- with(norway, TA-CA)

ggarrange(
ggplot(norway)+geom_point(aes(x = pH, y = CA))+theme_bw(),
ggplot(norway)+geom_point(aes(x = pH, y = OA))+ylim(-1e-4, 1e-4)+theme_bw(),
ggplot(norway)+geom_point(aes(x = TOC, y = OA))+theme_bw(),
ggplot(norway)+geom_point(aes(x = TA, y = OA))+theme_bw(), nrow = 2, ncol = 2)

```
*`r fig_nums("OA", "OA estimated as TA - CA, in eq/L")`*

In our samples, there is no link between organic alkalinity calculated that way and the concentration of TOC. This might result from other sources of alkalinity in our samples.

## Organic alkalinity according to @Hruska2003

@Hruska2003 suggested that the organic alkalinity (OA) can be computed as a triprotic model. OA is the defined as the concentration of organic bases $[RCOO^-]$ in the solution, minus the concentration of organic bases at pH = 4.5, as for an end-point titration. $[RCOO^-]$ depends on three $pK_a$ that were measured in @Hruska2003:

$$[RCOO^-]=\alpha_1 \times \frac{m \times [TOC]}{3}+ \alpha_2 \times \frac{m \times [TOC]}{3} + \alpha_3 \times \frac{m \times [TOC]}{3}$$

Where α is the ionization fraction of each acid/base couple:

$$\alpha = \frac{[RCOO^-]}{[RCOOH]}=\frac{K_a}{[H^+} = \frac{10^{-pK_a}}{[H^+]}$$

And $m$ is the site density of carboxylic group on the organic matter:

$$m = 10.2 \; \pm \;  0.6 \; \mu eq/mg \; DOC \Leftrightarrow 0.12 \; eq/mol \; DOC$$

$m$ is supposed to be equally divided between the three acids with their respective $pK_a$.

```{r organic-acids, eval = T}

pKa1 <- 3.04
Ka1 <- 10^(-pKa1)

pKa2 <- 4.42
Ka2 <- 10^(-pKa2)

pKa3 <- 6.46
Ka3 <- 10^(-pKa3)

m <- 10.2*1e-6*12.011*1e3*1e-3# ueq/mg to eq/mol, site density BUT THERE IS A 1e3 PB: have to multiply by 1e-3 to stay in the range
norway$RCOO <- with(norway, (Ka1/Hplus + 2*Ka2/Hplus + 3*Ka3/Hplus)* m/3 * TOC) # estimated in eq/L

norway$RCOO_4.5 <- with(norway, (Ka1/10^(-4.5) + 2*Ka2/10^(-4.5) + 3*Ka3/10^(-4.5))* m/3 * TOC)

norway$OA_hruska <- with(norway, RCOO-RCOO_4.5)

ggplot(norway)+
  geom_point(aes(x = pH, y = RCOO, col = survey))+
  scale_color_manual(values = c("firebrick","dodgerblue3"))+
  labs(y="[RCOO-], mol/L")+
  theme_minimal()+
  theme(legend.position = "bottom")


norway$CA_hruska <- with(norway, TA - OA_hruska - OH + Hplus) 

norway$CO3_hruska <- with(norway,CA_hruska / (Hplus/K2 +2)) # in mol/L
norway$HCO3_hruska <- with(norway, CO3_hruska*Hplus/K2)
norway$H2CO3_hruska <- with(norway, HCO3_hruska*Hplus/K1)
norway$fCO2_hruska <- with(norway,H2CO3_hruska/K0)
```

*`r fig_nums("OA-Hruska", "OA estimated with triprotic method of Hruska et al., in eq/L")`*

```{r fCO2-from-hruska}
ggplot(norway,aes(x= pH))+geom_point(aes(y = fCO2_hruska, col = "pCO2 from calculated from Hruska et al"), alpha = 0.5)+
  geom_point(aes(y = fCO2, col = "Measured pCO2"), alpha = 0.5)+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal(base_size = 15)+
  theme(legend.position = "bottom")
```

*`r fig_nums("pco2-hruska", "pCO2 estimated with Hruska method, in atm")`*

This method results in an overestimation of organic alkalinity in samples with high concentration of total organic carbon. The calculated carbonate alkalinity, and in turn the partial pressure of CO2, is then negative, which is impossible.

## Organic alkalinity according to @Liu2020

A simplifying approach was suggested by @Liu2020 , building on @Cai1998 and @Lozovik2005, where the organic alkalinity can be calculated directly from TOC as:

$OA = 80 \% \times 10\% \times [TOC]$

80% being the proportion of DOC that is an organic acid [\@Cai1998], and 10% the maximum fraction of anions contributing to alkalinity [@Lozovik2005]. This last value was calculated for DOC in humic lakes, but overall this equation is designed to be applicable to all kinds of lakes, tropical or temperate.

```{r fix-pH-OA-with-Liu}

#norway$pH_Liu <- with(norway, pH - (0.03+0.05*log10(IS))) 
#norway$Hplus_Liu <- 10^(-norway$pH_Liu) 
#norway$OH_Liu <- with(norway,Kw*Hplus_Liu)

norway$OA_Liu <- 0.08 * norway$TOC
norway$CA_Liu <- with(norway, TA-OA_Liu - OH + Hplus)

norway$CO3_Liu <- with(norway,CA_Liu / (Hplus/K2 +2)) # in mol/L
norway$HCO3_Liu <- with(norway, CO3_Liu*Hplus/K2)
norway$H2CO3_Liu <- with(norway, HCO3_Liu*Hplus/K1)
norway$fCO2_Liu <- with(norway,H2CO3_Liu/K0)

norway$DIC_Liu <- with(norway, H2CO3_Liu + HCO3_Liu + CO3_Liu)
```

```{r fCO2-from-liu}
ggplot(norway,aes(x= pH))+geom_point(aes(y = fCO2_Liu, col = "pCO2 from calculated from Liu et al."), alpha = 0.5)+
  geom_point(aes(y = fCO2, col = "Measured pCO2"), alpha = 0.5)+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal(base_size = 15)+
  theme(legend.position = "bottom")
```

*`r fig_nums("pCO2-Liu", "pCO2 estimated with Liu method, in atm")`*

Once again, the organic alkalinity is overestimated in samples with high concentration of TOC, resulting in negative pCO2.

# Model DIC and pCO2

Since the different methods to adjust the total alkalinity by removing the share of organic alkalinity, we tried different models aiming at estimating either the concentration of dissolved inorganic carbon (DIC), in order to calculate pCO2 with the carbonate equilibrium, or directly the partial pressure of CO2.

For each set of predictors, we fitted a model for DIC, then calculated the resulting pCO2; and fitted a model for pCO2. 

The models used here are generalized linear model, allowing the use of the Gamma distribution. 

We added a fixed intercept in the pCO2 models corresponding to the atmospheric concentration of CO2. 

## TA

```{r glm-dic-ta, fig.dim = c(10,8), results = T}
dic.ta <- glm(formula = DIC~TA, data = norway, family = Gamma(link = "identity"))

dic.ta.sum <- summary(dic.ta)$coefficients %>% as.data.frame() 
dic.ta.sp <- rownames(dic.ta.sum)[which(dic.ta.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
dic.ta.sum <- dic.ta.sum %>% format(scientific = T, digits = 2)

kable(dic.ta.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$DIC_pred <- fitted(dic.ta)
norway$DIC_pred_res <- residuals(dic.ta)
dic.ta.r2 <- with(summary(dic.ta), 1 - deviance/null.deviance) %>% round(2)
dic.ta.aic <- AIC(dic.ta)

g1 <- ggplot(norway)+geom_point(aes(x=DIC,y=DIC_pred))+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",dic.ta.r2, ""))+
    theme_minimal(base_size = 15)

g2 <- ggplot(norway)+geom_point(aes(x=DIC_pred,y=DIC_pred_res))+
   coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
  theme_minimal(base_size = 15)

norway$pCO2_calc <- with(norway, DIC_pred/(K0*(1+K1*Hplus+K2*K1*Hplus^2)))

g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal(base_size = 15)+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

*`r fig_nums("dic-ta", "Predicted vs fitted values, Standardized residuals vs fitted values,and measured (red) calculated (blue) pCO2 vs pH for DIC~TA")`*

```{r nlss-pred-ta}
nlss$dic_pred <- predict(dic.ta, newdata = nlss, type = "response")
nlss$pCO2_calc <- with(nlss, dic_pred/(K0+K0*K1/Hplus+K0*K1*K2/Hplus))

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_calc, col = "pCO2 from modelled DIC"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

*`r fig_nums("dic-ta-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*


```{r glm-pco2-ta, fig.dim = c(10,8), results = T}
pco2.ta <- glm(formula = fCO2~TA+0+offset(fCO2.atm), data = norway, family = Gamma(link = "identity"))

pco2.ta.sum <- summary(pco2.ta)$coefficients %>% as.data.frame() 
pco2.ta.sp <- rownames(pco2.ta.sum)[which(pco2.ta.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.ta.sum <- pco2.ta.sum %>% format(scientific = T, digits = 2)

kable(pco2.ta.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$pCO2_pred <- fitted(pco2.ta)
norway$pCO2_pred_res <- residuals(pco2.ta)
pco2.ta.r2 <- with(summary(pco2.ta), 1 - deviance/null.deviance) %>% round(2)
pco2.ta.aic <- AIC(pco2.ta)

g1 <- ggplot(norway)+geom_point(aes(x=fCO2,y=pCO2_pred))+   
  labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.ta.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

*`r fig_nums("pco2-ta", "Predicted vs fitted values, Standardized residuals vs fitted values,and measured (red) predicted (blue) pCO2 vs pH for pCO2~TA")`* 

```{r nlss-pred-pco2-ta}
nlss$pCO2_pred <- predict(pco2.ta, newdata = nlss, type = "response")

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_pred, col = "predicted pCO2 NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

*`r fig_nums("pco2-ta-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*

## 1/TA

```{r glm-dic-invta, fig.dim = c(10,8), results = T}
norway$invTA <- with(norway, ifelse(TA == 0, 0, 1/TA))

dic.invTA <- glm(formula = DIC~invTA, data = norway, family = Gamma(link = "identity"))

dic.invTA.sum <- summary(dic.invTA)$coefficients %>% as.data.frame() 
dic.invTA.sp <- rownames(dic.invTA.sum)[which(dic.invTA.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
dic.invTA.sum <- dic.invTA.sum %>% format(scientific = T, digits = 2)

kable(dic.invTA.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$DIC_pred <- fitted(dic.invTA)
norway$DIC_pred_res <- residuals(dic.invTA)
dic.invTA.r2 <- with(summary(dic.invTA), 1 - deviance/null.deviance) %>% round(2)
dic.invTA.aic <- AIC(dic.invTA)

g1 <- ggplot(norway)+geom_point(aes(x=DIC,y=DIC_pred))+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",dic.invTA.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=DIC_pred,y=DIC_pred_res))+
   coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
  theme_minimal()

norway$pCO2_calc <- with(norway, DIC_pred/(K0*(1+K1*Hplus+K2*K1*Hplus^2)))


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2, rel_heights = c(2,3))
```

*`r fig_nums("dic-invta", "Predicted vs fitted values, Standardized residuals vs fitted values,and measured (red) calculated (blue) pCO2 vs pH for DIC~1/TA")`*

```{r nlss-dic-invta}

nlss$invTA <- with(nlss, ifelse(TA == 0, 0, 1/TA))

nlss$dic_pred <- predict(dic.invTA, newdata = nlss, type = "response")
nlss$pCO2_calc <- with(nlss, dic_pred/(K0+K0*K1/Hplus+K0*K1*K2/Hplus))

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_calc, col = "pCO2 from modelled DIC"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

*`r fig_nums("dic-invta-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*

```{r glm-pco2-invTA, fig.dim = c(10,8), results = T}
pco2.invTA <- glm(formula = fCO2~invTA+0+offset(fCO2.atm), data = norway, family = Gamma(link = "identity"))

pco2.invTA.sum <- summary(pco2.invTA)$coefficients %>% as.data.frame() 
pco2.invTA.sp <- rownames(pco2.invTA.sum)[which(pco2.invTA.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.invTA.sum <- pco2.invTA.sum %>% format(scientific = T, digits = 2)

kable(pco2.invTA.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$pCO2_pred <- fitted(pco2.invTA)
norway$pCO2_pred_res <- residuals(pco2.invTA)
pco2.invTA.r2 <- with(summary(pco2.invTA), 1 - deviance/null.deviance) %>% round(2)
pco2.invTA.aic <- AIC(pco2.invTA)

g1 <- ggplot(norway)+geom_point(aes(x=fCO2,y=pCO2_pred))+   
  labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.invTA.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

*`r fig_nums("pco2-invta", "Predicted vs fitted values, Standardized residuals vs fitted values,and measured (red) and predicted (blue) pCO2 vs pH for pCO2~1/TA")`*

```{r nlss-pco2-invTA}

nlss$pCO2_pred <- predict(pco2.invTA, newdata = nlss, type = "response")

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_pred, col = "predicted pCO2 NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

*`r fig_nums("pco2-invta-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*

## TOC

```{r glm-dic-toc, fig.dim = c(10,8), results = T}

dic.toc <- glm(formula = DIC~TOC, data = norway, family = Gamma(link = "identity"))
dic.toc.sum <- summary(dic.toc)$coefficients %>% as.data.frame() 
dic.toc.sp <- rownames(dic.toc.sum)[which(dic.toc.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
dic.toc.sum <- dic.toc.sum %>% format(scientific = T, digits = 2)

kable(dic.toc.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$DIC_pred <- fitted(dic.toc)
norway$DIC_pred_res <- residuals(dic.toc)
dic.toc.r2 <- with(summary(dic.toc), 1 - deviance/null.deviance) %>% round(2)
dic.toc.aic <- AIC(dic.toc)

g1 <- ggplot(norway)+geom_point(aes(x=DIC,y=DIC_pred))+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",dic.toc.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=DIC_pred,y=DIC_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

norway$pCO2_calc <- with(norway, DIC_pred/(K0+K0*K1/Hplus+K0*K1*K2/(Hplus^2)))


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

*`r fig_nums("dic-toc", "Predicted vs fitted values, Standardized residuals vs fitted values, and measured (red) calculated (blue) pCO2 vs pH for DIC~TOC")`*

```{r nlss-dic-toc}
nlss$dic_pred <- predict(dic.toc, newdata = nlss, type = "response")
nlss$pCO2_calc <- with(nlss, dic_pred/(K0+K0*K1/Hplus+K0*K1*K2/Hplus))

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_calc, col = "pCO2 from predicted DIC, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```


*`r fig_nums("dic-toc-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*

```{r glm-pCO2-toc, fig.dim = c(10,8), results = T}

pco2.toc <- glm(formula = fCO2~TOC+0+offset(fCO2.atm), data = norway, family = Gamma(link = "identity"))

pco2.toc.sum <- summary(pco2.toc)$coefficients %>% as.data.frame() 
pco2.toc.sp <- rownames(pco2.toc.sum)[which(pco2.toc.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.toc.sum <- pco2.toc.sum %>% format(scientific = T, digits = 2)

kable(pco2.toc.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$pCO2_pred <- fitted(pco2.toc)
norway$pCO2_pred_res <- residuals(pco2.toc)
pco2.toc.r2 <- with(summary(pco2.toc), 1 - deviance/null.deviance) %>% round(2)
pco2.toc.aic <- AIC(pco2.toc)

g1 <- ggplot(norway)+geom_point(aes(x=fCO2,y=pCO2_pred))+   labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.toc.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```



*`r fig_nums("pco2-toc", "Predicted vs fitted values, Standardized residuals vs fitted values,and measured (red) and predicted (blue), pCO2 vs pH for DIC~TOC")`* 

```{r nlss-pco2-toc}
nlss$pCO2_pred <- predict(pco2.toc, newdata = nlss, type = "response")

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_pred, col = "Predicted pCO2"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

*`r fig_nums("pco2-toc-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*

```{r for-article}
ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"), alpha = 0.5)+
  geom_point(aes(y = fCO2, col = "Measured pCO2"), alpha = 0.5)+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_bw(base_size = 15)+
  theme(legend.position = "bottom")
```

```{r glm-pCO2-toc-cba, fig.dim = c(10,8), results = T}

cba <- subset(norway, survey == "CBA_2019")

pco2.toc.cba <- glm(formula = fCO2~TOC+0+offset(fCO2.atm), data = cba, family = Gamma(link = "identity"))

pco2.toc.cba.sum <- summary(pco2.toc.cba)$coefficients %>% as.data.frame() 
pco2.toc.cba.sp <- rownames(pco2.toc.cba.sum)[which(pco2.toc.cba.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.toc.cba.sum <- pco2.toc.cba.sum %>% format(scientific = T, digits = 2)

kable(pco2.toc.cba.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

cba$pCO2_pred <- fitted(pco2.toc.cba)
cba$pCO2_pred_res <- residuals(pco2.toc.cba)
pco2.toc.cba.r2 <- with(summary(pco2.toc.cba), 1 - deviance/null.deviance) %>% round(2)
pco2.toc.cba.aic <- AIC(pco2.toc.cba)

g1 <- ggplot(cba)+geom_point(aes(x=fCO2,y=pCO2_pred))+   labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.toc.cba.r2, ""))+
    theme_minimal()

g2 <- ggplot(cba)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

g3 <- ggplot(cba,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

```{r glm-pCO2-toc-n112, fig.dim = c(10,8), results = T}

n112 <- subset(norway, survey == "N112_2004")

pco2.toc.n112 <- glm(formula = fCO2~TOC+0+offset(fCO2.atm), data = n112, family = Gamma(link = "identity"))

pco2.toc.n112.sum <- summary(pco2.toc.n112)$coefficients %>% as.data.frame() 
pco2.toc.n112.sp <- rownames(pco2.toc.n112.sum)[which(pco2.toc.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.toc.n112.sum <- pco2.toc.n112.sum %>% format(scientific = T, digits = 2)

kable(pco2.toc.n112.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

n112$pCO2_pred <- fitted(pco2.toc.n112)
n112$pCO2_pred_res <- residuals(pco2.toc.n112)
pco2.toc.n112.r2 <- with(summary(pco2.toc.n112), 1 - deviance/null.deviance) %>% round(2)
pco2.toc.n112.aic <- AIC(pco2.toc.n112)

g1 <- ggplot(n112)+geom_point(aes(x=fCO2,y=pCO2_pred))+   labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.toc.n112.r2, ""))+
    theme_minimal()

g2 <- ggplot(n112)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

g3 <- ggplot(n112,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

```{r try-cba-model-on-n112}
n112$pCO2_pred <- predict(pco2.toc.cba, newdata = n112, type = "response")

ggplot(data = n112, aes(x = fCO2))+
  geom_point(aes(y = pCO2_pred, col = "Predicted pCO2 for N112 based on model fitted on CBA"), alpha = 0.5)+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
  coord_trans(x="log10",y="log10")+
  annotate(x = 0.0005, y = 0.0015, geom = "label", label = paste("r = ",round(cor(n112$fCO2, n112$pCO2_pred, use = "pairwise.complete"),2)))+
  labs(x = "Measured pCO2", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

```{r try-n112-model-on-cba}
cba$pCO2_pred <- predict(pco2.toc.n112, newdata = cba, type = "response")

ggplot(data = cba, aes(x = fCO2))+
  geom_point(aes(y = pCO2_pred, col = "Predicted pCO2 for CBA based on model fitted on N112"), alpha = 0.5)+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
  coord_trans(x="log10",y="log10")+
  annotate(x = 0.0005, y = 0.005, geom = "label", label = paste("r = ",round(cor(cba$fCO2, cba$pCO2_pred, use = "pairwise.complete"),2)))+
  labs(x = "Measured pCO2", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

*`r fig_nums("pco2-toc-article", "Model results for pCO2~TOC")`*

```{r boxplot-n112-cba}

ggarrange(
 ggplot(norway)+geom_boxplot(aes(x = "", y = TOC * 12.011 / 1e-3, col = survey))+
  scale_color_manual(values = c("firebrick","orange","dodgerblue"))+
  labs(x = "", col = "",y = "Total organic carbon, mgC/L")+
  coord_trans(y="log10")+
  theme_minimal()+
  theme(legend.position = "bottom")
,
 ggplot(norway)+geom_boxplot(aes(x = "", y = fCO2 * 1e6, col = survey))+
  scale_color_manual(values = c("firebrick","orange","dodgerblue"))+
  labs(x = "", col = "",y = "pCO2, uatm")+
  theme_minimal()+
  theme(legend.position = "bottom"),
common.legend = T,
ncol = 1, nrow = 2)
```


## TOC + temp

```{r glm-dic-toc-temp, fig.dim = c(10,8), results = T}

dic.toc.temp <- glm(formula = DIC~TOC+temp_k, data = norway, family = Gamma(link = "identity"))
dic.toc.temp.sum <- summary(dic.toc.temp)$coefficients %>% as.data.frame() 
dic.toc.temp.sp <- rownames(dic.toc.temp.sum)[which(dic.toc.temp.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
dic.toc.temp.sum <- dic.toc.temp.sum %>% format(scientific = T, digits = 2)

kable(dic.toc.temp.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$DIC_pred <- fitted(dic.toc.temp)
norway$DIC_pred_res <- residuals(dic.toc.temp)
dic.toc.temp.r2 <- with(summary(dic.toc.temp), 1 - deviance/null.deviance) %>% round(2)
dic.toc.temp.aic <- AIC(dic.toc.temp)

g1 <- ggplot(norway)+geom_point(aes(x=DIC,y=DIC_pred))+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",dic.toc.temp.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=DIC_pred,y=DIC_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

norway$pCO2_calc <- with(norway, DIC_pred/(K0+K0*K1/Hplus+K0*K1*K2/(Hplus^2)))


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

*`r fig_nums("dic-toc", "Predicted vs fitted values, Standardized residuals vs fitted values, and measured (red) calculated (blue) pCO2 vs pH for DIC~TOC")`*

```{r nlss-dic-toc-temp}
nlss$dic_pred <- predict(dic.toc.temp, newdata = nlss, type = "response")
nlss$pCO2_calc <- with(nlss, dic_pred/(K0+K0*K1/Hplus+K0*K1*K2/Hplus))

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_calc, col = "pCO2 from predicted DIC, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```


*`r fig_nums("dic-toc-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*

```{r glm-pCO2-toc-temp, fig.dim = c(10,8), results = T}

pco2.toc.temp <- glm(formula = fCO2~TOC+temp_k+0+offset(fCO2.atm), data = norway, family = Gamma(link = "identity"))

pco2.toc.temp.sum <- summary(pco2.toc.temp)$coefficients %>% as.data.frame() 
pco2.toc.temp.sp <- rownames(pco2.toc.temp.sum)[which(pco2.toc.temp.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.toc.temp.sum <- pco2.toc.temp.sum %>% format(scientific = T, digits = 2)

kable(pco2.toc.temp.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$pCO2_pred <- fitted(pco2.toc.temp)
norway$pCO2_pred_res <- residuals(pco2.toc.temp)
pco2.toc.temp.r2 <- with(summary(pco2.toc.temp), 1 - deviance/null.deviance) %>% round(2)
pco2.toc.temp.aic <- AIC(pco2.toc.temp)

g1 <- ggplot(norway)+geom_point(aes(x=fCO2,y=pCO2_pred))+   labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.toc.temp.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

*`r fig_nums("pco2-toc", "Predicted vs fitted values, Standardized residuals vs fitted values,and measured (red) and predicted (blue), pCO2 vs pH for DIC~TOC")`* 

```{r nlss-pco2-toc-temp}
nlss$pCO2_pred <- predict(pco2.toc.temp, newdata = nlss, type = "response")

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_pred, col = "Predicted pCO2"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

*`r fig_nums("pco2-toc-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*

```{r for-article-temp}
ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"), alpha = 0.5)+
  geom_point(aes(y = fCO2, col = "Measured pCO2"), alpha = 0.5)+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_bw(base_size = 15)+
  theme(legend.position = "bottom")
```

*`r fig_nums("pco2-toc-article", "Model results for pCO2~TOC")`*

## TA + TOC

```{r glm-dic-toc-ta, fig.dim = c(10,8), results = T}

dic.toc.ta <- glm(formula = DIC~TOC+TA, data = norway, family = Gamma(link = "identity"))
dic.toc.ta.sum <- summary(dic.toc.ta)$coefficients %>% as.data.frame() 
dic.toc.ta.sp <- rownames(dic.toc.ta.sum)[which(dic.toc.ta.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
dic.toc.ta.sum <- dic.toc.ta.sum %>% format(scientific = T, digits = 2)

kable(dic.toc.ta.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$DIC_pred <- fitted(dic.toc.ta)
norway$DIC_pred_res <- residuals(dic.toc.ta)
dic.toc.ta.r2 <- with(summary(dic.toc.ta), 1 - deviance/null.deviance) %>% round(2)
dic.toc.ta.aic <- AIC(dic.toc.ta)

g1 <- ggplot(norway)+geom_point(aes(x=DIC,y=DIC_pred))+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",dic.toc.ta.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=DIC_pred,y=DIC_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

norway$pCO2_calc <- with(norway, DIC_pred/(K0+K0*K1/Hplus+K0*K1*K2/(Hplus^2)))


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

*`r fig_nums("dic-ta-toc", "Predicted vs fitted values, Standardized residuals vs fitted values,and measured (red) calculated (blue) pCO2 vs pH for DIC~TA+TOC")`*

```{r nlss-dic-toc-ta}
nlss$dic_pred <- predict(dic.toc.ta, newdata = nlss, type = "response")
nlss$pCO2_calc <- with(nlss, dic_pred/(K0+K0*K1/Hplus+K0*K1*K2/Hplus))

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_calc, col = "pCO2 from predicted DIC, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

*`r fig_nums("dic-toc-ta-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*

```{r glm-pCO2-toc-ta, fig.dim = c(10,8),results = T}

pco2.toc.ta <- glm(formula = fCO2~TOC+TA+0+offset(fCO2.atm), data = norway, family = Gamma(link = "identity"))

pco2.toc.ta.sum <- summary(pco2.toc.ta)$coefficients %>% as.data.frame() 
pco2.toc.ta.sp <- rownames(pco2.toc.ta.sum)[which(pco2.toc.ta.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.toc.ta.sum <- pco2.toc.ta.sum %>% format(scientific = T, digits = 2)

kable(pco2.toc.ta.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$pCO2_pred <- fitted(pco2.toc.ta)
norway$pCO2_pred_res <- residuals(pco2.toc.ta)
pco2.toc.ta.r2 <- with(summary(pco2.toc.ta), 1 - deviance/null.deviance) %>% round(2)
pco2.toc.ta.aic <- AIC(pco2.toc.ta)

g1 <- ggplot(norway)+geom_point(aes(x=fCO2,y=pCO2_pred))+   labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.toc.ta.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

*`r fig_nums("pco2-toc-ta", "Predicted vs fitted values, Standardized residuals vs fitted values,and measured (red) calculated (blue) pCO2 vs pH for pCO2~TOC+TA")`*
`
```{r nlss-pco2-toc-ta}
nlss$pCO2_pred <- predict(pco2.toc.ta, newdata = nlss, type = "response")

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_pred, col = "Predicted pCO2, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

*`r fig_nums("pco2-toc-ta-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*

## TA*TOC + Hplus

```{r glm-dic-toc-ta-hplus, fig.dim = c(10,8), results = T}

dic.tocta.Hplus <- glm(formula = DIC~TOC+TA+Hplus, data = norway, family = Gamma(link = "identity"))
  dic.tocta.Hplus.sum <- summary(dic.tocta.Hplus)$coefficients %>% as.data.frame() 
  dic.tocta.Hplus.sp <- rownames(dic.tocta.Hplus.sum)[which(dic.tocta.Hplus.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
  dic.tocta.Hplus.sum <- dic.tocta.Hplus.sum %>% format(scientific = T, digits = 2)

kable(dic.tocta.Hplus.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$DIC_pred <- fitted(dic.tocta.Hplus)
norway$DIC_pred_res <- residuals(dic.tocta.Hplus)
dic.tocta.Hplus.r2 <- with(summary(dic.tocta.Hplus), 1 - deviance/null.deviance) %>% round(2)
dic.tocta.Hplus.aic <- AIC(dic.tocta.Hplus)

g1 <- ggplot(norway)+geom_point(aes(x=DIC,y=DIC_pred))+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",dic.tocta.Hplus.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=DIC_pred,y=DIC_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

norway$pCO2_calc <- with(norway, DIC_pred/(K0+K0*K1/Hplus+K0*K1*K2/(Hplus^2)))


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

*`r fig_nums("dic-tocta-hplus", "Predicted vs fitted values, Standardized residuals vs fitted values,and measured (red) calculated (blue) pCO2 vs pH for DIC~TA x TOC + Hplus")`*

```{r nlss-dic-toc-ta-hplus}
nlss$dic_pred <- predict(dic.tocta.Hplus, newdata = nlss, type = "response")
nlss$pCO2_calc <- with(nlss, dic_pred/(K0+K0*K1/Hplus+K0*K1*K2/Hplus))

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_calc, col = "pCO2 from predicted DIC, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

*`r fig_nums("dic-tatoc-hplus-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*

```{r glm-pCO2-toc-ta-hplus, fig.dim = c(10,8),results = T}

pco2.tocta.Hplus <- glm(formula = fCO2~TOC+TA+Hplus+0+offset(fCO2.atm), data = norway, family = Gamma(link = "identity"))

pco2.tocta.Hplus.sum <- summary(pco2.tocta.Hplus)$coefficients %>% as.data.frame() 
pco2.tocta.Hplus.sp <- rownames(pco2.tocta.Hplus.sum)[which(pco2.tocta.Hplus.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.tocta.Hplus.sum <- pco2.tocta.Hplus.sum %>% format(scientific = T, digits = 2)

kable(pco2.tocta.Hplus.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$pCO2_pred <- fitted(pco2.tocta.Hplus)
norway$pCO2_pred_res <- residuals(pco2.tocta.Hplus)
pco2.tocta.Hplus.r2 <- with(summary(pco2.tocta.Hplus), 1 - deviance/null.deviance) %>% round(2)
pco2.tocta.Hplus.aic <- AIC(pco2.tocta.Hplus)

g1 <- ggplot(norway)+geom_point(aes(x=fCO2,y=pCO2_pred))+   labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.tocta.Hplus.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

*`r fig_nums("pco2-tatoc-hplus", "Predicted vs fitted values, Standardized residuals vs fitted values,and measured (red) calculated (blue) pCO2 vs pH for pCO2~TA x TOC + Hplus")`*

```{r nlss-pco2-tocta-hplus}
nlss$pCO2_pred <- predict(pco2.tocta.Hplus, newdata = nlss, type = "response")

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_pred, col = "Predicted pCO2, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

*`r fig_nums("pco2-tocta-hplus-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*

## TOC + pH

```{r glm-dic-toc-Hplus, fig.dim = c(10,8), results = T}

dic.toc.Hplus <- glm(formula = DIC~TOC+Hplus, data = norway, family = Gamma(link = "identity"))
dic.toc.Hplus.sum <- summary(dic.toc.Hplus)$coefficients %>% as.data.frame() 
dic.toc.Hplus.sp <- rownames(dic.toc.Hplus.sum)[which(dic.toc.Hplus.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
dic.toc.Hplus.sum <- dic.toc.Hplus.sum %>% format(scientific = T, digits = 2)

kable(dic.toc.Hplus.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$DIC_pred <- fitted(dic.toc.Hplus)
norway$DIC_pred_res <- residuals(dic.toc.Hplus)
dic.toc.Hplus.r2 <- with(summary(dic.toc.Hplus), 1 - deviance/null.deviance) %>% round(2)
dic.toc.Hplus.aic <- AIC(dic.toc.Hplus)

g1 <- ggplot(norway)+geom_point(aes(x=DIC,y=DIC_pred))+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",dic.toc.Hplus.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=DIC_pred,y=DIC_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

norway$pCO2_calc <- with(norway, DIC_pred/(K0+K0*K1/Hplus+K0*K1*K2/(Hplus^2)))


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "Hplus", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

*`r fig_nums("dic-toc-hplus", "Predicted vs fitted values, Standardized residuals vs fitted values,and measured (red) calculated (blue) pCO2 vs pH for DIC~TOC+Hplus")`*

```{r nlss-dic-toc-Hplus}
nlss$dic_pred <- predict(dic.toc.Hplus, newdata = nlss, type = "response")
nlss$pCO2_calc <- with(nlss, dic_pred/(K0+K0*K1/Hplus+K0*K1*K2/Hplus))

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_calc, col = "pCO2 from predicted DIC, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

*`r fig_nums("dic-toc-hplus-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*

```{r glm-pCO2-toc-Hplus, fig.dim = c(10,8),results = T}

pco2.toc.Hplus <- glm(formula = fCO2~TOC+Hplus+0+offset(fCO2.atm), data = norway, family = Gamma(link = "identity"))

pco2.toc.Hplus.sum <- summary(pco2.toc.Hplus)$coefficients %>% as.data.frame() 
pco2.toc.Hplus.sp <- rownames(pco2.toc.Hplus.sum)[which(pco2.toc.Hplus.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.toc.Hplus.sum <- pco2.toc.Hplus.sum %>% format(scientific = T, digits = 2)

kable(pco2.toc.Hplus.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$pCO2_pred <- fitted(pco2.toc.Hplus)
norway$pCO2_pred_res <- residuals(pco2.toc.Hplus)
pco2.toc.Hplus.r2 <- with(summary(pco2.toc.Hplus), 1 - deviance/null.deviance) %>% round(2)
pCO2.toc.Hplus.aic <- AIC(pco2.toc.Hplus)

g1 <- ggplot(norway)+geom_point(aes(x=fCO2,y=pCO2_pred))+   labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.toc.Hplus.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

*`r fig_nums("dic-toc-hplus", "Predicted vs fitted values, Standardized residuals vs fitted values,and measured (red) calculated (blue) pCO2 vs pH for pCO2~TOC+Hplus")`* 

```{r nlss-pco2-toc-hplus}
nlss$pCO2_pred <- predict(pco2.toc.Hplus, newdata = nlss, type = "response")

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_pred, col = "Predicted pCO2, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

*`r fig_nums("pco2-toc-hplus-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*

## TA * TOC

```{r glm-dic-tocta, fig.dim = c(10,8), results = T}

dic.tocta <- glm(formula = DIC~TOC*TA, data = norway, family = Gamma(link = "identity"))
dic.tocta.sum <- summary(dic.tocta)$coefficients %>% as.data.frame() 
dic.tocta.sp <- rownames(dic.tocta.sum)[which(dic.toc.ta.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
dic.tocta.sum <- dic.tocta.sum %>% format(scientific = T, digits = 2)

kable(dic.tocta.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$DIC_pred <- fitted(dic.tocta)
norway$DIC_pred_res <- residuals(dic.tocta)
dic.tocta.r2 <- with(summary(dic.tocta), 1 - deviance/null.deviance) %>% round(2)
dic.tocta.aic <- AIC(dic.tocta)

g1 <- ggplot(norway)+geom_point(aes(x=DIC,y=DIC_pred))+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",dic.tocta.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=DIC_pred,y=DIC_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

norway$pCO2_calc <- with(norway, DIC_pred/(K0+K0*K1/Hplus+K0*K1*K2/(Hplus^2)))


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

*`r fig_nums("dic-tatoc", "Predicted vs fitted values, Standardized residuals vs fitted values,and measured (red) calculated (blue) pCO2 vs pH for DIC~TA x TOC")`*

```{r nlss-dic-tocta}
nlss$dic_pred <- predict(dic.tocta, newdata = nlss, type = "response")
nlss$pCO2_calc <- with(nlss, dic_pred/(K0+K0*K1/Hplus+K0*K1*K2/Hplus))

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_calc, col = "pCO2 from predicted DIC, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

*`r fig_nums("dic-tocta-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*

```{r glm-pCO2-tocta, fig.dim = c(10,8),results = T}

pco2.tocta <- glm(formula = fCO2~TOC+TA+0+offset(fCO2.atm), data = norway, family = Gamma(link = "identity"))

pco2.tocta.sum <- summary(pco2.tocta)$coefficients %>% as.data.frame() 
pco2.tocta.sp <- rownames(pco2.tocta.sum)[which(pco2.tocta.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.tocta.sum <- pco2.tocta.sum %>% format(scientific = T, digits = 2)

kable(pco2.tocta.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$pCO2_pred <- fitted(pco2.tocta)
norway$pCO2_pred_res <- residuals(pco2.tocta)
pco2.tocta.r2 <- with(summary(pco2.tocta), 1 - deviance/null.deviance) %>% round(2)
pco2.tocta.aic <- AIC(pco2.tocta)

g1 <- ggplot(norway)+geom_point(aes(x=fCO2,y=pCO2_pred))+   labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.tocta.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

*`r fig_nums("pco2-tatoc", "Predicted vs fitted values, Standardized residuals vs fitted values,and measured (red) calculated (blue) pCO2 vs pH for pCO2~TA x TOC")`*

```{r nlss-pco2-tocta}
nlss$pCO2_pred <- predict(pco2.tocta, newdata = nlss, type = "response")

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_pred, col = "Predicted pCO2, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

*`r fig_nums("pco2-tocta-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*

## TA*Hplus

```{r glm-dic-taHplus, fig.dim = c(10,8),results = T}

dic.taHplus <- glm(formula = DIC~TA*Hplus, data = norway, family = Gamma(link = "identity"))

dic.taHplus.sum <- summary(dic.taHplus)$coefficients %>% as.data.frame() 
dic.taHplus.sp <- rownames(dic.taHplus.sum)[which(dic.taHplus.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
dic.taHplus.sum <- dic.taHplus.sum %>% format(scientific = T, digits = 2)

kable(dic.taHplus.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$DIC_pred <- fitted(dic.taHplus)
norway$DIC_pred_res <- residuals(dic.taHplus)
dic.taHplus.r2 <- with(summary(dic.taHplus), 1 - deviance/null.deviance) %>% round(2)
dic.taHplus.aic <- AIC(dic.taHplus)

g1 <- ggplot(norway)+geom_point(aes(x=DIC,y=DIC_pred))+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",dic.taHplus.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=DIC_pred,y=DIC_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

norway$pCO2_calc <- with(norway, DIC_pred/(K0+K0*K1/Hplus+K0*K1*K2/(Hplus^2)))


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

*`r fig_nums("dic-taHplus", "Predicted vs fitted values, Standardized residuals vs fitted values,and measured (red) calculated (blue) pCO2 vs pH for DIC~TA x Hplus")`*

```{r nlss-dic-taHplus}
nlss$dic_pred <- predict(dic.taHplus, newdata = nlss, type = "response")
nlss$pCO2_calc <- with(nlss, dic_pred/(K0+K0*K1/Hplus+K0*K1*K2/Hplus))

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_calc, col = "pCO2 from predicted DIC, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

*`r fig_nums("dic-tahplus-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*

```{r glm-pco2-tahplus, fig.dim = c(10,8),results = T}

pco2.taHplus <- glm(formula = fCO2~TA*Hplus+0+offset(fCO2.atm), data = norway, family = Gamma(link = "identity"))

pco2.taHplus.sum <- summary(pco2.taHplus)$coefficients %>% as.data.frame() 
pco2.taHplus.sp <- rownames(pco2.taHplus.sum)[which(pco2.taHplus.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.taHplus.sum <- pco2.taHplus.sum %>% format(scientific = T, digits = 2)

kable(pco2.taHplus.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$pCO2_pred <- fitted(pco2.taHplus)
norway$pCO2_pred_res <- residuals(pco2.taHplus)
pco2.taHplus.r2 <- with(summary(pco2.taHplus), 1 - deviance/null.deviance) %>% round(2)
pco2.taHplus.aic <- AIC(pco2.taHplus)

g1 <- ggplot(norway)+geom_point(aes(x=fCO2,y=pCO2_pred))+   labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.taHplus.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

*`r fig_nums("pco2-taHplus", "Predicted vs fitted values, Standardized residuals vs fitted values,and measured (red) calculated (blue) pCO2 vs pH for DIC~TA")`*

```{r nlss-pco2-tahplus}

nlss$pCO2_pred <- predict(pco2.taHplus, newdata = nlss, type = "response")

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_pred, col = "Predicted pCO2, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")

```

*`r fig_nums("pco2-taHplus-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*

## TOC*Hplus

```{r glm-dic-tocHplus, fig.dim = c(10,8),results = T}

dic.TOCHplus <- glm(formula = DIC~TOC*Hplus, data = norway, family = Gamma(link = "identity"))

dic.TOCHplus.sum <- summary(dic.TOCHplus)$coefficients %>% as.data.frame() 
dic.TOCHplus.sp <- rownames(dic.TOCHplus.sum)[which(dic.TOCHplus.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
dic.TOCHplus.sum <- dic.TOCHplus.sum %>% format(scientific = T, digits = 2)

kable(dic.TOCHplus.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$DIC_pred <- fitted(dic.TOCHplus)
norway$DIC_pred_res <- residuals(dic.TOCHplus)
dic.TOCHplus.r2 <- with(summary(dic.TOCHplus), 1 - deviance/null.deviance) %>% round(2)
dic.TOCHplus.aic <- AIC(dic.TOCHplus)

g1 <- ggplot(norway)+geom_point(aes(x=DIC,y=DIC_pred))+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",dic.TOCHplus.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=DIC_pred,y=DIC_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

norway$pCO2_calc <- with(norway, DIC_pred/(K0+K0*K1/Hplus+K0*K1*K2/(Hplus^2)))


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

*`r fig_nums("dic-tochplus", "Predicted vs fitted values, Standardized residuals vs fitted values,and measured (red) calculated (blue) pCO2 vs pH for DIC~TOC x Hplus")`*

```{r nlss-dic-tochplus}
nlss$dic_pred <- predict(dic.TOCHplus, newdata = nlss, type = "response")
nlss$pCO2_calc <- with(nlss, dic_pred/(K0+K0*K1/Hplus+K0*K1*K2/Hplus))

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_calc, col = "pCO2 from predicted DIC, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

*`r fig_nums("dic-tochplus-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*

```{r glm-pco2-TOChplus, fig.dim = c(10,8),results = T}

pco2.TOCHplus <- glm(formula = fCO2~TOC*Hplus+0+offset(fCO2.atm), data = norway, family = Gamma(link = "identity"))

pco2.TOCHplus.sum <- summary(pco2.TOCHplus)$coefficients %>% as.data.frame() 
pco2.TOCHplus.sp <- rownames(pco2.TOCHplus.sum)[which(pco2.TOCHplus.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.TOCHplus.sum <- pco2.TOCHplus.sum %>% format(scientific = T, digits = 2)

kable(pco2.TOCHplus.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$pCO2_pred <- fitted(pco2.TOCHplus)
norway$pCO2_pred_res <- residuals(pco2.TOCHplus)
pco2.TOCHplus.r2 <- with(summary(pco2.TOCHplus), 1 - deviance/null.deviance) %>% round(2)
pco2.TOCHplus.aic <- AIC(pco2.TOCHplus)

g1 <- ggplot(norway)+geom_point(aes(x=fCO2,y=pCO2_pred))+   labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.TOCHplus.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

*`r fig_nums("dic-tochplus", "Predicted vs fitted values, Standardized residuals vs fitted values,and measured (red) calculated (blue) pCO2 vs pH for DIC~TOC x Hplus")`*

```{r nlss-pco2-tochplus}

nlss$pCO2_pred <- predict(pco2.TOCHplus, newdata = nlss, type = "response")

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_pred, col = "Predicted pCO2, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")

```

*`r fig_nums("dic-tochplus-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*

## TA + TOC*Hplus

```{r glm-dic-tocHplus-ta, fig.dim = c(10,8),results = T}

dic.tocHplus.ta <- glm(formula = DIC~TOC*Hplus+TA, data = norway, family = Gamma(link = "identity"))
dic.tocHplus.ta.sum <- summary(dic.tocHplus.ta)$coefficients %>% as.data.frame() 
dic.tocHplus.ta.sp <- rownames(dic.tocHplus.ta.sum)[which(dic.tocHplus.ta.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
dic.tocHplus.ta.sum <- dic.tocHplus.ta.sum %>% format(scientific = T, digits = 2)

kable(dic.tocHplus.ta.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$DIC_pred <- fitted(dic.tocHplus.ta)
norway$DIC_pred_res <- residuals(dic.tocHplus.ta)
dic.tocHplus.ta.r2 <- with(summary(dic.tocHplus.ta), 1 - deviance/null.deviance) %>% round(2)
dic.tocHplus.ta.aic <- AIC(dic.tocHplus.ta)

g1 <- ggplot(norway)+geom_point(aes(x=DIC,y=DIC_pred))+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",dic.tocHplus.ta.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=DIC_pred,y=DIC_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

norway$pCO2_calc <- with(norway, DIC_pred/(K0+K0*K1/Hplus+K0*K1*K2/(Hplus^2)))


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

*`r fig_nums("dic-tochplus-ta", "Predicted vs fitted values, Standardized residuals vs fitted values,and measured (red) calculated (blue) pCO2 vs pH for DIC ~ TA + TOC x Hplus")`*

```{r nlss-dic-tochplus-ta}
nlss$dic_pred <- predict(dic.tocHplus.ta, newdata = nlss, type = "response")
nlss$pCO2_calc <- with(nlss, dic_pred/(K0+K0*K1/Hplus+K0*K1*K2/Hplus))

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_calc, col = "pCO2 from predicted DIC, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

*`r fig_nums("pco2-tochplus-ta-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*

```{r glm-pco2-tochplus-ta, fig.dim = c(10,8),results = T}

pco2.tocHplus.ta <- glm(formula = fCO2~TOC*Hplus+TA+0+offset(fCO2.atm), data = norway, family = Gamma(link = "identity"))

pco2.tocHplus.ta.sum <- summary(pco2.tocHplus.ta)$coefficients %>% as.data.frame() 
pco2.tocHplus.ta.sp <- rownames(pco2.tocHplus.ta.sum)[which(pco2.tocHplus.ta.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.tocHplus.ta.sum <- pco2.tocHplus.ta.sum %>% format(scientific = T, digits = 2)

kable(pco2.tocHplus.ta.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$pCO2_pred <- fitted(pco2.tocHplus.ta)
norway$pCO2_pred_res <- residuals(pco2.tocHplus.ta)
pco2.tocHplus.ta.r2 <- with(summary(pco2.tocHplus.ta), 1- deviance/null.deviance) %>% round(2)
pco2.tocHplus.ta.aic <- AIC(pco2.tocHplus.ta)

g1 <- ggplot(norway)+geom_point(aes(x=fCO2,y=pCO2_pred))+   labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.tocHplus.ta.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

*`r fig_nums("dic-tochplus-ta", "Predicted vs fitted values, Standardized residuals vs fitted values,and measured (red) calculated (blue) pCO2 vs pH for DIC~TOC x Hplus + TA")`*

```{r nlss-pco2-tochplus-ta}
nlss$pCO2_pred <- predict(pco2.tocHplus.ta, newdata = nlss, type = "response")

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_pred, col = "Predicted pCO2, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

*`r fig_nums("pco2-tochplus-ta-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*

## TOC + TA*Hplus

```{r glm-dic-toc-taHplus, fig.dim = c(10,8),results = T}

dic.toc.taHplus <- glm(formula = DIC~TOC+TA*Hplus, data = norway, family = Gamma(link = "identity"))

dic.toc.taHplus.sum <- summary(dic.toc.taHplus)$coefficients %>% as.data.frame() 
dic.toc.taHplus.sp <- rownames(dic.toc.taHplus.sum)[which(dic.toc.taHplus.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
dic.toc.taHplus.sum <- dic.toc.taHplus.sum %>% format(scientific = T, digits = 2)
kable(dic.toc.taHplus.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$DIC_pred <- fitted(dic.toc.taHplus)
norway$DIC_pred_res <- residuals(dic.toc.taHplus)
dic.toc.taHplus.r2 <- with(summary(dic.toc.taHplus), 1 - deviance/null.deviance) %>% round(2)
dic.toc.taHplus.aic <- AIC(dic.toc.taHplus)

g1 <- ggplot(norway)+geom_point(aes(x=DIC,y=DIC_pred))+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",dic.toc.taHplus.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=DIC_pred,y=DIC_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

norway$pCO2_calc <- with(norway, DIC_pred/(K0+K0*K1/Hplus+K0*K1*K2/(Hplus^2)))


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

*`r fig_nums("dic-ta", "Predicted vs fitted values, Standardized residuals vs fitted values,and measured (red) calculated (blue) pCO2 vs pH for DIC ~ TOC + TA x Hplus")`*

```{r nlss-dic-toc-tahplus}
nlss$dic_pred <- predict(dic.toc.taHplus, newdata = nlss, type = "response")
nlss$pCO2_calc <- with(nlss, dic_pred/(K0+K0*K1/Hplus+K0*K1*K2/Hplus))

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_calc, col = "pCO2 from predicted DIC, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

*`r fig_nums("dic-toc-tahplus-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*


```{r glm-pco2-toc-tahplus, fig.dim = c(10,8),results = T}

pco2.toc.taHplus <- glm(formula = fCO2~TOC+TA*Hplus+0+offset(fCO2.atm), data = norway, family = Gamma(link = "identity"))

pco2.toc.taHplus.sum <- summary(pco2.toc.taHplus)$coefficients %>% as.data.frame()
pco2.toc.taHplus.sp <- rownames(pco2.toc.taHplus.sum)[which(pco2.toc.taHplus.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.toc.taHplus.sum <- pco2.toc.taHplus.sum %>% format(scientific = T, digits = 2)

kable(pco2.toc.taHplus.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$pCO2_pred <- fitted(pco2.toc.taHplus)
norway$pCO2_pred_res <- residuals(pco2.toc.taHplus)
pco2.toc.taHplus.r2 <- with(summary(pco2.toc.taHplus), 1 - deviance/null.deviance) %>% round(2)
pco2.toc.taHplus.aic <- AIC(pco2.toc.taHplus)

g1 <- ggplot(norway)+geom_point(aes(x=fCO2,y=pCO2_pred))+   labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.toc.taHplus.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

*`r fig_nums("pco2.toc.taHplus", "Predicted vs fitted values, Standardized residuals vs fitted values,and measured (red) calculated (blue) pCO2 vs pH for pCO2~TOC + TA x Hplus")`*

```{r nlss-pco2-toc-taHplus}
nlss$pCO2_pred <- predict(pco2.toc.taHplus, newdata = nlss, type = "response")

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_pred, col = "Predicted pCO2, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")

```

*`r fig_nums("pco2-toc-tahplus-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*

## TOC + TA*invHplus

```{r glm-dic-toc-tainvhplus, fig.dim = c(10,8),results = T}

norway$invHplus <- with(norway, 1/Hplus)

dic.toc.tainvHplus <- glm(formula = DIC~TOC+TA*invHplus, data = norway, family = Gamma(link = "identity"))

dic.toc.tainvHplus.sum <- summary(dic.toc.tainvHplus)$coefficients %>% as.data.frame()
dic.toc.tainvHplus.sp <- rownames(dic.toc.tainvHplus.sum)[which(dic.toc.tainvHplus.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
dic.toc.tainvHplus.sum <- dic.toc.tainvHplus.sum %>% format(scientific = T, digits = 2)

kable(dic.toc.tainvHplus.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$DIC_pred <- fitted(dic.toc.tainvHplus)
norway$DIC_pred_res <- residuals(dic.toc.tainvHplus)
dic.toc.tainvHplus.r2 <- with(summary(dic.toc.tainvHplus), 1 - deviance/null.deviance) %>% round(2)
dic.toc.tainvHplus.aic <- AIC(dic.toc.tainvHplus)

g1 <- ggplot(norway)+geom_point(aes(x=DIC,y=DIC_pred))+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",dic.toc.tainvHplus.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=DIC_pred,y=DIC_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

norway$pCO2_calc <- with(norway, DIC_pred/(K0+K0*K1/Hplus+K0*K1*K2/(Hplus^2)))


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

*`r fig_nums("dic-toc-tainvHplus", "Predicted vs fitted values, Standardized residuals vs fitted values,and measured (red) calculated (blue) pCO2 vs pH for DIC~TOC + TA/hplus")`*

```{r nlss-dic-toc-tainvHplus}
nlss$dic_pred <- predict(dic.toc.tainvHplus, newdata = nlss, type = "response")
nlss$pCO2_calc <- with(nlss, dic_pred/(K0+K0*K1/Hplus+K0*K1*K2/Hplus))

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_calc, col = "pCO2 from predicted DIC, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

*`r fig_nums("dic-toc-tainvHplus-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*

```{r glm-pco2-toc-tainvhplus, fig.dim = c(10,8),results = T}

norway$invHplus <- with(norway, 1/Hplus)

pco2.toc.tainvHplus <- glm(formula = fCO2~TOC+TA*invHplus+0+offset(fCO2.atm), data = norway, family = Gamma(link = "identity"))

pco2.toc.tainvHplus.sum <- summary(pco2.toc.tainvHplus)$coefficients %>% as.data.frame() 
pco2.toc.tainvHplus.sp <- rownames(pco2.toc.tainvHplus.sum)[which(pco2.toc.tainvHplus.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.toc.tainvHplus.sum <- pco2.toc.tainvHplus.sum %>% format(scientific = T, digits = 2)

kable(pco2.toc.tainvHplus.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$pCO2_pred <- fitted(pco2.toc.tainvHplus)
norway$pCO2_pred_res <- residuals(pco2.toc.tainvHplus)
pco2.toc.tainvHplus.r2 <- with(summary(pco2.toc.tainvHplus), 1 - deviance / null.deviance) %>% round(2)
pco2.toc.tainvHplus.aic <- AIC(pco2.toc.tainvHplus)

g1 <- ggplot(norway)+geom_point(aes(x=fCO2,y=pCO2_pred))+   labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.toc.tainvHplus.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
   coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

*`r fig_nums("dic-ta", "Predicted vs fitted values, Standardized residuals vs fitted values,and measured (red) calculated (blue) pCO2 vs pH for DIC~TA")`

```{r nlss-pco2-toc-tainvhplus}

nlss$pCO2_pred <- predict(pco2.toc.tainvHplus, newdata = nlss, type = "response")

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_pred, col = "Predicted pCO2, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")

```

*`r fig_nums("pco2-toc-tainvHplus-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*

## TA + TOC*invHplus

```{r glm-dic-tocinvhplus-ta, fig.dim = c(10,8),results = T}

norway$invHplus <- with(norway, 1/Hplus)

dic.tocinvHplus.ta <- glm(formula = DIC~TOC*invHplus+TA, data = norway, family = Gamma(link = "identity"))

dic.tocinvHplus.ta.sum <- summary(dic.tocinvHplus.ta)$coefficients %>% as.data.frame() 
dic.tocinvHplus.ta.sp <- rownames(dic.tocinvHplus.ta.sum)[which(dic.tocinvHplus.ta.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
dic.tocinvHplus.ta.sum <- dic.tocinvHplus.ta.sum %>% format(scientific = T, digits = 2)

kable(dic.tocinvHplus.ta.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$DIC_pred <- fitted(dic.tocinvHplus.ta)
norway$DIC_pred_res <- residuals(dic.tocinvHplus.ta)
dic.tocinvHplus.ta.r2 <- with(summary(dic.tocinvHplus.ta), 1 - deviance/null.deviance) %>% round(2)
dic.tocinvHplus.ta.aic <- AIC(dic.tocinvHplus.ta)

g1 <- ggplot(norway)+geom_point(aes(x=DIC,y=DIC_pred))+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",dic.tocinvHplus.ta.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=DIC_pred,y=DIC_pred_res))+   
    coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()

norway$pCO2_calc <- with(norway, DIC_pred/(K0+K0*K1/Hplus+K0*K1*K2/(Hplus^2)))


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_calc, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3+labs(caption = ),nrow = 2,rel_heights = c(2,3))
```

*`r fig_nums("dic-tocinvHplus-ta", "Predicted vs fitted values, Standardized residuals vs fitted values,and measured (red) calculated (blue) pCO2 vs pH for DIC ~ TOC / Hplus + TA")`*


```{r nlss-dic-tocinvHplus-ta}
nlss$dic_pred <- predict(dic.tocinvHplus.ta, newdata = nlss, type = "response")
nlss$pCO2_calc <- with(nlss, dic_pred/(K0+K0*K1/Hplus+K0*K1*K2/Hplus))

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_calc, col = "pCO2 from predicted DIC, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")
```

*`r fig_nums("pco2-tocinvhplus-ta-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*

```{r glm-pco2-tocinvhplus-ta, fig.dim = c(10,8),results = T}

norway$invHplus <- with(norway, 1/Hplus)

pco2.tocinvHplus.ta <- glm(formula = fCO2~TOC*invHplus+TA+0+offset(fCO2.atm), data = norway, start = c(0,0,0,0), family = Gamma(link = "identity"))

pco2.tocinvHplus.ta.sum <- summary(pco2.tocinvHplus.ta)$coefficients %>% as.data.frame() 
pco2.tocinvHplus.ta.sp <- rownames(pco2.tocinvHplus.ta.sum)[which(pco2.tocinvHplus.ta.sum$`Pr(>|t|)` < 0.05)] %>% paste(collapse = ", ")
pco2.tocinvHplus.ta.sum <- pco2.tocinvHplus.ta.sum %>% format(scientific = T, digits = 2)
  

kable(pco2.tocinvHplus.ta.sum, digits = 2) %>% kable_styling(bootstrap_options = "bordered")

norway$pCO2_pred <- fitted(pco2.tocinvHplus.ta)
norway$pCO2_pred_res <- residuals(pco2.tocinvHplus.ta)
pco2.tocinvHplus.ta.r2 <- with(summary(pco2.tocinvHplus.ta), 1 - deviance/null.deviance) %>% round(2)
pco2.tocinvHplus.ta.aic <- AIC(pco2.tocinvHplus.ta)

g1 <- ggplot(norway)+geom_point(aes(x=fCO2,y=pCO2_pred))+   labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  labs(x = "Measured pCO2, atm", y = "Predicted pCO2, atm")+
  geom_abline(slope= 1, intercept = 0)+coord_trans(x="log10",y="log10")+
  annotate(x = 0.5e-3, y = 3e-3, geom = "label", label = paste("R2 = ",pco2.tocinvHplus.ta.r2, ""))+
    theme_minimal()

g2 <- ggplot(norway)+geom_point(aes(x=pCO2_pred,y=pCO2_pred_res))+
     coord_trans(x = "log10")+labs(x = "fitted", y = "Std Residuals")+
    theme_minimal()


g3 <- ggplot(norway,aes(x= pH))+geom_point(aes(y = pCO2_pred, col = "pCO2 from model"))+
  geom_point(aes(y = fCO2, col = "Measured pCO2"))+
  labs(y = "pCO2, atm", x = "pH", col = "")+
  scale_color_manual(values = c( "firebrick","dodgerblue3"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  theme(legend.position = "bottom")

plot_grid(ggarrange(g1,g2),g3,nrow = 2,rel_heights = c(2,3))
```

*`r fig_nums("pco2-tocinvHplus-ta", "Predicted vs fitted values, Standardized residuals vs fitted values,and measured (red) calculated (blue) pCO2 vs pH for pCO2 ~ TOC / Hplus + TA")`*

```{r nlss-pco2invHplus-ta}
nlss$pCO2_pred <- predict(pco2.tocinvHplus.ta, newdata = nlss, type = "response")

ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_pred, col = "Predicted pCO2, NLS"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")

```

*`r fig_nums("pco2-tocta-nls", "Predicted pCO2 in atm vs pH for the Northern Lake Survey")`*

## Summary of all models

*`r tab_nums("summary-models","Summary of DIC and pCO2 models")`*

```{r table-results,results = T}
kable(cbind(data.frame(Predictors = c("TA",
                                      "1/TA",
                                "TOC",
                                "TA + TOC",
                                "TA*TOC",
                                "TA*Hplus",
                                "TOC*Hplus",
                                "TA*Hplus + TOC", 
                                "TA + TOC*Hplus",
                                "TA/Hplus + TOC",
                                "TA + TOC/Hplus"),
                        R2 = c(pco2.ta.r2,
                              pco2.invTA.r2,
                              pco2.toc.r2,
                              pco2.toc.ta.r2,
                              pco2.tocta.r2,
                              pco2.taHplus.r2,
                              pco2.TOCHplus.r2,
                              pco2.toc.taHplus.r2,
                              pco2.tocHplus.ta.r2,
                              pco2.toc.tainvHplus.r2,
                              pco2.tocinvHplus.ta.r2),
                       AIC = c(pco2.ta.aic,
                              pco2.invTA.aic,
                              pco2.toc.aic,
                              pco2.toc.ta.aic,
                              pco2.tocta.aic,
                              pco2.taHplus.aic,
                              pco2.TOCHplus.aic,
                              pco2.toc.taHplus.aic,
                              pco2.tocHplus.ta.aic,
                              pco2.toc.tainvHplus.aic,
                              pco2.tocinvHplus.ta.aic),
                        significant  = c(pco2.ta.sp,
                                 pco2.invTA.sp,
                                 pco2.toc.sp,
                                 pco2.toc.ta.sp,
                                 pco2.tocta.sp,
                                 pco2.taHplus.sp,
                                 pco2.TOCHplus.sp,
                                 pco2.toc.taHplus.sp,
                                 pco2.tocHplus.ta.sp,
                                 pco2.toc.tainvHplus.sp,
                                 pco2.tocinvHplus.ta.sp)),
                data.frame(R2 = c(dic.ta.r2,
                                dic.invTA.r2,
                                dic.toc.r2,
                                dic.toc.ta.r2,
                                dic.tocta.r2,
                                dic.taHplus.r2,
                                dic.TOCHplus.r2,
                                dic.toc.taHplus.r2,
                                dic.tocHplus.ta.r2,
                                dic.toc.tainvHplus.r2,
                                dic.tocinvHplus.ta.r2),
                           AIC = c(dic.ta.aic,
                                dic.invTA.aic,
                                dic.toc.aic,
                                dic.toc.ta.aic,
                                dic.tocta.aic,
                                dic.taHplus.aic,
                                dic.TOCHplus.aic,
                                dic.toc.taHplus.aic,
                                dic.tocHplus.ta.aic,
                                dic.toc.tainvHplus.aic,
                                dic.tocinvHplus.ta.aic),
                      significant  = c(dic.ta.sp,
                                dic.invTA.sp,
                                dic.toc.sp,
                                dic.toc.ta.sp,
                                dic.tocta.sp,
                                dic.taHplus.sp,
                                dic.TOCHplus.sp,
                                dic.toc.taHplus.sp,
                                dic.tocHplus.ta.sp,
                                dic.toc.tainvHplus.sp,
                                dic.tocinvHplus.ta.sp))),
             digits = 2) %>% 
  add_header_above(c(" "= 1, "pCO2" = 3, "DIC" = 3),italic = T) %>%
  column_spec(column = c(2,4), bold = T) %>% 
  kable_styling(bootstrap_options = "bordered")
```

# Northern European Lakes Survey

## Boxplots

```{r compare-boxplots, fig.dim = c(10,10)}
g1 <- ggplot()+geom_boxplot(data = nlss, aes(x="TA\nNorthern European Lakes Survey, 1995", y=TA, col = "NLS_1995"))+
  geom_boxplot(data = norway, aes(x = "TA\n CBA (2019) and N112 (2004) surveys", y = TA, col = survey))+
  scale_color_manual(values = c("firebrick","orange","dodgerblue"))+
  labs(x = "", col = "",y = "Total alkalinity, eq/L")+
  theme_minimal(base_size = 15)+
  theme(legend.position = "bottom")

g2 <- ggplot()+geom_boxplot(data = nlss, aes(x="TOC\nNorthern European Lakes Survey, 1995", y=TOC, col = "NLS_1995"))+
  geom_boxplot(data = norway, aes(x = "TOC\n CBA (2019) and N112 (2004) surveys", y = TOC, col = survey))+
  scale_color_manual(values = c("firebrick","orange","dodgerblue"))+
  labs(x = "", col = "",y = "Total organic carbon, mol/L")+
  theme_minimal(base_size = 15)+
  theme(legend.position = "bottom")

g3 <- ggplot()+geom_boxplot(data = nlss, aes(x="pH\nNorthern European Lakes Survey, 1995", y=pH, col = "NLS_1995"))+
  geom_boxplot(data = norway, aes(x = "pH\n CBA (2019) and N112 (2004) surveys", y = pH, col = survey))+
  scale_color_manual(values = c("firebrick","orange","dodgerblue"))+
  labs(x = "", col = "",y = "pH")+
  theme_minimal(base_size = 15)+
  theme(legend.position = "bottom")

ggarrange(g1,g2,g3, common.legend = T, nrow = 3)
```

*`r fig_nums("boxplot-compare", "Comparison of the distribution of TA, TOC and pH in the CBA, N112 and NLS surveys")`*

```{r nls-pCO2-TA}
nlss$ta_CO3 <- with(nlss,(TA - OH + Hplus) / (Hplus/K2 +2)) # in mol/L
nlss$ta_HCO3 <- with(nlss, ta_CO3*Hplus/K2)
nlss$ta_H2CO3 <- with(nlss, ta_HCO3*Hplus/K1)
nlss$pCO2_ta <- with(nlss,ta_H2CO3/K0)

g1 <- ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_ta), alpha = 0.5, col = "firebrick")+
  labs(x = "pH", y = "pCO2 from TA, atm")+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  facet_zoom(y = pCO2_ta > 0, zoom.size = 1)+
  theme_bw(base_size = 15)

print(g1)
```
*`r fig_nums("pCO2-from-TA-NLS", "pCO2 calculated from TA in the NLS surveys")`*

```{r nls-pCO2-toc, fid.dim = c(15,13)}

nlss$pCO2_toc <- predict(pco2.toc, newdata = nlss, type = "response")

g1 <- ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_ta, col = "pCO2 from carbonate equilibrium"), alpha = 0.5)+
  geom_point(aes(y = pCO2_toc, col = "pCO2 modelled with TOC"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "")+
  scale_color_manual(values = c("firebrick","dodgerblue"))+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")+
  facet_zoom(y = pCO2_ta > 0, zoom.size = 2)


g2 <- ggplot(data = nlss, aes(x = pH))+
  geom_point(aes(y = pCO2_ta, col = "pCO2 from carbonate equilibrium"), alpha = 0.5)+
  geom_point(aes(y = pCO2_toc, col = "pCO2 modelled with TOC"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995, lty = 2)+
  labs(x = "pH", col = "", y = "pCO2, atm")+
  scale_color_manual(values = c("firebrick","dodgerblue"))+
  ylim(0,0.006)+
  theme_bw(base_size = 15)+
  theme(legend.position = "top")

ggarrange(g2,g1, common.legend = T)
```
*`r fig_nums("pCO2-TA-TOC-NLS", "pCO2 calculated from TA, compared to pCO2 predicted with TOC, for the NLS surveys")`*

```{r map-pco2-nlss}
ggplot(nlss)+geom_point(aes(x=long, y = lat, col = pCO2_toc*1e6))+
  borders(regions = c("Norway","Sweden","Finland"))+ylim(55,72)+xlim(4,32)+
  scale_fill_continuous_divergingx(palette = "RdYlBu", aesthetics = c("fill","col"), mid = 1000, rev = T)+
  labs(col="pCO2, uatm")+
  theme_void()
```
# Evasion rate of CO2

## Theory

Wind speed <https://wcrp-cmip.github.io/CMIP6_CVs/docs/CMIP6_institution_id.html>

Data downloaded from Copernicus <https://cds.climate.copernicus.eu/cdsapp#!/dataset/derived-near-surface-meteorological-variables?tab=overview>

See part 1

Theory from @Hastie2018

$$FCO_2 = A_{lake} \times k \times \Delta CO_2$$

$FCO_2$ in mol/day, $A_{lake}$ = lake area in m2, $\Delta CO_2$ in mol/m3 is the difference between water and air pCO2.

According to @Vachon2013:

$$k_{600} = 2.51 + 1.48 \times U_{10} + 0.39 \times U_{10} \times log_{10} (A_{lake})$$

with $k_600$ in $cm/h$, $A$ in km2 and $U_{10}$ in m/s

Another widely used equation for k600 was introduced by @Cole1998 and only uses the wind speed:

$$ k_{600} = 2.07 + 0.215 \times U_{10}^{1.7}$$


$k_{CO_2}$ has to be adjusted for temperature [@Crusius2003] via the Schmidt number:

$$k_{600} = k_{CO_2}\times \left( \frac{600}{Sc_{CO_2}} \right) ^{-n}$$

The Schmidt $Sc_{CO_2}$ number is calculated from @Wanninkhof2014:

$$S_c = 1923.6 - 125.06 \times T + 4.3773 \times T^2 - 0.085681 \times T^3$$


## Compute ECO2

We calculate the gas transfer coefficient kCO2, based on the normalised gas transfer coefficient k600 and the Schmidt number. 

```{r norway-schmidt}
norway$pCO2_pred <- fitted(pco2.toc)
norway$pCO2_pred_res <- residuals(pco2.toc)

norway$Sc <- with(norway, 1923.6-125.06*temp_c+4.3733*temp_c^2-0.086781*temp_c^3) #@wanningkhof

norway$n <- NA
for(i in 1:length(norway$n)){
  if(norway$nws_m.s[i] < 3.7 & is.na(norway$nws_m.s[i]) == F){
    norway$n[i] = 2/3
  }else if(norway$nws_m.s[i] > 3.7 & is.na(norway$nws_m.s[i]) == F){
    norway$n[i] = 1/2
  } else if(is.na(norway$nws_m.s[i]) == T){
    norway$n[i] = NA
  }
} # adjusted n from Vachon


norway$k600 <- with(norway, 2.51+1.48*nws_m.s+0.39*nws_m.s*log10(lake.area)) # lake.area already in km2, in cm/h
                    
norway$kCO2 <- with(norway, k600*(600/Sc)^(n))*24*1e-2 # from cm/h to m/day

norway$k600_low <- with(norway, 2.07+0.25*nws_m.s^1.7) # lake area in km2. Cole & Caraco 1998
                    
norway$kCO2_low <- with(norway, k600_low*(600/Sc)^(n))*24*1e-2

norway$ECO2 <- with(norway, kCO2*(fCO2-fCO2.atm)*K0*1e3 * 12.011) # in gC/m2/day

norway$ECO2_low <- with(norway, kCO2_low*(fCO2-fCO2.atm)*K0*1e3 * 12.011) # in gC/m2/day

norway$ECO2_toc <- with(norway, kCO2*(pCO2_pred-fCO2.atm)*K0*1e3 * 12.011) # in gC/m2/day

norway$ECO2_toc_low <- with(norway, kCO2_low*(pCO2_pred-fCO2.atm)*K0*1e3 * 12.011) # in gC/m2/day


norway$ECO2_ta <- with(norway, kCO2*(ta_fCO2-fCO2.atm)*K0*1e3 * 12.011) # in gC/m2/day

norway$ECO2_ta_low <- with(norway, kCO2_low*(ta_fCO2-fCO2.atm)*K0*1e3 * 12.011) # in gC/m2/day
```

```{r a-lot-of-plots}

ggplot(norway, aes(x = TOC * 12.011 / 1e-3)) + geom_point(aes(y = fCO2*1e-6, col = "Measured"), alpha = 0.8, shape = 1) +
  geom_point(aes(y = pCO2_pred*1e-6, col = "Predicted from TOC"), alpha = 0.8, shape = 1) +
  geom_point(aes(y = ta_fCO2*1e-6, col = "With TA as DIC"), alpha = 0.8, shape = 1) +
  labs(x = "TOC in mg/L", y = "pCO2 in uatm")+
  facet_zoom(x = TOC < 0.002, y = fCO2 < 4.3e-4)+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange"))+
  theme_bw()+
  theme(legend.position = "bottom")


ggplot(norway, aes(x = fCO2*1e-6))+geom_point(aes(y = ta_fCO2*1e-6, col = "Calculated from TA"))+
  geom_point(aes(y = pCO2_pred*1e-6, col = "Predicted from TOC"))+
    labs(x = "Measured pCO2 in uatm", y = "pCO2 in uatm")+
  geom_abline(slope = 1, intercept = 0)+
#  facet_zoom(x = TOC < 0.002, y = fCO2 < 4.3e-4)+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange"))+
  theme_bw()+
  theme(legend.position = "bottom")

 ggplot(norway, aes(x = lake.area)) + geom_point(aes(y = k600, col = "Vachon and Prairie"))+
          geom_point(aes(y = k600_low, col = "Cole and Caraco")) + 
          scale_x_continuous(trans = "log10") + theme_bw()
 
  ggplot(norway, aes(x = lake.area)) + geom_point(aes(y = ECO2, col = "Vachon and Prairie (including lake area)"), alpha = 0.5)+
          geom_point(aes(y = ECO2_low, col = "Cole and Caraco (without lake area)"), alpha = 0.5) + 
          scale_color_manual(values = c("dodgerblue3","firebrick"))+
    labs(x = "Lare area in km2", y = "ECO2 in gC/m/day", col = "k600 calculated with")+
          scale_x_continuous(trans = "log10") + theme_bw() +
    theme(legend.position = "bottom")
  
ggplot(norway)+geom_point(aes(x=fCO2, y = pCO2_pred))  

ggplot(norway, aes(x = fCO2*1e-6)) + geom_point(aes(y = pCO2_pred*1e-6, col = "Predicted from TOC"), alpha = 0.8, shape = 1) +
  geom_point(aes(y = ta_fCO2*1e-6, col = "With TA as DIC"), alpha = 0.8, shape = 1) +
  geom_abline(slope = 1, intercept = 0)+
  labs(x = "TOC in mg/L", y = "pCO2 in uatm")+
  facet_grid(col = vars(survey))+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange"))+
  theme_bw()+
  theme(legend.position = "bottom")

ggplot()+ geom_point(data = subset(norway, TOC < 30/12.011*1e-3), aes(x = fCO2*1e6, y = pCO2_pred*1e6, col = "Predicted from TOC"), alpha = 0.8, shape = 1) +
  geom_point(data = subset(norway, TOC > 30/12.011*1e-3), aes(x = fCO2*1e6, y = ta_fCO2*1e6, col = "With TA as DIC"), alpha = 0.8, shape = 1) +
  geom_abline(slope = 1, intercept = 0)+
  labs(x = "Measured pC02 in uatm", y = "Predicted pCO2 in uatm")+
  facet_zoom(x = fCO2 < 2000e-6, y = ta_fCO2 < 5000e-6)+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange"))+
  theme_bw()+
  theme(legend.position = "bottom")

  ggplot(norway)+ geom_point(aes(x = fCO2*1e6, y = pCO2_pred*1e6, col = "Predicted from TOC"), alpha = 0.8, shape = 1) +
  geom_point(aes(x = fCO2*1e6, y = ta_fCO2*1e6, col = "Calculated from TA"), alpha = 0.8, shape = 1) +
  geom_abline(slope = 1, intercept = 0)+
  geom_text(aes(x = 6000, y = 22000, label = paste("r = ", round(cor(pCO2_pred, fCO2, use = "pairwise.complete"),2)), col = "Predicted from TOC"))+
    geom_text(aes(x = 6000, y = 20000, label = paste("r = ", round(cor(ta_fCO2, fCO2, use = "pairwise.complete"),2)), col = "Calculated from TA"))+
  labs(x = "Measured pC02 in uatm", y = "Predicted pCO2 in uatm")+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange"))+
  theme_bw()+
  theme(legend.position = "bottom")
  
ggplot(subset(norway, TOC < 30 / 12.011 * 1e-3))+ geom_point(aes(x = fCO2*1e6, y = pCO2_pred*1e6, col = "Predicted from TOC"), alpha = 0.8, shape = 1) +
  geom_point(aes(x = fCO2*1e6, y = ta_fCO2*1e6, col = "Calculated from TA"), alpha = 0.8, shape = 1) +
  geom_abline(slope = 1, intercept = 0)+
  geom_text(aes(x = 6000, y = 22000, label = paste("r = ", round(cor(pCO2_pred, fCO2, use = "pairwise.complete"),2)), col = "Predicted from TOC"))+
    geom_text(aes(x = 6000, y = 20000, label = paste("r = ", round(cor(ta_fCO2, fCO2, use = "pairwise.complete"),2)), col = "Calculated from TA"))+
  labs(x = "Measured pC02 in uatm", y = "Predicted pCO2 in uatm")+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange"))+
  theme_bw()+
  theme(legend.position = "bottom")

ggplot(subset(norway, TOC < 10 / 12.011 * 1e-3))+ geom_point(aes(x = fCO2*1e6, y = pCO2_pred*1e6, col = "Predicted from TOC"), alpha = 0.8, shape = 1) +
  geom_point(aes(x = fCO2*1e6, y = ta_fCO2*1e6, col = "Calculated from TA"), alpha = 0.8, shape = 1) +
  geom_abline(slope = 1, intercept = 0)+
  geom_text(aes(x = 2000, y = 22000, label = paste("r = ", round(cor(pCO2_pred, fCO2, use = "pairwise.complete"),2)), col = "Predicted from TOC"))+
    geom_text(aes(x = 2000, y = 20000, label = paste("r = ", round(cor(ta_fCO2, fCO2, use = "pairwise.complete"),2)), col = "Calculated from TA"))+
  labs(x = "Measured pC02 in uatm", y = "Predicted pCO2 in uatm")+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange"))+
  theme_bw()+
  theme(legend.position = "bottom")

ggplot(subset(norway, TOC > 20 / 12.011 * 1e-3))+ geom_point(aes(x = fCO2*1e6, y = pCO2_pred*1e6, col = "Predicted from TOC"), alpha = 0.8, shape = 1) +
  geom_point(aes(x = fCO2*1e6, y = ta_fCO2*1e6, col = "Calculated from TA"), alpha = 0.8, shape = 1) +
  geom_abline(slope = 1, intercept = 0)+
  geom_text(aes(x = 2000, y = 22000, label = paste("r = ", round(cor(pCO2_pred, fCO2, use = "pairwise.complete", method = "spearman"),2)), col = "Predicted from TOC"))+
    geom_text(aes(x = 2000, y = 20000, label = paste("r = ", round(cor(ta_fCO2, fCO2, use = "pairwise.complete"),2)), col = "Calculated from TA"))+
  labs(x = "Measured pC02 in uatm", y = "Predicted pCO2 in uatm", title = "TOC > 25 mg/L, spearman")+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange"))+
  theme_bw()+
  theme(legend.position = "bottom")


ggplot(subset(norway, pH < 5.4))+ geom_point(aes(x = fCO2*1e6, y = pCO2_pred*1e6, col = "Predicted from TOC"), alpha = 0.8, shape = 1) +
  geom_point(aes(x = fCO2*1e6, y = ta_fCO2*1e6, col = "Calculated from TA"), alpha = 0.8, shape = 1) +
  geom_abline(slope = 1, intercept = 0)+
  geom_text(aes(x = 2500, y = 20000, label = paste("r = ", round(cor(pCO2_pred, fCO2, use = "pairwise.complete"),2)), col = "Predicted from TOC"))+
    geom_text(aes(x = 2500, y = 22000, label = paste("r = ", round(cor(ta_fCO2, fCO2, use = "pairwise.complete"),2)), col = "Calculated from TA"))+
  labs(x = "Measured pC02 in uatm", y = "Predicted pCO2 in uatm", title = "pH < 5.4")+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange"))+
  theme_bw()+
  theme(legend.position = "bottom")

ggplot(subset(norway, pH > 5.4))+ geom_point(aes(x = fCO2*1e6, y = pCO2_pred*1e6, col = "Predicted from TOC"), alpha = 0.8, shape = 1) +
  geom_point(aes(x = fCO2*1e6, y = ta_fCO2*1e6, col = "Calculated from TA"), alpha = 0.8, shape = 1) +
  geom_abline(slope = 1, intercept = 0)+
  geom_text(aes(x = 5000, y = 10000, label = paste("r = ", round(cor(pCO2_pred, fCO2, use = "pairwise.complete"),2)), col = "Predicted from TOC"))+
    geom_text(aes(x = 5000, y = 12000, label = paste("r = ", round(cor(ta_fCO2, fCO2, use = "pairwise.complete"),2)), col = "Calculated from TA"))+
  labs(x = "Measured pC02 in uatm", y = "Predicted pCO2 in uatm", title = "pH > 5.4")+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange"))+
  theme_bw()+
  theme(legend.position = "bottom")


ggplot(subset(norway, pH > 5.4 & TOC < 0.004))+ geom_point(aes(x = fCO2*1e6, y = pCO2_pred*1e6, col = "Predicted from TOC"), alpha = 0.8, shape = 1) +
  geom_point(aes(x = fCO2*1e6, y = ta_fCO2*1e6, col = "Calculated from TA"), alpha = 0.8, shape = 1) +
  geom_abline(slope = 1, intercept = 0)+
  geom_text(aes(x = 5000, y = 10000, label = paste("r = ", round(cor(pCO2_pred, fCO2, use = "pairwise.complete"),2)), col = "Predicted from TOC"))+
    geom_text(aes(x = 5000, y = 12000, label = paste("r = ", round(cor(ta_fCO2, fCO2, use = "pairwise.complete"),2)), col = "Calculated from TA"))+
  labs(x = "Measured pC02 in uatm", y = "Predicted pCO2 in uatm", title = "pH > 5.4 & TOC < 48 mgC/L")+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange"))+
  theme_bw()+
  theme(legend.position = "bottom")

ggplot(subset(norway, pH > 5.4 & TOC < 0.0025))+ geom_point(aes(x = fCO2*1e6, y = pCO2_pred*1e6, col = "Predicted from TOC"), alpha = 0.8, shape = 1) +
  geom_point(aes(x = fCO2*1e6, y = ta_fCO2*1e6, col = "Calculated from TA"), alpha = 0.8, shape = 1) +
  geom_abline(slope = 1, intercept = 0)+
  geom_text(aes(x = 5000, y = 10000, label = paste("r = ", round(cor(pCO2_pred, fCO2, use = "pairwise.complete"),2)), col = "Predicted from TOC"))+
    geom_text(aes(x = 5000, y = 12000, label = paste("r = ", round(cor(ta_fCO2, fCO2, use = "pairwise.complete"),2)), col = "Calculated from TA"))+
  labs(x = "Measured pC02 in uatm", y = "Predicted pCO2 in uatm", title = "pH > 5.4 & TOC < 30 mgC/L")+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange"))+
  theme_bw()+
  theme(legend.position = "bottom")

ggplot(subset(norway, survey == "CBA_2019"))+ geom_point(aes(x = fCO2*1e6, y = pCO2_pred*1e6, col = "Predicted from TOC"), alpha = 0.8, shape = 1) +
  geom_point(aes(x = fCO2*1e6, y = ta_fCO2*1e6, col = "Calculated from TA"), alpha = 0.8, shape = 1) +
  geom_abline(slope = 1, intercept = 0)+
  geom_text(aes(x = 5000, y = 10000, label = paste("r = ", round(cor(pCO2_pred, fCO2, use = "everything"),2)), col = "Predicted from TOC"))+
    geom_text(aes(x = 5000, y = 12000, label = paste("r = ", round(cor(ta_fCO2, fCO2, use = "everything"),2)), col = "Calculated from TA"))+
  labs(x = "Measured pC02 in uatm", y = "Predicted pCO2 in uatm", title = "CBA_2019, pearson correlation coefficient")+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange"))+
  theme_bw()+
  theme(legend.position = "bottom")

ggplot(subset(norway, survey == "N112_2004"))+ geom_point(aes(x = fCO2*1e6, y = pCO2_pred*1e6, col = "Predicted from TOC"), alpha = 0.8, shape = 1) +
  geom_point(aes(x = fCO2*1e6, y = ta_fCO2*1e6, col = "Calculated from TA"), alpha = 0.8, shape = 1) +
  geom_abline(slope = 1, intercept = 0)+
  geom_text(aes(x = 2000, y = 10000, label = paste("r = ", round(cor(pCO2_pred, fCO2, use = "pairwise.complete"),2)), col = "Predicted from TOC"))+
    geom_text(aes(x = 2000, y = 12000, label = paste("r = ", round(cor(ta_fCO2, fCO2, use = "pairwise.complete"),2)), col = "Calculated from TA"))+
  labs(x = "Measured pC02 in uatm", y = "Predicted pCO2 in uatm", title = "N112_2004")+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange"))+
  theme_bw()+
  theme(legend.position = "bottom")
  

ggplot(subset(norway, survey == "CBA_2019" & pH < 5.4))+ 
  geom_point(aes(x = fCO2*1e6, y = pCO2_pred*1e6, col = "Predicted from TOC"), alpha = 0.8, shape = 1) +
  geom_point(aes(x = fCO2*1e6, y = ta_fCO2*1e6, col = "Calculated from TA"), alpha = 0.8, shape = 1) +
  geom_abline(slope = 1, intercept = 0)+
  geom_text(aes(x = 1750, y = 10000, label = paste("r = ", round(cor(pCO2_pred, fCO2, use = "pairwise.complete"),2)), col = "Predicted from TOC"))+
  geom_text(aes(x = 1750, y = 12000, label = paste("r = ", round(cor(ta_fCO2, fCO2, use = "pairwise.complete"),2)), col = "Calculated from TA"))+
  labs(x = "Measured pC02 in uatm", y = "Predicted pCO2 in uatm", title = "CBA_2019 & pH < 5.4")+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange"))+
  theme_bw()+
  theme(legend.position = "bottom")

ggplot(subset(norway, survey == "CBA_2019"))+ 
  geom_point(aes(x = fCO2*1e6, y = pCO2_pred*1e6, col = "Predicted from TOC"), alpha = 0.8, shape = 1) +
  geom_point(aes(x = fCO2*1e6, y = ta_fCO2*1e6, col = "Calculated from TA"), alpha = 0.8, shape = 1) +
  geom_abline(slope = 1, intercept = 0)+
  geom_text(aes(x = 1750, y = 10000, label = paste("r = ", round(cor(pCO2_pred, fCO2, use = "pairwise.complete", method = "spearman"),2)), col = "Predicted from TOC"))+
  geom_text(aes(x = 1750, y = 12000, label = paste("r = ", round(cor(ta_fCO2, fCO2, use = "pairwise.complete", method = "spearman"),2)), col = "Calculated from TA"))+
  labs(x = "Measured pC02 in uatm", y = "Predicted pCO2 in uatm", title = "CBA_2019, spearman correlation coefficient")+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange"))+
  theme_bw()+
  theme(legend.position = "bottom")

ggplot(subset(norway, survey == "N112_2004"))+ 
  geom_point(aes(x = fCO2*1e6, y = pCO2_pred*1e6, col = "Predicted from TOC"), alpha = 0.8, shape = 1) +
  geom_point(aes(x = fCO2*1e6, y = ta_fCO2*1e6, col = "Calculated from TA"), alpha = 0.8, shape = 1) +
  geom_abline(slope = 1, intercept = 0)+
  geom_text(aes(x = 1750, y = 10000, label = paste("r = ", round(cor(pCO2_pred, fCO2, use = "pairwise.complete", method = "spearman"),2)), col = "Predicted from TOC"))+
  geom_text(aes(x = 1750, y = 12000, label = paste("r = ", round(cor(ta_fCO2, fCO2, use = "pairwise.complete", method = "spearman"),2)), col = "Calculated from TA"))+
  labs(x = "Measured pC02 in uatm", y = "Predicted pCO2 in uatm", title = "N112_2004")+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange"))+
  theme_bw()+
  theme(legend.position = "bottom")

ggplot(norway)+ 
  geom_point(aes(x = fCO2*1e6, y = pCO2_pred*1e6, col = "Predicted from TOC"), alpha = 0.8, shape = 1) +
  geom_point(aes(x = fCO2*1e6, y = ta_fCO2*1e6, col = "Calculated from TA"), alpha = 0.8, shape = 1) +
  geom_abline(slope = 1, intercept = 0, linetype = 3)+
  geom_smooth(aes(x = fCO2*1e6, y = pCO2_pred*1e6, col = survey, group = survey))+
  geom_text(aes(x = 1750, y = 10000, label = paste("r = ", round(cor(pCO2_pred, fCO2, use = "pairwise.complete", method = "pearson"),2)), col = "Predicted from TOC"))+
  geom_text(aes(x = 1750, y = 12000, label = paste("r = ", round(cor(ta_fCO2, fCO2, use = "pairwise.complete", method = "pearson"),2)), col = "Calculated from TA"))+
  labs(x = "Measured pC02 in uatm", y = "Predicted pCO2 in uatm", title = "")+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange","pink"))+
  theme_bw()+
  theme(legend.position = "bottom")

ggplot()+geom_point(data = subset(norway, pH < 5.4), aes(x = fCO2, y = pCO2_pred, col = "pH < 5.4 : predicted with TOC"))+
  geom_point(data = subset(norway, TOC > 30 / 12.011 * 1e-3), aes(x = fCO2, y = ta_fCO2, col = "TOC > 25 : predicted with TA"))+
   labs(x = "Measured pC02 ", y = "Predicted pCO2", title = "")+
  geom_abline(slope = 1, intercept = 0, linetype = 3)+
  geom_hline(yintercept = fCO2.atm.2004)+
    geom_hline(yintercept = fCO2.atm.2019)+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange","pink"))+
  theme_bw()+
  theme(legend.position = "bottom")

ggplot(norway, aes(x = TOC * 12.011 /1e-3))+geom_point(aes(y = (pCO2_pred-fCO2)*1e6, col = "Diff TOC predicted - measured"), alpha = 0.5)+
  geom_point(aes(y = (ta_fCO2-fCO2)*1e6, col = "Diff TA predicted - measured"), alpha = 0.5)+
 labs(x = "TOC in mg/L", y = "Difference predicted - measured pCO2, uatm", title = "")+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange","pink"))+
  theme_bw()+
  theme(legend.position = "bottom")

ggplot(subset(norway, pH < 5.4), aes(x = TOC * 12.011 /1e-3))+geom_point(aes(y = (pCO2_pred-fCO2)*1e6, col = "Diff TOC predicted - measured"), alpha = 0.5)+
  geom_point(aes(y = (ta_fCO2-fCO2)*1e6, col = "Diff TA predicted - measured"), alpha = 0.5)+
 labs(x = "TOC in mg/L", y = "Difference predicted - measured pCO2, uatm", title = "")+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange","pink"))+
  theme_bw()+
  theme(legend.position = "bottom")

ggplot(subset(norway, TOC > 15 / 12.011 * 1e-3), aes(x = TOC * 12.011 /1e-3))+geom_point(aes(y = (pCO2_pred-fCO2)*1e6, col = "Diff TOC predicted - measured"), alpha = 0.5)+
  geom_point(aes(y = (ta_fCO2-fCO2)*1e6, col = "Diff TA predicted - measured"), alpha = 0.5)+
 labs(x = "TOC in mg/L", y = "Difference predicted - measured pCO2, uatm", title = "")+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange","pink"))+
  theme_bw()+
  theme(legend.position = "bottom")


ggarrange(
  plotlist = list(
ggplot(subset(norway, survey == "CBA_2019"))+geom_density(aes(x = ECO2, fill = "High estimate, measured"), alpha = 0.3, col = NA)+
  geom_density(aes(x=ECO2_toc, fill = "High estimate, TOC"), alpha = 0.3, col = NA) +
  geom_vline(aes(xintercept = median(subset(norway, survey == "CBA_2019")$ECO2), col = "High estimate, measured", linetype = "median"))+
  geom_vline(aes(xintercept = mean(subset(norway, survey == "CBA_2019")$ECO2), col = "High estimate, measured", linetype = "mean"))+
  geom_vline(aes(xintercept = median(subset(norway, survey == "CBA_2019")$ECO2_toc), col = "High estimate, TOC", linetype = "median"))+
  geom_vline(aes(xintercept = mean(subset(norway, survey == "CBA_2019")$ECO2_toc), col = "High estimate, TOC", linetype = "mean"))+
 scale_color_manual(values = c("dodgerblue3","firebrick","dodgerblue3","firebrick"))+
   scale_fill_manual(values = c("dodgerblue3","firebrick"))+
  labs(x = "ECO2 in gC/m2/day", col = "",linetype = "", title = "CBA, 2019", fill = "")+
  theme_minimal()
,
ggplot(subset(norway, survey == "N112_2004"))+geom_density(aes(x = ECO2, fill = "High estimate, measured"), alpha = 0.3, col = NA)+
 geom_density(aes(x=ECO2_toc, fill = "High estimate, TOC"), alpha = 0.3, col = NA) +
  geom_vline(aes(xintercept = median(subset(norway, survey == "N112_2004")$ECO2), col = "High estimate, measured", linetype = "median"))+
  geom_vline(aes(xintercept = mean(subset(norway, survey == "N112_2004")$ECO2), col = "High estimate, measured", linetype = "mean"))+
    geom_vline(aes(xintercept = median(subset(norway, survey == "N112_2004")$ECO2_toc), col = "High estimate, TOC", linetype = "median"))+
  geom_vline(aes(xintercept = mean(subset(norway, survey == "N112_2004")$ECO2_toc), col = "High estimate, TOC", linetype = "mean"))+
  scale_color_manual(values = c("dodgerblue3","firebrick","dodgerblue3","firebrick"))+
   scale_fill_manual(values = c("dodgerblue3","firebrick"))+
  labs(x = "ECO2 in gC/m2/day", col = "", linetype = "", title = "N112, 2004", fill = "")+
  theme_minimal()
),
  common.legend = T, legend = "bottom")

ggarrange(
  plotlist = list(
ggplot(subset(norway, survey == "CBA_2019"))+geom_density(aes(x = ECO2_low, fill = "Low estimate, measured"), alpha = 0.3, col = NA)+
  geom_density(aes(x=ECO2_toc_low, fill = "Low estimate, TOC"), alpha = 0.3, col = NA) +
  geom_vline(aes(xintercept = median(subset(norway, survey == "CBA_2019")$ECO2_low), col = "Low estimate, measured", linetype = "median"))+
  geom_vline(aes(xintercept = mean(subset(norway, survey == "CBA_2019")$ECO2_low), col = "Low estimate, measured", linetype = "mean"))+
  geom_vline(aes(xintercept = median(subset(norway, survey == "CBA_2019")$ECO2_toc_low), col = "Low estimate, TOC", linetype = "median"))+
  geom_vline(aes(xintercept = mean(subset(norway, survey == "CBA_2019")$ECO2_toc_low), col = "Low estimate, TOC", linetype = "mean"))+
 scale_color_manual(values = c("dodgerblue3","firebrick","dodgerblue3","firebrick"))+
   scale_fill_manual(values = c("dodgerblue3","firebrick"))+
  labs(x = "ECO2 in gC/m2/day", col = "",linetype = "", title = "CBA, 2019", fill = "")+
  theme_minimal()
,
ggplot(subset(norway, survey == "N112_2004"))+geom_density(aes(x = ECO2_low, fill = "Low estimate, measured"), alpha = 0.3, col = NA)+
 geom_density(aes(x=ECO2_toc_low, fill = "Low estimate, TOC"), alpha = 0.3, col = NA) +
  geom_vline(aes(xintercept = median(subset(norway, survey == "N112_2004")$ECO2_low), col = "Low estimate, measured", linetype = "median"))+
  geom_vline(aes(xintercept = mean(subset(norway, survey == "N112_2004")$ECO2_low), col = "Low estimate, measured", linetype = "mean"))+
    geom_vline(aes(xintercept = median(subset(norway, survey == "N112_2004")$ECO2_toc_low), col = "Low estimate, TOC", linetype = "median"))+
  geom_vline(aes(xintercept = mean(subset(norway, survey == "N112_2004")$ECO2_toc_low), col = "Low estimate, TOC", linetype = "mean"))+
  scale_color_manual(values = c("dodgerblue3","firebrick","dodgerblue3","firebrick"))+
   scale_fill_manual(values = c("dodgerblue3","firebrick"))+
  labs(x = "ECO2 in gC/m2/day", col = "", linetype = "", title = "N112, 2004", fill = "")+
  theme_minimal()
),
  common.legend = T, legend = "bottom")

 
```

```{r NLSS-schmidt-number}

nlss$Sc <- with(nlss, 1923.6-125.06*temp_c+4.3733*temp_c^2-0.086781*temp_c^3) #@wanningkhof

nlss$n <- NA
for(i in 1:length(nlss$n)){
  if(nlss$nws_m.s[i] < 3.7 & is.na(nlss$nws_m.s[i]) == F){
    nlss$n[i] = 2/3
  }else if(nlss$nws_m.s[i] > 3.7 & is.na(nlss$nws_m.s[i]) == F){
    nlss$n[i] = 1/2
  } else if(is.na(nlss$nws_m.s[i]) == T){
    nlss$n[i] = NA
  }
}


nlss$k600 <- with(nlss, 2.51+1.48*nws_m.s+0.39*nws_m.s*log10(lake.area)) # lake area in km2
                    
nlss$kCO2 <- with(nlss, k600*(600/Sc)^(n))*24*1e-2

nlss$k600_low <- with(nlss, 2.07+0.25*nws_m.s^1.7) # lake area in km2. Cole & Caraco 1998
nlss$kCO2_low <- with(nlss, k600_low*(600/Sc)^(n))*24*1e-2

nlss$ECO2_toc <- with(nlss, kCO2*(pCO2_toc-fCO2.atm)*K0*1e3 * 12.011) # in gC/m2/day
nlss$ECO2_toc_low <- with(nlss, kCO2_low*(pCO2_toc-fCO2.atm)*K0*1e3 * 12.011)

nlss$ECO2_ta <- with(nlss, kCO2*(pCO2_ta-fCO2.atm)*K0*1e3 * 12.011) # in gC/m2/day
nlss$ECO2_ta_low <- with(nlss, kCO2_low*(pCO2_ta-fCO2.atm)*K0*1e3 * 12.011) # in gC/m2/day


  ggplot(nlss, aes(x = lake.area)) + geom_point(aes(y = ECO2_toc, col = "Vachon and Prairie (including lake area)"), alpha = 0.5)+
          geom_point(aes(y = ECO2_toc_low, col = "Cole and Caraco (without lake area)"), alpha = 0.5) + 
          scale_color_manual(values = c("dodgerblue3","firebrick"))+
    labs(x = "Lare area in km2", y = "ECO2 in gC/m/day", col = "k600 calculated with")+
          scale_x_continuous(trans = "log10") + theme_bw() +
    theme(legend.position = "bottom")

  
```

## Compare ECO2 from TOC and ECO2 from TA
 
Comparison of the ECO2 obtained by calculation pCO2 from TOC or TA (in that case, we remove samples in which pH < 5.4).  
 
 *`r tab_nums("summary-eco2-toc","Median of pCO2 and ECO2, pCO2 predicted from TOC")`*
 
```{r summary-eco2-toc, results = T}
no <- norway %>% 
  dplyr::select(c("survey", "fCO2" ,"pCO2_pred", "ECO2_toc", "ECO2_toc_low")) %>% 
  mutate(nation = "Norway") %>% 
  setNames(c("survey","measured_pCO2","pCO2_toc","ECO2_high","ECO2_low","nation"))  %>% 
  dplyr::select(c("survey","nation","measured_pCO2","pCO2_toc","ECO2_high","ECO2_low"))

fns <- nlss %>% as_data_frame() %>%
  dplyr::select(c("nation", "pCO2_toc", "ECO2_toc", "ECO2_toc_low")) %>% 
  mutate(fCO2 = NA, survey = "nls_1995") %>% 
  setNames(c("nation","pCO2_toc","ECO2_high", "ECO2_low","measured_pCO2","survey")) %>% 
  dplyr::select(c("survey","nation","measured_pCO2","pCO2_toc","ECO2_high","ECO2_low"))

summary_eco2 <- rbind(no,fns) %>% group_by(nation, survey) %>% summarize_all(median, na.rm = T) 
kable(summary_eco2) %>% kable_styling()
```

 *`r tab_nums("summary-eco2-ta","Median of pCO2 and ECO2, pCO2 calculated from TA (excluding samples with pH < 5.4)")`*
 
```{r summary-eco2_ta, results = T}
no <- norway %>% 
  dplyr::select(c("survey", "pH", "fCO2", "ta_fCO2", "ECO2_ta", "ECO2_ta_low")) %>% 
  mutate(nation = "Norway") %>% 
  setNames(c("survey","pH","measured_pCO2","pCO2_ta","ECO2_high","ECO2_low","nation"))  %>%
  dplyr::select(c("survey","nation","pH","measured_pCO2","pCO2_ta","ECO2_high","ECO2_low"))

fns <- nlss %>% as_data_frame() %>%
  dplyr::select(c("nation", "pH","pCO2_ta","ECO2_ta", "ECO2_ta_low")) %>% 
  mutate(fCO2 = NA, survey = "nls_1995") %>% 
  setNames(c("nation","pH","pCO2_ta","ECO2_high", "ECO2_low","measured_pCO2","survey")) %>% 
  dplyr::select(c("survey","nation","pH","measured_pCO2","pCO2_ta","ECO2_high","ECO2_low"))

summary_eco2_ta <- rbind(no,fns) %>% filter(pH > 5.4) %>% group_by(nation, survey) %>% summarize_all(median, na.rm = T) 
kable(summary_eco2_ta) %>% kable_styling()

```


```{r map-eco2-nlss}
ggplot(nlss)+geom_point(aes(x=long, y = lat, col = ECO2_toc_low))+
  borders(regions = c("Norway","Sweden","Finland"))+ylim(55,72)+xlim(4,32)+
  scale_fill_continuous_divergingx(palette = "RdYlBu", aesthetics = c("fill","col"), mid = 0.5,rev = T)+
  labs(col="ECO2, gC/m2/day")+
  theme_void()
```

## Summary table with median and mean, TOC

 *`r tab_nums("summary-eco2","Median and mean of pCO2 and ECO2, pCO2 predicted from TOC, by survey")`*

```{r summary-eco2, results = T}
no <- norway %>% 
  dplyr::select(c("survey", "fCO2" , "ECO2", "ECO2_toc","ECO2_low", "ECO2_toc_low")) 

medyear <- function(x){median(x, na.rm = T) * 365} # to convert gC/m2/d in gC/m2/year
avyear <- function(x){mean(x, na.rm = T) * 365}

summary_eco2.1 <- no %>% group_by(survey) %>% summarize_all(medyear) %>% mutate(fCO2 = fCO2/365*1e6)

summary_eco2.2 <- no %>% group_by(survey) %>% summarize_all(avyear) %>% mutate(fCO2 = fCO2/365*1e6)

no2 <- rbind(summary_eco2.1, summary_eco2.2) %>% arrange(survey) %>% mutate(survey = c("median","mean","median","mean"))

fen <- nlss %>% dplyr::select(c("pCO2_toc","ECO2_toc","ECO2_toc_low")) %>% 
  mutate(ECO2 = NA, ECO2_low = NA, fCO2 = pCO2_toc/365*1e6, survey = NA) %>%
  dplyr::select(c("survey","fCO2", "ECO2", "ECO2_toc", "ECO2_low","ECO2_toc_low"))
fen$lake.id <- NULL

summary_fen.1 <- fen %>% group_by(survey) %>% summarize_all(medyear) %>% mutate(survey= "median")
summary_fen.2 <- fen %>% group_by(survey) %>% summarize_all(avyear) %>% mutate(survey= "mean")

tot <- rbind(no2, summary_fen.1) %>% rbind(summary_fen.2)

kable(tot, digits = 2, col.names = c(" ","pCO2, uatm", "ECO2 from DIC in gC/m2/day","ECO2 from TOC in gC/m2/day","ECO2 from DIC in gC/m2/day","ECO2 from TOC in gC/m2/day")) %>% 
  kable_styling %>% 
  group_rows(group_label= "CBA", start_row = 1, end_row = 2) %>%
  group_rows(group_label= "N112", start_row = 3, end_row = 4) %>% 
  group_rows(group_label= "NLS", start_row = 5, end_row = 6) %>% 
  add_header_above(c(" " = 2, "High estimates" = 2, "Low estimates" = 2)) 

kable(tot, digits = 2, col.names = c(" ","pCO2, uatm", "ECO2 from DIC in gC/m2/year","ECO2 from TOC in gC/m2/year","ECO2 from DIC in gC/m2/year","ECO2 from TOC in gC/m2/year")) %>% 
  kable_styling() %>% 
  group_rows(group_label= "CBA", start_row = 1, end_row = 2) %>%
  group_rows(group_label= "N112", start_row = 3, end_row = 4) %>%
  group_rows(group_label= "NLS", start_row = 5, end_row = 6) %>% 
  add_header_above(c(" " = 2, "High estimates" = 2, "Low estimates" = 2)) %>%
  save_kable(file = "compare.eco2.measured.png",zoom = 5)

```
## Monte Carlo for confidence intervals, all nlss

```{r mcuq}
library(mnonr)

ma1 <- nlss %>% subset(select = c(pCO2_toc,nws_m.s,lake.area)) %>% mardia()
covma <- cov(subset(nlss,select = c(pCO2_toc,nws_m.s,lake.area)), use = "complete.obs")

new.nlss <- mnonr(n=nrow(nlss), p = 3, ms = ma1$multivariate[1,2], mk = ma1$multivariate[2,2], Sigma = covma)

```

## Compare total emissions calculated from bins, with total emissions calculated from median and mean

We also compare with the efflux calculated by @Hastie2018 by class of area. The efflux is given in TgC/year. We convert it to gC/m2/year for each country. 

 *`r tab_nums("summary-FCO2-median","Total efflux of CO2 computed from the median for each lake category, compared to efflux calculated for all lakes (Norway, Sweden, Finland)")`*

```{r summary_bin_toc_median, results = T}
options(knitr.kable.NA = '')

p0 <- median(nlss$pCO2_toc, na.rm = T)*1e6
A0 <- sum(nlss$lake.area)
k0 <- nlss$kCO2 %>% median(na.rm = T) 
k0_low <- nlss$kCO2_low %>% median(na.rm = T)
E0 <- median(nlss$ECO2_toc * 365, na.rm = T) # gC/m2/y
E0_low <- median(nlss$ECO2_toc_low * 365, na.rm = T) # gC/m2/y

F0_realsum <-  with(nlss, sum(ECO2_toc * 365 *lake.area*1e6/12.011 * 43.99 * 1e-12, na.rm = T)) #MtCO2/y
F0_sumfrommedian <- with(nlss, E0*sum(lake.area*1e6)/12.011 * 43.99 * 1e-12)

F0_low_realsum <-  with(nlss, sum(ECO2_toc_low * 365 *lake.area*1e6/12.011 * 43.99 * 1e-12, na.rm = T)) #MtCO2/y
F0_low_sumfrommedian <- with(nlss, E0_low*sum(lake.area*1e6)/12.011 * 43.99 * 1e-12)

# Lake size < 0.1 km2

p1 <- nlss %>% subset(lake.area < 0.1) %>% pull(pCO2_toc) %>% median()*1e6
A1 <- nlss %>% subset(lake.area < 0.1) %>% pull(lake.area) %>% sum()

k1 <- with(subset(nlss, lake.area < 0.1), median(kCO2, na.rm = T)) 
E1 <- with(subset(nlss, lake.area < 0.1), median(ECO2_toc*365, na.rm = T)) #gC/m2/y

F1_realsum <- with(subset(nlss, lake.area < 0.1), sum(ECO2_toc * 365 *lake.area*1e6/12.011 * 43.99 * 1e-12, na.rm = T)) #MtCO2/y
F1_sumfrombin <- with(subset(nlss, lake.area < 0.1), E1*sum(lake.area*1e6)/12.011 * 43.99 * 1e-12)

  
k1_low <- with(subset(nlss, lake.area < 0.1), median(kCO2_low, na.rm = T)) 
E1_low <- with(subset(nlss, lake.area < 0.1), median(ECO2_toc_low*365, na.rm = T)) #gC/m2/y

F1_low_realsum <- with(subset(nlss, lake.area < 0.1), sum(ECO2_toc_low * 365/12.011 * 43.99  * 1e-12*lake.area*1e6, na.rm = T)) #MtCO2/y
F1_low_sumfrombin <- with(subset(nlss, lake.area < 0.1), E1_low*sum(lake.area*1e6)/12.011 * 43.99 * 1e-12)


W1 <- 38.17*1e12/(208008*1e6) # gC/m2/year in Weyhenmeyer
W1_sum <- with(subset(nlss, lake.area < 0.1), W1*sum(lake.area*1e6)/12.011 * 43.99 * 1e-12) # MtCO2/y

# 0.1 < Lake size < 1 km2

p2 <- nlss %>% subset(lake.area < 1 & lake.area > 0.1) %>% pull(pCO2_toc) %>% median()*1e6
A2 <- nlss %>% subset(lake.area < 1 & lake.area > 0.1) %>% pull(lake.area) %>% sum()

k2 <- with(subset(nlss, lake.area < 1 & lake.area > 0.1), median(kCO2, na.rm = T)) 
E2 <- with(subset(nlss, lake.area < 1 & lake.area > 0.1), median(ECO2_toc*365, na.rm = T)) #gC/m2/y

F2_realsum <- with(subset(nlss, lake.area < 1 & lake.area > 0.1), sum(ECO2_toc * 365/12.011 * 43.99 * 1e-12*lake.area*1e6, na.rm = T)) #MtCO2/y
F2_sumfrombin <- with(subset(nlss, lake.area < 1 & lake.area > 0.1), E2*sum(lake.area*1e6)/12.011 * 43.99 * 1e-12)


k2_low <- with(subset(nlss, lake.area < 1 & lake.area > 0.1), median(kCO2_low, na.rm = T)) 
E2_low <- with(subset(nlss, lake.area < 1 & lake.area > 0.1), median(ECO2_toc_low*365, na.rm = T)) #gC/m2/y

F2_low_realsum <- with(subset(nlss, lake.area < 1 & lake.area > 0.1), sum(ECO2_toc_low * 365/12.011 * 43.99 * 1e-12*lake.area*1e6, na.rm = T)) #MtCO2/y
F2_low_sumfrombin <- with(subset(nlss, lake.area < 1 & lake.area > 0.1), E2_low*sum(lake.area*1e6)/12.011 * 43.99 * 1e-12)



W2 <- 52.36*1e12/(282434*1e6) # gC/m2/year in W
W2_sum <- with(subset(nlss, lake.area < 1 & lake.area > 0.1), W2*sum(lake.area*1e6)/12.011 * 43.99 * 1e-12) # MtCO2/y

# 1 < Lake size < 10 km2

p3 <- nlss %>% subset(lake.area > 1 & lake.area < 10) %>% pull(pCO2_toc) %>% median()*1e6
A3 <- nlss %>% subset(lake.area > 1 & lake.area < 10) %>% pull(lake.area) %>% sum()

k3 <- with(subset(nlss, lake.area > 1 & lake.area < 10), median(kCO2, na.rm = T)) 
E3 <- with(subset(nlss, lake.area > 1 & lake.area < 10), median(ECO2_toc*365, na.rm = T)) #gC/m2/y

F3_realsum <- with(subset(nlss, lake.area > 1 & lake.area < 10), sum(ECO2_toc * 365/12.011 * 43.99 * 1e-12*lake.area*1e6, na.rm = T)) #MtCO2/y
F3_sumfrombin <- with(subset(nlss, lake.area > 1 & lake.area < 10), E3*sum(lake.area*1e6)/12.011 * 43.99 * 1e-12)


k3_low <- with(subset(nlss, lake.area > 1 & lake.area < 10), median(kCO2_low, na.rm = T)) 
E3_low <- with(subset(nlss, lake.area > 1 & lake.area < 10), median(ECO2_toc_low*365, na.rm = T)) #gC/m2/y

F3_low_realsum <- with(subset(nlss, lake.area > 1 & lake.area < 10), sum(ECO2_toc_low * 365/12.011 * 43.99  * 1e-12*lake.area*1e6, na.rm = T)) #MtCO2/y
F3_low_sumfrombin <- with(subset(nlss, lake.area > 1 & lake.area < 10), E3_low*sum(lake.area*1e6)/12.011 * 43.99  * 1e-12)


W3 <- 22.80*1e12/(286624*1e6) # gC/m2/year in W
W3_sum <- with(subset(nlss, lake.area > 1 & lake.area < 10), W3*sum(lake.area*1e6)/12.011 * 43.99 * 1e-12) # MtCO2/y

# 1 < Lake size < 10 km2

p4 <- nlss %>% subset(lake.area > 10) %>% pull(pCO2_toc) %>% median()*1e6
A4 <- nlss %>% subset(lake.area > 10) %>% pull(lake.area) %>% sum()

k600_4 <- with(subset(nlss, lake.area > 10), median(k600*24*1e-2, na.rm = T))
k600_4_low <- with(subset(nlss, lake.area > 10), median(k600_low*24*1e-2, na.rm = T))

k4 <- with(subset(nlss, lake.area > 10), median(kCO2, na.rm = T)) 
E4 <- with(subset(nlss, lake.area > 10), median(ECO2_toc*365, na.rm = T)) #gC/m2/y

F4_realsum <- with(subset(nlss, lake.area > 10), sum(ECO2_toc* 365*lake.area*1e6/12.011 * 43.99  * 1e-12, na.rm = T)) #MtCO2/y
F4_sumfrombin <- with(subset(nlss, lake.area > 10), E4*sum(lake.area*1e6)/12.011 * 43.99 * 1e-12)



k4_low <- with(subset(nlss, lake.area > 10), median(kCO2_low, na.rm = T)) 
E4_low <- with(subset(nlss, lake.area > 10), median(ECO2_toc_low*365, na.rm = T)) #gC/m2/y

F4_low_realsum <- with(subset(nlss, lake.area > 10), sum(ECO2_toc_low* 365*lake.area*1e6/12.011 * 43.99  * 1e-12, na.rm = T)) #MtCO2/y
F4_low_sumfrombin <- with(subset(nlss, lake.area > 10), E4_low*sum(lake.area*1e6)/12.011 * 43.99  * 1e-12)


W4 <- 53.96*1e12/(570583*1e6) # gC/m2/year in W
W4_sum <- with(subset(nlss, lake.area > 10), W4*sum(lake.area*1e6)/12.011 * 43.99 * 1e-12) # MtCO2/y

bin_FCO2 <- data.frame(lake.size = c("A < 0.1","0.1 < A < 1","1 < A < 10","> 10","sum"," "), 
          lake.area = c(A1, A2, A3, A4, NA,A0),
           pCO2 = c(p1,p2,p3,p4,NA,p0), 
           kCO2_low = c(k1_low,k2_low,k3_low,k4_low,NA,k0_low), 
           E_low = c(E1_low,E2_low,E3_low,E4_low,NA,E0_low),
           FCO2_low_bin = c(F1_low_sumfrombin, F2_low_sumfrombin, F3_low_sumfrombin, F4_low_sumfrombin, sum(F1_low_sumfrombin, F2_low_sumfrombin, F3_low_sumfrombin, F4_low_sumfrombin),F0_low_sumfrommedian),
            FCO2_low = c(F1_low_realsum, F2_low_realsum, F3_low_realsum, F4_low_realsum,sum(F1_low_realsum,F2_low_realsum,F3_low_realsum,F4_low_realsum),F0_low_realsum),
           kCO2_high = c(k1,k2,k3,k4, NA,k0),
           E_high = c(E1,E2,E3,E4, NA,E0),
           FCO2_high_bin = c(F1_sumfrombin, F2_sumfrombin, F3_sumfrombin, F4_sumfrombin, sum(F1_sumfrombin, F2_sumfrombin, F3_sumfrombin, F4_sumfrombin),F0_sumfrommedian),
          FCO2_high = c(F1_realsum, F2_realsum, F3_realsum, F4_realsum, sum(F1_realsum, F2_realsum, F3_realsum, F4_realsum),F0_realsum),
           Wey = c(W1,W2,W3,W4, NA,NA),
           Wey_sum = c(W1_sum, W2_sum, W3_sum, W4_sum, sum(W1_sum, W2_sum, W3_sum, W4_sum),NA))


kable(bin_FCO2, digits = 2, col.names = c("A = lake area in km2","Total lake area in km2","median pCO2, uatm","median kCO2, m2/d","median ECO2, g/m2/y", "binned FCO2, MtCO2/y","actual FCO2, MtCO2/y","kCO2, m2/d","median ECO2, g/m2/y", "binned FCO2, MtCO2/y", "actual FCO2, MtCO2/y","median ECO2, g/m2/day", "FCO2, MtCO2/y")) %>% kable_styling() %>% 
  add_header_above(c("Lake class" = 2, " " = 1, "Low estimate" = 4, "High estimate" = 4, "Hastie et al." = 2)) %>%
  group_rows(group_label= "All lakes", start_row = 6, end_row = 6) %>%
  column_spec(column = c(5,6,9,10,12), bold = T)

```

 *`r tab_nums("summary-FCO2-mean","Total efflux of CO2 computed from the mean for each lake category, compared to efflux calculated for all lakes (Norway, Sweden, Finland)")`*

```{r summary_bin_toc_mean, results = T}

p0 <- mean(nlss$pCO2_toc, na.rm = T)*1e6
A0 <- sum(nlss$ake.area)
k0 <- nlss$kCO2 %>% mean(na.rm = T) 
k0_low <- nlss$kCO2_low %>% mean(na.rm = T)
E0 <- mean(nlss$ECO2_toc * 365, na.rm = T) # gC/m2/y
E0_low <- mean(nlss$ECO2_toc_low * 365, na.rm = T) # gC/m2/y

F0_realsum <-  with(nlss, sum(ECO2_toc * 365 *lake.area*1e6/12.011 * 43.99 * 1e-12, na.rm = T)) #MtCO2/y
F0_sumfrommean <- with(nlss, E0*sum(lake.area*1e6)/12.011 * 43.99 * 1e-12)

F0_low_realsum <-  with(nlss, sum(ECO2_toc_low * 365 *lake.area*1e6/12.011 * 43.99 * 1e-12, na.rm = T)) #MtCO2/y
F0_low_sumfrommean <- with(nlss, E0_low*sum(lake.area*1e6)/12.011 * 43.99 * 1e-12)

# Lake size < 0.1 km2

p1 <- nlss %>% subset(lake.area < 0.1) %>% pull(pCO2_toc) %>% mean()*1e6
A1 <- nlss %>% subset(lake.area < 0.1) %>% pull(lake.area) %>% sum()

k1 <- with(subset(nlss, lake.area < 0.1), mean(kCO2, na.rm = T)) 
E1 <- with(subset(nlss, lake.area < 0.1), mean(ECO2_toc*365, na.rm = T)) #gC/m2/y

F1_realsum <- with(subset(nlss, lake.area < 0.1), sum(ECO2_toc * 365 *lake.area*1e6/12.011 * 43.99 * 1e-12, na.rm = T)) #MtCO2/y
F1_sumfrombin <- with(subset(nlss, lake.area < 0.1), E1*sum(lake.area*1e6)/12.011 * 43.99 * 1e-12)

  
k1_low <- with(subset(nlss, lake.area < 0.1), mean(kCO2_low, na.rm = T)) 
E1_low <- with(subset(nlss, lake.area < 0.1), mean(ECO2_toc_low*365, na.rm = T)) #gC/m2/y

F1_low_realsum <- with(subset(nlss, lake.area < 0.1), sum(ECO2_toc_low * 365/12.011 * 43.99  * 1e-12*lake.area*1e6, na.rm = T)) #MtCO2/y
F1_low_sumfrombin <- with(subset(nlss, lake.area < 0.1), E1_low*sum(lake.area*1e6)/12.011 * 43.99 * 1e-12)


W1 <- 38.17*1e12/(208008*1e6) # gC/m2/year in Weyhenmeyer
W1_sum <- with(subset(nlss, lake.area < 0.1), W1*sum(lake.area*1e6)/12.011 * 43.99 * 1e-12) # MtCO2/y

# 0.1 < Lake size < 1 km2

p2 <- nlss %>% subset(lake.area < 1 & lake.area > 0.1) %>% pull(pCO2_toc) %>% mean()*1e6

k2 <- with(subset(nlss, lake.area < 1 & lake.area > 0.1), mean(kCO2, na.rm = T)) 
E2 <- with(subset(nlss, lake.area < 1 & lake.area > 0.1), mean(ECO2_toc*365, na.rm = T)) #gC/m2/y

F2_realsum <- with(subset(nlss, lake.area < 1 & lake.area > 0.1), sum(ECO2_toc * 365/12.011 * 43.99 * 1e-12*lake.area*1e6, na.rm = T)) #MtCO2/y
F2_sumfrombin <- with(subset(nlss, lake.area < 1 & lake.area > 0.1), E2*sum(lake.area*1e6)/12.011 * 43.99 * 1e-12)


k2_low <- with(subset(nlss, lake.area < 1 & lake.area > 0.1), mean(kCO2_low, na.rm = T)) 
E2_low <- with(subset(nlss, lake.area < 1 & lake.area > 0.1), mean(ECO2_toc_low*365, na.rm = T)) #gC/m2/y

F2_low_realsum <- with(subset(nlss, lake.area < 1 & lake.area > 0.1), sum(ECO2_toc_low * 365/12.011 * 43.99 * 1e-12*lake.area*1e6, na.rm = T)) #MtCO2/y
F2_low_sumfrombin <- with(subset(nlss, lake.area < 1 & lake.area > 0.1), E2_low*sum(lake.area*1e6)/12.011 * 43.99 * 1e-12)



W2 <- 52.36*1e12/(282434*1e6) # gC/m2/year in W
W2_sum <- with(subset(nlss, lake.area < 1 & lake.area > 0.1), W2*sum(lake.area*1e6)/12.011 * 43.99 * 1e-12) # MtCO2/y

# 1 < Lake size < 10 km2

p3 <- nlss %>% subset(lake.area > 1 & lake.area < 10) %>% pull(pCO2_toc) %>% mean()*1e6

k3 <- with(subset(nlss, lake.area > 1 & lake.area < 10), mean(kCO2, na.rm = T)) 
E3 <- with(subset(nlss, lake.area > 1 & lake.area < 10), mean(ECO2_toc*365, na.rm = T)) #gC/m2/y

F3_realsum <- with(subset(nlss, lake.area > 1 & lake.area < 10), sum(ECO2_toc * 365/12.011 * 43.99 * 1e-12*lake.area*1e6, na.rm = T)) #MtCO2/y
F3_sumfrombin <- with(subset(nlss, lake.area > 1 & lake.area < 10), E3*sum(lake.area*1e6)/12.011 * 43.99 * 1e-12)


k3_low <- with(subset(nlss, lake.area > 1 & lake.area < 10), mean(kCO2_low, na.rm = T)) 
E3_low <- with(subset(nlss, lake.area > 1 & lake.area < 10), mean(ECO2_toc_low*365, na.rm = T)) #gC/m2/y

F3_low_realsum <- with(subset(nlss, lake.area > 1 & lake.area < 10), sum(ECO2_toc_low * 365/12.011 * 43.99  * 1e-12*lake.area*1e6, na.rm = T)) #MtCO2/y
F3_low_sumfrombin <- with(subset(nlss, lake.area > 1 & lake.area < 10), E3_low*sum(lake.area*1e6)/12.011 * 43.99  * 1e-12)


W3 <- 22.80*1e12/(286624*1e6) # gC/m2/year in W
W3_sum <- with(subset(nlss, lake.area > 1 & lake.area < 10), W3*sum(lake.area*1e6)/12.011 * 43.99 * 1e-12) # MtCO2/y

# 1 < Lake size < 10 km2

p4 <- nlss %>% subset(lake.area > 10) %>% pull(pCO2_toc) %>% mean()*1e6

k600_4 <- with(subset(nlss, lake.area > 10), mean(k600*24*1e-2, na.rm = T))
k600_4_low <- with(subset(nlss, lake.area > 10), mean(k600_low*24*1e-2, na.rm = T))

k4 <- with(subset(nlss, lake.area > 10), mean(kCO2, na.rm = T)) 
E4 <- with(subset(nlss, lake.area > 10), mean(ECO2_toc*365, na.rm = T)) #gC/m2/y

F4_realsum <- with(subset(nlss, lake.area > 10), sum(ECO2_toc* 365*lake.area*1e6/12.011 * 43.99  * 1e-12, na.rm = T)) #MtCO2/y
F4_sumfrombin <- with(subset(nlss, lake.area > 10), E4*sum(lake.area*1e6)/12.011 * 43.99 * 1e-12)



k4_low <- with(subset(nlss, lake.area > 10), mean(kCO2_low, na.rm = T)) 
E4_low <- with(subset(nlss, lake.area > 10), mean(ECO2_toc_low*365, na.rm = T)) #gC/m2/y

F4_low_realsum <- with(subset(nlss, lake.area > 10), sum(ECO2_toc_low* 365*lake.area*1e6/12.011 * 43.99  * 1e-12, na.rm = T)) #MtCO2/y
F4_low_sumfrombin <- with(subset(nlss, lake.area > 10), E4_low*sum(lake.area*1e6)/12.011 * 43.99  * 1e-12)


W4 <- 53.96*1e12/(570583*1e6) # gC/m2/year in W
W4_sum <- with(subset(nlss, lake.area > 10), W4*sum(lake.area*1e6)/12.011 * 43.99 * 1e-12) # MtCO2/y

bin_FCO2 <- data.frame(lake.size = c("A < 0.1","0.1 < A < 1","1 < A < 10","> 10","sum"," "), 
           pCO2 = c(p1,p2,p3,p4,NA,p0), 
           kCO2_low = c(k1_low,k2_low,k3_low,k4_low,NA,k0_low), 
           E_low = c(E1_low,E2_low,E3_low,E4_low,NA,E0_low),
           FCO2_low_bin = c(F1_low_sumfrombin, F2_low_sumfrombin, F3_low_sumfrombin, F4_low_sumfrombin, sum(F1_low_sumfrombin, F2_low_sumfrombin, F3_low_sumfrombin, F4_low_sumfrombin),F0_low_sumfrommean),
            FCO2_low = c(F1_low_realsum, F2_low_realsum, F3_low_realsum, F4_low_realsum,sum(F1_low_realsum,F2_low_realsum,F3_low_realsum,F4_low_realsum),F0_low_realsum),
           kCO2_high = c(k1,k2,k3,k4, NA,k0),
           E_high = c(E1,E2,E3,E4, NA,E0),
           FCO2_high_bin = c(F1_sumfrombin, F2_sumfrombin, F3_sumfrombin, F4_sumfrombin, sum(F1_sumfrombin, F2_sumfrombin, F3_sumfrombin, F4_sumfrombin),F0_sumfrommean),
          FCO2_high = c(F1_realsum, F2_realsum, F3_realsum, F4_realsum, sum(F1_realsum, F2_realsum, F3_realsum, F4_realsum),F0_realsum),
           Wey = c(W1,W2,W3,W4, NA,NA),
           Wey_sum = c(W1_sum, W2_sum, W3_sum, W4_sum, sum(W1_sum, W2_sum, W3_sum, W4_sum),NA))


kable(bin_FCO2, digits = 2, col.names = c("A = lake area in km2","mean pCO2, uatm","mean kCO2, m2/d","mean ECO2, g/m2/y", "binned FCO2, MtCO2/y","actual FCO2, MtCO2/y","kCO2, m2/d","mean ECO2, g/m2/y", "binned FCO2, MtCO2/y", "actual FCO2, MtCO2/y","mean ECO2, g/m2/day", "FCO2, MtCO2/y")) %>% kable_styling() %>% 
  add_header_above(c("Lake class" = 1, " " = 1, "Low estimate" = 4, "High estimate" = 4, "Hastie et al." = 2)) %>%
  group_rows(group_label= "All lakes", start_row = 6, end_row = 6) %>%
  column_spec(column = c(5,6,9,10,12), bold = T)

```

## Bin estimation by country for all inland waters 

We estimated the share of inland waters belonging to a given category of lakes (depending on area in km2) based on the proportion represented by each category in the total of the lakes sampled during the Northern European Lakes Survey. 

The largest lakes of Norway, Sweden and Finland account for a large part of the total inland waters. Therefore, we included them as a separated category. We assumed that all the lakes with an area larger than 100 km2 were samples in the NLS. Therefore, the CO2 efflux for these big lakes were simply added to the efflux calculated for the rest of the inland water.   

```{r lake-area-distribution}

ggplot(nlss)+geom_boxplot(aes(x=nation, y = lake.area, col = nation))+coord_trans(y = "log10")+
  scale_color_manual(values = c("firebrick","orange","dodgerblue3"))+
  geom_hline(yintercept = 100)+
  labs(y = "Lake area, km2", x = "")+
  scale_y_continuous(breaks = c(0.1,1,10,100))+
  theme_minimal()

```

 *`r tab_nums("summary-FCO2-norway","Total efflux of CO2 computed from the mean for each lake category, compared to efflux calculated for all lakes in Norway")`*

CAN BE RECODED WITH AN EXTRA COLUMN INDICATING LAKE CATEGORY + summarise
That would help for calculating uncertainty on each resulting number


```{r bin-area-norway, results = T}

nor <- filter(nlss, nation == "Norway")

inland.waters <- 20221 * 1e6 # km2 to m2, @SSB

p0 <- mean(nor$pCO2_toc, na.rm = T)*1e6
k0 <- mean(nor$kCO2, na.rm = T)
E0 <- mean(nor$ECO2_toc, na.rm = T)*365 # in gC/m2/year
F0 <- E0*inland.waters/12.011 * 43.99 * 1e-12 #MtCO2/t

k0_low <- mean(nor$kCO2_low, na.rm = T)
E0_low <- mean(nor$ECO2_toc_low, na.rm = T) *365 # in gC/m2/year
F0_low <- E0_low*inland.waters/12.011 * 43.99 * 1e-12 #MtCO2/t


A0 <- sum(subset(nor, lake.area < 100)$lake.area) # exclude big lakes

# Lake size < 0.1 km2

p1 <- nor %>% subset(lake.area < 0.1) %>% pull(pCO2_toc) %>% mean()*1e6
A1 <- nor %>% subset(lake.area < 0.1) %>% pull(lake.area) %>% sum()
A1_inland <- A1/A0*inland.waters

k1 <- with(subset(nor, lake.area < 0.1), mean(kCO2, na.rm = T)) 
E1 <- with(subset(nor, lake.area < 0.1), mean(ECO2_toc*365, na.rm = T)) #gC/m2/y
F1 <- E1*A1_inland/12.011 * 43.99 * 1e-12 #MtCO2/t

  
k1_low <- with(subset(nor, lake.area < 0.1), mean(kCO2_low, na.rm = T)) 
E1_low <- with(subset(nor, lake.area < 0.1), mean(ECO2_toc_low*365, na.rm = T)) #gC/m2/y
F1_low <- E1_low*A1_inland/12.011 * 43.99 * 1e-12

# 0.1 < Lake size < 1 km2

p2 <- nor %>% subset(lake.area < 1 & lake.area > 0.1) %>% pull(pCO2_toc) %>% mean()*1e6
A2 <- nor %>% subset(lake.area < 1 & lake.area > 0.1) %>% pull(lake.area) %>% sum()
A2_inland <- A2/A0*inland.waters

k2 <- with(subset(nor, lake.area < 1 & lake.area > 0.1), mean(kCO2, na.rm = T)) 
E2 <- with(subset(nor, lake.area < 1 & lake.area > 0.1), mean(ECO2_toc*365, na.rm = T)) #gC/m2/y
F2 <- E2*A2_inland/12.011 * 43.99 * 1e-12


k2_low <- with(subset(nor, lake.area < 1 & lake.area > 0.1), mean(kCO2_low, na.rm = T)) 
E2_low <- with(subset(nor, lake.area < 1 & lake.area > 0.1), mean(ECO2_toc_low*365, na.rm = T)) #gC/m2/y
F2_low <- E2_low*A2_inland/12.011 * 43.99 * 1e-12

# 1 < Lake size < 10 km2

p3 <- nor %>% subset(lake.area > 1 & lake.area < 10) %>% pull(pCO2_toc) %>% mean()*1e6
A3 <- nor %>% subset(lake.area > 1 & lake.area < 10) %>% pull(lake.area) %>% sum()
A3_inland <- A3/A0*inland.waters

k3 <- with(subset(nor, lake.area > 1 & lake.area < 10), mean(kCO2, na.rm = T)) 
E3 <- with(subset(nor, lake.area > 1 & lake.area < 10), mean(ECO2_toc*365, na.rm = T)) #gC/m2/y

F3 <- E3*A3_inland/12.011 * 43.99 * 1e-12


k3_low <- with(subset(nor, lake.area > 1 & lake.area < 10), mean(kCO2_low, na.rm = T)) 
E3_low <- with(subset(nor, lake.area > 1 & lake.area < 10), mean(ECO2_toc_low*365, na.rm = T)) #gC/m2/y
F3_low <- E3_low*A3_inland/12.011 * 43.99  * 1e-12

# 10 < Lake size < 100 km2

p4 <- nor %>% subset(lake.area > 10 & lake.area < 100) %>% pull(pCO2_toc) %>% mean()*1e6
A4 <- nor %>% subset(lake.area > 10 & lake.area < 100) %>% pull(lake.area) %>% sum()
A4_inland <- A4/A0*inland.waters

k4 <- with(subset(nor, lake.area > 10 & lake.area < 100), mean(kCO2, na.rm = T)) 
E4 <- with(subset(nor, lake.area > 10 & lake.area < 100), mean(ECO2_toc*365, na.rm = T)) #gC/m2/y
F4 <- E4*A4_inland/12.011 * 43.99 * 1e-12

k4_low <- with(subset(nor, lake.area > 10 & lake.area < 100), mean(kCO2_low, na.rm = T)) 
E4_low <- with(subset(nor, lake.area > 10 & lake.area < 100), mean(ECO2_toc_low*365, na.rm = T)) #gC/m2/y
F4_low <- E4_low*A4_inland/12.011 * 43.99  * 1e-12

# Big lakes > 100 km2
p5 <- nor %>% subset(lake.area > 100) %>% pull(pCO2_toc) %>% mean()*1e6
A5 <- nor %>% subset(lake.area > 100) %>% pull(lake.area) %>% sum()*1e6 # km2 to m2

k5 <- with(subset(nor, lake.area > 100), mean(kCO2, na.rm = T)) 
E5 <- with(subset(nor, lake.area > 100), mean(ECO2_toc*365, na.rm = T)) #gC/m2/y
F5 <- E5*A5/12.011 * 43.99 * 1e-12

k5_low <- with(subset(nor, lake.area > 100), mean(kCO2_low, na.rm = T)) 
E5_low <- with(subset(nor, lake.area > 100), mean(ECO2_toc_low*365, na.rm = T)) #gC/m2/y
F5_low <- E5_low*A5/12.011 * 43.99  * 1e-12


bin_FCO2 <- data.frame(
            lake.size = c("A < 0.1","0.1 < A < 1","1 < A < 10","> 10", "Big lakes (> 100)","Total","All lakes"),
           pCO2 = c(p1,p2,p3,p4,p5,NA,p0), 
           kCO2_low = c(k1_low,k2_low,k3_low,k4_low, k5_low,NA,k0_low), 
           E_low = c(E1_low,E2_low,E3_low,E4_low,E5_low,NA, E0_low),
           FCO2_low = c(F1_low, F2_low, F3_low, F4_low, F5_low, sum(F1_low, F2_low, F3_low, F4_low, F5_low), F0_low),
           kCO2_high = c(k1,k2,k3,k4,k5, NA,k0),
           E_high = c(E1,E2,E3,E4, E5,NA, E0),
           FCO2_high = c(F1, F2, F3, F4, F5, sum(F1, F2, F3, F4, F5),F0))


kable(bin_FCO2, digits = 2, col.names = c("A = lake area in km2","mean pCO2, uatm","mean kCO2, m2/d","mean ECO2, g/m2/y", "binned FCO2, MtCO2/y","kCO2, m2/d","mean ECO2, g/m2/y", "binned FCO2, MtCO2/y")) %>% kable_styling() %>% 
  add_header_above(c("Lake class" = 1, " " = 1, "Low estimate" = 3, "High estimate" = 3)) %>%
  group_rows(group_label = "All lakes", start_row = 7, end_row = 7)

```


 *`r tab_nums("summary-FCO2-sweden","Total efflux of CO2 computed from the mean for each lake category, compared to efflux calculated for all lakes in Sweden")`*
 
```{r bin-area-sweden, results = T}
swe <- filter(nlss, nation == "Sweden")

inland.waters <- 4014169.92 * 1e4 # ha to m2, @SCB

p0 <- mean(swe$pCO2_toc, na.rm = T)*1e6
k0 <- mean(swe$kCO2, na.rm = T)
E0 <- mean(swe$ECO2_toc, na.rm = T)*365 # in gC/m2/year
F0 <- E0*inland.waters/12.011 * 43.99 * 1e-12 #MtCO2/t

k0_low <- mean(swe$kCO2_low, na.rm = T)
E0_low <- mean(swe$ECO2_toc_low, na.rm = T) *365 # in gC/m2/year
F0_low <- E0_low*inland.waters/12.011 * 43.99 * 1e-12 #MtCO2/t


A0 <- sum(subset(swe, lake.area < 100)$lake.area) # exclude big lakes

# Lake size < 0.1 km2

p1 <- swe %>% subset(lake.area < 0.1) %>% pull(pCO2_toc) %>% mean()*1e6
A1 <- swe %>% subset(lake.area < 0.1) %>% pull(lake.area) %>% sum()
A1_inland <- A1/A0*inland.waters

k1 <- with(subset(swe, lake.area < 0.1), mean(kCO2, na.rm = T)) 
E1 <- with(subset(swe, lake.area < 0.1), mean(ECO2_toc*365, na.rm = T)) #gC/m2/y
F1 <- E1*A1_inland/12.011 * 43.99 * 1e-12 #MtCO2/t

  
k1_low <- with(subset(swe, lake.area < 0.1), mean(kCO2_low, na.rm = T)) 
E1_low <- with(subset(swe, lake.area < 0.1), mean(ECO2_toc_low*365, na.rm = T)) #gC/m2/y
F1_low <- E1_low*A1_inland/12.011 * 43.99 * 1e-12

# 0.1 < Lake size < 1 km2

p2 <- swe %>% subset(lake.area < 1 & lake.area > 0.1) %>% pull(pCO2_toc) %>% mean()*1e6
A2 <- swe %>% subset(lake.area < 1 & lake.area > 0.1) %>% pull(lake.area) %>% sum()
A2_inland <- A2/A0*inland.waters

k2 <- with(subset(swe, lake.area < 1 & lake.area > 0.1), mean(kCO2, na.rm = T)) 
E2 <- with(subset(swe, lake.area < 1 & lake.area > 0.1), mean(ECO2_toc*365, na.rm = T)) #gC/m2/y
F2 <- E2*A2_inland/12.011 * 43.99 * 1e-12


k2_low <- with(subset(swe, lake.area < 1 & lake.area > 0.1), mean(kCO2_low, na.rm = T)) 
E2_low <- with(subset(swe, lake.area < 1 & lake.area > 0.1), mean(ECO2_toc_low*365, na.rm = T)) #gC/m2/y
F2_low <- E2_low*A2_inland/12.011 * 43.99 * 1e-12

# 1 < Lake size < 10 km2

p3 <- swe %>% subset(lake.area > 1 & lake.area < 10) %>% pull(pCO2_toc) %>% mean()*1e6
A3 <- swe %>% subset(lake.area > 1 & lake.area < 10) %>% pull(lake.area) %>% sum()
A3_inland <- A3/A0*inland.waters

k3 <- with(subset(swe, lake.area > 1 & lake.area < 10), mean(kCO2, na.rm = T)) 
E3 <- with(subset(swe, lake.area > 1 & lake.area < 10), mean(ECO2_toc*365, na.rm = T)) #gC/m2/y

F3 <- E3*A3_inland/12.011 * 43.99 * 1e-12


k3_low <- with(subset(swe, lake.area > 1 & lake.area < 10), mean(kCO2_low, na.rm = T)) 
E3_low <- with(subset(swe, lake.area > 1 & lake.area < 10), mean(ECO2_toc_low*365, na.rm = T)) #gC/m2/y
F3_low <- E3_low*A3_inland/12.011 * 43.99  * 1e-12

# 1 < Lake size < 10 km2

p4 <- swe %>% subset(lake.area > 10 & lake.area < 100) %>% pull(pCO2_toc) %>% mean()*1e6
A4 <- swe %>% subset(lake.area > 10 & lake.area < 100) %>% pull(lake.area) %>% sum()
A4_inland <- A4/A0*inland.waters

k4 <- with(subset(swe, lake.area > 10 & lake.area < 100), mean(kCO2, na.rm = T)) 
E4 <- with(subset(swe, lake.area > 10 & lake.area < 100), mean(ECO2_toc*365, na.rm = T)) #gC/m2/y
F4 <- E4*A4_inland/12.011 * 43.99 * 1e-12

k4_low <- with(subset(swe, lake.area > 10 & lake.area < 100), mean(kCO2_low, na.rm = T)) 
E4_low <- with(subset(swe, lake.area > 10 & lake.area < 100), mean(ECO2_toc_low*365, na.rm = T)) #gC/m2/y
F4_low <- E4_low*A4_inland/12.011 * 43.99  * 1e-12

# Big lakes
p5 <- swe %>% subset(lake.area > 100) %>% pull(pCO2_toc) %>% mean()*1e6
A5 <- swe %>% subset(lake.area > 100) %>% pull(lake.area) %>% sum()*1e6 # km2 to m2

k5 <- with(subset(swe, lake.area > 100), mean(kCO2, na.rm = T)) 
E5 <- with(subset(swe, lake.area > 100), mean(ECO2_toc*365, na.rm = T)) #gC/m2/y
F5 <- E5*A5/12.011 * 43.99 * 1e-12

k5_low <- with(subset(swe, lake.area > 100), mean(kCO2_low, na.rm = T)) 
E5_low <- with(subset(swe, lake.area > 100), mean(ECO2_toc_low*365, na.rm = T)) #gC/m2/y
F5_low <- E5_low*A5/12.011 * 43.99  * 1e-12


bin_FCO2 <- data.frame(
            lake.size = c("A < 0.1","0.1 < A < 1","1 < A < 10","> 10", "Big lakes (> 100)","Total","All lakes"),
           pCO2 = c(p1,p2,p3,p4,p5,NA,p0), 
           kCO2_low = c(k1_low,k2_low,k3_low,k4_low, k5_low,NA,k0_low), 
           E_low = c(E1_low,E2_low,E3_low,E4_low,E5_low,NA, E0_low),
           FCO2_low = c(F1_low, F2_low, F3_low, F4_low, F5_low, sum(F1_low, F2_low, F3_low, F4_low, F5_low), F0_low),
           kCO2_high = c(k1,k2,k3,k4,k5, NA,k0),
           E_high = c(E1,E2,E3,E4, E5,NA, E0),
           FCO2_high = c(F1, F2, F3, F4, F5, sum(F1, F2, F3, F4, F5),F0))


kable(bin_FCO2, digits = 2, col.names = c("A = lake area in km2","mean pCO2, uatm","mean kCO2, m2/d","mean ECO2, g/m2/y", "binned FCO2, MtCO2/y","kCO2, m2/d","mean ECO2, g/m2/y", "binned FCO2, MtCO2/y")) %>% kable_styling() %>% 
  add_header_above(c("Lake class" = 1, " " = 1, "Low estimate" = 3, "High estimate" = 3)) %>%
  group_rows(group_label = "All lakes", start_row = 7, end_row = 7)

```

 *`r tab_nums("summary-FCO2-finland","Total efflux of CO2 computed from the mean for each lake category, compared to efflux calculated for all lakes in Finland")`*
 
```{r bin-area-finland, results = T}
fin <- filter(nlss, nation == "Finland")

inland.waters <- 34515 * 1e6 # km2 to m2, @Statfi

p0 <- mean(fin$pCO2_toc, na.rm = T)*1e6
k0 <- mean(fin$kCO2, na.rm = T)
E0 <- mean(fin$ECO2_toc, na.rm = T)*365 # in gC/m2/year
F0 <- E0*inland.waters/12.011 * 43.99 * 1e-12 #MtCO2/t

k0_low <- mean(fin$kCO2_low, na.rm = T)
E0_low <- mean(fin$ECO2_toc_low, na.rm = T) *365 # in gC/m2/year
F0_low <- E0_low*inland.waters/12.011 * 43.99 * 1e-12 #MtCO2/t


A0 <- sum(subset(fin, lake.area < 100)$lake.area) # exclude big lakes

# Lake size < 0.1 km2

p1 <- fin %>% subset(lake.area < 0.1) %>% pull(pCO2_toc) %>% mean()*1e6
A1 <- fin %>% subset(lake.area < 0.1) %>% pull(lake.area) %>% sum()
A1_inland <- A1/A0*inland.waters

k1 <- with(subset(fin, lake.area < 0.1), mean(kCO2, na.rm = T)) 
E1 <- with(subset(fin, lake.area < 0.1), mean(ECO2_toc*365, na.rm = T)) #gC/m2/y
F1 <- E1*A1_inland/12.011 * 43.99 * 1e-12 #MtCO2/t

  
k1_low <- with(subset(fin, lake.area < 0.1), mean(kCO2_low, na.rm = T)) 
E1_low <- with(subset(fin, lake.area < 0.1), mean(ECO2_toc_low*365, na.rm = T)) #gC/m2/y
F1_low <- E1_low*A1_inland/12.011 * 43.99 * 1e-12

# 0.1 < Lake size < 1 km2

p2 <- fin %>% subset(lake.area < 1 & lake.area > 0.1) %>% pull(pCO2_toc) %>% mean()*1e6
A2 <- fin %>% subset(lake.area < 1 & lake.area > 0.1) %>% pull(lake.area) %>% sum()
A2_inland <- A2/A0*inland.waters

k2 <- with(subset(fin, lake.area < 1 & lake.area > 0.1), mean(kCO2, na.rm = T)) 
E2 <- with(subset(fin, lake.area < 1 & lake.area > 0.1), mean(ECO2_toc*365, na.rm = T)) #gC/m2/y
F2 <- E2*A2_inland/12.011 * 43.99 * 1e-12


k2_low <- with(subset(fin, lake.area < 1 & lake.area > 0.1), mean(kCO2_low, na.rm = T)) 
E2_low <- with(subset(fin, lake.area < 1 & lake.area > 0.1), mean(ECO2_toc_low*365, na.rm = T)) #gC/m2/y
F2_low <- E2_low*A2_inland/12.011 * 43.99 * 1e-12

# 1 < Lake size < 10 km2

p3 <- fin %>% subset(lake.area > 1 & lake.area < 10) %>% pull(pCO2_toc) %>% mean()*1e6
A3 <- fin %>% subset(lake.area > 1 & lake.area < 10) %>% pull(lake.area) %>% sum()
A3_inland <- A3/A0*inland.waters

k3 <- with(subset(fin, lake.area > 1 & lake.area < 10), mean(kCO2, na.rm = T)) 
E3 <- with(subset(fin, lake.area > 1 & lake.area < 10), mean(ECO2_toc*365, na.rm = T)) #gC/m2/y

F3 <- E3*A3_inland/12.011 * 43.99 * 1e-12


k3_low <- with(subset(fin, lake.area > 1 & lake.area < 10), mean(kCO2_low, na.rm = T)) 
E3_low <- with(subset(fin, lake.area > 1 & lake.area < 10), mean(ECO2_toc_low*365, na.rm = T)) #gC/m2/y
F3_low <- E3_low*A3_inland/12.011 * 43.99  * 1e-12

# 1 < Lake size < 10 km2

p4 <- fin %>% subset(lake.area > 10 & lake.area < 100) %>% pull(pCO2_toc) %>% mean()*1e6
A4 <- fin %>% subset(lake.area > 10 & lake.area < 100) %>% pull(lake.area) %>% sum()
A4_inland <- A4/A0*inland.waters

k4 <- with(subset(fin, lake.area > 10 & lake.area < 100), mean(kCO2, na.rm = T)) 
E4 <- with(subset(fin, lake.area > 10 & lake.area < 100), mean(ECO2_toc*365, na.rm = T)) #gC/m2/y
F4 <- E4*A4_inland/12.011 * 43.99 * 1e-12

k4_low <- with(subset(fin, lake.area > 10 & lake.area < 100), mean(kCO2_low, na.rm = T)) 
E4_low <- with(subset(fin, lake.area > 10 & lake.area < 100), mean(ECO2_toc_low*365, na.rm = T)) #gC/m2/y
F4_low <- E4_low*A4_inland/12.011 * 43.99  * 1e-12

# Big lakes
p5 <- fin %>% subset(lake.area > 100) %>% pull(pCO2_toc) %>% mean()*1e6
A5 <- fin %>% subset(lake.area > 100) %>% pull(lake.area) %>% sum()*1e6 # km2 to m2

k5 <- with(subset(fin, lake.area > 100), mean(kCO2, na.rm = T)) 
E5 <- with(subset(fin, lake.area > 100), mean(ECO2_toc*365, na.rm = T)) #gC/m2/y
F5 <- E5*A5/12.011 * 43.99 * 1e-12

k5_low <- with(subset(fin, lake.area > 100), mean(kCO2_low, na.rm = T)) 
E5_low <- with(subset(fin, lake.area > 100), mean(ECO2_toc_low*365, na.rm = T)) #gC/m2/y
F5_low <- E5_low*A5/12.011 * 43.99  * 1e-12


bin_FCO2 <- data.frame(
            lake.size = c("A < 0.1","0.1 < A < 1","1 < A < 10","> 10", "Big lakes (> 100)","Total","All lakes"),
           pCO2 = c(p1,p2,p3,p4,p5,NA,p0), 
           kCO2_low = c(k1_low,k2_low,k3_low,k4_low, k5_low,NA,k0_low), 
           E_low = c(E1_low,E2_low,E3_low,E4_low,E5_low,NA, E0_low),
           FCO2_low = c(F1_low, F2_low, F3_low, F4_low, F5_low, sum(F1_low, F2_low, F3_low, F4_low, F5_low), F0_low),
           kCO2_high = c(k1,k2,k3,k4,k5, NA,k0),
           E_high = c(E1,E2,E3,E4, E5,NA, E0),
           FCO2_high = c(F1, F2, F3, F4, F5, sum(F1, F2, F3, F4, F5),F0))


kable(bin_FCO2, digits = 2, col.names = c("A = lake area in km2","mean pCO2, uatm","mean kCO2, m2/d","mean ECO2, g/m2/y", "binned FCO2, MtCO2/y","kCO2, m2/d","mean ECO2, g/m2/y", "binned FCO2, MtCO2/y")) %>% kable_styling() %>% 
  add_header_above(c("Lake class" = 1, " " = 1, "Low estimate" = 3, "High estimate" = 3)) %>%
  group_rows(group_label = "All lakes", start_row = 7, end_row = 7)

```



## Compare with @Raymond2013

@Raymond2013 estimate the CO2 emissions as gC/m2 land/year. We convert our estimated median CO2 evasion rate from gC/m2/year to gC/m2 land/year by multiplying it by the water area in a given region, and then dividing it by the land area. 

 *`r tab_nums("summary-FCO2-land","Evasion rate of CO2 per unit of area (gC/m2/year) and per unit of land area (gC/m2 land/year), low and high estimates")`*

```{r raymond, results = T}
inland.waters.nor <- 20221 * 1e6 # km2 to m2, @SSB
land.nor <- land <- 323806 * 1e6 # km2 to m2, @SSB
inland.waters.swe <- 4014169.92 * 1e4 # ha to m2, @SCB
land.swe <- 444435 * 1e6 # km2 to m2
inland.waters.fin <- 34515 * 1e6 # km2 to m2, @Statfi
land.fin <- 338478 * 1e6 # km2 to m2

tot.water <- inland.waters.nor + inland.waters.swe + inland.waters.fin
tot.land <- land.nor + land.swe + land.fin

mean.eco2.high <- c(median(nlss$ECO2_toc, na.rm = T)*365, #NLSS # in gC/m2/year
                    with(subset(nlss, nation == "Norway"), median(ECO2_toc, na.rm = T)*365),
                    with(subset(nlss, nation == "Sweden"), median(ECO2_toc, na.rm = T)*365),
                    with(subset(nlss, nation == "Finland"), median(ECO2_toc, na.rm = T)*365))

mean.eco2.low <- c(median(nlss$ECO2_toc_low, na.rm = T)*365, #NLSS # in gC/m2/year
                    with(subset(nlss, nation == "Norway"), median(ECO2_toc_low, na.rm = T)*365),
                    with(subset(nlss, nation == "Sweden"), median(ECO2_toc_low, na.rm = T)*365),
                    with(subset(nlss, nation == "Finland"), median(ECO2_toc_low, na.rm = T)*365))                    
                    
land.eco2.high <- c(mean.eco2.high[1]*tot.water/tot.land,
                    mean.eco2.high[2]*inland.waters.nor/land.nor,
                    mean.eco2.high[3]*inland.waters.swe/land.swe,
                    mean.eco2.high[4]*inland.waters.fin/land.fin)

land.eco2.low <- c(mean.eco2.low[1]*tot.water/tot.land,
                    mean.eco2.low[2]*inland.waters.nor/land.nor,
                    mean.eco2.low[3]*inland.waters.swe/land.swe,
                    mean.eco2.low[4]*inland.waters.fin/land.fin)

kable(tibble("Country" = c("All 3", "Norway", "Sweden", "Finland"),
            "Water"= c(tot.water, inland.waters.nor, inland.waters.swe, inland.waters.fin),
            "Land" = c(tot.land, land.nor, land.swe, land.fin),
            mean.eco2.high,
            land.eco2.high,
            mean.eco2.low,
            land.eco2.low),
      col.names = c("Country","Water area, km2", "Land area, km2", "Median ECO2, gC/m2/year", "Median ECO2, gC/m2 land/year", "Median ECO2, gC/m2/year", "Median ECO2, gC/m2 land/year"),
      digits = 2) %>% kable_styling() %>%
  add_header_above(c(" ","Area" = 2, "High estimate" = 2, "Low estimate" = 2))
```

```{r early-exit}
knitr::knit_exit()
```

## Summary table

For pCO2 calculated with TA: remove all values inferior to 0 as it is impossible. (Values coming from the approximation that TA ~ DIC, but TA can be negative at low pH). 

*`r tab_nums("summary-eco2","Summary statistics for evasion rate of CO2: minimum, median, maximum, mean and standard deviation in gC/m2/day")`*

```{r summary-evasion, results = T}

df <- subset(norway, survey == "N112_2004")

summary_n112 <- c(min(df$ECO2), median(df$ECO2), max(df$ECO2), mean(df$ECO2), sd(df$ECO2))

df <- subset(norway, survey == "N112_2004" & ta_fCO2 >= 0)

summary2_n112 <- c(min(df$ECO2), median(df$ECO2), max(df$ECO2), mean(df$ECO2), sd(df$ECO2))

df <- subset(norway, survey == "N112_2004" & pH >= 5.4)

summary3_n112 <- c(min(df$ECO2), median(df$ECO2), max(df$ECO2), mean(df$ECO2), sd(df$ECO2))

df <- subset(norway, survey == "CBA_2019")

summary_cba <- c(min(df$ECO2), median(df$ECO2), max(df$ECO2), mean(df$ECO2), sd(df$ECO2))

df <- subset(norway, survey == "CBA_2019" & ta_fCO2 >= 0)

summary2_cba <- c(min(df$ECO2), median(df$ECO2), max(df$ECO2), mean(df$ECO2), sd(df$ECO2))


df <- subset(norway, survey == "CBA_2019" & pH >= 5.4)

summary3_cba <- c(min(df$ECO2), median(df$ECO2), max(df$ECO2), mean(df$ECO2), sd(df$ECO2))


df <- nlss

summary_nlss_toc <- c(min(df$ECO2_toc, na.rm = T), median(df$ECO2_toc, na.rm = T), max(df$ECO2_toc, na.rm = T),  mean(df$ECO2_toc, na.rm = T), sd(df$ECO2_toc, na.rm = T))

summary_nlss_ta <- c(min(df$ECO2_ta, na.rm = T), median(df$ECO2_ta, na.rm = T), max(df$ECO2_ta, na.rm = T),  mean(df$ECO2_ta, na.rm = T), sd(df$ECO2_ta, na.rm = T))

df <- nlss %>% filter(pCO2_ta >= 0)

summary2_nlss_toc <- c(min(df$ECO2_toc, na.rm = T), median(df$ECO2_toc, na.rm = T), max(df$ECO2_toc, na.rm = T),  mean(df$ECO2_toc, na.rm = T), sd(df$ECO2_toc, na.rm = T))

summary2_nlss_ta <- c(min(df$ECO2_ta, na.rm = T), median(df$ECO2_ta, na.rm = T), max(df$ECO2_ta, na.rm = T),  mean(df$ECO2_ta, na.rm = T), sd(df$ECO2_ta, na.rm = T))

df <- nlss %>% filter(pH > 5.4)

summary3_nlss_toc <- c(min(df$ECO2_toc, na.rm = T), median(df$ECO2_toc, na.rm = T), max(df$ECO2_toc, na.rm = T),  mean(df$ECO2_toc, na.rm = T), sd(df$ECO2_toc, na.rm = T))

summary3_nlss_ta <- c(min(df$ECO2_ta, na.rm = T), median(df$ECO2_ta, na.rm = T), max(df$ECO2_ta, na.rm = T),  mean(df$ECO2_ta, na.rm = T), sd(df$ECO2_ta, na.rm = T))

df <- nlss %>% filter(nation == "Norway") %>% filter(lat < 63)

summary_snorway_1995_toc <- c(min(df$ECO2_toc, na.rm = T), median(df$ECO2_toc, na.rm = T),  max(df$ECO2_toc, na.rm = T), mean(df$ECO2_toc, na.rm = T), sd(df$ECO2_toc, na.rm = T))

summary_snorway_1995_ta <- c(min(df$ECO2_ta, na.rm = T), median(df$ECO2_ta, na.rm = T),  max(df$ECO2_ta, na.rm = T), mean(df$ECO2_ta, na.rm = T), sd(df$ECO2_ta, na.rm = T))

df <- nlss %>% filter(nation == "Norway" & pCO2_ta >= 0) %>% filter(lat < 63)

summary2_snorway_1995_toc <- c(min(df$ECO2_toc, na.rm = T), median(df$ECO2_toc, na.rm = T),  max(df$ECO2_toc, na.rm = T), mean(df$ECO2_toc, na.rm = T), sd(df$ECO2_toc, na.rm = T))

summary2_snorway_1995_ta <- c(min(df$ECO2_ta, na.rm = T), median(df$ECO2_ta, na.rm = T),  max(df$ECO2_ta, na.rm = T), mean(df$ECO2_ta, na.rm = T), sd(df$ECO2_ta, na.rm = T))

df <- nlss %>% filter(nation == "Norway" & pH > 5.4) %>% filter(lat < 63)

summary3_snorway_1995_toc <- c(min(df$ECO2_toc, na.rm = T), median(df$ECO2_toc, na.rm = T),  max(df$ECO2_toc, na.rm = T), mean(df$ECO2_toc, na.rm = T), sd(df$ECO2_toc, na.rm = T))

summary3_snorway_1995_ta <- c(min(df$ECO2_ta, na.rm = T), median(df$ECO2_ta, na.rm = T),  max(df$ECO2_ta, na.rm = T), mean(df$ECO2_ta, na.rm = T), sd(df$ECO2_ta, na.rm = T))

df <- nlss %>% filter(nation == "Norway")

summary_norway_1995_toc <- c(min(df$ECO2_toc, na.rm = T), median(df$ECO2_toc, na.rm = T),  max(df$ECO2_toc, na.rm = T), mean(df$ECO2_toc, na.rm = T), sd(df$ECO2_toc, na.rm = T))

summary_norway_1995_ta <- c(min(df$ECO2_ta, na.rm = T), median(df$ECO2_ta, na.rm = T),  max(df$ECO2_ta, na.rm = T), mean(df$ECO2_ta, na.rm = T), sd(df$ECO2_ta, na.rm = T))

df <- nlss %>% filter(nation == "Norway" & pCO2_ta >= 0)

summary2_norway_1995_toc <- c(min(df$ECO2_toc, na.rm = T), median(df$ECO2_toc, na.rm = T),  max(df$ECO2_toc, na.rm = T), mean(df$ECO2_toc, na.rm = T), sd(df$ECO2_toc, na.rm = T))

summary2_norway_1995_ta <- c(min(df$ECO2_ta, na.rm = T), median(df$ECO2_ta, na.rm = T),  max(df$ECO2_ta, na.rm = T), mean(df$ECO2_ta, na.rm = T), sd(df$ECO2_ta, na.rm = T))

df <- nlss %>% filter(nation == "Norway" & pH >= 5.4)

summary3_norway_1995_toc <- c(min(df$ECO2_toc, na.rm = T), median(df$ECO2_toc, na.rm = T),  max(df$ECO2_toc, na.rm = T), mean(df$ECO2_toc, na.rm = T), sd(df$ECO2_toc, na.rm = T))

summary3_norway_1995_ta <- c(min(df$ECO2_ta, na.rm = T), median(df$ECO2_ta, na.rm = T),  max(df$ECO2_ta, na.rm = T), mean(df$ECO2_ta, na.rm = T), sd(df$ECO2_ta, na.rm = T))



df <- nlss %>% filter(nation == "Sweden") 

summary_sweden_1995_toc <- c(min(df$ECO2_toc, na.rm = T), median(df$ECO2_toc, na.rm = T),  max(df$ECO2_toc, na.rm = T), mean(df$ECO2_toc, na.rm = T), sd(df$ECO2_toc, na.rm = T))

summary_sweden_1995_ta <- c(min(df$ECO2_ta, na.rm = T), median(df$ECO2_ta, na.rm = T),  max(df$ECO2_ta, na.rm = T), mean(df$ECO2_ta, na.rm = T), sd(df$ECO2_toc, na.rm = T))

df <- nlss %>% filter(nation == "Sweden" & pCO2_ta >= 0) 

summary2_sweden_1995_toc <- c(min(df$ECO2_toc, na.rm = T), median(df$ECO2_toc, na.rm = T),  max(df$ECO2_toc, na.rm = T), mean(df$ECO2_toc, na.rm = T), sd(df$ECO2_toc, na.rm = T))

summary2_sweden_1995_ta <- c(min(df$ECO2_ta, na.rm = T), median(df$ECO2_ta, na.rm = T),  max(df$ECO2_ta, na.rm = T), mean(df$ECO2_ta, na.rm = T), sd(df$ECO2_toc, na.rm = T))

df <- nlss %>% filter(nation == "Sweden" & pH >= 5.4) 

summary3_sweden_1995_toc <- c(min(df$ECO2_toc, na.rm = T), median(df$ECO2_toc, na.rm = T),  max(df$ECO2_toc, na.rm = T), mean(df$ECO2_toc, na.rm = T), sd(df$ECO2_toc, na.rm = T))

summary3_sweden_1995_ta <- c(min(df$ECO2_ta, na.rm = T), median(df$ECO2_ta, na.rm = T),  max(df$ECO2_ta, na.rm = T), mean(df$ECO2_ta, na.rm = T), sd(df$ECO2_toc, na.rm = T))

df <- nlss %>% filter(nation == "Finland") 

summary_finland_1995_toc <- c(min(df$ECO2_toc, na.rm = T), median(df$ECO2_toc, na.rm = T),  max(df$ECO2_toc, na.rm = T), mean(df$ECO2_toc, na.rm = T), sd(df$ECO2_toc, na.rm = T))

summary_finland_1995_ta <- c(min(df$ECO2_ta, na.rm = T), median(df$ECO2_ta, na.rm = T),  max(df$ECO2_ta, na.rm = T), mean(df$ECO2_ta, na.rm = T), sd(df$ECO2_toc, na.rm = T))

df <- nlss %>% filter(nation == "Finland" & pCO2_ta >= 0) 

summary2_finland_1995_toc <- c(min(df$ECO2_toc, na.rm = T), median(df$ECO2_toc, na.rm = T),  max(df$ECO2_toc, na.rm = T), mean(df$ECO2_toc, na.rm = T), sd(df$ECO2_toc, na.rm = T))

summary2_finland_1995_ta <- c(min(df$ECO2_ta, na.rm = T), median(df$ECO2_ta, na.rm = T),  max(df$ECO2_ta, na.rm = T), mean(df$ECO2_ta, na.rm = T), sd(df$ECO2_toc, na.rm = T))

df <- nlss %>% filter(nation == "Finland" & pH >= 5.4) 

summary3_finland_1995_toc <- c(min(df$ECO2_toc, na.rm = T), median(df$ECO2_toc, na.rm = T),  max(df$ECO2_toc, na.rm = T), mean(df$ECO2_toc, na.rm = T), sd(df$ECO2_toc, na.rm = T))

summary3_finland_1995_ta <- c(min(df$ECO2_ta, na.rm = T), median(df$ECO2_ta, na.rm = T),  max(df$ECO2_ta, na.rm = T), mean(df$ECO2_ta, na.rm = T), sd(df$ECO2_toc, na.rm = T))

summary.df <- rbind(summary_n112, summary_cba, summary_nlss_ta, summary_sweden_1995_ta, summary_finland_1995_ta, summary_norway_1995_ta, summary_snorway_1995_ta, summary_nlss_toc, summary_sweden_1995_toc, summary_finland_1995_toc, summary_norway_1995_toc, summary_snorway_1995_toc) %>% as.data.frame()

rownames(summary.df) <- c("N112, 2004", "CBA, 2019","Northern Lake Survey, TA", "Sweden, TA", "Finland, TA", "Norway, TA", "South Norway, TA", "Northern Lake Survey, TOC", "Sweden, TOC", "Finland, TOC", "Norway, TOC", "South Norway, TOC")

colnames(summary.df) <- c("Min", "Median","Max","Mean","Sd")

knitr::kable(summary.df, digits = 2, caption = "All pCO2") %>% kable_styling(full_width= T, font_size = 14) %>% 
  group_rows(group_label = "ECO2 from measured pCO2", start_row = 1,end_row=2) %>%
  group_rows(group_label = "ECO2 computed with TA", start_row = 3,end_row=7) %>%
  group_rows(group_label = "ECO2 computed with TOC", start_row = 8,end_row=12) %>% 
  column_spec(column = c(3,5), bold = T) 


summary.df2 <- rbind(summary2_n112, summary2_cba, summary2_nlss_ta, summary2_sweden_1995_ta, summary2_finland_1995_ta, summary2_norway_1995_ta, summary2_snorway_1995_ta, summary2_nlss_toc, summary2_sweden_1995_toc, summary2_finland_1995_toc, summary2_norway_1995_toc, summary2_snorway_1995_toc) %>% as.data.frame()

rownames(summary.df2) <- c("N112, 2004", "CBA, 2019","Northern Lake Survey, TA", "Sweden, TA", "Finland, TA", "Norway, TA", "South Norway, TA", "Northern Lake Survey, TOC", "Sweden, TOC", "Finland, TOC", "Norway, TOC", "South Norway, TOC")

colnames(summary.df2) <- c("Min", "Median","Max","Mean","Sd")

knitr::kable(summary.df2, digits = 2, caption = "Excluding pCO2_ta < 0") %>% kable_styling(full_width= T, font_size = 14) %>% 
  group_rows(group_label = "ECO2 from measured pCO2", start_row = 1,end_row=2) %>%
  group_rows(group_label = "ECO2 computed with TA", start_row = 3,end_row=7) %>%
  group_rows(group_label = "ECO2 computed with TOC", start_row = 8,end_row=12) %>% 
  column_spec(column = c(3,5), bold = T) 

summary.df3 <- rbind(summary3_n112, summary3_cba, summary3_nlss_ta, summary3_sweden_1995_ta, summary3_finland_1995_ta, summary3_norway_1995_ta, summary3_snorway_1995_ta, summary3_nlss_toc, summary2_sweden_1995_toc, summary2_finland_1995_toc, summary2_norway_1995_toc, summary2_snorway_1995_toc) %>% as.data.frame()

rownames(summary.df3) <- c("N112, 2004", "CBA, 2019","Northern Lake Survey, TA", "Sweden, TA", "Finland, TA", "Norway, TA", "South Norway, TA", "Northern Lake Survey, TOC", "Sweden, TOC", "Finland, TOC", "Norway, TOC", "South Norway, TOC")

colnames(summary.df3) <- c("Min", "Median","Max","Mean","Sd")

knitr::kable(summary.df3, digits = 2, caption = "Excluding pH < 5.4") %>% kable_styling(full_width= T, font_size = 14) %>% 
  group_rows(group_label = "ECO2 from measured pCO2", start_row = 1,end_row=2) %>%
  group_rows(group_label = "ECO2 computed with TA", start_row = 3,end_row=7) %>%
  group_rows(group_label = "ECO2 computed with TOC", start_row = 8,end_row=12) %>% 
  column_spec(column = c(3,5), bold = T) 
```

## Compare with @Creed2018

Paper from Weyhenmeyer, in which the median pCO2 and CO2 evasion rates are compared.

(Weyhenmeyer et al. 2015) estimated ECO2 in mgC/m2/day in small boreal lakes. Using the characteristics of the 4 example lakes they describe, we computed pCO2 based on DOC concentration and subsequently the CO2 emission. They computed CO2 concentration based on 5 118 swedish lakes, using the carbonate equilibrium, but removing samples for which pH < 5.4. Even though we used a different formula to calculate the gas transfer coefficient k600, we obtain comparable evasion rates for the 4 example lakes provided in their survey. We used the DOC concentration in each lake to predict pCO2. We computed k600 using the formula from (Vachon and Prairie 2013), as in this article, including the lake area and a wind speed of 3.5 m/s as in Weyhenmeyer et al. (2015). 
Lake type	ECO2 Weyhenmeyer (gC/m2/day)	ECO2 predicted (gC/m2/day)
A (short retention time, short ice-free season)	0.402	0.309
B (long water retention time, short ice-free season)	0.418	0.282
C (short water retention time, long ice-free season)	0.910	0.946
D (long water retention time, long ice-free season)	0.688	0.753



```{r compare-weyhenmeyer, results = T}
K0 <- filter(nlss, nation == "Sweden")$K0 %>% median()
K1 <- filter(nlss, nation == "Sweden")$K1 %>% median()
K2 <- filter(nlss, nation == "Sweden")$K2 %>% median()
Sc <- filter(nlss, nation == "Sweden")$Sc %>% median()
kCO2 <- filter(nlss, nation == "Sweden")$kCO2 %>% median()

pCO2_10.5 <- fCO2.atm.1995 + 1.05709*(10.5/12.011*1e-3) #pCO2 for a lake with a concentration of 10.5 mg/L TOC
ECO2_10.5 <- kCO2*(pCO2_10.5-fCO2.atm.1995)*K0*1e3*12.011 #ECO2 in g/m2/day

pCO2_atm <- 360.17 * 1e-6

print(ECO2_10.5)

filter(nlss, nation == "Sweden")$k600 %>% median(na.rm = T) # 7.43 cm/h
filter(nlss, nation == "Sweden")$k600 %>% mean(na.rm = T) # 7.56 cm/h
# median in Weyhenmeyer: < 0.61m/day -> 2.54 cm/h

filter(nlss, nation == "Sweden")$kCO2 %>% median(na.rm = T) # 7.43 cm/h
filter(nlss, nation == "Sweden")$kCO2 %>% mean(na.rm = T) # 7.56 cm/h


wHplus <- 10^(-6.6) # median pH in W: 6.6
pCO2_a <- (2.5/12.011*1e-3)/(K0+K0*K1/wHplus+K0*K1*K2/(wHplus^2))
pCO2_b <- (2/12.011*1e-3)/(K0+K0*K1/wHplus+K0*K1*K2/(wHplus^2))
pCO2_c <- (4.9/12.011*1e-3)/(K0+K0*K1/wHplus+K0*K1*K2/(wHplus^2))
pCO2_d <- (4.4/12.011*1e-3)/(K0+K0*K1/wHplus+K0*K1*K2/(wHplus^2))

pCO2_a_pred <- pCO2_atm + 1.1 * (5 / 12.011*1e-3) # DOC in lakes a converted to mol/L
pCO2_b_pred <- pCO2_atm + 1.1 * (4 / 12.011*1e-3) # DOC in lakes a converted to mol/L
pCO2_c_pred <- pCO2_atm + 1.1 * (15 / 12.011*1e-3) # DOC in lakes a converted to mol/L
pCO2_d_pred <- pCO2_atm + 1.1 * (10 / 12.011*1e-3) # DOC in lakes a converted to mol/L

k600_a <- 2.51+1.48*3.5+0.39*3.5*log10(0.11) # in cm/h
kCO2_a <- k600_a*(600/Sc)^(2/3)*24*1e-2 # from cm/h to m/day
k600_b <- 2.51+1.48*3.5+0.39*3.5*log10(0.51) # in cm/h
kCO2_b <- k600_b*(600/Sc)^(2/3)*24*1e-2 # from cm/h to m/day
k600_c <- 2.51+1.48*3.5+0.39*3.5*log10(0.14) # in cm/h
kCO2_c <- k600_c*(600/Sc)^(2/3)*24*1e-2 # from cm/h to m/day
k600_d <- 2.51+1.48*3.5+0.39*3.5*log10(0.38) # in cm/h
kCO2_d <- k600_d*(600/Sc)^(2/3)*24*1e-2 # from cm/h to m/day

ECO2_a <- kCO2_a*(pCO2_a_pred-fCO2.atm.1995)*K0*1e6*12.011 #ECO2 in mg/m2/day
ECO2_b <- kCO2_b*(pCO2_b_pred-fCO2.atm.1995)*K0*1e6*12.011 #ECO2 in mg/m2/day
ECO2_c <- kCO2_c*(pCO2_c_pred-fCO2.atm.1995)*K0*1e6*12.011 #ECO2 in mg/m2/day
ECO2_d <- kCO2_d*(pCO2_d_pred-fCO2.atm.1995)*K0*1e6*12.011 #ECO2 in mg/m2/day

kable(data.frame(lake_type = c("a","b","c","d"), median_DIC_mg.L = c(2.5,2,4.9,4.4), pCO2_DIC = c(pCO2_a,pCO2_b,pCO2_c,pCO2_d)*1e6, pCO2_pred = c(pCO2_a_pred,pCO2_b_pred,pCO2_c_pred,pCO2_d_pred)*1e6, ECO2_mgC.m2.day = c(ECO2_a, ECO2_b, ECO2_c, ECO2_d), ECO2_weyhemeyer = c(402, 418, 910, 753))) %>% kable_styling(bootstrap_options = "bordered")
```

*`r tab_nums("weyhenmeyer","ECO2 calculated from median DIC values from @Weyhenmeyer2015, following the same process as in our article")`*


## Compare with @Lindroth2021

All numbers converted to MtCO2/year

```{r tranvik-norway, results = T}
inland.waters.nor <- 20221 * 1e6 # km2 to m2, @SSB
land <- 323806 * 1e6 # km2 to m2, @SSB
mean.emissions.nor.toc <- nlss %>% filter(nation == "Norway") %>% pull(ECO2_toc) %>% median(na.rm = T)  #gC/m2/day
mean.emissions.nor.ta <- nlss %>% filter(nation == "Norway" & pCO2_ta >= 0 & pH > 5.4) %>% pull(ECO2_ta) %>% median(na.rm = T) 


data.frame("FCO2 from TOC" = (inland.waters.nor * mean.emissions.nor.toc /12.011 * 43.99 * 365 * 1e-12), # from gC/day to gCO2/day to Mton CO2eq/year
           "FCO2 from TA" = (inland.waters.nor * mean.emissions.nor.ta /12.011 * 43.99 * 365 * 1e-12), # from gC/year to gCO2/year to Mton CO2eq/year
           "Percent of NIR" = (inland.waters.nor * mean.emissions.nor.toc /12.011 * 43.99 * 365 * 1e-12) / 38.7 * 100, # @Bjøness2020
           "Percent area lakes included in survey" = sum(subset(nlss, nation == "Norway")$lake.area*1e6) / inland.waters.nor * 100,
          "ECO2 per m2 land" = (inland.waters.nor * mean.emissions.nor.toc * 365 )/land # gC/m2 land/year
           ) %>% t() %>% as.data.frame() %>% kable(digits = 2)
```

```{r tranvik-sweden, results = T}
inland.waters.swe <- 4014169.92 * 1e4 # ha to m2, @SCB
land <- 444435 * 1e6 # km2 to m2
mean.emissions.swe.toc <- nlss %>% filter(nation == "Sweden") %>% pull(ECO2_toc) %>% median(na.rm = T) 
mean.emissions.swe.ta <- nlss %>% filter(nation == "Sweden" & pCO2_ta >= 0 & pH > 5.4) %>% pull(ECO2_ta) %>% median(na.rm = T) 

low.eco2.toc.swe <- nlss %>% filter(nation == "Sweden") %>% pull(ECO2_toc_low) %>% median(na.rm = T) 
low.eco2.ta.swe <- nlss %>% filter(nation == "Sweden" & pCO2_ta >= 0 & pH > 5.4) %>% pull(ECO2_ta_low) %>% median(na.rm = T) 

high <- data.frame("FCO2 from TOC" = (inland.waters.swe * mean.emissions.swe.toc /12.011 * 43.99 * 365 * 1e-12), # from gC/day to gCO2/day to Mton CO2eq/year, assuming the rate if valid half of the year
           "FCO2 from TA" = (inland.waters.swe * mean.emissions.swe.ta /12.011 * 43.99 * 365 * 1e-12), # from gC/year to gCO2/year to Mton CO2eq/year
           "Percent of NIR" = (inland.waters.swe * mean.emissions.swe.toc /12.011 * 43.99 * 365 * 1e-12) / 36.9 * 100, #@SEPA2022
            "FCO2 NLS" = sum(with(filter(nlss, nation == "Sweden"), ECO2_toc * lake.area*1e6 /12 * 43.99 * 364 * 1e-12), na.rm = T),
           "Percent area lakes included in survey" = sum(subset(nlss, nation == "Sweden")$lake.area*1e6) / inland.waters.swe * 100,
            "ECO2 per m2 land" = (inland.waters.swe * mean.emissions.swe.toc * 365)/land # gC/m2 land/year
           ) %>% t() %>% as.data.frame() %>% setNames("High") 

low <- data.frame("FCO2 from TOC" = (inland.waters.swe * low.eco2.toc.swe /12.011 * 43.99 * 365 * 1e-12), # from gC/day to gCO2/day to Mton CO2eq/year, assuming the rate if valid half of the year
           "FCO2 from TA" = (inland.waters.swe * low.eco2.ta.swe /12.011 * 43.99 * 365 * 1e-12), # from gC/year to gCO2/year to Mton CO2eq/year
           "Percent of NIR" = (inland.waters.swe * low.eco2.toc.swe /12.011 * 43.99 * 365 * 1e-12) / 36.9 * 100, #@SEPA2022
            "FCO2 NLS" = sum(with(filter(nlss, nation == "Sweden"), ECO2_toc_low * lake.area*1e6 /12 * 43.99 * 364 * 1e-12), na.rm = T),
           "Percent area lakes included in survey" = sum(subset(nlss, nation == "Sweden")$lake.area*1e6) / inland.waters.swe * 100,
            "ECO2 per m2 land" = (inland.waters.swe * low.eco2.toc.swe * 365)/land # gC/m2 land/year
           ) %>% t() %>% as.data.frame() %>% setNames("Low")

both <- cbind(high,low)

kable(both, digits = 2) %>% kable_styling()
```

```{r tranvik-finland, results = T}
inland.waters.fin <- 34515 * 1e6 # km2 to m2, @Statfi
land <- 338478 * 1e6 # km2 to m2
mean.emissions.fin.toc <- nlss %>% filter(nation == "Finland") %>% pull(ECO2_toc) %>% median(na.rm = T) 
mean.emissions.fin.ta <- nlss %>% filter(nation == "Finland"& pCO2_ta >= 0 & pH > 5.4) %>% pull(ECO2_ta) %>% median(na.rm = T) 

data.frame("FCO2 from TOC, MtCo2eq/y" = (inland.waters.fin * mean.emissions.fin.toc /12.011 * 43.99 * 365 * 1e-12), # from gC/day to gCO2/day to Mton CO2eq/year, assuming the rate if valid half of the year
           "FCO2 from TA, MtCo2eq/y" = (inland.waters.fin * mean.emissions.fin.ta /12.011 * 43.99 * 365 * 1e-12), # from gC/year to gCO2/year to Mton CO2eq/year
           "Percent of NIR" = (inland.waters.fin * mean.emissions.fin.toc /12.011 * 43.99 * 365 * 1e-12) / 58.4 * 100, # @Forsell2022
            "FCO2 NLS MtCO2eq/y" = with(filter(nlss, nation == "Finland"), sum(ECO2_toc * lake.area*1e6 /12.011 * 43.99 * 365 * 1e-12, na.rm = T)),
            "Percent area lakes included in survey" = sum(subset(nlss, nation == "Finland")$lake.area*1e6) / inland.waters.fin*100,
            "ECO2 per m2 land" = (inland.waters.fin * mean.emissions.fin.toc * 365 )/land # gC/m2 water / year * m2 water / m2 land ->  gC/m2 land/year
           ) %>% t() %>% as.data.frame() %>% kable(digits = 2)
```

## Binned estimations

```{r bin-area}
nlss$log.lake.area <- nlss$lake.area %>% log10()
cut(nlss$log.lake.area, breaks = 4) %>% unique()
nlss$class.lake <- cut(nlss$log.lake.area, breaks = 4, labels = F)
ggplot(nlss)+geom_point(aes(x = class.lake, y = log.lake.area))
ggplot(nlss)+geom_point(aes(x = log.lake.area, y = pCO2_toc, col = as.factor(class.lake)))
ggplot(nlss)+geom_point(aes(x = log.lake.area, y = ECO2_toc, col = as.factor(class.lake)))


bin_nlss <- nlss %>% group_by(class.lake) %>% 
  summarise(median_area = median(lake.area), total_area = sum(lake.area), median_pCO2 = median(pCO2_toc)*1e6,
            median_ECO2 = median(ECO2_toc, na.rm = T), 
            actual_FCO2_Mt= sum(ECO2_toc*lake.area*1e6/ 12.011 * 43.99 * 365 * 1e-12, na.rm = T)) %>%
  mutate(prop_area = total_area / sum(total_area) * 100,
         bin_FCO2_Mt = total_area *1e6 * median_ECO2 / 12.011 * 43.99 * 365 * 1e-12)

bin_nlss <- dplyr::select(bin_nlss, c(class.lake, median_area, total_area, prop_area, median_pCO2,median_ECO2, bin_FCO2_Mt, actual_FCO2_Mt))

sum_table <- c(0, median(nlss$lake.area), sum(nlss$lake.area), sum(bin_nlss$prop_area),
               median(nlss$pCO2_toc)*1e6, median(nlss$ECO2_toc, na.rm = T), 
               sum(bin_nlss$bin_FCO2_Mt),
               sum(bin_nlss$actual_FCO2_Mt))


kable(rbind(bin_nlss, sum_table), digits = 2, caption = paste("NLSS. FCO2 as median(ECO2) * total_area = ", round(with(nlss, median(ECO2_toc, na.rm = T)*sum(lake.area)*1e6/ 12.011 * 43.99 * 365 * 1e-12),2), "MtCO2_eq/y", sep = " ")) %>% kable_styling()

test.ta <- nlss %>% subset(pH>5.4) %>% group_by(class.lake) %>% summarise(median_area = median(lake.area), total_area = sum(lake.area), median_pCO2 = median(pCO2_ta)*1e6,
            median_ECO2 = median(ECO2_ta, na.rm = T), 
            actual_FCO2_Mt= sum(ECO2_ta*lake.area*1e6/ 12.011 * 43.99 * 365 * 1e-12, na.rm = T)) %>%
  mutate(prop_area = total_area / sum(total_area) * 100,
         bin_FCO2_Mt = total_area *1e6 * median_ECO2 / 12.011 * 43.99 * 365 * 1e-12)
test.ta <- dplyr::select(test.ta, c(class.lake, median_area, total_area, prop_area, median_pCO2,median_ECO2, bin_FCO2_Mt, actual_FCO2_Mt))

sum_table_ta <- c(0, median(subset(nlss, pH>5.4)$lake.area), sum(subset(nlss, pH > 5.4)$lake.area), sum(test.ta$prop_area),
               median(subset(nlss, pH > 5.4)$pCO2_ta)*1e6, median(subset(nlss, pH > 5.4)$ECO2_ta, na.rm = T), 
               sum(test.ta$bin_FCO2_Mt),
               sum(test.ta$actual_FCO2_Mt))


kable(rbind(test.ta, sum_table_ta), digits = 2, caption = paste("NLSS. FCO2 as median(ECO2) * total_area = ", round(with(subset(nlss, pH > 5.4), median(ECO2_ta, na.rm = T)*sum(lake.area)*1e6/ 12.011 * 43.99 * 365 * 1e-12),2), "MtCO2_eq/y", sep = " ")) %>% kable_styling()
```


```{r bin-area-sweden-dep, results  = T}
swe <- filter(nlss, nation == "Sweden")
inland.waters <- 4014169.92 * 1e4

swe$log.lake.area <- swe$lake.area %>% log10()
swe$class.lake <- cut(swe$log.lake.area, breaks = 4, labels = F)


bin_swe <- swe %>% group_by(class.lake) %>% 
  summarise(n = n(),
            median_area = median(lake.area), total_area = sum(lake.area), median_pCO2 = median(pCO2_toc)*1e6,
            median_ECO2 = median(ECO2_toc, na.rm = T), 
            actual_FCO2_Mt= sum(ECO2_toc*lake.area*1e6/ 12.011 * 43.99 * 365 * 1e-12, na.rm = T)) %>%
  mutate(prop_area = total_area / sum(total_area) * 100,
         bin_FCO2_Mt = total_area *1e6 * median_ECO2 / 12.011 * 43.99 * 365 * 1e-12,
         bin_FCO2_swe = inland.waters * prop_area / 100 * median_ECO2 / 12.011 * 43.99 * 365 * 1e-12)

bin_swe <- dplyr::select(bin_swe, c(class.lake, n, median_area, total_area, prop_area, median_pCO2,median_ECO2, actual_FCO2_Mt, bin_FCO2_Mt, bin_FCO2_swe))

sum_table <- c(0, sum(bin_swe$n), median(swe$lake.area), sum(swe$lake.area), sum(bin_swe$prop_area),
               median(swe$pCO2_toc)*1e6, median(swe$ECO2_toc, na.rm = T), 
               sum(bin_swe$actual_FCO2_Mt),
               sum(bin_swe$bin_FCO2_Mt),
               sum(bin_swe$bin_FCO2_swe))


kable(rbind(bin_swe, sum_table), digits = 2, 
      caption = paste("Sweden. FCO2 in sampled lakes as median(ECO2) * total_area = ", 
                      round(with(swe, median(ECO2_toc, na.rm = T)*sum(lake.area)*1e6/ 12.011 * 43.99 * 365 * 1e-12),2), "MtCO2_eq/y; FCO2 in total sweway as median(ECO2) * inland water =",
                      round(with(swe, median(ECO2_toc, na.rm = T)*inland.waters/ 12.011 * 43.99 * 365 * 1e-12),2), "MtCO2_eq/y", sep = " ")) %>% 
  kable_styling()

```

```{r bin-area-sweden-low, results  = T}
swe <- filter(nlss, nation == "Sweden")
inland.waters <- 4014169.92 * 1e4

swe$log.lake.area <- swe$lake.area %>% log10()
swe$class.lake <- cut(swe$log.lake.area, breaks = 4, labels = F)


bin_swe <- swe %>% group_by(class.lake) %>% 
  summarise(n = n(),
            median_area = median(lake.area), total_area = sum(lake.area), median_pCO2 = median(pCO2_toc)*1e6,
            median_ECO2 = median(ECO2_toc_low, na.rm = T), 
            actual_FCO2_Mt= sum(ECO2_toc_low*lake.area*1e6/ 12.011 * 43.99 * 365 * 1e-12, na.rm = T)) %>%
  mutate(prop_area = total_area / sum(total_area) * 100,
         bin_FCO2_Mt = total_area *1e6 * median_ECO2 / 12.011 * 43.99 * 365 * 1e-12,
         bin_FCO2_swe = inland.waters * prop_area / 100 * median_ECO2 / 12.011 * 43.99 * 365 * 1e-12)

bin_swe <- dplyr::select(bin_swe, c(class.lake, n, median_area, total_area, prop_area, median_pCO2,median_ECO2, actual_FCO2_Mt, bin_FCO2_Mt, bin_FCO2_swe))

sum_table <- c(0, sum(bin_swe$n), median(swe$lake.area), sum(swe$lake.area), sum(bin_swe$prop_area),
               median(swe$pCO2_toc)*1e6, median(swe$ECO2_toc, na.rm = T), 
               sum(bin_swe$actual_FCO2_Mt),
               sum(bin_swe$bin_FCO2_Mt),
               sum(bin_swe$bin_FCO2_swe))


kable(rbind(bin_swe, sum_table), digits = 2, 
      caption = paste("Sweden. FCO2 in sampled lakes as median(ECO2) * total_area = ", 
                      round(with(swe, median(ECO2_toc_low, na.rm = T)*sum(lake.area)*1e6/ 12.011 * 43.99 * 365 * 1e-12),2), "MtCO2_eq/y; FCO2 in total sweway as median(ECO2) * inland water =",
                      round(with(swe, median(ECO2_toc_low, na.rm = T)*inland.waters/ 12.011 * 43.99 * 365 * 1e-12),2), "MtCO2_eq/y", sep = " ")) %>% 
  kable_styling()

```


```{r bin-area-finland-dep, results = T}
fin <- filter(nlss, nation == "Finland")
inland.waters <- 34515 * 1e6 # km2 to m2, @Statfi

fin$log.lake.area <- fin$lake.area %>% log10()
cut(fin$log.lake.area, breaks = 4) %>% unique()
fin$class.lake <- cut(fin$log.lake.area, breaks = 4, labels = F)


bin_fin <- fin %>% group_by(class.lake) %>% 
  summarise(n = n(),
            median_area = median(lake.area), total_area = sum(lake.area), median_pCO2 = median(pCO2_toc)*1e6,
            median_ECO2 = median(ECO2_toc, na.rm = T), 
            actual_FCO2_Mt= sum(ECO2_toc*lake.area*1e6/ 12.011 * 43.99 * 365 * 1e-12, na.rm = T)) %>%
  mutate(prop_area = total_area / sum(total_area) * 100,
         bin_FCO2_Mt = total_area *1e6 * median_ECO2 / 12.011 * 43.99 * 365 * 1e-12,
         bin_FCO2_fin = inland.waters * prop_area / 100 * median_ECO2 / 12.011 * 43.99 * 365 * 1e-12)

bin_fin <- dplyr::select(bin_fin, c(class.lake, n, median_area, total_area, prop_area, median_pCO2,median_ECO2, actual_FCO2_Mt, bin_FCO2_Mt, bin_FCO2_fin))

sum_table <- c(0, sum(bin_fin$n), median(fin$lake.area), sum(fin$lake.area), sum(bin_fin$prop_area),
               median(fin$pCO2_toc)*1e6, median(fin$ECO2_toc, na.rm = T), 
               sum(bin_fin$actual_FCO2_Mt),
               sum(bin_fin$bin_FCO2_Mt),
               sum(bin_fin$bin_FCO2_fin))


kable(rbind(bin_fin, sum_table, caption = "Finland"), digits = 2, 
      caption = paste("Finland. FCO2 in sampled lakes as median(ECO2) * total_area = ", 
                      round(with(fin, median(ECO2_toc, na.rm = T)*sum(lake.area)*1e6/ 12.011 * 43.99 * 365 * 1e-12),2), "MtCO2_eq/y; FCO2 in total finway as median(ECO2) * inland water =",
                      round(with(fin, median(ECO2_toc, na.rm = T)*inland.waters/ 12.011 * 43.99 * 365 * 1e-12),2), "MtCO2_eq/y", sep = " ")) %>% 
  kable_styling()

```


# Maps

## CBA / N112 summaries

```{r map-fCO2-norway}

map1 <- ggplot()+
  borders(region = c("Norway"), fill = "seashell2", col = "white")+xlim(4,13)+ylim(58,63)+
  geom_point(data = filter(norway, dfCO2 > 0), aes(x=long, y = lat, size = fCO2, col = survey, shape = "Supersaturated"))+
  geom_point(data = filter(norway, dfCO2 < 0), aes(x=long, y = lat, size =fCO2, col = survey, shape = "Undersaturated"))+
  labs(size = "fCO2 (atm)", col = "Survey", shape = "Saturation") +
  scale_color_manual(values = c("firebrick","dodgerblue4"))+
  scale_shape_manual(values = c(1,16))+
  #scale_size(range = c(1,6))+
  theme_void(base_size = 15)+
  theme(legend.position = "right")

map2 <- ggplot()+
  borders(region = c("Norway"), fill = "seashell2", col = "white")+xlim(4,13)+ylim(58,63)+
  geom_point(data = filter(norway, dfCO2 > 0), aes(x=long, y = lat, size = ECO2, col = survey, shape = "Supersaturated"))+
  geom_point(data = filter(norway, dfCO2 < 0), aes(x=long, y = lat, size = ECO2, col = survey, shape = "Undersaturated"))+
  labs(size = "Evasion rate of CO2 \n(g/m2/day)", col = "Survey", shape = "Saturation") +
  scale_color_manual(values = c("firebrick","dodgerblue4"))+
  scale_shape_manual(values = c(1,16))+
  #scale_size(range = c(1,6), breaks = c(1000,2000,3000,4000))+
  theme_void(base_size = 15)+
  theme(legend.position = "right")
```

```{r combine, fig.dim = c(10,4)}
ggarrange(map1, map2, common.legend = F, nrow = 2, labels = c("a)","b)"))
```

*`r fig_nums("map-norway-compare","a) pCO2 in atm and b) CO2 evasion in gC/m2/day ")`*

## pCO2

```{r map-CBA, fig.dim = c(10,5)}

fCO2_lims <- c(min(log10(norway$fCO2*1e6)), max(log10(norway$fCO2*1e6)))

cba_fCO2 <- ggplot()+
  borders(region = c("Norway"), fill = "seashell2", col = "seashell2")+xlim(4,13)+ylim(58,63)+
  geom_point(data = subset(norway, survey == "CBA_2019"), aes(x=long, y = lat, col = log10(fCO2*1e6),size = log10(fCO2*1e6)), shape = 16)+
  labs(col = "pCO2 (uatm), log scale", size = "fCO2 (uatm), log scale") +
  scale_color_continuous_sequential(rev = F, palette = "OrRd", end = 0.8, limits = fCO2_lims)+
  scale_size(range = c(0.5,3), limits = fCO2_lims)+
  guides(color = guide_legend())+
  theme_void(base_size = 15)+
  theme(legend.position = "right")

n112_fCO2 <- ggplot()+
  borders(region = c("Norway"), fill = "seashell2", col = "seashell2")+xlim(4,13)+ylim(58,63)+
  geom_point(data = subset(norway, survey == "N112_2004"), aes(x=long, y = lat, col = log10(fCO2*1e6),size = log10(fCO2*1e6)), shape = 16)+
  labs(col = "pCO2 (uatm), log scale", size = "fCO2 (uatm), log scale") +
  scale_color_continuous_sequential(rev = F, palette = "OrRd", end = 0.8, limits = fCO2_lims)+
  scale_size(range = c(0.5,3), limits = fCO2_lims)+
  guides(color = guide_legend())+
  theme_void(base_size = 15)+
  theme(legend.position = "right")

ggarrange(n112_fCO2,cba_fCO2, common.legend = F, ncol = 2, labels = c("a)","b)"))

```

*`r fig_nums("map-pCO2-log","pCO2 in atm for a) N112 and b) CBA survey")`*


```{r map-nls-fCO2}

ggplot()+
  borders(region = c("Norway", "Sweden","Finland"), fill = "seashell2", col = "seashell2")+xlim(4,35)+ylim(55,72)+
  geom_point(data = nlss, aes(x=long, y = lat, col = log10(pCO2_toc*1e6)), shape = 16, size = 1)+
  labs(col = "pCO2 (uatm), \nlog scale") +
  scale_color_continuous_sequential(rev = F, palette = "OrRd", end = 0.8)+
#  scale_size(range = c(0.5,2), breaks = c(2,3,4,5))+
  guides(color = guide_legend())+
  theme_void(base_size = 15)+
  theme(legend.position = "right")

```

*`r fig_nums("map-pCO2-log","pCO2 in log scale for the Northern Lake Survey")`*

## ECO2

```{r map-ECO2-cba, fig.dim = c(8,4)}

ECO2_lims <- c(-2,25)
leg <- "Evasion rate of CO2,\ng/m2/day"

cba_ECO2 <- ggplot()+
  borders(region = c("Norway"), fill = "seashell2", col = "seashell2")+xlim(4,13)+ylim(58,63)+
  geom_point(data = subset(norway, survey == "CBA_2019"), aes(x=long, y = lat, col = ECO2,size = ECO2), shape = 16)+
  labs(col = leg, size = leg) +
  scale_color_continuous_sequential(rev = F, palette = "Oslo", begin = 0.2, limits = ECO2_lims)+
  scale_size(range = c(0.5,2.5), limits = ECO2_lims)+
  guides(color = guide_legend())+
  theme_void(base_size = 15)+
  theme(legend.position = "right")

n112_ECO2 <- ggplot()+
  borders(region = c("Norway"), fill = "seashell2", col = "seashell2")+xlim(4,13)+ylim(58,63)+
  geom_point(data = subset(norway, survey == "N112_2004"), aes(x=long, y = lat, col = ECO2,size = ECO2), shape = 16)+
  labs(col = leg, size = leg) +
  scale_color_continuous_sequential(rev = F, palette = "Oslo", begin = 0.2, limits = ECO2_lims)+
  scale_size(range = c(0.5,2.5), limits = ECO2_lims)+
  guides(color = guide_legend())+
  theme_void(base_size = 15)+
  theme(legend.position = "right")

ggarrange(n112_ECO2,cba_ECO2, common.legend = T, ncol = 2, legend = "top", labels = c("a)","b)"))

```
*`r fig_nums("map-ECO2-norway","Evasion rate of CO2 for a) N112 and b) CBA survey, in gC/m2/day")`*

```{r map-nls-ECO2}

nls_ECO2 <- ggplot()+
  borders(region = c("Norway", "Sweden","Finland"), fill = "seashell2", col = "seashell2")+xlim(4,35)+ylim(55,72)+
  geom_point(data = subset(nlss, ECO2_toc < 100), aes(x=long, y = lat, col = ECO2_toc, size = ECO2_toc), shape = 16)+
  labs(col = leg, size = leg) +
  scale_color_continuous_sequential(rev = F, palette = "Oslo", begin = 0.2, limits = ECO2_lims)+
  scale_size(range = c(0.5,2.5), limits = ECO2_lims)+
  guides(color = guide_legend())+
  theme_void(base_size = 15)+
  theme(legend.position = "right")

print(nls_ECO2)
```

*`r fig_nums("map-ECO2-nls","Evasion rate of CO2 for the Northern Lakes Survey in gC/m2/day")`*

```{r figure-maps, fig.dim = c(8,10)}
cba_ECO2 <- cba_ECO2 + theme(legend.position = "")
n112_ECO2 <- n112_ECO2 + theme(legend.position = "")
nls_ECO2 <- nls_ECO2 + theme(legend.position = "bottom")
ggarrange(ggarrange(n112_ECO2,cba_ECO2, ncol = 2, labels = c("a) N112, 2004", "b) CBA, 2019")), nls_ECO2, nrow = 2, heights = c(2,4), labels =  c("", "c) NLS, 1995"))

```

*`r fig_nums("map-ECO2-full","Evasion rate of CO2 for a) N112, b) CBA and c) NLS survey, in gC/m2/day")`*

## South Norway

```{r map-norway-1995}

df <- nlss %>% filter(nation == "Norway") %>% filter(lat < 63)

fCO2_lims <- c(min(log10(norway$fCO2*1e6)), max(log10(norway$fCO2*1e6)))

n1995_fCO2 <- ggplot()+
  borders(region = c("Norway"), fill = "seashell2", col = "seashell2")+xlim(4,13)+ylim(58,63)+
  geom_point(data = df, aes(x=long, y = lat, col = log10(pCO2_toc*1e6), size = log10(pCO2_toc*2e6)), shape = 16)+
  labs(col = "fCO2 (uatm), \nlog scale", size = "fCO2 (uatm), \nlog scale") +
  scale_color_continuous_sequential(rev = F, palette = "OrRd", end = 0.8, limits = fCO2_lims)+
  scale_size(range = c(0.5,2), limits = fCO2_lims)+
  guides(color = guide_legend())+
  theme_void(base_size = 20)+
  theme(legend.position = "right")


ECO2_lims <- c(-2,25)

n1995_ECO2 <- ggplot()+
  borders(region = c("Norway"), fill = "seashell2", col = "seashell2")+xlim(4,13)+ylim(58,63)+
  geom_point(data = subset(df, ECO2_toc < 100), aes(x=long, y = lat, col = ECO2_toc, size = ECO2_toc), shape = 16)+
  geom_point(data = subset(df, ECO2_toc > 100), aes(x=long, y = lat), col = "firebrick", shape = 16, size = 1.5)+
  labs(col = "Evasion rate\n(gC/m2/day)", size = "Evasion rate\n(gC/m2/day)") +
  scale_color_continuous_sequential(rev = F, palette = "Oslo", begin = 0.2, limits = ECO2_lims)+
  scale_size(range = c(0.5,2), limits = ECO2_lims)+
  guides(color = guide_legend())+
  theme_void(base_size = 20)+
  theme(legend.position = "right")

```

```{r map-compare-pCO2, fig.dim = c(12,4)}
ggarrange(n1995_fCO2, n112_fCO2, cba_fCO2, labels = c("1995","2004","2019"), common.legend = T, ncol = 3, legend = "bottom")
```

*`r fig_nums("pCO2-south-norway","Maps of pCO2 in South Norway, in 1995 (NLS), 2004 (N112 survey) and 2019 (CBA survey)")`*

```{r map-compare-ECO2, fig.dim = c(12,4) }
ggarrange(n1995_ECO2, n112_ECO2,cba_ECO2, labels = c("1995","2004","2019"), common.legend = T, ncol = 3, legend = "bottom")
```

*`r fig_nums("ECO2-south-norway","Maps of ECO2 in South Norway, in 1995 (NLS), 2004 (N112 survey) and 2019 (CBA survey)")`*

`r knitr::knit_exit()`

```{r boxplots-ECO2}

ggplot()+
  geom_boxplot(aes(x = "2004", y = subset(norway, survey == "N112_2004")$ECO2, col = "2004"))+
  geom_boxplot(aes(x = "2019", y = subset(norway, survey =="CBA_2019")$ECO2, col = "2019"))+
    geom_boxplot(aes(x="1995", y = subset(nlss, nation == "Norway" & lat < 63)$ECO2_toc, col = "1995"))+
    theme_minimal()

ggplot()+
  geom_boxplot(aes(x = "2004", y = with(subset(norway, survey == "N112_2004"),fCO2/TOC), col = "2004"))+
  geom_boxplot(aes(x = "2019", y = with(subset(norway, survey =="CBA_2019"), fCO2/TOC), col = "2019"))+
    geom_boxplot(aes(x="1995", y = with(subset(nlss, nation == "Norway" & lat < 63),pCO2_toc/TOC), col = "1995"))+
  coord_trans(y = "log10")+
    theme_minimal()

ggplot()+
  geom_boxplot(aes(x = "2004", y = with(subset(norway, survey == "N112_2004"),DIC/TOC), col = "2004"))+
  geom_boxplot(aes(x = "2019", y = with(subset(norway, survey =="CBA_2019"), DIC/TOC), col = "2019"))+
    geom_boxplot(aes(x="1995", y = with(subset(nlss, nation == "Norway" & lat < 63),DIC/TOC), col = "1995"))+
  coord_trans(y = "log10")+
    theme_minimal()

ggplot()+
  geom_boxplot(aes(x = "2004", y = with(subset(norway, survey == "N112_2004"),pH), col = "2004"))+
  geom_boxplot(aes(x = "2019", y = with(subset(norway, survey =="CBA_2019"), pH), col = "2019"))+
    geom_boxplot(aes(x="1995", y = with(subset(nlss, nation == "Norway" & lat < 63),pH), col = "1995"))+
    theme_minimal()
```

# Predict fCO2 from TOC

R-squared: <https://rdrr.io/cran/rsq/man/rsq.html> <https://www.sciencedirect.com/science/article/pii/S0304407696018180>

```{r fCO2-toc-norway}

df <- norway

summary(glmfCO2norway <- glm(fCO2~TOC+0+offset(fCO2.atm), data = df, family = Gamma(link = "identity")))
coef.glmfCO2norway <- summary(glmfCO2norway)$coefficients
r2norway <- with(summary(glmfCO2norway), 1 - deviance/null.deviance) %>% round(2)
r2norway <- rsq::rsq(glmfCO2norway,adj = T, type = "kl") %>% round(2)

df$predfCO2_offset <- predict(glmfCO2norway, se = T)[1] %>% unlist
df$predfCO2_se <- predict(glmfCO2norway, se = T)[2] %>% unlist

m.norway <- ggplot(df, aes(x = TOC))+
  geom_point(aes(y = fCO2))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  geom_hline(yintercept = fCO2.atm.2004, col = "pink")+
  geom_hline(yintercept = fCO2.atm.2019, col = "pink")+
  annotate(x = 0.00005, y = 0.002, geom = "label", 
           label = paste("Slope = ", round(coef.glmfCO2norway[1],2), "\n R2 = ", r2norway))+
  #xlim(0,0.004)+ylim(0,0.2)+
  coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "N112 and CBA surveys, 2004 and 2019", col = "")+
  theme_minimal(base_size = 15)+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
  

m.norway

```

```{r check-dic-toc}

norway$DIC.TIC <- with(norway, DIC/TOC)


summary(glmfCO2norway <- glm(fCO2~TOC+0+offset(fCO2.atm), data = df, family = Gamma(link = "identity")))
coef.glmfCO2norway <- summary(glmfCO2norway)$coefficients
r2norway <- with(summary(glmfCO2norway), 1 - deviance/null.deviance) %>% round(2)

df$predfCO2_offset <- predict(glmfCO2norway, se = T)[1] %>% unlist
df$predfCO2_se <- predict(glmfCO2norway, se = T)[2] %>% unlist


m.norway <- ggplot(df, aes(x = TOC))+
  geom_point(aes(y = fCO2))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  geom_hline(yintercept = fCO2.atm.2004, col = "pink")+
  geom_hline(yintercept = fCO2.atm.2019, col = "pink")+
  annotate(x = 0.00005, y = 0.002, geom = "label", 
           label = paste("Slope = ", round(coef.glmfCO2norway[1],2), "\n R2 = ", r2norway))+
  #xlim(0,0.004)+ylim(0,0.2)+
  coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "N112 and CBA surveys, 2004 and 2019", col = "")+
  theme_minimal(base_size = 15)+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
  

m.norway
```

```{r fCO2-toc-n112}

df <- subset(norway, survey == "N112_2004")

summary(glmfCO2n112 <- glm(fCO2~TOC+0+offset(fCO2.atm), data = df, family = Gamma(link = "identity")))
coef.glmfCO2n112 <- summary(glmfCO2n112)$coefficients
r2n112 <- with(summary(glmfCO2n112), 1 - deviance/null.deviance) %>% round(2)

df$predfCO2_offset <- predict(glmfCO2n112, se = T)[1] %>% unlist
df$predfCO2_se <- predict(glmfCO2n112, se = T)[2] %>% unlist


m.n112 <- ggplot(df, aes(x = TOC))+
  geom_point(aes(y = fCO2))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  geom_hline(yintercept = fCO2.atm.2004, col = "pink")+
  annotate(x = 3.5e-5, y = 35e-3, geom = "label", 
           label = paste("Intercept =", fCO2.atm.2004*1e6," uatm","\n Slope = ", round(coef.glmfCO2n112[1],2), "\n R2 = ", r2n112))+
  xlim(1.5e-5,3.5e-3)+ylim(9e-5,0.2)+
  coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "N112 survey, 2004", col = "")+
  theme_minimal(base_size = 15)+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
  

print(m.n112)
```

```{r fCO2-toc-cba}

df <- subset(norway, survey == "CBA_2019")

summary(glmfCO2cba <- glm(fCO2~TOC+0+offset(fCO2.atm), data = df, family = Gamma(link = "identity")))
coef.glmfCO2cba <- summary(glmfCO2cba)$coefficients
r2cba <- with(summary(glmfCO2cba), 1 - deviance/null.deviance) %>% round(2)

df$predfCO2_offset <- predict(glmfCO2cba, se = T)[1] %>% unlist
df$predfCO2_se <- predict(glmfCO2cba, se = T)[2] %>% unlist


m.cba <- ggplot(df, aes(x = TOC))+
  geom_point(aes(y = fCO2))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  geom_hline(yintercept = fCO2.atm.2019, col = "pink")+
  annotate(x = 3.5e-5, y = 35e-3, geom = "label", 
           label = paste("Intercept =", fCO2.atm.2019*1e6," uatm","\n Slope = ", round(coef.glmfCO2cba[1],2), "\n R2 = ", r2cba))+
  xlim(1.5e-5,3.5e-3)+ylim(9e-5,0.2)+
  coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "CBA survey, 2019", col = "")+
  theme_minimal(base_size = 15)+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

print(m.cba)
```

```{r fCO2-toc-nlss}

summary(glmfCO2nlss <- glm(pCO2_dic~TOC+0+offset(fCO2.atm), data = nlss, family = Gamma(link = "identity")))
coef.glmfCO2nlss <- summary(glmfCO2nlss)$coefficients
r2nlss <- with(summary(glmfCO2nlss), 1 - deviance/null.deviance) %>% round(2)

nlss$predfCO2_offset <- predict(glmfCO2nlss, se = T)[1] %>% unlist
nlss$predfCO2_se <- predict(glmfCO2nlss, se = T)[2] %>% unlist


m.nlss <- ggplot(nlss, aes(x = TOC))+
  geom_point(aes(y = pCO2_dic))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  geom_hline(yintercept = fCO2.atm.1995, col = "pink")+
  annotate(x = 3.5e-5, y = 0.035, geom = "label", 
           label = paste("Intercept =", fCO2.atm.1995*1e6," uatm","\n Slope = ", round(coef.glmfCO2nlss[1],2), "\n R2 = ", r2nlss))+
  xlim(1.5e-5,3.5e-3)+ylim(9e-5,0.2)+
  coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "NLS survey, 1995", col = "")+
  theme_minimal(base_size = 15)+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

print(m.nlss)
```

```{r fCO2-toc-lowtoc-nlss, eval = F}

df <- subset(nlss, TOC < max(norway$TOC) & fCO2 < max(norway$fCO2))

summary(glmfCO2nlss <- glm(fCO2~TOC+0+offset(fCO2.atm), data = df, family = Gamma(link = "identity")))
coef.glmfCO2nlss <- summary(glmfCO2nlss)$coefficients
r2nlss <- with(summary(glmfCO2nlss), 1 - deviance/null.deviance) %>% round(2)

df$predfCO2_offset <- predict(glmfCO2nlss, se = T)[1] %>% unlist
df$predfCO2_se <- predict(glmfCO2nlss, se = T)[2] %>% unlist


m.nlss.2 <- ggplot(df, aes(x = TOC))+
  geom_point(aes(y = pCO2_dic))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  geom_hline(yintercept = fCO2.atm.1995, col = "pink")+
  annotate(x = 0.00003, y = 0.004, geom = "label", 
           label = paste("Intercept =", fCO2.atm.1995*1e6," uatm","\n Slope = ", round(coef.glmfCO2nlss[1],2), "\n R2 = ", r2nlss))+
  coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "NLS survey, 1995", col = "")+
  theme_minimal(base_size = 15)+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

m.nlss.2
```

```{r fCO2total}
 total <- data.frame(fCO2 = c(norway$fCO2, nlss$pCO2_dic),
                     fCO2.atm = c(norway$fCO2.atm, nlss$fCO2.atm),
                     TOC = c(norway$TOC, nlss$TOC),
                     pH = c(norway$pH, nlss$pH))

summary(glmfCO2total <- glm(fCO2~TOC+0+offset(fCO2.atm), data = total, family = Gamma(link = "identity")))
coef.glmfCO2total <- summary(glmfCO2total)$coefficients
r2total <- with(summary(glmfCO2total), 1 - deviance/null.deviance) %>% round(2)
r2total <- rsq(glmfCO2total, type = "kl")

total$predfCO2_offset <- predict(glmfCO2total, se = T)[1] %>% unlist
total$predfCO2_se <- predict(glmfCO2total, se = T)[2] %>% unlist


m.total <- ggplot(total, aes(x = TOC))+
  geom_point(aes(y = fCO2))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
#  geom_hline(yintercept = fCO2.atm.1995, col = "pink")+
  annotate(x = 3.5e-5, y = 0.035, geom = "label", 
           label = paste("Slope = ", round(coef.glmfCO2total[1],2), "\n R2 = ", round(r2total,2)))+
  xlim(1.5e-5,3.5e-3)+ylim(9e-5,0.2)+
  coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "All surveys", col = "")+
  theme_minimal(base_size = 15)+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

print(m.total)
```

```{r all-models, fig.dim = c(12,12)}
ggarrange(m.n112,m.cba, m.nlss, m.total, nrow = 2, ncol = 2, common.legend = T)

```

```{r fCO2-toc-nlss-gaussian, fig.dim = c(10,10)}
nlss$TOC2 <- nlss$TOC^2

summary(glmfCO2nlss <- glm(pCO2_dic~TOC+0+offset(fCO2.atm), data = nlss, family = Gamma(link = "sqrt")))
coef.glmfCO2nlss <- summary(glmfCO2nlss)$coefficients
r2nlss <- with(summary(glmfCO2nlss), 1 - deviance/null.deviance) %>% round(2)

nlss$predfCO2_offset <- predict(glmfCO2nlss, se = T)[1] %>% unlist
nlss$predfCO2_se <- predict(glmfCO2nlss, se = T)[2] %>% unlist

ggplot(nlss, aes(x = TOC))+
  geom_point(aes(y = pCO2_dic))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  geom_hline(yintercept = fCO2.atm.1995, col = "pink")+
  annotate(x = 3e-5, y = 0.035, geom = "label", 
           label = paste("Intercept =", fCO2.atm.1995*1e6," uatm","\n Slope = ", round(coef.glmfCO2nlss[1],2), "\n R2 = ", r2nlss))+
  xlim(1.5e-5,3.5e-3)+ylim(9e-5,0.2)+
  coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "NLS survey, 1995", col = "")+
  theme_minimal(base_size = 15)+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

```{r fCO2-toc-loglink}
total <- data.frame(fCO2 = c(norway$fCO2, nlss$pCO2_dic),
                     fCO2.atm = c(norway$fCO2.atm, nlss$fCO2.atm),
                     TOC = c(norway$TOC, nlss$TOC),
                     pH = c(norway$pH, nlss$pH))

summary(glmfCO2total <- glm(fCO2~TOC, data = total, family = Gamma(link = "log")))

coef.glmfCO2total <- summary(glmfCO2total)$coefficients
r2total <- with(summary(glmfCO2total), 1 - deviance/null.deviance) %>% round(2)
r2total <- rsq(glmfCO2total, type = "kl")

total$predfCO2_offset <- predict(glmfCO2total, se = T)[1] %>% unlist %>% exp()
total$predfCO2_se <- predict(glmfCO2total, se = T)[2] %>% unlist


m.total <- ggplot(total, aes(x = TOC))+
  geom_point(aes(y = fCO2))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
#  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
#  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
#  geom_hline(yintercept = fCO2.atm.1995, col = "pink")+
 annotate(x = 3.5e-5, y = 0.035, geom = "label", 
           label = paste("Slope (log) = ", round(coef.glmfCO2total[1],2), "\n R2 = ", round(r2total,2)))+
 # xlim(1.5e-5,3.5e-3)+ylim(9e-5,0.2)+
  coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "All surveys", col = "")+
  theme_minimal(base_size = 15)+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

print(m.total)
```

### NLSS fCO2-CO2 model with uncorrected TA

```{r glm-ta-fCO2, eval = F}


summary(glmfCO2nlss <- glm(ta_fCO2~TOC+0+offset(fCO2.atm), data = filter(nlss, ta_pCO2 > 0), family = Gamma(link = "identity")))
coef.glmfCO2nlss <- summary(glmfCO2nlss)$coefficients
r2nlss <- with(summary(glmfCO2nlss), 1 - deviance/null.deviance) %>% round(2)

nlss$predfCO2_offset <- predict(glmfCO2nlss, newdata = nlss, se = T)[1] %>% unlist
nlss$predfCO2_se <- predict(glmfCO2nlss, newdata = nlss, se = T)[2] %>% unlist


ggplot(nlss, aes(x = TOC))+
  geom_point(aes(y = ta_pCO2))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  geom_hline(yintercept = fCO2.atm.1995, col = "pink")+
  annotate(x = 0.001, y = -0.4, geom = "label", 
           label = paste("Intercept =", fCO2.atm.1995*1e6," uatm","\n Slope = ", round(coef.glmfCO2nlss[1],2), "\n R2 = ", r2nlss))+
 # coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm (uncorrected)", x = "TOC, mol/L", title = "NLS survey, 1995", col = "")+
  theme_minimal(base_size = 15)+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

```{r fit-evasion-rate-toc-cba}
df <- subset(norway, survey == "CBA_2019")

summary(glmECO2 <- glm(ECO2~TOC_mg+0+offset(K0*fCO2.atm), data = df, family = gaussian(link = "identity")))
coef.glmECO2 <- summary(glmECO2)$coefficients
r2ECO2 <- with(summary(glmECO2), 1 - deviance/null.deviance) %>% round(2)

df$predECO2 <- predict(glmECO2, se = T)[1] %>% unlist
df$predECO2_se <- predict(glmECO2, se = T)[2] %>% unlist


ggplot(df, aes(x = TOC_mg))+
  geom_point(aes(y = ECO2))+
    geom_line(aes(y = (predECO2), col = "predict"))+
  geom_line(aes(y = (predECO2+predECO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predECO2-predECO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  annotate(x = 3, y = 15, geom = "label", 
          label = paste("Slope = ", round(coef.glmECO2[2],2), "\n R2 = ", r2ECO2))+
  coord_trans(x="log10")+
  labs(y = "Evasion of CO2, g/m2/day", x = "TOC, mg/L", title = "CBA", col = "")+
  theme_minimal()+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

```{r fit-evasion-rate-toc-n112}
df <- subset(norway, survey == "N112_2004")

summary(glmECO2 <- glm(ECO2~TOC_mg+0+offset(K0*fCO2.atm), data = df, family = gaussian(link = "identity")))
coef.glmECO2 <- summary(glmECO2)$coefficients
r2ECO2 <- with(summary(glmECO2), 1 - deviance/null.deviance) %>% round(2)

df$predECO2 <- predict(glmECO2, se = T)[1] %>% unlist
df$predECO2_se <- predict(glmECO2, se = T)[2] %>% unlist


ggplot(df, aes(x = TOC_mg))+
  geom_point(aes(y = ECO2))+
    geom_line(aes(y = (predECO2), col = "predict"))+
  geom_line(aes(y = (predECO2+predECO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predECO2-predECO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  annotate(x = 0.5, y = 3, geom = "label", 
           label = paste("Slope = ", round(coef.glmECO2[2],2), "\n R2 = ", r2ECO2))+
  coord_trans(x="log10")+
  labs(y = "Evasion of CO2, g/m2/day", x = "TOC, mg/L", title = "N112", col = "")+
  theme_minimal()+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```
