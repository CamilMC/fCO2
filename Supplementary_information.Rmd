---
title: "Supplementary Information"
author: "Camille Crapart"
date: "2023-02-09"
output: 
   bookdown::html_document2:
     code_folding: hide
     toc_float: true
     toc: true
     number_sections: true
     fig_caption: true
     keep_tex: true

bibliography: C:\\Users\\raine\\Documents\\UiO\\Bibtex\\fCO2.bib
link-citations: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries}
library(dplyr)
library(ggplot2)
library(ggpubr)
library(cowplot)
library(colorspace)

library(rsq)

fCO2.atm.2020 <- 411.51 * 1e-6 # oct 2020
fCO2.atm.2019 <- 408.75 * 1e-6 # oct 2019
fCO2.atm.2004 <- 374.63 * 1e-6 # oct 2004
fCO2.atm.1995 <- 360.17 * 1e-6
```

# Bookdown documentation

<https://bookdown.org/yihui/bookdown/a-single-document.html>

# Import data

```{r import-data}

norway <- readRDS("norway.rds")
nlss <- readRDS("nlss.rds")

```

# Organic alkalinity

## Hruska alkalinity

```{r organic-acids, eval = T}

pKa1 <- 3.04
Ka1 <- 10^(-pKa1)

pKa2 <- 4.42
Ka2 <- 10^(-pKa2)

pKa3 <- 6.46
Ka3 <- 10^(-pKa3)

m <- 10.2*1e-6*12.011*1e3*1e-3# ueq/mg to eq/mol, site density BUT THERE IS A 1e3 PB: have to multiply by 1e-3 to stay in the range
norway$RCOO <- with(norway, (Ka1/Hplus + 2*Ka2/Hplus + 3*Ka3/Hplus)* m/3 * TOC) # estimated in eq/L

norway$RCOO_4.5 <- with(norway, (Ka1/10^(-4.5) + 2*Ka2/10^(-4.5) + 3*Ka3/10^(-4.5))* m/3 * TOC)

norway$OA_hruska <- with(norway, RCOO-RCOO_4.5)

ggplot(norway)+geom_point(aes(x = pH, y = RCOO, col = survey))
ggplot(norway)+geom_point(aes(x = log10(RCOO), y = log10(fCO2), col = survey))

norway$CA_hruska <- with(norway, TA + OA_hruska - OH + Hplus) 

norway$CO3_hruska <- with(norway,CA_hruska / (Hplus/K2 +2)) # in mol/L
norway$HCO3_hruska <- with(norway, CO3_hruska*Hplus/K2)
norway$H2CO3_hruska <- with(norway, HCO3_hruska*Hplus/K1)
norway$fCO2_hruska <- with(norway,H2CO3_hruska/K0)

norway$OA_Liu <- 0.08 * norway$TOC
norway$CA_Liu <- with(norway, TA-OA_Liu - OH + Hplus)


ggplot(norway, aes(x = CA*1e3))+
  geom_point(aes(y = (TA - OH + Hplus)*1e3, col = "CA from TA"), alpha = 0.5)+
  geom_point(aes(y = CA_hruska*1e3, col = "Modelled CA from Hruska"), alpha = 0.5)+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
  geom_smooth(aes(y = (TA-OH+Hplus)*1e3, col = "CA from TA"), method = "lm", se = F)+
  geom_smooth(aes(y = CA_hruska*1e3, col = "Modelled CA from Hruska"), method = "lm", se = F)+
  #annotate(x= 2.3, y = 2, geom = "text", label = "1:1 line")+
  labs(y = "Calculated CA, meq/L", x = "Measured CA, meq/L", col = "")+
  coord_trans(x = "log10", y = "log10")+
  facet_grid(rows = vars(survey))+
  scale_color_manual(values = c("firebrick","orange"))+
  theme_minimal()

ggplot(norway, aes(x = fCO2*1e6))+
  geom_point(aes(y = ta_fCO2*1e6, col = "fCO2 from TA"), alpha = 0.5)+
  geom_point(aes(y = fCO2_hruska*1e6, col = "fCO2 from TA corrected Hruska"), alpha = 0.5)+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
  geom_smooth(aes(y = ta_fCO2*1e6, col = "fCO2 from TA"), method = "lm", se = F)+
  geom_smooth(aes(y = fCO2_hruska*1e6, col = "fCO2 from TA corrected Hruska"), method = "lm", se = F)+
  #annotate(x= 2.3, y = 2, geom = "text", label = "1:1 line")+
  labs(y = "Calculated fCO2, uatm", x = "Measured fCO2, uatm", col = "")+
  coord_trans(x = "log10", y = "log10")+
   facet_grid(rows = vars(survey))+
  scale_color_manual(values = c("firebrick","orange"))+
  theme_minimal()

g1 <- ggplot(norway, aes(x = pH))+
  geom_point(aes(y = CA*1e3, col = "Measured"), alpha = 0.5)+
  geom_point(aes(y = CA_hruska*1e3, col = "Hruska"), alpha = 0.5)+
  geom_point(aes(y = CA_Liu*1e3, col = "Liu"), shape = "")+
  labs(x = "pH", y = "Carbonate alkalinity, meq/L")+
  scale_color_manual(values = c("firebrick","orange", "black"))+
#  facet_grid(rows = vars(survey))+
  theme_minimal()
  
g2 <- ggplot(norway, aes(x = pH))+
  geom_point(aes(y = fCO2, col = "Measured"), alpha = 0.5)+
  geom_point(aes(y = fCO2_hruska, col = "Hruska"), alpha = 0.5)+
  labs(x = "pH", y = "fCO2, atm")+
  scale_color_manual(values = c("firebrick","black"))+
 # facet_grid(rows = vars(survey))+
  theme_minimal()
```

## Liu

```{r fix-pH-OA-with-Liu}
#norway$pH_Liu <- with(norway, pH - (0.03+0.05*log10(IS)))
#norway$Hplus_Liu <- 10^(-norway$pH_Liu)
#norway$OH_Liu <- with(norway,Kw*Hplus_Liu)

norway$OA_Liu <- 0.08 * norway$TOC
norway$CA_Liu <- with(norway, TA-OA_Liu - OH + Hplus)

norway$CO3_Liu <- with(norway,CA_Liu / (Hplus/K2 +2)) # in mol/L
norway$HCO3_Liu <- with(norway, CO3_Liu*Hplus/K2)
norway$H2CO3_Liu <- with(norway, HCO3_Liu*Hplus/K1)
norway$fCO2_Liu <- with(norway,H2CO3_Liu/K0)

norway$DIC_Liu <- with(norway, H2CO3_Liu + HCO3_Liu + CO3_Liu)

ggplot(norway, aes(x = CA*1e3))+
  geom_point(aes(y = (TA - OH + Hplus)*1e3, col = "CA from TA"), alpha = 0.5)+
  geom_point(aes(y = CA_Liu*1e3, col = "Modelled CA from Liu"), alpha = 0.5)+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
  geom_smooth(aes(y = (TA-OH+Hplus)*1e3, col = "CA from TA"), method = "lm", se = F)+
  geom_smooth(aes(y = CA_Liu*1e3, col = "Modelled CA from Liu"), method = "lm", se = F)+
  #annotate(x= 2.3, y = 2, geom = "text", label = "1:1 line")+
  labs(y = "Calculated CA, meq/L", x = "Measured CA, meq/L", col = "")+
  coord_trans( x = "log10")+
  scale_color_manual(values = c("firebrick","orange"))+
  theme_minimal()

ggplot(norway, aes(x = fCO2*1e6))+
  geom_point(aes(y = ta_fCO2*1e6, col = "fCO2 from TA"), alpha = 0.5)+
  geom_point(aes(y = fCO2_Liu*1e6, col = "fCO2 from TA corrected Liu"), alpha = 0.5)+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
  geom_smooth(aes(y = ta_fCO2*1e6, col = "fCO2 from TA"), method = "lm", se = F)+
  geom_smooth(aes(y = fCO2_Liu*1e6, col = "fCO2 from TA corrected Liu"), method = "lm", se = F)+
  #annotate(x= 2.3, y = 2, geom = "text", label = "1:1 line")+
  labs(y = "Calculated fCO2, uatm", x = "Measured fCO2, uatm", col = "")+
  coord_trans( x = "log10")+
  scale_color_manual(values = c("firebrick","orange"))+
  theme_minimal()

g3 <- ggplot(norway, aes(x = pH))+
  geom_point(aes(y = CA*1e3, col = "Measured"), alpha = 0.5)+
  geom_point(aes(y = CA_Liu*1e3, col = "Liu"), alpha = 0.5)+
  labs(x = "pH", y = "Carbonate Alkalinity, meq/L")+
  scale_color_manual(values = c("orange", "black"))+
#  facet_grid(rows = vars(survey))+
  theme_minimal()

g4 <- ggplot(norway, aes(x = pH))+
  geom_point(aes(y = fCO2, col = "Measured"), alpha = 0.5)+
  geom_point(aes(y = fCO2_Liu, col = "Liu"), alpha = 0.5)+
  labs(x = "pH", y = "fCO2, atm")+
  scale_color_manual(values = c("orange", "black"))+
#  facet_grid(rows = vars(survey))+
  theme_minimal()
```

## Compare Hruska and Liu

```{r plot-hruska-liu}
library(cowplot)
ggarrange(g1,g2,g3,g4, ncol = 2, nrow = 2, common.legend = T)

```

## CBA/N112 carbonate alkalinity

```{r CA-TA}
norway$sqrtCA <- norway$CA %>% sqrt()

ggplot(norway, aes(x = log10(TA*1e3)))+
  geom_point(aes(y = log10(CA*1e3), col = survey), alpha = 0.5)+
 # geom_line(aes(y = log10(sqrt(TA*1e3))))+
  labs(x= "Total alkalinity, meq/L, log10", y= "Carbonate alkalinity, meq/L, log10")+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
  annotate(x = -2.5, y = -2.75, geom = "text", label = "1:1 line")+
  scale_color_manual(values = c("firebrick", "dodgerblue3"))+
  theme_minimal()
```

```{r empirical-model-ca}
norway$invHplus <- 1/norway$Hplus
summary(lmOAm <- glm(CA  ~ TA + invHplus:TOC, data = norway, family = Gamma(link = "sqrt")))

norway$TAOA <- predict(lmOAm, newdata = norway, type = "response")
norway$CA_pred <- with(norway, TAOA - OH + Hplus)
norway$cta_CO3 <- with(norway,(TAOA - OH + Hplus) / (Hplus/K2 +2)) # in mol/L
norway$cta_HCO3 <- with(norway, cta_CO3*Hplus/K2)
norway$cta_H2CO3 <- with(norway, cta_HCO3*Hplus/K1)
norway$cta_fCO2 <- with(norway,cta_H2CO3/K0)

ggplot(norway, aes(x = CA*1e3))+
  geom_point(aes(y = (TA - OH + Hplus)*1e3, col = "CA from TA"), alpha = 0.5)+
  geom_point(aes(y = CA_pred*1e3, col = "CA from corrected TA"), alpha = 0.5)+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
  geom_vline(xintercept = 0.07, lty = 3)+
  geom_smooth(aes(y = (TA-OH+Hplus)*1e3, col = "CA from TA"), method = "lm", se = F)+
  geom_smooth(aes(y = CA_pred*1e3, col = "CA from corrected TA"), method = "lm", se = F)+
  annotate(x= 0.004, y = 0.002, geom = "text", label = "1:1")+
  #facet_grid(rows = vars(survey))+
  labs(y = "Calculated CA, meq/L", x = "Measured CA, meq/L", col = "")+
  coord_trans( x = "log10", y = "log10")+
  scale_color_manual(values = c("firebrick","orange"))+
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        legend.position = "bottom")

ggplot(norway, aes(x = CA*1e3))+
  geom_point(aes(y = (TA - OH + Hplus)*1e3, col = "CA from TA"), alpha = 0.5)+
  geom_point(aes(y = CA_pred*1e3, col = "CA from corrected TA"), alpha = 0.5)+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
  geom_smooth(aes(y = (TA-OH+Hplus)*1e3, col = "CA from TA"), method = "lm", se = F)+
  geom_smooth(aes(y = CA_pred*1e3, col = "CA from corrected TA"), method = "lm", se = F)+
  labs(y = "Calculated CA, meq/L", x = "Measured CA, meq/L", col = "")+
  coord_trans( x = "log10", y = "log10")+
  scale_color_manual(values = c("firebrick","orange"))+
  annotate(x= 0.004, y = 0.002, geom = "text", label = "1:1")+
  facet_grid(rows = vars(survey))+
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

ggplot(norway, aes(x = fCO2))+
  geom_point(aes(y = ta_fCO2, col = "fCO2 from TA"), alpha = 0.5)+
  geom_point(aes(y = cta_fCO2, col = "fCO2 from corrected TA"), alpha = 0.5)+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
  geom_smooth(aes(y = ta_fCO2, col = "fCO2 from TA"), method = "lm", se = F)+
  geom_smooth(aes(y = cta_fCO2, col = "fCO2 from corrected TA"), method = "lm", se = F)+
  labs(y = "Calculated fCO2, atm", x = "Measured fCO2, atm", col = "")+
  coord_trans( x = "log10", y = "log10")+
  scale_color_manual(values = c("firebrick","orange"))+
 # annotate(x= 0.004, y = 0.002, geom = "text", label = "1:1")+
  #facet_grid(rows = vars(survey))+
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        legend.position = "bottom")



```

```{r visualisation-CA-pH}

g5 <- ggplot(norway, aes(x = pH))+
  geom_point(aes(y = CA*1e3, col = "Measured"), alpha = 0.5)+
  geom_point(aes(y = CA_pred*1e3, col = "CA calculated from corrected TA"), alpha = 0.5)+
  labs(x = "pH", y = "Carbonate Alkalinity, meq/L")+
  scale_color_manual(values = c("orange", "black"))+
  facet_grid(rows = vars(survey))+
  theme_minimal()

g6 <- ggplot(norway, aes(x = pH))+
  geom_point(aes(y = fCO2, col = "Measured"), alpha = 0.5)+
  geom_point(aes(y = cta_fCO2, col = "fCO2 calculated from corrected TA"), alpha = 0.5)+
  labs(x = "pH", y = "fCO2, atm")+
  scale_color_manual(values = c("orange", "black"))+
  facet_grid(rows = vars(survey))+
  theme_minimal()

ggarrange(g5,g6, common.legend = T)

g7 <- ggplot(norway, aes(x = pH))+
  geom_point(aes(y = CA*1e3, col = "Measured"), alpha = 0.5)+
  geom_point(aes(y = (TA-OH+Hplus)*1e3, col = "CA calculated from TA"), alpha = 0.5)+
  labs(x = "pH", y = "Carbonate Alkalinity, meq/L")+
  scale_color_manual(values = c("firebrick", "black"))+
  facet_grid(rows = vars(survey))+
  theme_minimal()

g8 <- ggplot(norway, aes(x = pH))+
  geom_point(aes(y = fCO2, col = "Measured"), alpha = 0.5)+
  geom_point(aes(y = ta_fCO2, col = "fCO2 calculated from TA"), alpha = 0.5)+
  labs(x = "pH", y = "fCO2, atm")+
  scale_color_manual(values = c("firebrick", "black"))+
  facet_grid(rows = vars(survey))+
  theme_minimal()

ggarrange(g7,g8, common.legend = T)

ggarrange(g5,g6,g7,g8, nrow = 2, ncol = 2, common.legend = T)

ggplot(norway, aes(x = TA*1e3))+
  geom_point(aes(y = (TA - OH + Hplus)*1e3, col = "CA from TA"), alpha = 0.5)+
  geom_point(aes(y = CA_pred*1e3, col = "CA from corrected TA"), alpha = 0.5)+
  geom_point(aes(y = CA*1e3, col = "Measured CA"), alpha = 0.5)+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
  geom_vline(xintercept = 0.07, lty = 3)+
   annotate(x= 0.004, y = 0.002, geom = "text", label = "1:1")+
  #facet_grid(rows = vars(survey))+
  labs(y = "Calculated CA, meq/L", x = "Measured TA, meq/L", col = "")+
  coord_trans( x = "log10", y = "log10")+
  scale_color_manual(values = c("firebrick","orange","dodgerblue3"))+
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        legend.position = "bottom")

```

# Northern European Lakes Survey

```{r nls-oganic-alkalinity}

lmoaM <- readRDS("lmoaM.rds")

nlss$invHplus <- 1/nlss$Hplus
nlss$invHplus2 <- 1/(nlss$Hplus^2)

nlss$TAOA <- predict(lmoaM, newdata = nlss, type = "response") # TA corrected by OA

nlss$CA_pred <- with(nlss, TAOA-OH+Hplus)
nlss$CO3 <- with(nlss,(CA_pred) / (Hplus/K2 +2)) # in mol/L
nlss$HCO3 <- with(nlss, CO3*Hplus/K2)
nlss$H2CO3 <- with(nlss, HCO3*Hplus/K1)
nlss$fCO2 <- with(nlss,H2CO3/K0)

nlss$dfCO2 <- with(nlss, fCO2 - fCO2.atm)

nlss$DIC <- with(nlss, H2CO3 + HCO3 + CO3)

pCA <- ggplot()+
  geom_point(data = nlss, aes(x = TA, y = CA_pred, col = pH))+
  geom_label(data = subset(nlss, CA_pred > 0.1), aes(x = TA, y = CA_pred, label = row.nb), nudge_y = 0.03)+
  scale_color_binned_sequential(palette = "Red")+
  theme_minimal()

pCA
```

```{r nls-fCO2-uncorrected-TA}
nlss$ta_CO3 <- with(nlss,(TA - OH + Hplus) / (Hplus/K2 +2)) # in mol/L
nlss$ta_HCO3 <- with(nlss, ta_CO3*Hplus/K2)
nlss$ta_H2CO3 <- with(nlss, ta_HCO3*Hplus/K1)
nlss$ta_fCO2 <- with(nlss,ta_H2CO3/K0)

nlss$ta_CA <- with(nlss, ta_HCO3+2*ta_CO3)

nlss$ta_dfCO2 <- with(nlss, ta_fCO2 - fCO2.atm)

pCATA <- ggplot()+
  geom_point(data = nlss, aes(x = TA, y = ta_CA, col = pH))+
#  geom_label(data = subset(nlss, CA_pred > 0.1), aes(x = TA, y = CA_pred, label = row.nb), nudge_y = 0.03)+
  scale_color_binned_sequential(palette = "Red")+
  theme_minimal()

pCATA

```

```{r plot-compare-fCO2-nls}

ggplot(nlss, aes(x = TA*1e3)) + 
  geom_point(aes(y = ta_fCO2*1e6, col = "fCO2 from uncorrected TA"), alpha = 0.5)+
  geom_point(aes(y = fCO2*1e6, col = "fCO2 from corrected TA"), alpha = 0.5)+
  geom_hline(yintercept = fCO2.atm.1995*1e6, col = "black")+
  scale_color_manual(values = c("orange","firebrick"))+
  theme_minimal()+
  labs(x = "Total alkalinity, meq/L", y = "fCO2, atm", col = "")+
  coord_trans(x = "log10", y = "log10")+
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),
        legend.position = "bottom")
```

# Predict fCO2 from TOC
R-squared: https://rdrr.io/cran/rsq/man/rsq.html

```{r fCO2-toc-norway}

df <- norway

summary(glmfCO2norway <- glm(fCO2~TOC+0+offset(fCO2.atm), data = df, family = Gamma(link = "identity")))
coef.glmfCO2norway <- summary(glmfCO2norway)$coefficients
r2norway <- with(summary(glmfCO2norway), 1 - deviance/null.deviance) %>% round(2)
r2norway <- rsq(glmfCO2norway,adj = T, type = "kl")

df$predfCO2_offset <- predict(glmfCO2norway, se = T)[1] %>% unlist
df$predfCO2_se <- predict(glmfCO2norway, se = T)[2] %>% unlist

m.norway <- ggplot(df, aes(x = TOC))+
  geom_point(aes(y = fCO2))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  geom_hline(yintercept = fCO2.atm.2004, col = "pink")+
  geom_hline(yintercept = fCO2.atm.2019, col = "pink")+
  annotate(x = 0.00005, y = 0.002, geom = "label", 
           label = paste("Slope = ", round(coef.glmfCO2norway[1],2), "\n R2 = ", r2norway))+
  #xlim(0,0.004)+ylim(0,0.2)+
  coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "N112 and CBA surveys, 2004 and 2019", col = "")+
  theme_minimal()+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
  

m.norway

```

```{ rcheck-dic-toc}

norway$DIC.TIC <- with(norway, DIC/TOC)


summary(glmfCO2norway <- glm(fCO2~TOC+0+offset(fCO2.atm), data = df, family = Gamma(link = "identity")))
coef.glmfCO2norway <- summary(glmfCO2norway)$coefficients
r2norway <- with(summary(glmfCO2norway), 1 - deviance/null.deviance) %>% round(2)

df$predfCO2_offset <- predict(glmfCO2norway, se = T)[1] %>% unlist
df$predfCO2_se <- predict(glmfCO2norway, se = T)[2] %>% unlist


m.norway <- ggplot(df, aes(x = TOC))+
  geom_point(aes(y = fCO2))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  geom_hline(yintercept = fCO2.atm.2004, col = "pink")+
  geom_hline(yintercept = fCO2.atm.2019, col = "pink")+
  annotate(x = 0.00005, y = 0.002, geom = "label", 
           label = paste("Slope = ", round(coef.glmfCO2norway[1],2), "\n R2 = ", r2norway))+
  #xlim(0,0.004)+ylim(0,0.2)+
  coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "N112 and CBA surveys, 2004 and 2019", col = "")+
  theme_minimal()+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
  

m.norway
```

```{r fCO2-toc-n112}

df <- subset(norway, survey == "N112_2004")

summary(glmfCO2n112 <- glm(fCO2~TOC+0+offset(fCO2.atm), data = df, family = Gamma(link = "identity")))
coef.glmfCO2n112 <- summary(glmfCO2n112)$coefficients
r2n112 <- with(summary(glmfCO2n112), 1 - deviance/null.deviance) %>% round(2)

df$predfCO2_offset <- predict(glmfCO2n112, se = T)[1] %>% unlist
df$predfCO2_se <- predict(glmfCO2n112, se = T)[2] %>% unlist


m.n112 <- ggplot(df, aes(x = TOC))+
  geom_point(aes(y = fCO2))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  geom_hline(yintercept = fCO2.atm.2004, col = "pink")+
  annotate(x = 3e-5, y = 35e-3, geom = "label", 
           label = paste("Intercept =", fCO2.atm.2004*1e6," uatm","\n Slope = ", round(coef.glmfCO2n112[1],2), "\n R2 = ", r2n112))+
  xlim(1.5e-5,3.5e-3)+ylim(9e-5,0.2)+
  coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "N112 survey, 2004", col = "")+
  theme_minimal()+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
  

print(m.n112)
```

```{r fCO2-toc-cba}

df <- subset(norway, survey == "CBA_2019")

summary(glmfCO2cba <- glm(fCO2~TOC+0+offset(fCO2.atm), data = df, family = Gamma(link = "identity")))
coef.glmfCO2cba <- summary(glmfCO2cba)$coefficients
r2cba <- with(summary(glmfCO2cba), 1 - deviance/null.deviance) %>% round(2)

df$predfCO2_offset <- predict(glmfCO2cba, se = T)[1] %>% unlist
df$predfCO2_se <- predict(glmfCO2cba, se = T)[2] %>% unlist


m.cba <- ggplot(df, aes(x = TOC))+
  geom_point(aes(y = fCO2))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  geom_hline(yintercept = fCO2.atm.2019, col = "pink")+
  annotate(x = 3e-5, y = 35e-3, geom = "label", 
           label = paste("Intercept =", fCO2.atm.2019*1e6," uatm","\n Slope = ", round(coef.glmfCO2cba[1],2), "\n R2 = ", r2cba))+
  xlim(1.5e-5,3.5e-3)+ylim(9e-5,0.2)+
  coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "CBA survey, 2019", col = "")+
  theme_minimal()+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

print(m.cba)
```

```{r fCO2-toc-nlss}

summary(glmfCO2nlss <- glm(fCO2~TOC+0+offset(fCO2.atm), data = nlss, family = Gamma(link = "identity")))
coef.glmfCO2nlss <- summary(glmfCO2nlss)$coefficients
r2nlss <- with(summary(glmfCO2nlss), 1 - deviance/null.deviance) %>% round(2)

nlss$predfCO2_offset <- predict(glmfCO2nlss, se = T)[1] %>% unlist
nlss$predfCO2_se <- predict(glmfCO2nlss, se = T)[2] %>% unlist


m.nlss <- ggplot(nlss, aes(x = TOC))+
  geom_point(aes(y = fCO2))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  geom_hline(yintercept = fCO2.atm.1995, col = "pink")+
  annotate(x = 3e-5, y = 0.035, geom = "label", 
           label = paste("Intercept =", fCO2.atm.1995*1e6," uatm","\n Slope = ", round(coef.glmfCO2nlss[1],2), "\n R2 = ", r2nlss))+
  xlim(1.5e-5,3.5e-3)+ylim(9e-5,0.2)+
  coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "NLS survey, 1995", col = "")+
  theme_minimal()+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

print(m.nlss)
```

```{r fCO2-toc-lowtoc-nlss, eval = F}

df <- subset(nlss, TOC < max(norway$TOC) & fCO2 < max(norway$fCO2))

summary(glmfCO2nlss <- glm(fCO2~TOC+0+offset(fCO2.atm), data = df, family = Gamma(link = "identity")))
coef.glmfCO2nlss <- summary(glmfCO2nlss)$coefficients
r2nlss <- with(summary(glmfCO2nlss), 1 - deviance/null.deviance) %>% round(2)

df$predfCO2_offset <- predict(glmfCO2nlss, se = T)[1] %>% unlist
df$predfCO2_se <- predict(glmfCO2nlss, se = T)[2] %>% unlist


m.nlss.2 <- ggplot(df, aes(x = TOC))+
  geom_point(aes(y = fCO2))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  geom_hline(yintercept = fCO2.atm.1995, col = "pink")+
  annotate(x = 0.00003, y = 0.004, geom = "label", 
           label = paste("Intercept =", fCO2.atm.1995*1e6," uatm","\n Slope = ", round(coef.glmfCO2nlss[1],2), "\n R2 = ", r2nlss))+
  coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "NLS survey, 1995", col = "")+
  theme_minimal()+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

m.nlss.2
```

```{r fig.dim = c(10,30)}
ggarrange(m.n112, m.cba, m.nlss,common.legend = T, nrow = 3)
```


```{r fCO2-toc-nlss-gaussian, fig.dim = c(10,10)}
nlss$TOC2 <- nlss$TOC^2

summary(glmfCO2nlss <- glm(fCO2~TOC+0+offset(fCO2.atm), data = nlss, family = Gamma(link = "sqrt")))
coef.glmfCO2nlss <- summary(glmfCO2nlss)$coefficients
r2nlss <- with(summary(glmfCO2nlss), 1 - deviance/null.deviance) %>% round(2)

nlss$predfCO2_offset <- predict(glmfCO2nlss, se = T)[1] %>% unlist
nlss$predfCO2_se <- predict(glmfCO2nlss, se = T)[2] %>% unlist

m.nlss <- ggplot(nlss, aes(x = TOC))+
  geom_point(aes(y = fCO2))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  geom_hline(yintercept = fCO2.atm.1995, col = "pink")+
  annotate(x = 3e-5, y = 0.035, geom = "label", 
           label = paste("Intercept =", fCO2.atm.1995*1e6," uatm","\n Slope = ", round(coef.glmfCO2nlss[1],2), "\n R2 = ", r2nlss))+
  xlim(1.5e-5,3.5e-3)+ylim(9e-5,0.2)+
  coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "NLS survey, 1995", col = "")+
  theme_minimal()+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

print(m.nlss)
```

### NLSS fCO2-CO2 model with uncorrected TA

```{r glm-ta-fCO2}

summary(glmfCO2nlss <- glm(ta_fCO2~TOC+0+offset(fCO2.atm), data = nlss, family = Gamma(link = "identity")))
coef.glmfCO2nlss <- summary(glmfCO2nlss)$coefficients
r2nlss <- with(summary(glmfCO2nlss), 1 - deviance/null.deviance) %>% round(2)

nlss$predfCO2_offset <- predict(glmfCO2nlss, se = T)[1] %>% unlist
nlss$predfCO2_se <- predict(glmfCO2nlss, se = T)[2] %>% unlist


ggplot(nlss, aes(x = TOC))+
  geom_point(aes(y = ta_fCO2))+
    geom_line(aes(y = (predfCO2_offset), col = "predict"))+
  geom_line(aes(y = (predfCO2_offset+predfCO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predfCO2_offset-predfCO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  geom_hline(yintercept = fCO2.atm.1995, col = "pink")+
  annotate(x = 0.00003, y = 0.004, geom = "label", 
           label = paste("Intercept =", fCO2.atm.1995*1e6," uatm","\n Slope = ", round(coef.glmfCO2nlss[1],2), "\n R2 = ", r2nlss))+
  coord_trans(x="log10", y = "log10")+
  labs(y = "fCO2, atm (uncorrected)", x = "TOC, mol/L", title = "NLS survey, 1995", col = "")+
  theme_minimal()+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

# Evasion rate of CO2

Wind speed <https://wcrp-cmip.github.io/CMIP6_CVs/docs/CMIP6_institution_id.html>

Data downloaded from Copernicus <https://cds.climate.copernicus.eu/cdsapp#!/dataset/derived-near-surface-meteorological-variables?tab=overview>

See part 1

Theory from @Hastie2018

$FCO_2 = A_{lake}*k*\Delta CO_2$

FCO2 in mol/day, Alake = lake area in m2, $\Delta CO_2$ in mol/m3 is the difference between water and air pCO2.

According to Vachon and Prairie 2013:

$k_{600} = 2.51 + 1.48*U_{10} + 0.39 * U_{10} * log_{10] A_{lake}$

with A in km2 and \<u in m/s

k has to be adjusted for temperature. @Vachon200:

$K_{600} = k_{CO2}*(\frac{600}{Sc_{CO2})^-n$

Get Sc for all lakes:

Schmidt number from <http://www.diva-portal.org/smash/get/diva2:779938/FULLTEXT01.pdf>

```{r norway-schmidt}

norway$Sc <- with(norway, 1923.6-125.06*temp_c+4.3733*temp_c^2-0.086781*temp_c^3) #@wanningkhof

norway$n <- NA
for(i in 1:length(norway$n)){
  if(norway$nws_m.s[i] < 3.7 & is.na(norway$nws_m.s[i]) == F){
    norway$n[i] = 2/3
  }else if(norway$nws_m.s[i] > 3.7 & is.na(norway$nws_m.s[i]) == F){
    norway$n[i] = 1/2
  } else if(is.na(norway$nws_m.s[i]) == T){
    norway$n[i] = NA
  }
} # adjusted n from Vachon


norway$k600 <- with(norway, 2.51+1.48*nws_m.s+0.39*nws_m.s*log10(lake.area)) # lake.area already in km2
                    
norway$kCO2 <- with(norway, k600*(600/Sc)^n) #m/day

norway$FCO2 <- with(norway, lake.area*1e6*kCO2*((fCO2 - fCO2.atm)*K0*1e3)) #-> lake.area in m2, dCO2 in mol/m3, k in m/day -> mol/day. K0 is in mol/L <- mol/1e-3 m3

norway$ECO2 <- with(norway, kCO2*(fCO2-fCO2.atm)*K0*1e3 * 12.011) # in gC/m2/day

norway$mgC.m2.day <- with(norway, kCO2*(fCO2-fCO2.atm)*K0*1e3 * 12.011 * 1e3) # in mgC/m2/day

norway$TOC_mg <- norway$TOC*12.011*1e3

```

```{r NLSS-schmidt}

nlss$Sc <- with(nlss, 1923.6-125.06*temp_c+4.3733*temp_c^2-0.086781*temp_c^3) #@wanningkhof

nlss$n <- NA
for(i in 1:length(nlss$n)){
  if(nlss$nws_m.s[i] < 3.7 & is.na(nlss$nws_m.s[i]) == F){
    nlss$n[i] = 2/3
  }else if(nlss$nws_m.s[i] > 3.7 & is.na(nlss$nws_m.s[i]) == F){
    nlss$n[i] = 1/2
  } else if(is.na(nlss$nws_m.s[i]) == T){
    nlss$n[i] = NA
  }
}


nlss$k600 <- with(nlss, 2.51+1.48*nws_m.s+0.39*nws_m.s*log10(lake.area)) # lake area in km2
                    
nlss$kCO2 <- with(nlss, k600*(600/Sc)^n)

nlss$FCO2 <- with(nlss, lake.area*1e6*kCO2*((fCO2 - fCO2.atm)*K0*1e3)) #-> mol/day, lake.area in m2, dfCO2 in mol/day

nlss$ECO2 <- with(nlss, kCO2*(fCO2-fCO2.atm)*K0*1e3 * 12.011) # in gC/m2/day

nlss$mgC.m2.day <- with(nlss, kCO2*(fCO2-fCO2.atm)*K0*1e3 * 12.011 * 1e3) # in mgC/m2/day

nlss$TOC_mg <- nlss$TOC*12.011*1e3
```

```{r fit-evasion-rate-toc-norway}

summary(glmECO2 <- glm(ECO2~TOC_mg+0+offset(K0*fCO2.atm), data = norway, family = gaussian(link = "identity")))
coef.glmECO2 <- summary(glmECO2)$coefficients
r2ECO2 <- with(summary(glmECO2), 1 - deviance/null.deviance) %>% round(2)

norway$predECO2 <- predict(glmECO2, se = T)[1] %>% unlist
norway$predECO2_se <- predict(glmECO2, se = T)[2] %>% unlist


ggplot(norway, aes(x = TOC_mg))+
  geom_point(aes(y = ECO2, size = DIC/TOC))+
    geom_line(aes(y = (predECO2), col = "predict"))+
  geom_line(aes(y = (predECO2+predECO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predECO2-predECO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  #geom_hline(yintercept = fCO2.atm.1995, col = "pink")+
  annotate(x = 1, y = 10, geom = "label", 
           label = paste("Slope = ", round(coef.glmECO2[2],2), "\n R2 = ", r2ECO2))+
  coord_trans(x="log10")+
  labs(y = "Evasion of CO2, g/m2/day", x = "TOC, mg/L", title = "norway", col = "")+
  theme_minimal()+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

```{r fit-evasion-rate-toc-cba}
df <- subset(norway, survey == "CBA_2019")

summary(glmECO2 <- glm(ECO2~TOC_mg+0+offset(K0*fCO2.atm), data = df, family = gaussian(link = "identity")))
coef.glmECO2 <- summary(glmECO2)$coefficients
r2ECO2 <- with(summary(glmECO2), 1 - deviance/null.deviance) %>% round(2)

df$predECO2 <- predict(glmECO2, se = T)[1] %>% unlist
df$predECO2_se <- predict(glmECO2, se = T)[2] %>% unlist


ggplot(df, aes(x = TOC_mg))+
  geom_point(aes(y = ECO2))+
    geom_line(aes(y = (predECO2), col = "predict"))+
  geom_line(aes(y = (predECO2+predECO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predECO2-predECO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  annotate(x = 3, y = 15, geom = "label", 
          label = paste("Slope = ", round(coef.glmECO2[2],2), "\n R2 = ", r2ECO2))+
  coord_trans(x="log10")+
  labs(y = "Evasion of CO2, g/m2/day", x = "TOC, mg/L", title = "CBA", col = "")+
  theme_minimal()+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

```{r fit-evasion-rate-toc-n112}
df <- subset(norway, survey == "N112_2004")

summary(glmECO2 <- glm(ECO2~TOC_mg+0+offset(K0*fCO2.atm), data = df, family = gaussian(link = "identity")))
coef.glmECO2 <- summary(glmECO2)$coefficients
r2ECO2 <- with(summary(glmECO2), 1 - deviance/null.deviance) %>% round(2)

df$predECO2 <- predict(glmECO2, se = T)[1] %>% unlist
df$predECO2_se <- predict(glmECO2, se = T)[2] %>% unlist


ggplot(df, aes(x = TOC_mg))+
  geom_point(aes(y = ECO2))+
    geom_line(aes(y = (predECO2), col = "predict"))+
  geom_line(aes(y = (predECO2+predECO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predECO2-predECO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  annotate(x = 0.5, y = 3, geom = "label", 
           label = paste("Slope = ", round(coef.glmECO2[2],2), "\n R2 = ", r2ECO2))+
  coord_trans(x="log10")+
  labs(y = "Evasion of CO2, g/m2/day", x = "TOC, mg/L", title = "N112", col = "")+
  theme_minimal()+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))

```

```{r ECO2-TOC-nlss}
df <- filter(nlss, is.na(ECO2) == F)

summary(glmECO2 <- glm(ECO2~TOC_mg+0+offset(K0*fCO2.atm), data = df, family = gaussian(link = "identity")))
coef.glmECO2 <- summary(glmECO2)$coefficients
r2ECO2 <- with(summary(glmECO2), 1 - deviance/null.deviance) %>% round(2)

df$predECO2 <- predict(glmECO2, se = T)[1] %>% unlist
df$predECO2_se <- predict(glmECO2, se = T)[2] %>% unlist


ggplot(df, aes(x = TOC_mg))+
  geom_point(aes(y = ECO2, size = DIC/TOC))+
    geom_line(aes(y = (predECO2), col = "predict"))+
  geom_line(aes(y = (predECO2+predECO2_se), col = "Std Error"), lty = 2)+
  geom_line(aes(y = (predECO2-predECO2_se), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  #geom_hline(yintercept = fCO2.atm.1995, col = "pink")+
  annotate(x = 1, y = 10, geom = "label", 
           label = paste("Slope = ", round(coef.glmECO2[2],2), "\n R2 = ", r2ECO2))+
  coord_trans(x="log10")+
  labs(y = "Evasion of CO2, g/m2/day", x = "TOC, mg/L", title = "Northern Lakes Survey", col = "")+
  theme_minimal()+
    theme(legend.position = "bottom", 
          axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1))
```

# Maps

```{r map-fCO2-norway}

map1 <- ggplot()+
  borders(region = c("Norway"), fill = "seashell2", col = "white")+xlim(4,13)+ylim(58,63)+
  geom_point(data = filter(norway, dfCO2 > 0), aes(x=long, y = lat, size = fCO2, col = survey, shape = "Supersaturated"))+
  geom_point(data = filter(norway, dfCO2 < 0), aes(x=long, y = lat, size =fCO2, col = survey, shape = "Undersaturated"))+
  labs(size = "fCO2 (atm)", col = "Survey", shape = "Saturation") +
  scale_color_manual(values = c("firebrick","dodgerblue4"))+
  scale_shape_manual(values = c(1,16))+
  #scale_size(range = c(1,6))+
  theme_void(base_size = 15)
```

```{r map-ECO2-norway}

map2 <- ggplot()+
  borders(region = c("Norway"), fill = "seashell2", col = "white")+xlim(4,13)+ylim(58,63)+
  geom_point(data = filter(norway, dfCO2 > 0), aes(x=long, y = lat, size = ECO2, col = survey, shape = "Supersaturated"))+
  geom_point(data = filter(norway, dfCO2 < 0), aes(x=long, y = lat, size = ECO2, col = survey, shape = "Undersaturated"))+
  labs(size = "Evasion rate of CO2 \n(g/m2/day)", col = "Survey", shape = "Saturation") +
  scale_color_manual(values = c("firebrick","dodgerblue4"))+
  scale_shape_manual(values = c(1,16))+
  #scale_size(range = c(1,6), breaks = c(1000,2000,3000,4000))+
  theme_void(base_size = 15)
```

```{r combine, fig.dim = c(16,8)}
ggarrange(map1, map2, common.legend = T, ncol = 2)
```

```{r map-nls}

ggplot()+
  borders(region = c("Norway", "Sweden","Finland"), fill = "seashell2", col = "seashell2")+xlim(4,35)+ylim(55,72)+
  geom_point(data = nlss, aes(x=long, y = lat, col = log10(fCO2*1e6)), shape = 16, size = 1)+
  labs(col = "fCO2 (uatm), \nlog scale") +
  scale_color_continuous_sequential(rev = F, palette = "OrRd", end = 0.8)+
#  scale_size(range = c(0.5,2), breaks = c(2,3,4,5))+
  guides(color = guide_legend())+
  theme_void(base_size = 15)+
  theme(legend.position = "right")
```

```{r map-nls-ECO2}

ggplot()+
  borders(region = c("Norway", "Sweden","Finland"), fill = "seashell2", col = "seashell2")+xlim(4,35)+ylim(55,72)+
  geom_point(data = subset(nlss, ECO2 < 100), aes(x=long, y = lat, col = ECO2), shape = 16, size = 1)+
  geom_point(data = subset(nlss, ECO2 > 100), aes(x=long, y = lat), col = "firebrick", shape = 16, size = 1.5)+
  labs(col = "Evasion rate\n(gC/m2/day)") +
  scale_color_continuous_sequential(rev = F, palette = "Oslo", begin = 0.2)+
#  scale_size(range = c(0.5,2), breaks = c(2,3,4,5))+
  guides(color = guide_legend())+
  theme_void(base_size = 15)+
  theme(legend.position = "right")

```
