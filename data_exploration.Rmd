---
title: "fCO2_exploration"
author: "Camille Crapart"
date: '2022-11-14'
output: 
  html_document:
    toc: true
    toc_float: true
    number_sections: true
    code_folding: show
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, message = T, warning = F, error = F, fig.align = "center", results = T, collapse = T)
options(knitr.kable.NA="", knitr.table.format = "html")
```


```{r libraries}
library(DBI)
library(AquaEnv)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(sf)
library(mgcv)
library(MASS)

fCO2.1995 <- 360.17
fCO2.2019 <- 410

```
## Extract soil 

https://daac.ornl.gov/SOILS/guides/Global_Soil_Regolith_Sediment.html


```{r extract-soil-depth, eval = F}
soil <- raster::raster("DAAC/average_soil_and_sedimentary-deposit_thickness.tif")
fennoscandia <- readRDS("fennoscandia.33.rds")
soil.df <- raster::extract(soil, dplyr::select(fennoscandia, c("ebint","geom"), sp = T, df = T, na.rm = T, fun = mean)
                           
# soil.sel <- soil.df %>% st_as_sf %>% dplyr::select(c("ebint","average_soil_and_sedimentary.deposit_thickness"))                         
# names(soil.sel) <- c("ebint","soil","geometry")
                          
names(soil.df) <- c("ebint","soil","geom")
saveRDS(soil.df, "soil.df.rds")

soil.df <- readRDS("soil.df.rds")
soil.df$soil[which(soil.df$soil > 50)] <- 50 # maximum value

saveRDS(soil.df, "soil.df.rds")
```

# Model fCO2 in Northern Lakes 

```{r load-data, eval = F}
con <- dbConnect(RPostgreSQL::PostgreSQL(),user = "camille.crapart", password = "camille",host = "vm-srv-wallace.vm.ntnu.no", dbname = "nofa")

ion <- tbl(con, sql("SELECT gid, ebint,nation,date,temp_c,latitude,longitude,ph,alk_e_ueq_l,alk_subst,ca_ueq_l,mg_ueq_l,na_ueq_l,k_ueq_l,nh4_ueq_l,cl_ueq_l,so4_ueq_l,no3_ueq_l,f_ueq_l,tot_p_ug_l,tot_n_ug_l,toc_mg_l FROM environmental.north_euro_lake_surv_1995 ")) %>% as.data.frame()
names(ion) <- c("gid", "ebint","nation","date","temp_c","latitude","longitude","ph","alk_ueq","alk","ca","mg","na","k","nh4","cl","so4","no3","f","tp","tn","toc")
saveRDS(ion,"ion.rds")

lakes <- st_read(con,query = "SELECT gid, ebint, geom, area, perimtot FROM environmental.ecco_biwa_lakes_v_0_1 WHERE ebint IN (SELECT ebint FROM environmental.north_euro_lake_surv_1995)")
saveRDS(lakes,"lakes.rds")

```

## Computes fCO2 in Northern Lakes 


```{r model-fco2-4D, eval = F}
ion <- readRDS("ion.rds")
lakes <- readRDS("lakes.rds")

sum(ion$alk < 0) #153 lakes
sum(ion$alk == 0) #272 lakes
sum(ion$ph == 0) #2 lakes
sum(ion$ph < 0)

ion.alk <- subset(ion, alk > 0)
ion.alk <- subset(ion.alk, ph > 4.01)

temp <- ion.alk$temp_c
temp[which(is.na(temp))] <- 4
pH <- ion.alk$ph
TA <- ion.alk$alk / 1000000 # mol / L

fCO2.1995.atm <- fCO2.1995*10^(-6) # ppm to atm



ae1 <- aquaenv(S=0, t=4, SumCO2=NULL, TA=TA, pH=pH, fCO2atm = fCO2.1995.atm)

ae2 <- aquaenv(S=0, t=temp, SumCO2=NULL, TA=TA, pH=pH, fCO2atm = fCO2.1995.atm)

plot(ae1$fCO2,ae2$fCO2)

ion.alk$fCO2 <- ae2$fCO2 * 10^6

saveRDS(ion.alk, "ion.alk.rds")
saveRDS(ae1,"ae1.rds")
saveRDS(ae2, "ae2.rds")

fennoscandia <- readRDS("fennoscandia.33.rds")
soil <- readRDS("soil.df.rds")
waterchem <- merge(fennoscandia, ion.alk, by = "ebint") %>% merge(st_drop_geometry(lakes), by = "ebint") %>% merge(st_drop_geometry(soil), by = "ebint")
lakes.waterchem <- merge(lakes, ion.alk, by = "ebint") %>% merge(st_drop_geometry(fennoscandia), by = "ebint") %>% merge(st_drop_geometry(soil), by = "ebint")

names(waterchem)[which(names(waterchem) == "area.x")] <- "area"
names(waterchem)[which(names(waterchem) == "area.y")] <- "lake.area"

saveRDS(waterchem,"waterchem.rds")
saveRDS(lakes.waterchem,"lakes.waterchem.rds")

```

## Convenience df

```{r log10-transform, eval = T}

waterchem <- readRDS("waterchem.rds")

wtc <- dplyr::select(st_drop_geometry(waterchem),c("fCO2","area","lake.area","perimtot","Slope","Alt", "soil","latitude.x","longitude.x","NDVI","Arable","Bog","Forest","Bare","Runoff","Temp","Precip","ph","alk","ca","mg","na","k","so4","no3","nh4","cl","f","tp","tn","toc"))

wtc$is <- wtc %>% dplyr::select(c("ca","mg","na","k","so4","no3","nh4","cl","f")) %>% rowSums()
wtc$dev.sat <- abs(wtc$fCO2 - fCO2.1995)
# wtc$sat <- NA
# wtc$sat[which(wtc$fCO2 > fCO2.1995)] <- "over"
# wtc$sat[which(wtc$fCO2 > fCO2.1995)] <- "under"


logwtc <- filter(wtc, nh4 != 0 & no3 != 0 )

logwtc$log10fCO2 <- logwtc$fCO2 %>% log10()
logwtc$log10Slope <- logwtc$Slope %>% log10()
logwtc$log10soil <- logwtc$soil %>% log10()
logwtc$log10Runoff <- logwtc$Runoff %>% log10()
logwtc$log10Precip <- logwtc$Precip %>% log10()
logwtc$log10ca <- logwtc$ca %>% log10()
logwtc$log10so4 <- logwtc$so4 %>% log10()
logwtc$log10no3 <- logwtc$no3 %>% log10()
logwtc$log10nh4 <- logwtc$nh4 %>% log10()
logwtc$log10tn <- logwtc$tn %>% log10()
logwtc$log10tp <- logwtc$tp %>% log10()
logwtc$log10toc <- logwtc$toc %>% log10()

oversat <- subset(wtc,fCO2 >= fCO2.1995)
undersat <- subset(wtc,fCO2 < fCO2.1995)
```


```{r match-catchment, eval = F}
library(colorspace)

waterchem <- readRDS("waterchem.rds")


p1 <- ggplot(waterchem)+geom_point(aes(x=toc, y = TOC, col = nation.x))
ggsave("TOC_compare.png", p1)

g1 <- ggplot(waterchem)+geom_sf(aes(fill=log10(fCO2), col = log10(fCO2)))+
    scale_colour_continuous_divergingx(palette = "RdYlBu", mid = log10(fCO2.1995), aesthetics = c("fill", "col"), name = "log10(fCO2)")+
    theme_minimal()
ggsave("map_fco2.png",g1, width = 12, height = 16, unit = "cm", dpi = "retina")

g2 <- ggplot(waterchem)+geom_point(aes(x = longitude.x, y = latitude.x, fill=log10(fCO2), col = log10(fCO2)))+
    scale_colour_continuous_divergingx(palette = "RdYlBu", mid = log10(fCO2.1995), aesthetics = c("fill", "col"), name = "log10(fCO2)")+
    theme_minimal()
ggsave("map_lakes_fco2.png",g2, width = 12, height = 16, unit = "cm", dpi = "retina")

g3 <- ggplot(waterchem)+geom_point(aes(x = longitude.x, y = latitude.x, fill=log10(alk), col = log10(alk)))+
    scale_colour_continuous_divergingx(palette = "RdYlBu", mid = log10(1000), aesthetics = c("fill", "col"), name = "log10(alk, ueq/L)")+
    theme_minimal()
ggsave("map_lakes_alk.png",g3, width = 12, height = 16, unit = "cm", dpi = "retina")



h1 <- ggplot(waterchem)+geom_histogram(aes(group = fCO2, x = log10(fCO2), fill = log10(fCO2), col = log10(fCO2)))+
  scale_colour_continuous_divergingx(palette = "RdYlBu", mid = log10(fCO2.1995), aesthetics = c("fill", "col"), name = "log10(fCO2)")+
  geom_vline(xintercept = log10(fCO2.1995), col = "red")+theme_minimal()
ggsave("hist_fCO2.png",h1, width = 12, height = 8, unit = "cm", dpi = "retina") 



t1 <- ggplot(waterchem, aes(x = log10(toc)))+
  geom_ribbon(aes(ymin = -Inf, ymax = log10(fCO2.1995), fill = "undersaturated"), alpha = 0.25)+
  geom_ribbon(aes(ymax = +Inf, ymin = log10(fCO2.1995),fill = "oversaturated"), alpha = 0.25)+
  geom_hline(yintercept = log10(fCO2.1995))+
  scale_fill_manual(values = c("lightgray","darkgray"), name = "Oversaturation")+
  geom_point(aes(y=log10(fCO2), col = latitude.x))+
  scale_color_viridis_c()+
  theme_minimal()

ggsave("CO2_oversaturation.png",t1, width = 15, height = 10, unit = "cm", dpi = "retina")

t2 <- ggplot(waterchem, aes(x = toc))+
  geom_ribbon(aes(ymin = -Inf, ymax = fCO2.1995, fill = "undersaturated"), alpha = 0.25)+
  geom_ribbon(aes(ymax = +Inf, ymin = fCO2.1995,fill = "oversaturated"), alpha = 0.25)+
  geom_hline(yintercept = fCO2.1995)+
  scale_fill_manual(values = c("lightgray","darkgray"), name = "Oversaturation")+
  geom_point(aes(y=fCO2, col = latitude.x))+
  scale_color_viridis_c()+
  theme_minimal()

ggplot()+
 # scale_colour_continuous_divergingx(palette = "RdYlBu", mid = 5, aesthetics = c("col"))+
  geom_point(data = oversat, aes(y = log10(fCO2-fCO2.1995), x = Temp, col = "oversat"))+
  geom_smooth(data = oversat, aes(y = log10(fCO2-fCO2.1995), x = Temp), col = "black", formula = y~x)+
  geom_point(data = undersat, aes(y = log10(abs(fCO2-fCO2.1995)), x = Temp, col = "undersat"))+
    geom_smooth(data = undersat, aes(y = log10(abs(fCO2-fCO2.1995)), x = Temp), col = "gray", formula = y~x)+
    theme_minimal()


ggplot()+
 # scale_colour_continuous_divergingx(palette = "RdYlBu", mid = 5, aesthetics = c("col"))+
  geom_point(data = oversat, aes(y = log10(fCO2-fCO2.1995), x = Temp, col = "oversat"))+
  geom_smooth(data = oversat, aes(y = log10(fCO2-fCO2.1995), x = Temp), col = "black", formula = y~x)+
  geom_point(data = undersat, aes(y = log10(abs(fCO2-fCO2.1995)), x = Temp, col = "undersat"))+
    geom_smooth(data = undersat, aes(y = log10(abs(fCO2-fCO2.1995)), x = Temp), col = "gray", formula = y~x)+
    theme_minimal()

ggplot()+
  scale_colour_continuous_divergingx(palette = "RdYlBu", mid = 5, aesthetics = c("col"))+
  geom_point(data = oversat, aes(col = log10(fCO2-fCO2.1995), x = Temp, y = log10(alk)))+
  geom_smooth(data = oversat, aes(y = log10(alk), x = Temp), col = "black", formula = y~x)+
  geom_point(data = undersat, aes(col = log10(abs(fCO2-fCO2.1995)), x = Temp, y = log10(alk)))+
    geom_smooth(data = undersat, aes(y = log10(alk), x = Temp), col = "gray", formula = y~x)+
    theme_minimal()


ggplot(waterchem)+geom_point(aes(x = longitude.x, y = latitude.x, fill=soil, col = soil))+
    scale_colour_continuous_divergingx(palette = "RdYlBu", mid = 50, aesthetics = c("fill", "col"), name = "soil depth")+
    theme_minimal()

ggplot()+
  scale_colour_continuous_divergingx(palette = "RdYlBu", mid = 5, aesthetics = c("col"))+
  geom_point(data = oversat, aes(y = dev.sat, x = log10(soil), col = log10(alk)))+
  geom_smooth(data = oversat, aes(y = dev.sat, x = log10(soil)), col = "black", formula = y~x)+
  geom_point(data = undersat, aes(y = dev.sat, x = log10(soil), col = log10(alk)))+
    geom_smooth(data = undersat, aes(y = dev.sat, x = log10(soil)), col = "gray", formula = y~x)+
    theme_minimal()

```

`r knitr::include_graphics(c("map_fCO2.png", "hist_fCO2.png","CO2_oversaturation.png"))`


## Corplot and PCA

```{r plots, fig.dim = c(15,15)}

corrplot::corrplot.mixed(cor(dplyr::select(wtc, c("fCO2","area","lake.area","perimtot","Slope","Alt","soil","latitude.x","longitude.x","toc"))), tl.cex = 1.5, number.cex = 1.5)
corrplot::corrplot.mixed(cor(dplyr::select(wtc, c("fCO2","NDVI","Arable","Bog","Forest","Bare","Runoff","Temp","Precip","toc"))), tl.cex = 1.5, number.cex = 1.5)
corrplot::corrplot.mixed(cor(dplyr::select(wtc, c("fCO2","ph","alk","is","ca","mg","na","k","cl","so4","f","no3","nh4","tp","tn","toc"))), tl.cex = 1.5, number.cex = 1.5)
```
```{r pca-total, fig.dim = c(12,10)}

library(viridisLite)
library(factoextra)

pca.rr <- prcomp(formula = ~., data = wtc, center = T, scale. = T)

plot.pca.12 <- fviz_pca_var(pca.rr,
                              habillage = "none",
                             label = "var",
                             col.var = "black",
                             labelsize = 7,
                             repel = T,arrowsize=1)+theme_bw(base_size=30)

plot.pca.23 <- fviz_pca_var(pca.rr, axes = c(2,3),
                              habillage = "none",
                             label = "var",
                             labelsize = 7,
                             col.var = "black",
                             repel = T,arrowsize=1)+theme_bw(base_size=30)
par(mfrows = c(1,2))
plot.pca.12
plot.pca.23

``` 


# fCO2 modelled with TOC

## fCO2 modelled with TOC, LM 

Fit fCO2 with only TOC as predictor:

```{r fCO2-TOC}

lm1 <- lm(fCO2~toc, data = wtc)
summary(lm1)

wtc$fplm <- predict(lm1, type = "response")
ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2), col = "Obs"))+geom_point(aes(y = log10(fplm), col = "Pred"))+
  annotate(geom = "text",label = paste("AIC",round(extractAIC(lm1)[2]), sep = "="), x = 0, y = 3.5)+
  scale_color_manual(values = c("lightblue","black"))+theme_minimal()

extractAIC(lm1)

```



```{r fCO2-TOC-log}

lm1b <- lm(log10fCO2~log10toc, data = logwtc)
summary(lm1b)


logwtc$fplm <- predict(lm1b, type = "response")
ggplot(logwtc,aes(x=log10toc))+geom_point(aes(y=log10fCO2, col = "Obs"))+geom_point(aes(y = fplm, col = "Pred"))+
  annotate(geom = "text",label = paste("AIC",round(extractAIC(lm1b)[2]), sep = "="), x = 0, y = 3.5)+
  scale_color_manual(values = c("lightblue","black"))+theme_minimal()
```

```{r test-double}
lmover <- lm(fCO2~toc, data = oversat)
lmunder <- lm(fCO2~toc, data = undersat)
summary(lmover)
summary(lmunder)

oversat$pred <- predict(lmover, type = "response") %>% log10()
undersat$pred <- predict(lmunder, type = "response") %>% log10()

ggplot()+geom_point(data = wtc, aes(x = log10(toc), y = log10(fCO2), col = "obs"))+
  geom_point(data = oversat, aes(x = log10(toc), y = pred, col = "over"))+
  geom_point(data = undersat, aes(x = log10(toc), y = pred, col = "under"))+
  scale_color_manual(values = c("lightblue","black","darkgray"))+
  theme_minimal()

```
## fCO2-TOC with GAM and Gamma distribution 

```{r gam-fco2-toc}
g1 <- mgcv::gam(fCO2~toc, data = wtc, family = Gamma(link = "identity"))
summary(g1)

wtc$fpg <- predict(g1,type = "reponse")
ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2), col = "Obs"))+geom_point(aes(y = log10(fpg), col = "Pred"))+
  annotate(geom = "text",label = paste("AIC",round(extractAIC(g1)[2]), sep = "="), x = 0, y = 3.5)+
  scale_color_manual(values = c("lightblue","black"))+theme_minimal()

g1b <- mgcv::gam(log10fCO2~log10toc, data = logwtc, family = Gamma(link = "identity"), method = "REML")
summary(g1b)

logwtc$fpg <- predict(g1b, type = "response")
ggplot(logwtc,aes(x=log10toc))+geom_point(aes(y=log10fCO2, col = "Obs"))+geom_point(aes(y = fpg, col = "Pred"))+
  annotate(geom = "text",label = paste("AIC",round(extractAIC(g1b)[2]), sep = "="), x = 0, y = 3.5)+
  scale_color_manual(values = c("lightblue","black"))+theme_minimal()

g1c <- mgcv::gam(fCO2~toc, data = wtc, family = Gamma(link = "log"))
summary(g1c)

wtc$fpgc <- predict(g1c,type = "reponse")
ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2), col = "Obs"))+geom_point(aes(y = fpgc, col = "Pred"))+
  annotate(geom = "text",label = paste("AIC",round(extractAIC(g1c)[2]), sep = "="), x = 0, y = 3.5)+
  scale_color_manual(values = c("lightblue","black"))+theme_minimal()
```



## GAM with Tweedie


```{r fCO2-TOC-tweedie}
t1 <- gam(list(fCO2~toc,~1, ~1), data = wtc, family = twlss(link = list("identity","identity","identity")))
summary(t1)

wtc$fpt <- predict(t1, type = "response")[,1]
ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2), col = "Obs"))+geom_point(aes(y = log10(fpt), col = "Pred"))+
  annotate(geom = "text",label = paste("AIC",round(extractAIC(t1)[2]), sep = "="), x = 0, y = 3.5)+
  scale_color_manual(values = c("lightblue","black"))+theme_minimal()
```

```{r logfCO2-logTOC-tweedie}

t1b <- gam(list(log10fCO2~log10toc,~1, ~1), data = logwtc, family = twlss(link = list("identity","identity","identity")))
summary(t1b)

logwtc$fpt <- predict(t1b, type = "response")[,1]
ggplot(logwtc,aes(x=log10toc))+geom_point(aes(y=log10fCO2, col = "Obs"))+geom_point(aes(y = fpt, col = "Pred"))+
  annotate(geom = "text",label = paste("AIC",round(extractAIC(t1b)[2]), sep = "="), x = 0, y = 3.5)+
  scale_color_manual(values = c("lightblue","black"))+theme_minimal()
```

```{r fCO2-lTOC-tweedie-loglink}

t1c <- gam(list(fCO2~toc,~1, ~1), data = wtc, family = twlss(link = list("log","identity","identity")))
summary(t1c)

 
wtc$fptc <- predict(t1c, type = "response")[,1]
ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2), col = "Obs"))+geom_point(aes(y = log10(fptc), col = "Pred"))+
  annotate(geom = "text",label = paste("AIC",round(extractAIC(t1c)[2]), sep = "="), x = 0, y = 3.5)+
  scale_color_manual(values = c("lightblue","black"))+theme_minimal()
```

```{r test-double-tweedie}

twover <- gam(list(fCO2~toc,~1,~1), data = oversat,family = twlss(link = list("identity","identity","identity")))
twunder <- gam(list(fCO2~toc,~1,~1), data = undersat,family = twlss(link = list("identity","identity","identity")))
summary(twover)
summary(twunder)

oversat$pred_tw <- predict(twover, type = "response")[,1] %>% log10()
undersat$pred_tw <- predict(twunder, type = "response")[,1] %>% log10()

ggplot()+geom_point(data = wtc, aes(x = log10(toc), y = log10(fCO2), col = "obs"))+
  geom_point(data = oversat, aes(x = log10(toc), y = pred_tw, col = "over"))+
  geom_point(data = undersat, aes(x = log10(toc), y = pred_tw, col = "under"))+
  scale_color_manual(values = c("lightblue","black","darkgray"))+
  theme_minimal()

```

## GLM with gamma

Fit fCO2 with only TOC as predictor:

```{r fCO2-TOC-glm}
glm1 <- glm(fCO2~toc, data = wtc, family = Gamma(link = "identity"))
summary(glm1)

wtc$fpg <- predict(glm1, type = "response")
ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2), col = "Obs"))+geom_point(aes(y = log10(fpg), col = "Pred"))+
  annotate(geom = "text",label = paste("AIC",round(extractAIC(glm1)[2]), sep = "="), x = 0, y = 3.5)+
  scale_color_manual(values = c("lightblue","black"))+theme_minimal()
```

```{r logfCO2-logTOC-glm}
glm1b <- glm(log10fCO2~log10toc, data = logwtc, family = Gamma(link = "identity"))
summary(glm1b)

logwtc$fpg <- predict(glm1b,  type = "response")
ggplot(logwtc,aes(x=log10toc))+geom_point(aes(y=log10fCO2, col = "Obs"))+geom_point(aes(y = fpg, col = "Pred"))+
  annotate(geom = "text",label = paste("AIC",round(extractAIC(glm1b)[2]), sep = "="), x = 0, y = 3.5)+
  scale_color_manual(values = c("lightblue","black"))+theme_minimal()

```

```{r glm}
glm1c <- glm(fCO2~toc, data = wtc, family = Gamma(link = "log"))
summary(glm1c)

wtc$fpgc <- predict(glm1c, type = "response")
ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2), col = "Obs"))+
  geom_point(aes(y = log10(fpgc), col = "Pred"))+scale_color_manual(values = c("lightblue","black"))+
  annotate(geom = "text",label = paste("AIC",round(extractAIC(glm1c)[2]), sep = "="), x = 0, y = 3.5)+
  theme_minimal()

```


# Test on CBA data

## Load and merge biochemistry data (CBA) and catchment data (NIVA)

```{r load-data-niva, eval = F}
id.niva <- read_xlsx("id_niva.xlsx")

catchment.poly <- st_read("catchments_poly/lakes1000cat.shp")
niva.stations <- st_read("catchments_poly/lakes1000stations.shp")
niva.data <- read_xlsx("niva_selection.xlsx", sheet = "niva")

all.niva <- st_drop_geometry(niva.stations) %>% merge(niva.data, by.x = "sttn_cd", by.y = "station_code") %>% merge(catchment.poly, by.x = "statn_d", by.y= "station_id")

#bdg.stations <- id.niva %>% merge(niva.stations, by.x = "STATION_ID", by.y = "sttn_cd") %>% merge(niva.data, by.x = "STATION_ID", by.y = "station_code")
bdg.niva <- id.niva %>% merge(all.niva, by.x = "STATION_ID", by.y = "sttn_cd") %>% st_as_sf()

missing.bdg <- id.niva %>% filter(!STATION_ID %in% bdg.niva$STATION_ID)

saveRDS(bdg.niva, "bdg.niva.rds")
```

```{r load-73-lakes}
bdg.niva <- readRDS("bdg.niva.rds")

cba <- readxl::read_xlsx("CBA_100Lakes_Master.xlsx")

cba.total <- merge(cba,bdg.niva, by.x = "Lake_ID", by.y = "CBA_Lake_ID")

cba.sel <- cba.total %>% dplyr::select(c("Lake_ID","CO2","basin_area_km2","lake_area_km2","latitude","longitude","agriculture","peat","forest","era_runoff_1981_2010","era_temp_1981_2010","era_prec_1981_2010","nilu_ndep_2012_2016","pH","Alkalinity","Ca","SO4","NO3","TOTP","TN","TOC","T","geometry"))
cba.sel <- cba.sel %>% filter(!is.na(Alkalinity))

dim(cba.sel)

cba.sel[,-which(names(cba.sel) == "geometry")] <- apply(cba.sel[,-which(names(cba.sel) == "geometry")], 2, as.numeric)

#names(cba.sel) <- c("Lake_ID","fCO2","area","lake.area","Arable","Bog","Forest","Runoff","Temp","Precip","ph","Ca","SO4","NO3","TOTP","TN","TOC","geometry")

# conversion from mg/L to ueq/L
cba.sel$area <- cba.sel$basin_area_km2 * 10^6
cba.sel$lake.area <- cba.sel$lake_area_km2 * 10^6
cba.sel$ca <- cba.sel$Ca / 40.078 * 2 * 1000
cba.sel$so4 <- cba.sel$SO4/(32.06+15.999*4) * 2 * 1000 
cba.sel$no3 <- cba.sel$NO3/(14.007+15.999*3) * 2 * 1000
cba.sel$tp <- cba.sel$TOTP
cba.sel$tn <- cba.sel$TN * 1000
cba.sel$toc <- cba.sel$TOC
cba.sel$alk <- cba.sel$Alkalinity * 10^3

cba.sel$log10Runoff <- cba.sel$era_runoff_1981_2010 %>% log10()
cba.sel$Forest <- cba.sel$forest
cba.sel$Bog <- cba.sel$peat
cba.sel$Arable <- cba.sel$agriculture
cba.sel$log10Precip <- cba.sel$era_prec_1981_2010 %>% log10()
cba.sel$log10ca <-cba.sel$Ca %>% as.numeric() %>% log10()
cba.sel$log10so4 <- cba.sel$so4 %>% log10()
cba.sel$log10no3 <- cba.sel$no3 %>% log10()
cba.sel$log10tp <- cba.sel$TOTP %>% log10()
cba.sel$log10tn <- cba.sel$TN %>% log10()
cba.sel$log10toc <- cba.sel$TOC %>% log10()
cba.sel$Temp <- cba.sel$T
cba.sel$ph <- cba.sel$pH
cba.sel$TNdep <- cba.sel$nilu_ndep_2012_2016

saveRDS(cba.sel,"cba.sel.rds")

```

## NDVI

```{r download-NDVI-raster-2015, eval = F}
# http://poles.tpdc.ac.cn/en/data/9775f2b4-7370-4e5e-a537-3482c9a83d88/
library(gimms)
ndvi.2015 <- downloadGimms(x= 2015,y=2015,dsn = "NDVI")
 
ndvi.max.2015 <- monthlyComposite(ndvi.2015,monthlyIndices(ndvi.2015), overwrite = T, filename = "ndvi.max.2015.nc")
saveRDS(ndvi.max.2015,"NDVI/ndvi.max.2015.rds")
```

```{r NDVI, eval = F}
ndvi.max.2015 <- readRDS("NDVI/ndvi.max.2015.rds")
cba.poly <- readRDS("cba.sel.rds") %>% dplyr::select(c("Lake_ID","geometry")) %>% st_as_sf()

# Makes the raster smaller, ensuring faster processing of the data
scandinavia <- as(extent(0,35,55,73),"SpatialPolygons")
summer.scandinavia.2015 <- raster::crop(ndvi.max.2015,scandinavia)

# Re-introduces NA
summer.scan <- reclassify(summer.scandinavia.2015, cbind(-Inf, 0, NA), right=FALSE)

# Stack bands for summer
summer.mean.2015 <- raster::stack(summer.scan[[6]],summer.scan[[7]],summer.scan[[8]]) %>% mean()

# extract data
summer.ndvi.2015 <- raster::extract(summer.mean.2015,cba.poly, fun = mean, df = T, sp = T, na.rm = T)
names(summer.ndvi.2015) <- c("Lake_ID","ndvi")
summer.ndvi.2015$NDVI <- floor(summer.ndvi.2015$ndvi/10)/1000

# save df
saveRDS(summer.ndvi.2015, "NDVI/100lakes.summer.ndvi.2015.rds")
write.csv(summer.ndvi.2015,"NDVI/100lakes.summer.ndvi.2015.csv")
```

## Compute fCO2 in CBA lakes

fCO2 in 2019: 410 ppm 
https://www.eea.europa.eu/ims/atmospheric-greenhouse-gas-concentrations

```{r model-fCO2-CBA}
fCO2.2019 <- 410.5 
temp <- cba.sel$T
TA <- cba.sel$alk / 1000000
pH <- cba.sel$pH
CO2 <- cba.sel$CO2 * 10^(-6)
ae3 <- aquaenv(S=0, t=temp,pH = pH, TA=TA, SumCO2 = NULL, fCO2atm = fCO2.2019 * 10^6)
cba.sel$fCO2 <- ae3$fCO2 *10^6

```

```{r catchment-cba, eval = F}
summer.ndvi.2015 <- readRDS("NDVI/100lakes.summer.ndvi.2015.rds")
cba.sf <- merge(cba.sel,summer.ndvi.2015,by = "Lake_ID") %>% st_as_sf()

library(colorspace)

g1 <- ggplot(cba.sf)+geom_sf(aes(fill=log10(fCO2), col = log10(fCO2)))+
    scale_colour_continuous_divergingx(palette = "RdYlBu", mid = log10(fCO2.1995), aesthetics = c("fill", "col"), name = "log10(fCO2)")+
    theme_minimal()
ggsave("map_fco2_cba.png",g1, width = 12, height = 16, unit = "cm", dpi = "retina")

h1 <- ggplot(cba.sf)+geom_histogram(aes(group = fCO2, x = log10(fCO2), fill = log10(fCO2), col = log10(fCO2)))+
  scale_colour_continuous_divergingx(palette = "RdYlBu", mid = log10(fCO2.2019), aesthetics = c("fill", "col"), name = "log10(fCO2)")+
  geom_vline(xintercept = log10(fCO2.2019), col = "red")+theme_minimal()
ggsave("hist_fCO2_cba.png",h1, width = 12, height = 8, unit = "cm", dpi = "retina") 



t1 <- ggplot(cba.sf, aes(x = log10(toc)))+
  geom_ribbon(aes(ymin = -Inf, ymax = log10(fCO2.2019), fill = "undersaturated"), alpha = 0.25)+
  geom_ribbon(aes(ymax = +Inf, ymin = log10(fCO2.2019),fill = "oversaturated"), alpha = 0.25)+
  geom_hline(yintercept = log10(fCO2.2019))+
  scale_fill_manual(values = c("lightgray","darkgray"), name = "Oversaturation")+
  geom_point(aes(y=log10(fCO2), col = latitude))+
  scale_color_viridis_c()+
  theme_minimal()

ggsave("CO2_oversaturation_cba.png",t1, width = 12, height = 8, unit = "cm", dpi = "retina")


```

`r knitr::include_graphics(c("map_fCO2_cba.png", "hist_fCO2_cba.png","CO2_oversaturation_cba.png"))`

## Test and compare LM and GAM 

Selected  models: lm1, g1b (on log-transformed data), t1, glm1

```{r test-predict-fCO2-toc}

models <- c("GAM on log transformed data", "GLM with id link","GLM with log link","LM", "Tweedie with id link", "Tweedie with log link")

summer.ndvi.2015 <- readRDS("NDVI/100lakes.summer.ndvi.2015.rds")
cba.sf <- merge(cba.sel,summer.ndvi.2015,by = "Lake_ID") %>% st_as_sf()
cba.sf$log10fCO2lm <- predict(lm1,newdata = cba.sf, type = "response") %>% log10()
cba.sf$log10fCO2gam <- predict(g1b, newdata = cba.sf, type = "response")
cba.sf$log10fCO2tweedie <- predict(t1,newdata = cba.sf, type = "response")[,1] %>% log10()
cba.sf$log10fCO2glm <- predict(glm1, newdata = cba.sf, type = "response") %>% log10()

cba.sf$log10fCO2glm_log <- predict(glm1c, newdata = cba.sf, type = "response") %>% log10()
cba.sf$log10fCO2tweedie_log <- predict(t1c,newdata = cba.sf, type = "response")[,1] %>% log10()


ggplot(cba.sf, aes(x=log10(fCO2)))+
   geom_point(aes(y=log10fCO2lm, col = "LM", shape = "LM"))+
  geom_point(aes(y=log10fCO2glm, col = "GLM-gamma-id", shape = "GLM-gamma-id"))+
  geom_point(aes(y = log10fCO2tweedie, col = "Tweedie", shape = "Tweedie"))+
  geom_point(aes(y=log10fCO2gam, col = "GAM", shape = "GAM"))+
  geom_point(aes(y = log10fCO2glm_log, col = "GLM-gamma-log", shape = "GLM-gamma-log"))+
  geom_point(aes(y=log10fCO2tweedie_log, col = "Tweedie-log", shape = "Tweedie-log"))+
  geom_abline(slope = 1, intercept = 0, col = "red")+
  scale_color_manual(name = "Model", labels = models, values = as.vector(palette.colors(n=6)))+
  scale_shape_manual(name = "Model", labels = models, values = c(15,16,17,18, 25, 8))+
  labs(y = "Predicted log10fCO2", x = "Aquaenv log10fCO2")+
  theme_minimal()

ggplot(cba.sf, aes(x=log10toc))+
  geom_point(aes(y = log10(fCO2)), col = "gray")+
  geom_point(aes(y = log10fCO2glm_log, col = "GLM-gamma-log", shape = "GLM-gamma-log"),size = 3)+
  geom_point(aes(y=log10fCO2tweedie_log, col = "Tweedie-log", shape = "Tweedie-log"), size = 2)+
  geom_point(aes(y=log10fCO2gam, col = "GAM", shape = "GAM"), size = 2)+
  geom_point(aes(y=log10fCO2glm, col = "GLM-gamma-id", shape = "GLM-gamma-id"),size = 3)+
  geom_point(aes(y=log10fCO2lm, col = "LM", shape = "LM"), size = 2)+
  geom_point(aes(y = log10fCO2tweedie, col = "Tweedie", shape = "Tweedie"), size = 1)+
  geom_hline(yintercept = log10(fCO2.2019), col = "red")+
  scale_color_manual(name = "Model", labels = models , values = as.vector(palette.colors(n=6)))+
  scale_shape_manual(name = "Model", labels = models, values = c(rep(19,6)))+
  labs(y = "Predicted log10fCO2", x = "log10(TOC)")+
  theme_minimal()

ggplot(cba.sf, aes(x=toc))+
  geom_point(aes(y = fCO2), col = "gray")+
  geom_point(aes(y = 10^(log10fCO2glm_log), col = "GLM-gamma-log", shape = "GLM-gamma-log"),size = 3)+
  geom_point(aes(y=10^(log10fCO2tweedie_log), col = "Tweedie-log", shape = "Tweedie-log"), size = 2)+
  geom_point(aes(y=10^(log10fCO2gam), col = "GAM", shape = "GAM"), size = 2)+
  geom_point(aes(y=10^(log10fCO2glm), col = "GLM-gamma-id", shape = "GLM-gamma-id"),size = 3)+
  geom_point(aes(y=10^(log10fCO2lm), col = "LM", shape = "LM"), size = 2)+
  geom_point(aes(y = 10^(log10fCO2tweedie), col = "Tweedie", shape = "Tweedie"), size = 1)+
  geom_hline(yintercept = fCO2.2019, col = "red")+
  scale_color_manual(name = "Model", labels = models , values = as.vector(palette.colors(n=6)))+
  scale_shape_manual(name = "Model", labels = models, values = c(rep(19,6)))+
  labs(y = "Predicted fCO2", x = "TOC")+
  ylim(-10,5000)+xlim(0,30)+
  theme_minimal()

```

The TOC values > 40 mg/L (logTOC > 1,6) are potentially outliers, but removing them doesn't change the test.


GAM: linear pred with intercept. The model does not have the "asymptot" at fCO2 = fCO2 atm

LM = GLM id link = Tweedie id link. Both models are similar but underestimate fCO2 for high fCO2

GLM log link = Tweedie log link. Seem to work best. 



# Adding other variables

fCO2 

Choosen variables: 

* NDVI as proxy for soil TOC
* Ca as proxy for soil TIC
* Runoff as proxy for transport
* TOC (freshwater OC )
* C:N as proxy for bacterioplankton respiration
* tp as proxy for photosynthesis?
* photomineralization is neglected (Lina's estimation of contribution to CO2 production = 3%)
* sedimentation : ???

```{r gam-tweedie-toc-NDVI}
waterchem <- readRDS("waterchem.rds")
wtc <- dplyr::select(st_drop_geometry(waterchem),c("fCO2","area","lake.area","perimtot","Slope","Alt","soil","latitude.x","longitude.x","NDVI","Arable","Bog","Forest","Bare","Runoff","Temp","Precip","ph","alk","ca","mg","na","k","so4","no3","nh4","cl","f","tp","tn","toc"))
wtc$is <- wtc %>% dplyr::select(c("ca","mg","na","k","so4","no3","nh4","cl","f")) %>% rowSums()
wtc$cn <- wtc$toc / wtc$tn




t2 <- gam(list(fCO2~toc+is+ca+NDVI+Runoff+cn,~1, ~1), data = wtc, family = twlss(link = list("log","identity","identity")))
summary(t2)

g2 <- glm(fCO2~toc+is+ca+NDVI+Runoff+cn, data = wtc, family = Gamma(link = "log"))
summary(g2)

wtc$fpt <- predict(t2, type = "response")[,1]
wtc$fpg <- predict(g2, type = "response")
ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2), col = "Obs"))+
  geom_point(aes(y = log10(fpt), col = "Tweedie"))+
  geom_point(aes(y = log10(fpg), col = "GLM"))+
  annotate(geom = "text",label = paste("AIC tweedie ",round(extractAIC(t2)[2]), sep = "="), x = 0, y = 3.5)+
    annotate(geom = "text",label = paste("AIC gamma ",round(extractAIC(g2)[2]), sep = "="), x = 0, y = 3.2)+
  scale_color_manual(values = c("lightblue","black","orange"))+theme_minimal()

ggplot(wtc)+geom_point(aes(x=fCO2, y = fpg, col ="gamma"))+
  geom_point(aes(x=fCO2, y = fpt, col ="tweedie"))+
  theme_minimal()
```

The GAM with tweedie distribution avoids predicting extremely high fCO2. But there is no way to predict undersaturated fCO2. 

```{r predict-sat}
wtc$sat <- NA
wtc$sat[which(wtc$fCO2 > fCO2.1995)] <- 1
wtc$sat[which(wtc$fCO2 < fCO2.1995)] <- 0
wtc$sat <- as.factor(wtc$sat)

glmsat <- glm(sat~toc+ca+cn+Runoff+NDVI, data = wtc, family = binomial)
summary(glmsat)

wtc$sat.pred <- predict(glmsat, type = "response")

ggplot(wtc)+geom_point(aes(x=log10(toc),y=log10(fCO2), col = sat.pred))+
  scale_colour_continuous_divergingx(palette = "RdYlBu", mid = 0.5)+
  geom_hline(yintercept = log10(fCO2.1995), col = "purple")+
  theme_minimal()
```


```{r gam-over-under}
oversat <- subset(wtc,fCO2 >= fCO2.1995)
undersat <- subset(wtc,fCO2 < fCO2.1995)


t2o <- gam(list(fCO2~toc+is+ca+NDVI+Runoff+cn,~1, ~1), data = oversat, family = twlss(link = list("log","identity","identity")))
summary(t2o)
t2u <- gam(list(fCO2~toc+is+ca+NDVI+Runoff+cn,~1, ~1), data = undersat, family = twlss(link = list("log","identity","identity")))
summary(t2u)

oversat$fp2 <- predict(t2o, type = "response")[,1]
undersat$fp2 <- predict(t2u, type = "response")[,1]

ggplot()+geom_point(data = wtc, aes(x=log10(toc), y=log10(fCO2)))+
  geom_point(data = oversat, aes(x=log10(toc), y = log10(fp2), col = "oversat"))+
  geom_point(data = undersat, aes(x=log10(toc), y = log10(fp2), col = "undersat"))+
  geom_point(data = wtc, aes(x=log10(toc), y = log10(fpg), col = "total"))+
  theme_minimal()

```

```{r variable-sel}

t3 <- gam(list(fCO2~toc*cn*NDVI*Runoff + ca,~1, ~1), data = wtc, family = twlss(link = list("log","identity","identity")))
summary(t3)

t3o <- gam(list(fCO2~toc*Runoff*cn+ca,~1, ~1), data = oversat, family = twlss(link = list("log","identity","identity")))
summary(t3o)
t3u <- gam(list(fCO2~toc*cn+ca,~1, ~1), data = undersat, family = twlss(link = list("log","identity","identity")))
summary(t3u)

wtc$fp3 <- predict(t3, type = "response")[,1]
oversat$fp3 <- predict(t3o, type = "response")[,1]
undersat$fp3 <- predict(t3u, type = "response")[,1]

ggplot()+geom_point(data = wtc, aes(x=log10(toc), y=log10(fCO2)))+
    geom_point(data = wtc, aes(x=log10(toc), y = log10(fp3), col = "total"),alpha = 0.5)+
  geom_point(data = oversat, aes(x=log10(toc), y = log10(fp3), col = "oversat"),alpha = 0.5)+
  geom_point(data = undersat, aes(x=log10(toc), y = log10(fp3), col = "undersat"),alpha = 0.5)+
  scale_color_manual(values = c("goldenrod","lightblue","darkolivegreen3"))+
  theme_minimal()
 

```

`r knitr::knit_exit()`

# Extra

## Full model and stepwise selection 

```{r stepwise-selection-lm}
library(MASS)
# Fit the full model 
full.model <- lm(log(fCO2) ~., data = st_drop_geometry(wtc))
summary(full.model)

# Stepwise regression model
step.model1 <- stepAIC(full.model, direction = "both", trace = FALSE)
summary(step.model1)

```

## Full model on log-transformed variables



```{r lm-log-stepwise, eval = T}

lm2 <- lm(log10fCO2~., data = logwtc)
summary(lm2)

step.model2 <- stepAIC(lm2, direction = "both", trace = FALSE)
summary(step.model2)
```







## fCO2 modelled with TOC, GAM

```{r gam-model}
library(mgcv)

#g1 <- mgcv::gam(log10fCO2~s(log10Slope)+s(NDVI)+s(log10Runoff)+s(Forest)+s(Bare)+s(Arable)+s(Bog)+s(Temp)+s(log10Precip)+s(ph)+s(log10ca)+s(log10so4)+s(log10no3)+s(log10nh4)+s(log10tn)+s(log10tp)+s(log10toc), data = logwtc, method = "REML", select = T)
#saveRDS(g1,"g1.rds")
# g1 <- readRDS("g1.rds")
# summary(g1)


#g2 <- mgcv::gam(log10fCO2~s(log10Slope)+s(NDVI)+s(Arable)+s(Temp)+s(log10Precip)+s(ph)+s(log10ca)+s(log10so4)+s(log10no3)+s(log10nh4)+s(log10tp)+s(log10toc), data = logwtc, method = "REML", select = T)
#saveRDS(g2,"g2.rds")
# g2 <- readRDS("g2.rds")
# summary(g2)

#g3 <- mgcv::gam(log10fCO2~s(NDVI)+s(Arable)+s(Temp)+s(log10Precip)+s(ph)+s(log10ca)+s(log10so4)+s(log10no3)+s(log10tp)+s(log10toc), data = logwtc, method = "REML")
#saveRDS(g3,"g3.rds")
# g3 <- readRDS("g3.rds")
# summary(g3)



```

```{r test-no-log}
  
cba.sf$fCO2lm <- predict(lm1,newdata = cba.sf, type = "response")
cba.sf$fCO2gam <- predict(g1, newdata = cba.sf, type = "response")
cba.sf$fCO2tweedie <- predict(t1,newdata = cba.sf, type = "response")[,1]
cba.sf$fCO2glm <- predict(glm1, newdata = cba.sf, type = "response")

ggplot(cba.sf, aes(x=fCO2))+geom_point(aes(y=fCO2lm + fCO2.1995, col = "LM", shape = "LM"))+
  geom_point(aes(y=fCO2glm, col = "GLM-gamma", shape = "GLM-gamma"))+
  geom_point(aes(y =fCO2tweedie, col = "Tweedie", shape = "Tweedie"))+
  geom_point(aes(y=fCO2gam, col = "GAM", shape = "GAM"))+
  geom_abline(slope = 1, intercept = 0, col = "red")+
  scale_color_manual(name = "Model", labels = c("GAM", "GLM-gamma-log","LM","Tweedie"), values = as.vector(palette.colors(n=4)))+
  scale_shape_manual(name = "Model", labels = c("GAM", "GLM-gamma-log","LM","Tweedie"), values = c(1,2,3,4))+
  labs(y = "Predicted fCO2", x = "Aquaenv fCO2")+
  ylim(0,10000)+
  theme_minimal()

ggplot(cba.sf, aes(x=toc))+geom_point(aes(y=fCO2lm + fCO2.1995, col = "LM", shape = "LM"))+
  geom_point(aes(y = fCO2), col = "black")+
  geom_point(aes(y=fCO2glm, col = "GLM-gamma", shape = "GLM-gamma"))+
  geom_point(aes(y =fCO2tweedie, col = "Tweedie", shape = "Tweedie"))+
  geom_point(aes(y=fCO2gam, col = "GAM", shape = "GAM"))+
  scale_color_manual(name = "Model", labels = c("GAM", "GLM-gamma-log","LM","Tweedie"), values = as.vector(palette.colors(n=4,palette = "ggplot2")))+
  scale_shape_manual(name = "Model", labels = c("GAM", "GLM-gamma-log","LM","Tweedie"), values = c(1,2,3,4))+
  labs(y = "Predicted fCO2", x = "TOC (mg/L)")+
  theme_minimal()



```




