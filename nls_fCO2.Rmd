---
title: "fCO2_exploration"
author: "Camille Crapart"
date: '2022-11-14'
output: 
   bookdown::html_document2:
     code_folding: hide
     toc: true
     toc_float: true
     number_sections: true
     fig_caption: true

bibliography: C:\\Users\\raine\\Documents\\UiO\\Bibtex\\fCO2.bib
link-citations: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, message = T, warning = F, error = F, fig.align = "center", results = T, collapse = T, cache.lazy = F)
options(knitr.kable.NA="", knitr.table.format = "html")
```

```{r libraries, message = F}
library(readxl)

library(DBI)
library(AquaEnv)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(sf)
library(mgcv)
library(MASS)
library(colorspace)

fCO2.1995 <- 360.17
fCO2.2019 <- 410

```

# Northern Lakes Survey Database

## Download from NOFA database

```{r load-data, eval = F}
con <- dbConnect(RPostgreSQL::PostgreSQL(),user = "camille.crapart", password = "camille",host = "vm-srv-wallace.vm.ntnu.no", dbname = "nofa")

ion <- tbl(con, sql("SELECT gid, ebint,nation,date,temp_c,latitude,longitude,ph,alk_e_ueq_l,alk_subst,k25_ms_m,ca_ueq_l,mg_ueq_l,na_ueq_l,k_ueq_l,nh4_ueq_l,cl_ueq_l,so4_ueq_l,no3_ueq_l,f_ueq_l,tot_p_ug_l,tot_n_ug_l,toc_mg_l,dist_closest_ebint,dist_2nd_closest_ebint FROM environmental.north_euro_lake_surv_1995 ")) %>% as.data.frame()
names(ion) <- c("gid", "ebint","nation","date","temp_c","latitude","longitude","ph","alk_ueq","alk","cond","ca","mg","na","k","nh4","cl","so4","no3","f","tp","tn","toc","dist_closest_ebint","dist_2nd_closest_ebint")
saveRDS(ion,"ion.rds")

lakes <- st_read(con,query = "SELECT gid, ebint, geom, area, perimtot FROM environmental.ecco_biwa_lakes_v_0_1 WHERE ebint IN (SELECT ebint FROM environmental.north_euro_lake_surv_1995)")
saveRDS(lakes,"lakes.rds")

catchments <- st_read(con,query = "SELECT ebint, geom FROM catchments.lake_catchments WHERE ebint IN (SELECT ebint FROM environmental.north_euro_lake_surv_1995)") # in UTM33
saveRDS(catchments,"catchments.rds")
catchment.poly <- st_transform(catchments, crs = st_crs("EPSG:4326")) # converts in World Geodetic System 1984
saveRDS(catchment.poly,"catchment.poly.rds")
catchment.poly.corine <- st_transform(catchment.poly, crs = st_crs("EPSG:3035")) # converts to EU extended referential ETRS89-extended
saveRDS(catchment.poly.corine, "catchment.poly.corine.rds")
```

## Computes fCO2 in Northern Lakes

```{r model-fco2-4D, eval = F}
ion <- readRDS("ion.rds")
lakes <- readRDS("lakes.rds")

sum(ion$alk < 0) #153 lakes
sum(ion$alk == 0) #272 lakes
sum(ion$ph == 0) #2 lakes
sum(ion$ph < 0)

ion.alk <- subset(ion, alk > 0)
ion.alk <- subset(ion.alk, ph > 4.01)

temp <- ion.alk$temp_c
temp[which(is.na(temp))] <- 4
pH <- ion.alk$ph
TA <- ion.alk$alk / 1000000 # mol / L

fCO2.1995.atm <- fCO2.1995*10^(-6) # ppm to atm

ae <- aquaenv(S=0, t=temp, SumCO2=NULL, TA=TA, pH=pH, fCO2atm = fCO2.1995.atm)

ion.alk$fCO2 <- ae$fCO2 * 10^6

saveRDS(ion.alk, "ion.alk.rds")
saveRDS(ae, "ae.rds")
```

```{r explore-fCO2-results}
ae <- readRDS("ae.rds") %>% as.data.frame()

ggplot(ae)+geom_point(aes(x=pH, y = fCO2, col = TA))+scale_color_viridis_c()+theme_minimal()
ggplot(ae)+geom_point(aes(x=TA, y = fCO2, col = pH))+scale_color_viridis_c()+theme_minimal()

```

## Catchment characteristics



### Soil

<https://daac.ornl.gov/SOILS/guides/Global_Soil_Regolith_Sediment.html>

```{r extract-soil-depth, eval = F}

soil <- raster::raster("DAAC/average_soil_and_sedimentary-deposit_thickness.tif")
catchment.poly <- readRDS("catchment.poly.rds")
soil.df <- raster::extract(soil, catchment.poly, sp = F, df = T, na.rm = T, fun = mean, method = "simple")
                           
names(soil.df) <- c("ebint","soil")
soil.df$soil[which(soil.df$soil > 50)] <- 50 # maximum value
saveRDS(soil.df, "soil.df.rds")
```

### NDVI

NDVI values are extracted from the GIMMS NDVI3g dataset [@NCAR2018], stored on <http://poles.tpdc.ac.cn/en/data/9775f2b4-7370-4e5e-a537-3482c9a83d88/>, in the "ecocast" dataset and accessed via the "gimms" package [@Detsch2021] on Rstudio.

Data is taken bi-monthly [@Tucker2005]. Raster layers of all slices are downloaded using the downloadGimms function, then monthly composites are calculated using the monthlyComposites function. The maximum NDVI value is taken for each pixel. Afterwards the NDVI values for each catchment polygon are extracted using the extract function from the raster package [@Hijmans2018].

The values stored in the ecocast dataset are composed of the NDVI value and a flag value indicating the goodness of the data. All the NDVI values extracted, corresponding to the values for the studied catchments, had a flag of 1, indicating a good value. The NDVI value was retrieved from the stored value using the formula $floor(ndvi3g/10)/1000$ [@Detsch2021], and then the mean of the 3 summer values (June, July and August) was computed for each catchment.

```{r summer-ndvi, eval = F}

# Download Gimms NDVI

ndvi.1994 <- downloadGimms(x= 1994,y=1994,dsn = "NDVI")
ndvi.max <- monthlyComposite(ndvi.1994,monthlyIndices(ndvi.1994))
saveRDS(ndvi.max,"ndvi.max.rds")

# Load data

ndvi.max <- readRDS("ndvi.max.rds")
catchment.poly <- readRDS("catchment.poly.Rdata")

# Computes summer mean
summer.mean <- raster::stack(ndvi.max[[6]],ndvi.max[[7]],ndvi.max[[8]]) %>% mean()

# Crops raster to Scandinavia
summer.scandinavia <- raster::crop(summer.mean,c(0,35,55,73))

# Re-introduces NA
summer.scan <- reclassify(summer.scandinavia, cbind(-Inf, 0, NA), right=FALSE)
saveRDS(summer.scan, "summer.scan.rds")

# Extract NDVI for each catchment
summer.ndvi <- raster::extract(summer.scan,catchment.poly, fun = mean, df = T, sp = T)
names(summer.ndvi) <- c("ebint","ndvi")
summer.ndvi$ndvi.value <- floor(summer.ndvi$ndvi/10)/1000
summer.ndvi$flag.value <- summer.ndvi$ndvi - floor(summer.ndvi$ndvi/10)*10 + 1 

# Saves NDVI file
saveRDS(summer.ndvi, "summer.ndvi.Rdata")
write.csv(summer.ndvi,"summer.ndvi.csv")
```

### Runoff

The runoff data was downloaded from the CORDEX database [@CORDEXvERC]. The data is available at <https://esg-dn1.nsc.liu.se/projects/esgf-liu/>.

The names of the variables in the CORDEX project follow the CF Metadata convention: <http://cfconventions.org/>. We used here the "mrros" variable, for surface runuff, in kg/m2/s.

According to Euro-CORDEX guidelines, we used the mean runoff over 30 years. We chose the interval 1970 - 2000 to match the temperature and precipitation data provided by WorldClim (p11 on EURO-CORDEX guidelines <https://www.euro-cordex.net/imperia/md/content/csc/cordex/guidance_for_euro-cordex_climate_projections_data_use__2021-02_1_.pdf>). This time period matches .

```{r runoff, eval = F}
runoff.raster <- "CORDEX/mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"
runoff.nc <- nc_open(runoff.raster)

runoff.stack <- raster::stack(runoff.raster, bands = c(1441:1812)) # Correspond to January 1970 to December 2000
runoff.mean <- runoff.stack %>% mean() 

catchment.poly <- readRDS("catchment.poly.Rdata")
runoff.fennoscandia <- raster::extract(runoff.mean, catchment.poly, fun = mean, df = T, sp = T, na.rm = T)
names(runoff.fennoscandia) <- c("ebint","runoff")
saveRDS(runoff.fennoscandia,"CORDEX/runoff.fennoscandia.rds")
```

### Temperature, precipitation and slope

Temperature and precipitation are downloaded from the database Worldclim [@WorldClim]. We use the average of the time interval 1970-2000, stored in the "Bioclimatic variable" dataset, available for download at: <https://www.worldclim.org/data/worldclim21.html>. We used the highest available resolution (30 seconds). Temperature is the mean annual temperature from 1970 to 2000 in Â°C, or "bio1" in the Bioclimatic dataset. The original data is in C\*10 so the data is divided by 10 before use. Precipitation is the mean annual precipitation in mm or bio12 in the Bioclimatic dataset.

```{r temp-prec, eval = F}
bio.fennoscandia <- raster::getData(name = "worldclim", var = "bio", res = 2.5)

annual.temp <- raster::extract(bio.fennoscandia[[1]], catchment.poly, fun = mean, df = T, sp = T)
saveRDS(annual.temp,"annual.temp.Rdata")

annual.prec <- raster::extract(bio.fennoscandia$bio12, catchment.poly, fun = mean, df = T, sp = T)
saveRDS(annual.prec,"annual.prec.Rdata")
```

The altitude data was accessed through the "getData" function, and comes from the NASA digital elevation model (SRTM 90 m). The slope was then computed using the "terrain" function from the raster package.

```{r altitude-slope, eval = F}
alt.nor <- getData("alt",country = "NOR", mask = T)
alt.swe <- getData("alt",country = "SWE", mask = T)
alt.fin <- getData("alt",country = "FIN", mask = T)

alt.list <- list(alt.nor,alt.swe,alt.fin)
alt <- do.call(raster::merge,alt.list)

alt.fennoscandia <- extract(alt,remote.set[,c("longitude","latitude")])
alt.df <- data.frame(ebint = remote.set$ebint, alt = alt.fennoscandia )
saveRDS(alt.df, "alt.df.Rdata")

slope.nor <- terrain(alt.nor, unit = "degrees")
slope.swe <- terrain(alt.swe, unit = "degrees")
slope.fin <- terrain(alt.fin, unit = "degrees")
slope.list <- list(slope.nor,slope.swe,slope.fin)
slope <- do.call(raster::merge,slope.list)

slope.nona <- reclassify(slope,cbind(NA,100), right = NA) #reintroduces NA

slope.fennoscandia <- raster::extract(slope,catchment.poly, sp = T, df = T, fun = mean)
saveRDS(slope.df, "slope.df.Rdata")
```

### Land cover

The Land Cover data was downloaded from <https://land.copernicus.eu/pan-european/corine-land-cover/lcc-2000-2006>. The previous version (1995-2000) excludes Norway so the 2000 version was preferred.

The land cover data was downloaded as a raster (.tiff file), which included the legend recording the code for each land use. The raster and legend were assembled in QGIS before being imported as a shapefile in R. The codes (corresponding to the line in the extracted dataframe) of the categories of interest were:

Arable land:

-   12: non-irrigated arable land
-   16: fruit trees and berries plantations
-   18: pastures
-   19: annual crops associated with permanent crops
-   20: Complex cultivation patterns

Bogs:

-   36: peat bogs
-   35: inland marshes, excluded because all zeros in the studied area.

Forest:

-   23: Broad-leaved forest
-   24: Coniferous forest
-   25: Mixed forest

Bare:

-   31: Bare rocks
-   32: Sparsely vegetated areas
-   33: Burnt areas

```{r extract-land-cover, eval = F}
corine <- raster::raster("Corine_Land_Cover/U2006_CLC2000_V2020_20u1.tif")
clc.remote <- raster::extract(corine,catchment.poly.corine)

saveRDS(clc.remote,"clc.remote.Rdata")
```

The proportion of each land-cover category was computed for each catchment.

```{r corine-tab-prop, eval = F}
clc.remote <- readRDS("clc.remote.Rdata")
clc.tab <- sapply(clc.remote, function(x) tabulate(x,45))
clc.tab.area <- clc.tab*prod(res(corine))
catchment.area <- colSums(clc.tab.area)
clc.tab.prop <- sweep(clc.tab.area,2,catchment.area, FUN = "/")
names(clc.tab.prop) <- catchment.poly.corine$ebint
saveRDS(clc.tab.prop,"clc.tab.prop.Rdata")
```

Then, a dataframe for the category of interest (bogs, arable land, forest, bare land) was created and saved.

```{r corine-select-categories, eval = F}
clc.tab.prop <- readRDS("clc.tab.prop.Rdata") %>% as.data.frame()

bogs <- clc.tab.prop[36,] %>% t() %>% as.data.frame() %>% setNames("bogs") %>% tibble::rownames_to_column(var = "ebint")
saveRDS(bogs,"bogs.rds")
arable <- colSums(clc.tab.prop[c(12,16,18,19,20),]) %>% as.data.frame() %>% setNames("arable") %>% tibble::rownames_to_column(var = "ebint")
saveRDS(arable,"arable.rds")
forest <- colSums(clc.tab.prop[c(23,24,25),]) %>% as.data.frame() %>% setNames("forest") %>% tibble::rownames_to_column(var = "ebint")
saveRDS(forest,"forest.rds")
bare <- colSums(clc.tab.prop[c(31,32,33),]) %>% as.data.frame() %>% setNames("bare") %>% tibble::rownames_to_column(var = "ebint")
saveRDS(bare,"bare.rds")
```

### Nitrogen and sulfur deposition

The nitrogen and sulfur deposition data were extracted from the EMEP database [@EMEP]. The data from 2000 was used as it is the first model available.

N-deposition (NOx and NH3) is the sum of:

-   Dry deposition of oxidized nitrogen per m2 grid DDEP_OXN_m2Grid, in mg/m2
-   Wet deposition of oxidized nitrogen WDEP_OXN, in mg/m2
-   Dry deposition of oxidized nitrogen per m2 grid DDEP_RDN_m2Grid, in mg/m2
-   Wet deposition of reduced nitrogen WDEP_RDN, in mg/m2

```{r extract-Ndep, eval = F}
EMEP_file <- "EMEP/EMEP01_rv4.42_year.2000met_2000emis_rep2021.nc"
catchment_poly <- readRDS("catchment.poly.Rdata")

woxn <- raster(EMEP_file, varname = "WDEP_OXN") 
doxn <- raster(EMEP_file, varname = "DDEP_OXN_m2Grid")
wrdn <- raster(EMEP_file, varname = "WDEP_RDN")
drdn <- raster(EMEP_file, varname = "DDEP_RDN_m2Grid")

woxn_df <- extract(woxn,catchment.poly, sp = T, df = T, na.rm = T, fun = mean) 
names(woxn_df) <- c("ebint","woxn")
doxn_df <- extract(doxn,catchment.poly, sp = T, df = T, na.rm = T, fun = mean)
names(doxn_df) <- c("ebint","doxn")
wrdn_df <- extract(wrdn,catchment.poly, sp = T, df = T, na.rm = T, fun = mean)
names(wrdn_df) <- c("ebint","wrdn")
drdn_df <- extract(drdn,catchment.poly, sp = T, df = T, na.rm = T, fun = mean)
names(drdn_df) <- c("ebint","drdn")

ndep.df <- merge(woxn_df,doxn_df, by = "ebint") %>% merge(wrdn_df, by = "ebint") %>% merge(drdn_df, by = "ebint")
ndep.df$tndep <- rowSums(ndep.df@data[,c(2:5)])

saveRDS(ndep.df,"ndep.df.Rdata")
```

The S-deposition is composed of the sum of:

-   Dry deposition of oxidized sulphur per m2 grid DDEP_SOX_m2Grid, in mg/m2
-   Wet deposition of oxidized sulphur WDEP_SOX, in mg/m2

```{r extract-Sdep, eval = F}
library(ncdf4)
EMEP_file <- "EMEP/EMEP01_rv4.42_year.2000met_2000emis_rep2021.nc"
catchment_poly <- readRDS("catchment.poly.Rdata")

wsox <- raster(EMEP_file, varname = "WDEP_SOX") 
dsox <- raster(EMEP_file, varname = "DDEP_SOX_m2Grid")

wsox_df <- extract(wsox,catchment_poly, sp = T, df = T, na.rm = T, fun = mean) 
names(wsox_df) <- c("ebint","wsox")

dsox_df <- extract(dsox,catchment_poly, sp = T, df = T, na.rm = T, fun = mean)
names(dsox_df) <- c("ebint","dsox")

sdep.df <- merge(wsox_df,dsox_df, by = "ebint")
sdep.df$tsdep <- rowSums(sdep.df@data[,c(2:3)])

saveRDS(sdep.df,"sdep.df.rds")
```

### Near surface wind speed

```{r nws}
library(sp)
ion <- readRDS("ion.rds")

nws.oct.1995 <- "NWS/Wind_WFDE5_CRU_199510_v2.1.nc" %>% raster::raster()
ion.spdf <- SpatialPointsDataFrame(coords = ion[,c("longitude","latitude")], data =  ion[,c("longitude","latitude")]) 
ion.nws <- raster::extract(nws.oct.1995, ion.spdf)

ion$nws_m.s <- ion.nws

```

## Merge dfs

```{r gather-data, eval = F}

lakes <- readRDS("lakes.rds")
#soil.df <- readRDS("soil.df.rds")

summer.ndvi <- readRDS("summer.ndvi.Rdata") %>% st_as_sf() %>% st_drop_geometry()
runoff.fennoscandia <- readRDS("runoff.fennoscandia.rds") %>% st_as_sf() %>% st_drop_geometry()

annual.temp <- readRDS("annual.temp.Rdata") %>% st_as_sf() %>% st_drop_geometry()
names(annual.temp) <- c("ebint","temp")

annual.prec <- readRDS("annual.prec.Rdata")  %>% st_as_sf() %>% st_drop_geometry()
names(annual.prec) <- c("ebint","prec")

slope.fennoscandia <- readRDS("slope.fennoscandia.Rdata")  %>% st_as_sf() %>% st_drop_geometry()
names(slope.fennoscandia) <- c("ebint","slope")

alt.df <- readRDS("alt.df.Rdata")

bogs <- readRDS("bogs.rds")
arable <- readRDS("arable.rds")
forest <- readRDS("forest.rds")
bare <- readRDS("bare.rds")

#ndep <- readRDS("ndep.df.Rdata") %>% st_as_sf() %>% st_drop_geometry()
#sdep <- readRDS("sdep.df.rds") %>% st_as_sf() %>% st_drop_geometry()

total <- ion %>%
  merge(lakes, by = "ebint") %>% 
  merge(summer.ndvi, by = "ebint") %>% 
  merge(runoff.fennoscandia,by = "ebint") %>% 
  merge(annual.temp, by ="ebint") %>% 
  merge(annual.prec, by = "ebint") %>%
  merge(slope.fennoscandia, by = "ebint") %>%
  merge(alt.df, by = "ebint") %>%
  merge(bogs, by = "ebint") %>%
  merge(arable, by = "ebint")%>%
  merge(forest,by = "ebint") %>%
  merge(bare, by = "ebint")# %>%
#  merge(ndep, by = "ebint") %>% 
#  merge(sdep, by = "ebint")

total$uncertain <- ifelse(total$dist_closest_ebint/total$dist_2nd_closest_ebint > 0.5, FALSE, TRUE)
total$uncertain[which(is.na(total$uncertain)==TRUE)] <- FALSE

saveRDS(total,file = "total.rds")
total <- readRDS("total.rds")

nls <- total %>% filter(toc >= 0) %>% filter(tp > 0) %>% filter(alk_ueq > 0) %>% filter(uncertain == FALSE) %>% filter(!is.na(temp_c))

# fennoscandia_raw <- fennoscandia_raw %>% filter(runoff > 0)
# fennoscandia_raw <- fennoscandia_raw %>% filter(ndvi.value > 0)
# fennoscandia_raw <- fennoscandia_raw %>% filter(is.na(slope) == F)
# fennoscandia_raw <- fennoscandia_raw %>% filter(alt != 0)
# fennoscandia_raw <- fennoscandia_raw %>% filter(uncertain == FALSE)
# fennoscandia_raw$uncertain <- NULL



saveRDS(nls, file = "nls.rds")

```

```{r selected-df, eval = F}

nls <- readRDS("nls.rds")
nls <- subset(nls, !is.na(temp_c))

nlss <- data.frame(survey = rep("nls", dim(nls)[1]))
nlss$pH <- nls$ph
nlss$Hplus <- 10^(-nlss$pH)
nlss$TA <- nls$alk_ueq * 1e-6
nlss$TOC <- nls$toc / 12.011 * 1e-3
nlss$nws_m.s <- nls$nws_m.s

nlss$long <- nls$longitude
nlss$lat <- nls$latitude
nlss$fCO2.atm <- fCO2.1995 * 1e-6

nlss$temp_c <- nls$temp_c
nlss$temp_k <- nls$temp_c + 273.15
```

```{r compute-fCO2}

nlss$Kw = with(nlss, exp(148.9802 - 13847.26/temp_k - 23.6521*log(temp_k))) # Dickson and Riley, 1979

#nlss$K0 <- with(nlss, 10^-((-2622.38/temp_k) + 15.5873 - 0.0178471*temp_k)) #Harned and Davis, 1943
nlss$K0 <- with(nlss, exp(-58.0931+90.5069*100/temp_k+22.2940*log(temp_k/100))) # Weiss 1974
nlss$K1 <- with(nlss, 10^-((3404.71/temp_k)- 14.8435 + 0.032786*temp_k)) # Harned and Davis, 1943
nlss$K2 <- with(nlss, 10^-((2902.39/temp_k) - 6.4980 + 0.02379*temp_k)) # Harned and Scholes, 1941


nlss$OH <- with(nlss, Kw/Hplus)

nlss$CO3 <- with(nlss,(TA - OH + Hplus) / (Hplus/K2 +2)) # in mol/L
nlss$HCO3 <- with(nlss, CO3*Hplus/K2)
nlss$H2CO3 <- with(nlss, HCO3*Hplus/K1)
nlss$fCO2 <- with(nlss,H2CO3/K0)

nlss$dfCO2 <- with(nlss, fCO2 - fCO2.atm)



# Check
nlss$DIC <- with(nlss, H2CO3 + HCO3 + CO3)
nlss$CA <- with(nlss, HCO3 + 2*CO3)


ggplot(nlss, aes(x = TA, y = CA, col = pH))+geom_point()+
  geom_abline(slope = 1, intercept = 0)+
  theme_minimal()

ggplot(nlss, aes(x = log10(TOC), y = fCO2, col = survey))+
  geom_hline(yintercept = fCO2.1995*1e-6, col = "firebrick")+
  scale_color_manual(values = c("firebrick","lightblue","orange"))+
  geom_point()+
  theme_minimal()

ggplot(nlss, aes(x = pH))+geom_point(aes(y = H2CO3, col = "H2CO3"))+
  geom_point(aes(y = HCO3, col = "HCO3"))+
  geom_point(aes(y = CO3, col = "CO3"))+
  scale_color_manual(values = c("firebrick","lightblue","orange"))+
  theme_minimal()

#ggplot(nlss)+geom_point(aes(x=TA, y = CA, col = survey))+
#  scale_color_manual(values = c("firebrick","lightblue","orange"))+
#  geom_abline(slope = 1, intercept = 0)+
#  theme_minimal()

ggplot(nlss)+geom_point(aes(x=pH, y = fCO2, col = survey))+
  scale_color_manual(values = c("firebrick","lightblue","orange"))+
  geom_abline(slope = 1, intercept = 0)+
  theme_minimal()

```

```{r aquaenv}
ae <- with(nlss, aquaenv(pH = pH, S = 0, TA = TA, SumCO2 = NULL, t = temp_c))
nlss$ae_fCO2 <- ae$fCO2

9ggplot(nlss, aes(x = log10(TOC))) + 
  geom_point(aes(y = fCO2, col = "manual with corrected TA"))+
  geom_point(aes(y = ae_fCO2, col = "aquaenv"))+
  geom_hline(yintercept = fCO2.1995*1e-6, col = "firebrick")+
  scale_color_manual(values = c("firebrick","lightblue","orange"))+
  geom_point()+
  theme_minimal()
```
# Other


```{r match-catchment, eval = F}
catchments <- readRDS("catchments.rds")
wtc <- readRDS("wtc.rds")
wtc.sf <- merge(catchments, wtc, by = "ebint")
saveRDS(wtc.sf, "wtc.sf.rds")

p1 <- ggplot(waterchem)+geom_point(aes(x=toc, y = TOC, col = nation.x))
ggsave("TOC_compare.png", p1)

g1 <- ggplot(waterchem)+geom_sf(aes(fill=log10(fCO2), col = log10(fCO2)))+
    scale_colour_continuous_divergingx(palette = "RdYlBu", mid = log10(fCO2.1995), aesthetics = c("fill", "col"), name = "log10(fCO2)")+
    theme_minimal()
ggsave("map_fco2.png",g1, width = 12, height = 16, unit = "cm", dpi = "retina")

g2 <- ggplot(waterchem)+geom_point(aes(x = longitude.x, y = latitude.x, fill=log10(fCO2), col = log10(fCO2)))+
    scale_colour_continuous_divergingx(palette = "RdYlBu", mid = log10(fCO2.1995), aesthetics = c("fill", "col"), name = "log10(fCO2)")+
    theme_minimal()
ggsave("map_lakes_fco2.png",g2, width = 12, height = 16, unit = "cm", dpi = "retina")

g3 <- ggplot(waterchem)+geom_point(aes(x = longitude.x, y = latitude.x, fill=log10(alk), col = log10(alk)))+
    scale_colour_continuous_divergingx(palette = "RdYlBu", mid = log10(1000), aesthetics = c("fill", "col"), name = "log10(alk, ueq/L)")+
    theme_minimal()
ggsave("map_lakes_alk.png",g3, width = 12, height = 16, unit = "cm", dpi = "retina")



h1 <- ggplot(waterchem)+geom_histogram(aes(group = fCO2, x = log10(fCO2), fill = log10(fCO2), col = log10(fCO2)))+
  scale_colour_continuous_divergingx(palette = "RdYlBu", mid = log10(fCO2.1995), aesthetics = c("fill", "col"), name = "log10(fCO2)")+
  geom_vline(xintercept = log10(fCO2.1995), col = "red")+theme_minimal()
ggsave("hist_fCO2.png",h1, width = 12, height = 8, unit = "cm", dpi = "retina") 



t1 <- ggplot(waterchem, aes(x = log10(toc)))+
  geom_ribbon(aes(ymin = -Inf, ymax = log10(fCO2.1995), fill = "undersaturated"), alpha = 0.25)+
  geom_ribbon(aes(ymax = +Inf, ymin = log10(fCO2.1995),fill = "oversaturated"), alpha = 0.25)+
  geom_hline(yintercept = log10(fCO2.1995))+
  scale_fill_manual(values = c("lightgray","darkgray"), name = "Oversaturation")+
  geom_point(aes(y=log10(fCO2), col = latitude.x))+
  scale_color_viridis_c()+
  theme_minimal()

ggsave("CO2_oversaturation.png",t1, width = 15, height = 10, unit = "cm", dpi = "retina")

t2 <- ggplot(waterchem, aes(x = toc))+
  geom_ribbon(aes(ymin = -Inf, ymax = fCO2.1995, fill = "undersaturated"), alpha = 0.25)+
  geom_ribbon(aes(ymax = +Inf, ymin = fCO2.1995,fill = "oversaturated"), alpha = 0.25)+
  geom_hline(yintercept = fCO2.1995)+
  scale_fill_manual(values = c("lightgray","darkgray"), name = "Oversaturation")+
  geom_point(aes(y=fCO2, col = latitude.x))+
  scale_color_viridis_c()+
  theme_minimal()

ggplot()+
 # scale_colour_continuous_divergingx(palette = "RdYlBu", mid = 5, aesthetics = c("col"))+
  geom_point(data = oversat, aes(y = log10(fCO2-fCO2.1995), x = Temp, col = "oversat"))+
  geom_smooth(data = oversat, aes(y = log10(fCO2-fCO2.1995), x = Temp), col = "black", formula = y~x)+
  geom_point(data = undersat, aes(y = log10(abs(fCO2-fCO2.1995)), x = Temp, col = "undersat"))+
    geom_smooth(data = undersat, aes(y = log10(abs(fCO2-fCO2.1995)), x = Temp), col = "gray", formula = y~x)+
    theme_minimal()


ggplot()+
 # scale_colour_continuous_divergingx(palette = "RdYlBu", mid = 5, aesthetics = c("col"))+
  geom_point(data = oversat, aes(y = log10(fCO2-fCO2.1995), x = Temp, col = "oversat"))+
  geom_smooth(data = oversat, aes(y = log10(fCO2-fCO2.1995), x = Temp), col = "black", formula = y~x)+
  geom_point(data = undersat, aes(y = log10(abs(fCO2-fCO2.1995)), x = Temp, col = "undersat"))+
    geom_smooth(data = undersat, aes(y = log10(abs(fCO2-fCO2.1995)), x = Temp), col = "gray", formula = y~x)+
    theme_minimal()

ggplot()+
  scale_colour_continuous_divergingx(palette = "RdYlBu", mid = 5, aesthetics = c("col"))+
  geom_point(data = oversat, aes(col = log10(fCO2-fCO2.1995), x = Temp, y = log10(alk)))+
  geom_smooth(data = oversat, aes(y = log10(alk), x = Temp), col = "black", formula = y~x)+
  geom_point(data = undersat, aes(col = log10(abs(fCO2-fCO2.1995)), x = Temp, y = log10(alk)))+
    geom_smooth(data = undersat, aes(y = log10(alk), x = Temp), col = "gray", formula = y~x)+
    theme_minimal()


ggplot(waterchem)+geom_point(aes(x = longitude.x, y = latitude.x, fill=soil, col = soil))+
    scale_colour_continuous_divergingx(palette = "RdYlBu", mid = 50, aesthetics = c("fill", "col"), name = "soil depth")+
    theme_minimal()

ggplot()+
  scale_colour_continuous_divergingx(palette = "RdYlBu", mid = 5, aesthetics = c("col"))+
  geom_point(data = oversat, aes(y = dev.sat, x = log10(soil), col = log10(alk)))+
  geom_smooth(data = oversat, aes(y = dev.sat, x = log10(soil)), col = "black", formula = y~x)+
  geom_point(data = undersat, aes(y = dev.sat, x = log10(soil), col = log10(alk)))+
    geom_smooth(data = undersat, aes(y = dev.sat, x = log10(soil)), col = "gray", formula = y~x)+
    theme_minimal()

```

`r knitr::include_graphics(c("map_fCO2.png", "hist_fCO2.png","CO2_oversaturation.png"))`



# Corplot and PCA

`r wtc <- readRDS("wtc.rds")`

There are `r sum(wtc$sat == 1)` (`r round(sum(wtc$sat == 1)/dim(wtc)[1]*100,1)`%) supersaturated lakes and `r sum(wtc$sat == -1)` (`r round(sum(wtc$sat == -1)/dim(wtc)[1]*100,1)`%)undersaturated lakes.

## Super- and undersaturated lakes

```{r compare-over-under}
library(reshape2)
wtc.long <- melt(wtc,id.vars= c("ebint","sat"))

wtc.long$sat[which(wtc.long$sat == -1)] <- "under"
wtc.long$sat[which(wtc.long$sat == 1)] <- "over"

bp1 <- ggplot(filter(wtc.long, variable %in% c("alk","cond","toc","tp","tn")))+geom_boxplot(aes(y = log10(value), fill = variable))+
  facet_grid(rows=vars(variable),cols=vars(sat), scales = "free_y")+
  scale_fill_viridis_d(end = 0.8)+
  theme_minimal()

bp2 <- ggplot(filter(wtc.long, variable %in% c("temp","area","alt","slope","latitude")))+geom_boxplot(aes(y = log10(value), fill = variable))+
  facet_grid(rows=vars(variable),cols=vars(sat), scales = "free_y")+
  scale_fill_viridis_d(end = 0.8)+
  theme_minimal()

ggarrange(bp1,bp2, ncol = 2, nrow = 1)
```

# Corrplots

ADD P-MAT

```{r plots, fig.dim = c(15,15), cache.extra=file.mtime("wtc.rds")}

corrplot::corrplot.mixed(cor(dplyr::select(wtc, c("fCO2","area","perimtot","slope","alt","latitude","longitude","toc")), use = "pairwise.complete"), tl.cex = 1.5, number.cex = 1.5)
corrplot::corrplot.mixed(cor(dplyr::select(wtc, c("fCO2","ndvi.value","arable","bogs","forest","bare","runoff","temp","prec","toc")), use = "pairwise.complete"), tl.cex = 1.5, number.cex = 1.5)
corrplot::corrplot.mixed(cor(dplyr::select(wtc, c("fCO2","ph","alk","cond","ca","mg","na","k","cl","so4","f","no3","nh4","tp","tn","toc","cn","cp"))), tl.cex = 1.5, number.cex = 1.5)
```

## PCA

```{r pca-total, fig.dim = c(12,10), cache = T, cache.extra=file.mtime("wtc.rds")}

library(viridisLite)
library(factoextra)

pca.rr <- prcomp(formula = ~., data = wtc, center = T, scale. = T)

plot.pca.12 <- fviz_pca_var(pca.rr,
                              habillage = "none",
                             label = "var",
                             col.var = "black",
                             labelsize = 7,
                             repel = T,arrowsize=1)+theme_bw(base_size=30)

plot.pca.23 <- fviz_pca_var(pca.rr, axes = c(2,3),
                              habillage = "none",
                             label = "var",
                             labelsize = 7,
                             col.var = "black",
                             repel = T,arrowsize=1)+theme_bw(base_size=30)
par(mfrows = c(1,2))
plot.pca.12
plot.pca.23

```

# fCO2 modelled with TOC

```{r over-under-df}
oversat <- dplyr::filter(wtc, sat == 1)
undersat <- dplyr::filter(wtc, sat == -1)
 
```

## fCO2 modelled with TOC, LM

Fit fCO2 with only TOC as predictor:

```{r fCO2-TOC, cache = T, cache.extra=file.mtime("wtc.rds")}

lm1 <- lm(fCO2~toc, data = wtc)
summary(lm1)

wtc$fplm <- predict(lm1, type = "response")
ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2), col = "Obs"))+geom_point(aes(y = log10(fplm), col = "Pred"))+
  geom_hline(yintercept = log10(fCO2.1995), col = "darkblue")+
  annotate(geom = "text",label = paste("AIC",round(extractAIC(lm1)[2]), sep = "="), x = 0, y = 3.5)+
  scale_color_manual(values = c("lightblue","black"))+theme_minimal()

lm1b <- lm(log10(fCO2)~log10(toc), data = wtc)
summary(lm1b)


wtc$fplmlog <- predict(lm1b, type = "response")
ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2), col = "Obs"))+geom_point(aes(y = fplmlog, col = "Pred"))+
   geom_hline(yintercept = log10(fCO2.1995), col = "darkblue")+
  annotate(geom = "text",label = paste("AIC",round(extractAIC(lm1b)[2]), sep = "="), x = 0, y = 3.5)+
  scale_color_manual(values = c("lightblue","black"))+theme_minimal()
```

```{r test-double, cache = T, cache.extra=file.mtime("wtc.rds")}
lmover <- lm(fCO2~toc, data = oversat)
lmunder <- lm(fCO2~toc, data = undersat)

summary(lmover)
summary(lmunder)

oversat$pred <- predict(lmover, type = "response") %>% log10()
undersat$pred <- predict(lmunder, type = "response") %>% log10()

ggplot()+geom_point(data = wtc, aes(x = log10(toc), y = log10(fCO2), col = "obs"))+
  geom_point(data = oversat, aes(x = log10(toc), y = pred, col = "over"))+
  geom_point(data = undersat, aes(x = log10(toc), y = pred, col = "under"))+
  geom_hline(yintercept = log10(fCO2.1995), col = "darkblue")+
  scale_color_manual(values = c("lightblue","black","darkgray"))+
  theme_minimal()

```

## fCO2-TOC with GAM and Gamma distribution

```{r gam-fco2-toc, cache = T, cache.extra=file.mtime("wtc.rds")}
g1 <- mgcv::gam(fCO2~toc, data = wtc, family = Gamma(link = "identity"))
summary(g1)

wtc$fpg <- predict(g1,type = "response")
ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2), col = "Obs"))+geom_point(aes(y = log10(fpg), col = "Pred"))+
  annotate(geom = "text",label = paste("AIC",round(extractAIC(g1)[2]), sep = "="), x = 0, y = 3.5)+
  geom_hline(yintercept = log10(fCO2.1995), col = "darkblue")+
  scale_color_manual(values = c("lightblue","black"))+theme_minimal()

g1b <- mgcv::gam(log10(fCO2)~log10(toc), data = wtc, family = Gamma(link = "identity"), method = "REML")
summary(g1b)

wtc$fpglog <- predict(g1b, type = "response")
ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2), col = "Obs"))+geom_point(aes(y = fpglog, col = "Pred"))+
  annotate(geom = "text",label = paste("AIC",round(extractAIC(g1b)[2]), sep = "="), x = 0, y = 3.5)+
  geom_hline(yintercept = log10(fCO2.1995), col = "darkblue")+
  scale_color_manual(values = c("lightblue","black"))+theme_minimal()

g1c <- mgcv::gam(fCO2~toc, data = wtc, family = Gamma(link = "log"))
summary(g1c)

wtc$fpgc <- predict(g1c,type = "response")
ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2), col = "Obs"))+geom_point(aes(y = log10(fpgc), col = "Pred"))+
  annotate(geom = "text",label = paste("AIC",round(extractAIC(g1c)[2]), sep = "="), x = 0, y = 3.5)+
  geom_hline(yintercept = log10(fCO2.1995), col = "darkblue")+
  scale_color_manual(values = c("lightblue","black"))+theme_minimal()
```

## GAM with Tweedie

```{r fCO2-TOC-tweedie, cache = T, cache.extra=file.mtime("wtc.rds")}
t1 <- gam(list(fCO2~toc,~1, ~1), data = wtc, family = twlss(link = list("identity","identity","identity")))
summary(t1)

wtc$fpt <- predict(t1, type = "response")[,1]
ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2), col = "Obs"))+geom_point(aes(y = log10(fpt), col = "Pred"))+
   geom_hline(yintercept = log10(fCO2.1995), col = "darkblue")+
  annotate(geom = "text",label = paste("AIC",round(extractAIC(t1)[2]), sep = "="), x = 0, y = 3.5)+
  scale_color_manual(values = c("lightblue","black"))+theme_minimal()

t1b <- gam(list(log10(fCO2)~log10(toc),~1, ~1), data = wtc, family = twlss(link = list("identity","identity","identity")))
summary(t1b)

wtc$fptlog <- predict(t1b, type = "response")[,1]
ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2), col = "Obs"))+geom_point(aes(y = fptlog, col = "Pred"))+
   geom_hline(yintercept = log10(fCO2.1995), col = "darkblue")+
  annotate(geom = "text",label = paste("AIC",round(extractAIC(t1b)[2]), sep = "="), x = 0, y = 3.5)+
  scale_color_manual(values = c("lightblue","black"))+theme_minimal()


t1c <- gam(list(fCO2~toc,~1, ~1), data = wtc, family = twlss(link = list("log","identity","identity")))
summary(t1c)

 
wtc$fptc <- predict(t1c, type = "response")[,1]
ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2), col = "Obs"))+geom_point(aes(y = log10(fptc), col = "Pred"))+
   geom_hline(yintercept = log10(fCO2.1995), col = "darkblue")+
  annotate(geom = "text",label = paste("AIC",round(extractAIC(t1c)[2]), sep = "="), x = 0, y = 3.5)+
  scale_color_manual(values = c("lightblue","black"))+theme_minimal()
```

```{r test-double-tweedie, cache = T, cache.extra=file.mtime("wtc.rds")}

twover <- gam(list(fCO2~toc,~1,~1), data = oversat,family = twlss(link = list("log","identity","identity")))
twunder <- gam(list(fCO2~toc,~1,~1), data = undersat,family = twlss(link = list("log","identity","identity")))
summary(twover)
summary(twunder)

oversat$pred_tw <- predict(twover, type = "response")[,1] %>% log10()
undersat$pred_tw <- predict(twunder, type = "response")[,1] %>% log10()

ggplot()+geom_point(data = wtc, aes(x = log10(toc), y = log10(fCO2), col = "obs"))+
  geom_point(data = oversat, aes(x = log10(toc), y = pred_tw, col = "over"))+
  geom_point(data = undersat, aes(x = log10(toc), y = pred_tw, col = "under"))+
  scale_color_manual(values = c("lightblue","black","darkgray"))+
   geom_hline(yintercept = log10(fCO2.1995), col = "darkblue")+
  theme_minimal()

```

## GLM with gamma

Fit fCO2 with only TOC as predictor:

```{r fCO2-TOC-glm, cache = T, cache.extra=file.mtime("wtc.rds")}
glm1 <- glm(fCO2~toc, data = wtc, family = Gamma(link = "identity"))
summary(glm1)

wtc$fpg <- predict(glm1, type = "response")
ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2), col = "Obs"))+geom_point(aes(y = log10(fpg), col = "Pred"))+
   geom_hline(yintercept = log10(fCO2.1995), col = "darkblue")+
  annotate(geom = "text",label = paste("AIC",round(extractAIC(glm1)[2]), sep = "="), x = 0, y = 3.5)+
  scale_color_manual(values = c("lightblue","black"))+theme_minimal()

glm1b <- glm(log10(fCO2)~log10(toc), data = wtc, family = Gamma(link = "identity"))
summary(glm1b)

wtc$fpglog <- predict(glm1b,  type = "response")
ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2), col = "Obs"))+geom_point(aes(y = fpglog, col = "Pred"))+
   geom_hline(yintercept = log10(fCO2.1995), col = "darkblue")+
  annotate(geom = "text",label = paste("AIC",round(extractAIC(glm1b)[2]), sep = "="), x = 0, y = 3.5)+
  scale_color_manual(values = c("lightblue","black"))+theme_minimal()


glm1c <- glm(fCO2~toc, data = wtc, family = Gamma(link = "log"))
summary(glm1c)

wtc$fpgc <- predict(glm1c, type = "response")
ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2), col = "Obs"))+
  geom_point(aes(y = log10(fpgc), col = "Pred"))+scale_color_manual(values = c("lightblue","black"))+
   geom_hline(yintercept = log10(fCO2.1995), col = "darkblue")+
  annotate(geom = "text",label = paste("AIC",round(extractAIC(glm1c)[2]), sep = "="), x = 0, y = 3.5)+
  theme_minimal()

```

```{r test-double-glm, cache = T, cache.extra=file.mtime("wtc.rds")}

glmover <- glm(fCO2~toc, data = oversat, family = Gamma(link = "log"))
glmunder <- glm(fCO2~toc, data = undersat, family = Gamma(link = "log"))
summary(glmover)
summary(glmunder)

oversat$pred_glm <- predict(glmover, type = "response") %>% log10()
undersat$pred_glm <- predict(glmunder, type = "response") %>% log10()

ggplot()+geom_point(data = wtc, aes(x = log10(toc), y = log10(fCO2), col = "obs"))+
  geom_point(data = oversat, aes(x = log10(toc), y = pred_glm, col = "over"))+
  geom_point(data = undersat, aes(x = log10(toc), y = pred_glm, col = "under"))+
  scale_color_manual(values = c("lightblue","black","darkgray"))+
   geom_hline(yintercept = log10(fCO2.1995), col = "darkblue")+
  theme_minimal()

```

# Adding other variables

Goal: predict fCO2 in lakes // part of TIC pool.

Processes involved:

`r knitr::include_graphics(c("C-cycle.png","C-cycle-legend.png"))`

@Maberly2012 CO2 imported is from SOC respiration

@Allesson2022 conductivity is linked to groundwater influx -\> TIC import

Choosen variables:

-   TOC is freshwater OC pool

-   Temp as proxy for bacterioplankton respiration. \*\* not significant in models below. I suggest a DOC quality proxy ex. C/N

-   IS ("ionic strenght"; though incomplete,as a "proxy" itself for conductivity) for TIC imported (we don't use Ca because Ca is too correlated to alkalinity, which we already use to compute fCO2)

Neglected processes:

-   transport: we consider the water pool only

-   photomineralization is neglected (Lina's estimation of contribution to CO2 production = 3%) [@Allesson2021]

-   sedimentation : ??? assume that sedimentation rate and respiration balance each other.

-   methanogenesis: left out at the moment

**IF THE INTERACTION BETWEEN TOC and SAT IS NOT INCLUDED, GLM OBTAINS THE SAME RESULTS AS LM (RESULTS FOR LM ARE THE SAME WITH AND WITHOUT INTERACTION)**

```{r glm-variables-id, cache = T, cache.extra=file.mtime("wtc.rds")}
wtc <- readRDS("wtc.rds")

glm2 <- glm(fCO2~toc+cond+temp+tp, data = wtc, family = Gamma(link = "log"))
summary(glm2)

glm3 <- glm(fCO2~toc*sat+cond+temp+tp, data = wtc, family = Gamma(link = "log"))
summary(glm3)

glm4 <- glm(fCO2~toc+cond+temp+tp*sat, data = wtc, family = Gamma(link = "log"))
summary(glm4)

lm3 <- lm(fCO2~toc*sat+cond+temp+tp, data = wtc)
summary(lm3)

wtc$fp <- predict(glm2, type = "response")
wtc$fp3 <- predict(glm3, type = "response")
wtc$fp4 <- predict(glm4, type = "response")
wtc$fplm3 <- predict(glm3, type = "response")

ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2), col = "Obs"))+
  geom_point(aes(y = log10(fp), col = "GLM with toc+sat"), size = 2, alpha = 0.5)+
   geom_point(aes(y = log10(fp3), col = "GLM with toc*sat"), size = 2, alpha = 0.5)+
  geom_point(aes(y = log10(fp4), col = "GLM with tp*sat"), size = 1, alpha = 0.5)+
  geom_point(aes(y = log10(fplm3), col = "LM with toc*sat"), size = 1, alpha = 0.5)+
     scale_color_manual(values = c("orange","darkolivegreen","firebrick","lightblue","black")) +
  geom_hline(yintercept = log10(fCO2.1995), col = "darkblue") +
  theme_minimal()

```

```{r cba-test-glm, cache = T, cache.extra=file.mtime("cba.sf.rds")}
cba.sf <- readRDS("cba.sf.rds")

cba.sf$sat <- NA
cba.sf$sat[which(cba.sf$fCO2 < fCO2.2019)] <- -1
cba.sf$sat[which(cba.sf$fCO2 > fCO2.2019)] <- 1

cba.sf$fp3 <- predict(glm3,newdata= cba.sf, type = "response")
cba.sf$fplm3 <- predict(lm3, newdata = cba.sf, type = "response")

ggplot(cba.sf, aes(x=log10(toc)))+
  geom_point(aes(y=log10(fCO2), col = "Obs"), size = 2)+
  geom_point(aes(y=log10(fp3), col = "Pred GLM + log-link"), size = 2, alpha = 0.5)+
  geom_point(aes(y=log10(fplm3), col = "Pred LM + id-link"), size = 2, alpha = 0.5)+
  geom_hline(yintercept = log10(fCO2.2019), col = "darkblue")+             
scale_color_manual(values = c("black","lightblue","firebrick","orange")) +
    theme_minimal()

```

temp is not significant in above model.

-   The only way to get the "cloud" of points for oversaturated lakes is to include pH in the model -\> how to do without?

```{r test-ph}

glm8 <- glm(fCO2~toc+cond+tp+ph+temp, data = wtc, family = Gamma(link = "log"))
summary(glm8)

wtc$fp8 <- predict(glm8, type = "response")

ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2)), col = "Black")+
  geom_point(aes(y = log10(fp8), col = "GLM with toc+Temp+cond+tp+ph"), size = 1, alpha = 0.5)+
  geom_hline(yintercept = log10(fCO2.1995), col = "darkblue") +
  scale_color_manual(values = c("lightblue"))+
  theme_minimal()

```

## Test with TOC predictors

```{r glm-toc-predictors}
wtc <- readRDS("wtc.rds")

wtc.ndvi <- wtc %>% filter(!is.na(ndvi.value)) %>% filter(!is.na(runoff))

glm10 <- glm(fCO2~ndvi.value+arable+bogs+runoff+tndep, data = wtc.ndvi, family = Gamma(link = "log"))
summary(glm10)

wtc.ndvi$fp10 <- predict(glm10, type = "response")

ggplot(wtc.ndvi,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2)), col = "Black")+
  geom_point(aes(y = log10(fp10), col = "GLM with ndvi+arable+bogs+runoff"), size = 1, alpha = 0.5)+
  geom_hline(yintercept = log10(fCO2.1995), col = "darkblue") +
  scale_color_manual(values = c("lightblue"))+
  theme_minimal()

```

## Test with Lauerwald predictors

```{r glm-laerwald}
wtc <- readRDS("wtc.rds")

wtc.lauer <- dplyr::filter(wtc,!is.na(slope))

glmlauer <- glm(fCO2~prec+temp+slope, data = wtc.lauer, family = Gamma(link = "log"))
summary(glmlauer)

wtc.lauer$fp <- predict(glmlauer, type = "response")

ggplot(wtc.lauer,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2)), col = "Black")+
  geom_point(aes(y = log10(fp), col = "GLM with prec+temp+slope"), size = 1, alpha = 0.5)+
  geom_hline(yintercept = log10(fCO2.1995), col = "darkblue") +
  scale_color_manual(values = c("lightblue"))+
  theme_minimal()

ggplot(wtc.lauer, aes(x = log10(fCO2), y = log10(fp)))+geom_point(aes(col = log10(area)))+
  geom_abline(slope = 1, intercept = 0)+
  geom_smooth(se = F, formula = y~x)+
  annotate(geom = "label", x = 3.5, y = 2.5, label = paste("r2 = ", round(cor(wtc.lauer$fCO2,wtc.lauer$fp)^2, 2)))+
  scale_color_viridis_c()+
  theme_minimal()

glmlauer2 <- glm(fCO2~prec+temp+slope+area, data = wtc.lauer, family = Gamma(link = "log"))
summary(glmlauer2)

wtc.lauer$fp2 <- predict(glmlauer2, type = "response")

ggplot(wtc.lauer,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2)), col = "Black")+
  geom_point(aes(y = log10(fp2), col = "GLM with prec+temp+slope+area"), size = 1, alpha = 0.5)+
  geom_hline(yintercept = log10(fCO2.1995), col = "darkblue") +
  scale_color_manual(values = c("lightblue"))+
  theme_minimal()

ggplot(wtc.lauer)+geom_point(aes(x = log10(fCO2), y = log10(fp2), col = log10(area)))+
  geom_abline(slope = 1, intercept = 0)+
  annotate(geom = "label", x = 3.5, y = 2.5, label = paste("r2 = ", round(cor(wtc.lauer$fCO2,wtc.lauer$fp2)^2, 2)))+
  scale_color_viridis_c()+
  theme_minimal()

```

```{r test-hastie}
glm_hastie <- glm(fCO2~area+temp+prec, data = wtc, family = Gamma(link = "log"))
summary(glm_hastie)
wtc$fphastie <- predict(glm_hastie, type= "response")

ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2)), col = "Black")+
  geom_point(aes(y = log10(fphastie), col = "GLM with prec+temp+area"), size = 1, alpha = 0.5)+
  geom_hline(yintercept = log10(fCO2.1995), col = "darkblue") +
  scale_color_manual(values = c("lightblue"))+
  theme_minimal()

ggplot(wtc)+geom_point(aes(x = log10(fCO2), y = log10(fphastie), col = log10(slope)))+
  geom_abline(slope = 1, intercept = 0)+
  annotate(geom = "label", x = 3.5, y = 2.5, label = paste("r2 = ", round(cor(wtc$fCO2,wtc$fphastie)^2, 2)))+
  scale_color_viridis_c()+
  theme_minimal()

glm_hastie2 <- glm(fCO2~area+temp*log10(tp)+prec, data = wtc, family = Gamma(link = "log"))
summary(glm_hastie2)
wtc$fphastie2 <- predict(glm_hastie2, type= "response")

ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2)), col = "Black")+
  geom_point(aes(y = log10(fphastie2), col = "GLM with prec+temp+area+log10(tp)"), size = 1, alpha = 0.5)+
  geom_hline(yintercept = log10(fCO2.1995), col = "darkblue") +
  scale_color_manual(values = c("lightblue"))+
  theme_minimal()

ggplot(wtc)+geom_point(aes(x = log10(fCO2), y = log10(fphastie2), col = log10(slope)))+
  geom_abline(slope = 1, intercept = 0)+
  annotate(geom = "label", x = 3.5, y = 2.5, label = paste("r2 = ", round(cor(wtc$fCO2,wtc$fphastie2)^2, 2)))+
  scale_color_viridis_c()+
  theme_minimal()
```

# Bibliographie

`r knitr::knit_exit()`

# More

```{r glm-variables-ind, cache = T, cache.extra=file.mtime("wtc.rds"), fig.dim = c(15,10)}


glm5 <- glm(fCO2~toc*sat+tp, data = wtc, family = Gamma(link = "log"))
summary(glm5)

glm6 <- glm(fCO2~toc*sat+cond, data = wtc, family = Gamma(link = "log"))
summary(glm6)

glm7 <- glm(fCO2~toc*sat+temp, data = wtc, family = Gamma(link = "log"))
summary(glm7)

wtc$fp5 <- predict(glm5, type = "response")
wtc$fp6 <- predict(glm6, type = "response")
wtc$fp7 <- predict(glm7, type = "response")

p3 <- ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2)), col = "Black")+
  geom_point(aes(y = log10(fp3), col = "GLM with toc*sat+is+Temp+tp"), size = 2, alpha = 0.5)+
  geom_hline(yintercept = log10(fCO2.1995), col = "darkblue") +
  scale_color_manual(values = c("lightblue")) +
  theme_minimal()

p5 <- ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2)), col = "Black")+
  geom_point(aes(y = log10(fp5), col = "GLM with tp"), size = 2, alpha = 0.5)+
  geom_hline(yintercept = log10(fCO2.1995), col = "darkblue") +
 scale_color_manual(values = c("darkolivegreen")) +
  theme_minimal()

p6 <- ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2)), col = "Black")+
  geom_point(aes(y = log10(fp6), col = "GLM with is"), size = 1.5, alpha = 0.5)+
  geom_hline(yintercept = log10(fCO2.1995), col = "darkblue") +
     scale_color_manual(values = c("orange")) +
  theme_minimal()

p7 <- ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2)), col = "Black")+
  geom_point(aes(y = log10(fp7), col = "GLM with Temp"), size = 1.5, alpha = 0.5)+
  geom_hline(yintercept = log10(fCO2.1995), col = "darkblue") +
  scale_color_manual(values = c("firebrick")) +
  theme_minimal()

ggarrange(p3,p5,p6,p7,nrow=2, ncol = 2)
```

```{r glm-ndvi}
wtc <- readRDS("wtc.rds")

wtc.ndvi <- wtc %>% filter(!is.na(ndvi.value)) %>% filter(!is.na(runoff))

glm3 <- glm(fCO2~toc*sat+cond+temp+tp, data = wtc.ndvi, family = Gamma(link = "log"))
summary(glm3)

wtc.ndvi$fp3 <- predict(glm3, type = "response")


glm10 <- glm(fCO2~ndvi.value+arable+bogs+runoff+tndep, data = wtc.ndvi, family = Gamma(link = "log"))
summary(glm10)

wtc.ndvi$fp10 <- predict(glm10, type = "response")

ggplot(wtc.ndvi,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2)), col = "Black")+
  geom_point(aes(y = log10(fp3), col = "GLM with toc*sat+cond+tp+Temp"), size = 2, alpha = 0.5)+
  geom_point(aes(y = log10(fp10), col = "GLM with ndvi+arable+bogs+runoff"), size = 1, alpha = 0.5)+
  geom_hline(yintercept = log10(fCO2.1995), col = "darkblue") +
  scale_color_manual(values = c("firebrick","lightblue"))+
  theme_minimal()

glm11 <- glm(fCO2~toc*ndvi.value+cond+tp, data = wtc.ndvi, family = Gamma(link = "log"))
summary(glm11)

wtc.ndvi$fp11 <- predict(glm11, type = "response")

ggplot(wtc.ndvi,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2)), col = "Black")+
  geom_point(aes(y = log10(fp3), col = "GLM with toc*sat+cond+tp"), size = 2, alpha = 0.5)+
  geom_point(aes(y = log10(fp11), col = "GLM with toc*ndvi+cond+tp"), size = 1, alpha = 0.5)+
  geom_hline(yintercept = log10(fCO2.1995), col = "darkblue") +
  scale_color_manual(values = c("firebrick","lightblue"))+
  theme_minimal()

glm12 <- glm(fCO2~ndvi.value, data = wtc.ndvi, family = Gamma(link = "log"))
summary(glm12)

wtc.ndvi$fp12 <- predict(glm12, type = "response")

ggplot(wtc.ndvi,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2)), col = "Black")+
  geom_point(aes(y = log10(fp3), col = "GLM with toc*sat+cond+tp+Temp"), size = 2, alpha = 0.5)+
  geom_point(aes(y = log10(fp12), col = "GLM with ndvi"), size = 1, alpha = 0.5)+
  geom_hline(yintercept = log10(fCO2.1995), col = "darkblue") +
  scale_color_manual(values = c("firebrick","lightblue"))+
  theme_minimal()

glm15 <- glm(fCO2~runoff, data = wtc.ndvi, family = Gamma(link = "log"))
summary(glm15)

wtc.ndvi$fp15 <- predict(glm15, type = "response")

ggplot(wtc.ndvi,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2)), col = "Black")+
  geom_point(aes(y = log10(fp3), col = "GLM with toc*sat+cond+tp+Temp"), size = 2, alpha = 0.5)+
  geom_point(aes(y = log10(fp15), col = "GLM with runoff"), size = 1, alpha = 0.5)+
  geom_hline(yintercept = log10(fCO2.1995), col = "darkblue") +
  scale_color_manual(values = c("firebrick","lightblue"))+
  theme_minimal()

glm16 <- glm(fCO2~bogs, data = wtc.ndvi, family = Gamma(link = "log"))
summary(glm16)

wtc.ndvi$fp16 <- predict(glm16, type = "response")

ggplot(wtc.ndvi,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2)), col = "Black")+
  geom_point(aes(y = log10(fp3), col = "GLM with toc*sat+cond+tp+Temp"), size = 2, alpha = 0.5)+
  geom_point(aes(y = log10(fp16), col = "GLM with bogs"), size = 1, alpha = 0.5)+
  geom_hline(yintercept = log10(fCO2.1995), col = "darkblue") +
  scale_color_manual(values = c("firebrick","lightblue"))+
  theme_minimal()

glm17 <- glm(fCO2~forest, data = wtc.ndvi, family = Gamma(link = "log"))
summary(glm17)

wtc.ndvi$fp17 <- predict(glm17, type = "response")

ggplot(wtc.ndvi,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2)), col = "Black")+
  geom_point(aes(y = log10(fp3), col = "GLM with toc*sat+cond+tp+Temp"), size = 2, alpha = 0.5)+
  geom_point(aes(y = log10(fp17), col = "GLM with forest"), size = 1, alpha = 0.5)+
  geom_hline(yintercept = log10(fCO2.1995), col = "darkblue") +
  scale_color_manual(values = c("firebrick","lightblue"))+
  theme_minimal()

glm18 <- glm(fCO2~arable, data = wtc.ndvi, family = Gamma(link = "log"))
summary(glm18)

wtc.ndvi$fp18 <- predict(glm18, type = "response")

ggplot(wtc.ndvi,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2)), col = "Black")+
  geom_point(aes(y = log10(fp3), col = "GLM with toc*sat+cond+tp+Temp"), size = 2, alpha = 0.5)+
  geom_point(aes(y = log10(fp18), col = "GLM with arable"), size = 1, alpha = 0.5)+
  geom_hline(yintercept = log10(fCO2.1995), col = "darkblue") +
  scale_color_manual(values = c("firebrick","lightblue"))+
  theme_minimal()

glm19 <- glm(fCO2~prec, data = wtc.ndvi, family = Gamma(link = "log"))
summary(glm19)

wtc.ndvi$fp19 <- predict(glm19, type = "response")

ggplot(wtc.ndvi,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2)), col = "Black")+
  geom_point(aes(y = log10(fp3), col = "GLM with toc*sat+cond+tp+Temp"), size = 2, alpha = 0.5)+
  geom_point(aes(y = log10(fp19), col = "GLM with precipitation"), size = 1, alpha = 0.5)+
  geom_hline(yintercept = log10(fCO2.1995), col = "darkblue") +
  scale_color_manual(values = c("firebrick","lightblue"))+
  theme_minimal()

```

## Tests with tweedie

```{r gam-tweedie-toc-NDVI, cache = T}
wtc <-readRDS("wtc.rds")

t2 <- gam(list(fCO2~toc+is+ca+NDVI+Runoff+cn+cp,~1, ~1), data = wtc, family = twlss(link = list("log","identity","identity")))
summary(t2)

t2b <- gam(list(fCO2~s(toc)+s(is)+s(ca)+s(NDVI)+s(Runoff)+s(cn)+s(cp),~1, ~1), data = wtc, family = twlss(link = list("log","identity","identity")))
summary(t2b)

t2c <- gam(list(fCO2~s(toc)+s(is)+s(ca)+s(cn)+s(cp),~1, ~1), data = wtc, family = twlss(link = list("log","identity","identity")))
summary(t2c)


g2 <- glm(fCO2~toc+is+ca+NDVI+Runoff+cn+cp, data = wtc, family = Gamma(link = "log"))
summary(g2)

g2b <- glm(fCO2~toc+is+ca+NDVI+Runoff+cn+cp, data = wtc, family = Gamma(link = "identity"), start = c(1,1,1,1,1,1,1,1))
summary(g2b)


wtc$fpt <- predict(t2, type = "response")[,1]
wtc$fptb <- predict(t2b, type = "response")[,1]
wtc$fptc <- predict(t2c, type = "response")[,1]
wtc$fpg <- predict(g2, type = "response")
wtc$fpgb <- predict(g2b, type = "response")

ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2), col = "Obs"))+
  geom_point(aes(y = log10(fpg), col = "GLM"), size = 2, alpha = 0.5)+
  geom_point(aes(y = log10(fpt), col = "Tweedie"), size = 1, alpha = 0.5)+
    annotate(geom = "text",label = paste("AIC tweedie ",round(extractAIC(t2)[2]), sep = "="), x = 0, y = 3.5)+
    annotate(geom = "text",label = paste("AIC gamma ",round(extractAIC(g2)[2]), sep = "="), x = 0, y = 3.3)+
   geom_hline(yintercept = log10(fCO2.1995), col = "darkblue")+
  scale_color_manual(values = c("orange","black","lightblue"))+theme_minimal()

ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2), col = "Obs"))+
  geom_point(aes(y = log10(fpt), col = "Tweedie"), size = 2, alpha = 0.5)+
  geom_point(aes(y = log10(fptb), col = " Smoothed Tweedie"), size = 1, alpha = 0.5)+
  annotate(geom = "text",label = paste("AIC tweedie ",round(extractAIC(t2)[2]), sep = "="), x = 0, y = 3.5)+
  annotate(geom = "text",label = paste("AIC s tweedie ",round(extractAIC(t2b)[2]), sep = "="), x = 0, y = 3.7)+
   geom_hline(yintercept = log10(fCO2.1995), col = "darkblue")+
  scale_color_manual(values = c("firebrick","black","lightblue"))+theme_minimal()

ggplot(wtc,aes(x=log10(toc)))+geom_point(aes(y=log10(fCO2), col = "Obs"))+
  geom_point(aes(y = log10(fpg), col = "GLM-log"), size = 2, alpha = 0.5)+
  geom_point(aes(y = log10(fpgb), col = "GLM-id"), size = 1, alpha = 0.5)+
  annotate(geom = "text",label = paste("AIC GLM-log ",round(extractAIC(g2)[2]), sep = "="), x = 0, y = 3.5)+
  annotate(geom = "text",label = paste("AIC GLM-id ",round(extractAIC(g2b)[2]), sep = "="), x = 0, y = 3.7)+
   geom_hline(yintercept = log10(fCO2.1995), col = "darkblue")+
  scale_color_manual(values = c("firebrick","lightblue","black"))+theme_minimal()
```

Similar results for GAM with tweedie and GLM with gamma. Smoothed tweedie has lower AIC. All models are unable to predict undersaturation at high TOC concentration.

```{r predict-sat, cache = T}

wtc$sat <- NA
wtc$sat[which(wtc$fCO2 > fCO2.1995)] <- 1
wtc$sat[which(wtc$fCO2 < fCO2.1995)] <- 0
wtc$sat <- as.factor(wtc$sat)

glmsat <- glm(sat~is+ca+NDVI+Runoff+cn+cp+ph, data = wtc, family = binomial)
summary(glmsat)

wtc$sat.pred <- predict(glmsat, type = "response")

ggplot(wtc)+geom_point(aes(x=log10(toc),y=log10(fCO2), col = sat.pred))+
  scale_colour_continuous_divergingx(palette = "RdYlBu", mid = 0.5)+
  geom_hline(yintercept = log10(fCO2.1995), col = "purple")+
  theme_minimal()
```

```{r gam-over-under, cache = T}
oversat <- subset(wtc,fCO2 > fCO2.1995)
undersat <- subset(wtc,fCO2 < fCO2.1995)


t2o <- gam(list(fCO2~s(toc)+s(is)+s(ca)+s(NDVI)+s(Runoff)+s(cn)+s(cp),~1, ~1), data = oversat, family = twlss(link = list("log","identity","identity")))
summary(t2o)
t2u <- gam(list(fCO2~s(toc)+s(is)+s(ca)+s(NDVI)+s(Runoff)+s(cn)+s(cp),~1, ~1), data = undersat, family = twlss(link = list("log","identity","identity")))
summary(t2u)

oversat$fp2 <- predict(t2o, type = "response")[,1]
undersat$fp2 <- predict(t2u, type = "response")[,1]

ggplot()+geom_point(data = wtc, aes(x=log10(toc), y=log10(fCO2)))+
  geom_point(data = oversat, aes(x=log10(toc), y = log10(fp2), col = "oversat"))+
  geom_point(data = undersat, aes(x=log10(toc), y = log10(fp2), col = "undersat"))+
  geom_point(data = wtc, aes(x=log10(toc), y = log10(fpg), col = "total"), size = 1, alpha = 0.5)+
   geom_hline(yintercept = log10(fCO2.1995), col = "darkblue")+
  scale_color_manual(values = c("firebrick","lightblue","orange"))+
   annotate(geom = "text",label = paste("AIC over ",round(extractAIC(t2o)[2]), sep = "= "), x = 0, y = 3.5)+
  annotate(geom = "text",label = paste("AIC under ",round(extractAIC(t2u)[2]), sep = "= "), x = 0, y = 3.3)+
  theme_minimal()

```

# Extra

## Full model and stepwise selection

```{r stepwise-selection-lm}
library(MASS)
# Fit the full model 
full.model <- lm(log(fCO2) ~., data = st_drop_geometry(wtc))
summary(full.model)

# Stepwise regression model
step.model1 <- stepAIC(full.model, direction = "both", trace = FALSE)
summary(step.model1)

```

## Full model on log-transformed variables

```{r lm-log-stepwise, eval = T}

lm2 <- lm(log10fCO2~., data = logwtc)
summary(lm2)

step.model2 <- stepAIC(lm2, direction = "both", trace = FALSE)
summary(step.model2)
```

## fCO2 modelled with TOC, GAM

```{r gam-model}
library(mgcv)

#g1 <- mgcv::gam(log10fCO2~s(log10Slope)+s(NDVI)+s(log10Runoff)+s(Forest)+s(Bare)+s(Arable)+s(Bog)+s(Temp)+s(log10Precip)+s(ph)+s(log10ca)+s(log10so4)+s(log10no3)+s(log10nh4)+s(log10tn)+s(log10tp)+s(log10toc), data = logwtc, method = "REML", select = T)
#saveRDS(g1,"g1.rds")
# g1 <- readRDS("g1.rds")
# summary(g1)


#g2 <- mgcv::gam(log10fCO2~s(log10Slope)+s(NDVI)+s(Arable)+s(Temp)+s(log10Precip)+s(ph)+s(log10ca)+s(log10so4)+s(log10no3)+s(log10nh4)+s(log10tp)+s(log10toc), data = logwtc, method = "REML", select = T)
#saveRDS(g2,"g2.rds")
# g2 <- readRDS("g2.rds")
# summary(g2)

#g3 <- mgcv::gam(log10fCO2~s(NDVI)+s(Arable)+s(Temp)+s(log10Precip)+s(ph)+s(log10ca)+s(log10so4)+s(log10no3)+s(log10tp)+s(log10toc), data = logwtc, method = "REML")
#saveRDS(g3,"g3.rds")
# g3 <- readRDS("g3.rds")
# summary(g3)



```

```{r test-no-log}
  
cba.sf$fCO2lm <- predict(lm1,newdata = cba.sf, type = "response")
cba.sf$fCO2gam <- predict(g1, newdata = cba.sf, type = "response")
cba.sf$fCO2tweedie <- predict(t1,newdata = cba.sf, type = "response")[,1]
cba.sf$fCO2glm <- predict(glm1, newdata = cba.sf, type = "response")

ggplot(cba.sf, aes(x=fCO2))+geom_point(aes(y=fCO2lm + fCO2.1995, col = "LM", shape = "LM"))+
  geom_point(aes(y=fCO2glm, col = "GLM-gamma", shape = "GLM-gamma"))+
  geom_point(aes(y =fCO2tweedie, col = "Tweedie", shape = "Tweedie"))+
  geom_point(aes(y=fCO2gam, col = "GAM", shape = "GAM"))+
  geom_abline(slope = 1, intercept = 0, col = "red")+
  scale_color_manual(name = "Model", labels = c("GAM", "GLM-gamma-log","LM","Tweedie"), values = as.vector(palette.colors(n=4)))+
  scale_shape_manual(name = "Model", labels = c("GAM", "GLM-gamma-log","LM","Tweedie"), values = c(1,2,3,4))+
  labs(y = "Predicted fCO2", x = "Aquaenv fCO2")+
  ylim(0,10000)+
  theme_minimal()

ggplot(cba.sf, aes(x=toc))+geom_point(aes(y=fCO2lm + fCO2.1995, col = "LM", shape = "LM"))+
  geom_point(aes(y = fCO2), col = "black")+
  geom_point(aes(y=fCO2glm, col = "GLM-gamma", shape = "GLM-gamma"))+
  geom_point(aes(y =fCO2tweedie, col = "Tweedie", shape = "Tweedie"))+
  geom_point(aes(y=fCO2gam, col = "GAM", shape = "GAM"))+
  scale_color_manual(name = "Model", labels = c("GAM", "GLM-gamma-log","LM","Tweedie"), values = as.vector(palette.colors(n=4,palette = "ggplot2")))+
  scale_shape_manual(name = "Model", labels = c("GAM", "GLM-gamma-log","LM","Tweedie"), values = c(1,2,3,4))+
  labs(y = "Predicted fCO2", x = "TOC (mg/L)")+
  theme_minimal()



```
