---
title: "Data preparation"
author: "Camille Crapart"
date: "2023-02-21"
output: 
   bookdown::html_document2:
     code_folding: show
     toc: true
     toc_float: true
     number_sections: true
     fig_caption: true

bibliography: C:\\Users\\raine\\Documents\\UiO\\Bibtex\\fCO2.bib
link-citations: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, message = T, warning = F, error = F, fig.align = "center", results = T, collapse = T, cache.lazy = F)
options(knitr.kable.NA="", knitr.table.format = "html")
```

```{r libraries}
library(readxl)

library(AquaEnv)
library(MASS)
library(mgcv)

library(dplyr)
library(ggplot2)
library(colorspace)

library(sf)
library(sp)

fCO2.atm.2020 <- 411.51 * 1e-6 # oct 2020
fCO2.atm.2019 <- 408.75 * 1e-6 # oct 2019
fCO2.atm.2004 <- 374.63 * 1e-6 # oct 2004
fCO2.atm.1995 <- 360.17 * 1e-6 # 1995
```

atm concentration of CO2: <https://climate.nasa.gov/vital-signs/carbon-dioxide/>, dataset on <https://gml.noaa.gov/webdata/ccgg/trends/co2/co2_mm_mlo.txt>


# Data from CBA and N112 surveys

TOC was analysed by infrared CO2 detection after catalytic high temperature combustion (Shimadzu TOC-VWP analyzer) at the Department of Biosciences at the University of Oslo. pH and alkalinity (end-point titration to pH 4.5) were measured at the Chemistry Department of the University of Oslo.  


```{r cba-data}
cba.all <- readxl::read_xlsx("CBA_100Lakes_Master.xlsx")

ggplot(cba.all)+geom_point(aes(x = TOC, y = as.character(Lake_ID)))+geom_vline(xintercept = 45)
ggplot(cba.all)+geom_point(aes(x = Alkalinity, y = as.character(Lake_ID)))+geom_vline(xintercept = 0.7)
ggplot(cba.all)+geom_point(aes(x = pH_Kje, y = as.character(Lake_ID)))+
  geom_vline(xintercept = 5)


#cba <- subset(cba.all, TOC < 40) %>% subset(Alkalinity < 0.7) 

bdg.niva <- readRDS("bdg.niva.rds") %>% dplyr::select(c("CBA_Lake_ID", "lake_area_km2","basin_area_km2"))
#bdg.niva.sf <- sf::st_geometry(bdg.niva, "geometry") 

cba <- merge(cba.all,bdg.niva, by.x = "Lake_ID", by.y = "CBA_Lake_ID") 
```

```{r cba-windspeed}

nws.files <- list.files(path = "NWS", pattern = "Wind_WFDE5_CRU_2019", full.names = T) 
nws.list.stacks <- lapply(nws.files, raster::stack) %>% lapply(raster::crop, c(0,35,55,73))
nws.list.means <- lapply(nws.list.stacks, raster::mean, na.rm = T)
saveRDS(nws.list.means, "cba.nws.list.mean.rds")

#<- nws.files %>% raster::stack()  
nws.2019.mean <- raster::mean(nws.2019, na.rm = T)
annual.nws.2019 <- mean(nws.2019, na.rm = T)
cba.spdf <- SpatialPointsDataFrame(coords = cba[,c("Long","Lat")], data = cba[,c("Long","Lat")], proj4string = CRS("+proj=longlat +datum=WGS84"))
annual.nws.cba <- raster::extract(annual.nws.2019, cba.spdf)


nws.oct.2019 <- "NWS/Wind_WFDE5_CRU_201910_v2.1.nc" %>% raster::raster()
cba.spdf <- SpatialPointsDataFrame(coords = cba[,c("Long","Lat")], data =  cba[,c("Long","Lat")]) 
nws.cba <- raster::extract(nws.oct.2019, cba.spdf)

cba$nws_m.s <- nws.cba
```


```{r cba-catchment-data}
cba.summer.ndvi.2015 <- readRDS("cba.summer.ndvi.2015.rds")

runoff.cba <- readRDS("runoff.cba.rds")

bogs.cba <- readRDS("CLC/bogs.cba.rds")
arable.cba <- readRDS("CLC/arable.cba.rds")
forest.cba <- readRDS("CLC/forest.cba.rds")
bare.cba <- readRDS("CLC/bare.cba.rds")

ndep.cba <- readRDS("Ndep/ndep.df.cba.rds")

annual.temp.cba <- readRDS("annual.temp.cba.rds")
annual.prec.cba <- readRDS("annual.prec.cba.rds")

cba <- cba %>% merge(cba.summer.ndvi.2015, by = "Lake_ID") %>% merge(runoff.cba, by = "Lake_ID") %>%
  merge(bogs.cba, by = "Lake_ID") %>% merge(arable.cba, by = "Lake_ID") %>% merge(forest.cba, by = "Lake_ID") %>%
  merge(bare.cba, by = "Lake_ID") %>% merge(ndep.cba, by = "Lake_ID") %>% 
  merge(annual.prec.cba, by = "Lake_ID") %>% merge(annual.temp.cba, by = "Lake_ID")
```

```{r N112}
n112.all <- read.table("Larsen/N112_subset_110909.txt", sep="", header = TRUE,na.strings = c(".", "NA"))

n112 <- n112.all %>% subset(ykoord > 6e6) %>% subset(is.na(TIC.ug) == F) %>% subset(is.na(alkendpoint) == F)
names(n112)

nws.oct.2004 <- "NWS/Wind_WFDE5_CRU_200410_v2.1.nc" %>% raster::raster()
n112.spdf <- SpatialPointsDataFrame(coords = n112[,c("xkoord","ykoord")], data = n112[,c("xkoord","ykoord")], proj4string = CRS("+proj=utm +zone=32 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"))
n112.spdf.wgs <- n112.spdf %>% spTransform(CRS("+proj=longlat +datum=WGS84"))
nws.n112 <- raster::extract(nws.oct.2004, n112.spdf.wgs)

n112$nws_m.s <- nws.n112
```

```{r annual-wind-speed}

nws.files <- list.files(path = "NWS", pattern = "Wind_WFDE5_CRU_2004", full.names = T)
nws.2004 <- nws.files %>% raster::stack(band = 1) %>% mean()
annual.nws.2004 <- mean(nws.2004, na.rm = T)
n112.spdf <- SpatialPointsDataFrame(coords = n112[,c("xkoord","ykoord")], data = n112[,c("xkoord","ykoord")], proj4string = CRS("+proj=utm +zone=32 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"))
n112.spdf.wgs <- n112.spdf %>% spTransform(CRS("+proj=longlat +datum=WGS84"))
annual.nws.n112 <- raster::extract(annual.nws.2004, n112.spdf.wgs)

saveRDS(annual.nws.n112, "annual.nws.n112.rds")
```


```{r norway}
norway <- data.frame(survey = c(rep("CBA_2019", dim(cba)[1]),rep("N112_2004",dim(n112)[1])))

norway$lake.id <- c(cba$Lake_ID,
                    n112$Vatnlnr)
  
norway$lake.name <- c(cba$Lake_name,
                      rep(NA,dim(n112)[1]))

norway$TOC <- c(cba$TOC/12.011 * 1e-3, # mg/L to mol/L
                n112$TOC/12.011 * 1e-3) # mg/L to mol/L

norway$TIC <- c(rep(NA, dim(cba)[1]),
                n112$TIC.ug/12.011 * 1e-6) # ug/L to mol/L

norway$Ca <- c(cba$Ca / 40.78 * 1e-3, #mg/L to mol/L
                rep(NA, dim(n112)[1])) # ug/L to mol/L

norway$TN <- c(cba$TN / 14 * 1e-3, #mg/L to mol/L
                n112$TotN / 14 * 1e-6) # ug/L to mol/L

norway$Fe <- c(cba$Fe / 55.845 * 1e-3, #mg/L to mol/L
                rep(NA, dim(n112)[1]))

norway$TA <- c(cba$Alkalinity * 1e-3, # convert from meq/L to mol/L
               n112$alkendpoint * 1e-6) # assumes ueq/L to mol/L,

norway$temp_c <- c(cba$T,
                   n112$temp.situ)

norway$temp_k <- norway$temp_c + 273.15
  
norway$EC <- c(cba$EC_Kje,
               rep("NA",dim(n112)[1])) %>% as.numeric()

norway$IS <- 1.3e-5 * norway$EC

norway$fCO2.atm <- c(rep(fCO2.atm.2019, dim(cba)[1]), 
                     rep(rep(fCO2.atm.2004,dim(n112)[1])))

norway$pH <- c(cba$pH_Kje,
               n112$pH)

norway$Hplus <- 10^(-norway$pH)

norway$CO2 <- c(as.numeric(cba$CO2) * 1e-6, # from umol/L to mol/L
                n112$co2.umolar * 1e-6) # umol/L to mol/kg_solution
                
norway$long <- c(cba$Long,
                 n112.spdf.wgs@coords[,1])

norway$lat <- c(cba$Lat,
                 n112.spdf.wgs@coords[,2])

norway$lake.area <- c(cba$lake_area_km2,
                      n112$lake.area)

norway$catchment.area <- c(cba$basin_area_km2,
                      n112$poly.area)

norway$nws_m.s <- c(cba$nws_m.s,
                    n112$nws_m.s)

norway$ndvi <- c(cba$NDVI,
                 n112$NDVI)

norway$runoff <- c(cba$Runoff,
                 n112$runoff)

norway$bog <- c(cba$Bog,
                 n112$bog)

norway$arable <- c(cba$Arable,
                 n112$arable)

norway$forest <- c(cba$Forest,
                 n112$forest)

norway$Ndep <- c(cba$TNdep,
                 n112$Ndep)

norway$temp.annual <- c(cba$temp,
                 n112$temp.ann)

norway$prec.annual <- c(cba$precip,
                 rep(NA,dim(n112)[1]))
```

```{r constants}

norway$Kw = with(norway, exp(148.9802 - 13847.26/temp_k - 23.6521*log(temp_k))) # Dickson and Riley, 1979

#norway$K0 <- with(norway, 10^-((-2622.38/temp_k) + 15.5873 - 0.0178471*temp_k)) #Harned and Davis, 1943
norway$K0 <- with(norway, exp(-58.0931+90.5069*100/temp_k+22.2940*log(temp_k/100))) # Weiss 1974
norway$K1 <- with(norway, 10^-((3404.71/temp_k)- 14.8435 + 0.032786*temp_k)) # Harned and Davis, 1943
norway$K2 <- with(norway, 10^-((2902.39/temp_k) - 6.4980 + 0.02379*temp_k)) # Harned and Scholes, 1941

```

## Carbonate speciation from measured CO2

```{r carbonate-speciation-from-measured-CO2}
norway$H2CO3 <- norway$CO2 # in mol/L
norway$HCO3 <- with(norway, H2CO3 * K1 / Hplus)
norway$CO3 <- with(norway, K2 * HCO3 / Hplus)

norway$fCO2 <- with(norway, CO2 / K0)
norway$dfCO2 <- with(norway, fCO2 - fCO2.atm)

norway$OH <- with(norway, Kw/Hplus)

# Check
norway$DIC <- with(norway, H2CO3 + HCO3 + CO3)
norway$CA <- with(norway,  HCO3 + 2*CO3) 
```

```{r plot-carbonates}
ggplot(norway, aes(x = pH))+geom_point(aes(y = H2CO3, col = "H2CO3", size = DIC))+
  geom_point(aes(y = HCO3, col = "HCO3", size = DIC))+
  geom_point(aes(y = CO3, col = "CO3", size = DIC))+
  scale_color_manual(values = c("orange","firebrick","dodgerblue3"))+
  theme_minimal()

ggplot(norway, aes(x = TA))+geom_point(aes(y = H2CO3, col = "H2CO3", size = DIC))+
  geom_point(aes(y = HCO3, col = "HCO3", size = DIC))+
  geom_point(aes(y = CO3, col = "CO3", size = DIC))+
  scale_color_manual(values = c("orange","firebrick","dodgerblue3"))+
  coord_trans(y= "log10")+
  theme_minimal()

ggplot(norway)+geom_point(aes(x = TIC, y = HCO3))+ylim(0,0.00025)

```

```{r plot-fCO2}

ggplot(norway, aes(x = TOC, y = fCO2, col = survey))+
  geom_hline(yintercept = fCO2.atm.2019, col = "firebrick")+
  geom_hline(yintercept = fCO2.atm.2004, col = "dodgerblue3")+
  scale_color_manual(values = c("firebrick","dodgerblue3"))+
  coord_trans(x = "log10")+
  geom_point()+
  theme_minimal()

```

## Carbonate speciation from TA

```{r carbonate-speciation-from-TA}

norway$ta_CO3 <- with(norway,(TA - OH + Hplus) / (Hplus/K2 +2)) # in mol/L
norway$ta_HCO3 <- with(norway, ta_CO3*Hplus/K2)
norway$ta_H2CO3 <- with(norway, ta_HCO3*Hplus/K1)
norway$ta_fCO2 <- with(norway,ta_H2CO3/K0)

norway$ta_DIC <- with(norway, ta_H2CO3 + ta_HCO3 + ta_CO3)
```

## Save norway

```{r save-norway}
saveRDS(norway,"norway.rds")

```

# Northern Lakes Survey

## Download from NOFA database

Measurements methods for the Northern Lakes Survey are detailed in @Henriksen1996.

Alkalinity, detailed in Annex 3. 
"alk_e" is a the variable corresponding to the alkalinity calibrated, taking into account the account the different methods used in Norway, Sweden and Finland. 


```{r load-data, eval = F}
con <- DBI::dbConnect(RPostgreSQL::PostgreSQL(),user = "camille.crapart", password = "camille",host = "vm-srv-wallace.vm.ntnu.no", dbname = "nofa")

ion <- tbl(con, sql("SELECT gid, ebint,nation,date,temp_c,latitude,longitude,ph,alk_e_ueq_l,alk_subst,k25_ms_m,ca_ueq_l,mg_ueq_l,na_ueq_l,k_ueq_l,nh4_ueq_l,cl_ueq_l,so4_ueq_l,no3_ueq_l,f_ueq_l,tot_p_ug_l,tot_n_ug_l,toc_mg_l,dist_closest_ebint,dist_2nd_closest_ebint FROM environmental.north_euro_lake_surv_1995 ")) %>% as.data.frame()
names(ion) <- c("gid", "ebint","nation","date","temp_c","latitude","longitude","ph","alk_ueq","alk","cond","ca","mg","na","k","nh4","cl","so4","no3","f","tp","tn","toc","dist_closest_ebint","dist_2nd_closest_ebint")
saveRDS(ion,"ion.rds")

lakes <- st_read(con,query = "SELECT gid, ebint, geom, area, perimtot FROM environmental.ecco_biwa_lakes_v_0_1 WHERE ebint IN (SELECT ebint FROM environmental.north_euro_lake_surv_1995)")
saveRDS(lakes,"lakes.rds")

catchments <- st_read(con,query = "SELECT ebint, geom FROM catchments.lake_catchments WHERE ebint IN (SELECT ebint FROM environmental.north_euro_lake_surv_1995)") # in UTM33
saveRDS(catchments,"catchments.rds")
catchment.poly <- st_transform(catchments, crs = st_crs("EPSG:4326")) # converts in World Geodetic System 1984
saveRDS(catchment.poly,"catchment.poly.rds")
catchment.poly.corine <- st_transform(catchment.poly, crs = st_crs("EPSG:3035")) # converts to EU extended referential ETRS89-extended
saveRDS(catchment.poly.corine, "catchment.poly.corine.rds")
```


```{r model-fco2-4D, eval = F}
ion <- readRDS("ion.rds")
lakes <- readRDS("lakes.rds")


#ion$alk_l <- with(ion, ifelse(nation == "Norway", alk - 32, alk))
#ion$alk_e <- with(ion, ifelse(nation == "Norway", alk_l + sqrt(0.646*alk_l), alk_l))

sum(ion$alk < 0) #153 lakes
sum(ion$alk == 0) #272 lakes
sum(ion$ph == 0) #2 lakes
sum(ion$ph < 4.01)

# ion.alk <- subset(ion, alk > 0)
# ion.alk <- subset(ion.alk, ph > 4.01)

# saveRDS(ion.alk, "ion.alk.rds")
```

## Near surface wind speed

<https://cds.climate.copernicus.eu/cdsapp#!/dataset/10.24381/cds.6c68c9bb?tab=overview>

Resolution : 1x1 degree \~11.1x11.1 km \<- 123 km2

```{r nws, eval = T}
library(sp)
ion <- readRDS("ion.rds")
lakes <- readRDS("lakes.rds")

nws.oct.1995 <- "NWS/Wind_WFDE5_CRU_199510_v2.1.nc" %>% raster::raster()
plot(nws.oct.1995)

ion.spdf <- SpatialPointsDataFrame(coords = ion[,c("longitude","latitude")], data =  ion[,c("longitude","latitude")]) 
ion.nws <- raster::extract(nws.oct.1995, ion.spdf)

ion$nws_m.s <- ion.nws

saveRDS(ion,"ion.rds")

# 
# lakes.nws <- raster::extract(nws.oct.1995, lakes, sp = F, df = F, na.rm = T, fun = mean)
# saveRDS(lakes.nws, "lakes.nws.rds")
# 
# lakes$nws <- cbind(lakes,unlist(lakes.nws))

```

## Merge dfs

```{r merge-df, eval = F}

ion <- readRDS("ion.rds")
lakes <- readRDS("lakes.rds")

nls <- merge(ion, lakes, by = "ebint")

nls$uncertain <- ifelse(nls$dist_closest_ebint/nls$dist_2nd_closest_ebint > 0.5, FALSE, TRUE)
nls$uncertain[which(is.na(nls$uncertain)==TRUE)] <- FALSE

nls$temp_c[which(is.na(nls$temp_c)==T)] <- 4

nls <- nls %>% filter(toc >= 0) %>% filter(tp > 0) %>% filter(uncertain == FALSE) 

saveRDS(nls,"nls.rds")
```

```{r selected-df}
nls <- readRDS("nls.rds")

nlss <- data.frame(lake.id = nls$ebint)

nlss$pH <- nls$ph
nlss$Hplus <- 10^(-nlss$pH)
nlss$TA <- nls$alk_ueq * 1e-6
nlss$TOC <- nls$toc / 12.011 * 1e-3
nlss$nws_m.s <- nls$nws_m.s

nlss$long <- nls$longitude
nlss$lat <- nls$latitude
nlss$fCO2.atm <- fCO2.atm.1995

nlss$temp_c <- nls$temp_c
nlss$temp_k <- nls$temp_c + 273.15

nlss$lake.area <- nls$area * 1e-6 # m2 to km2

nlss$nation <- nls$nation


```

```{r dissociation-constants, eval = F}
nlss$Kw = with(nlss, exp(148.9802 - 13847.26/temp_k - 23.6521*log(temp_k))) # Dickson and Riley, 1979

#nlss$K0 <- with(nlss, 10^-((-2622.38/temp_k) + 15.5873 - 0.0178471*temp_k)) #Harned and Davis, 1943
nlss$K0 <- with(nlss, exp(-58.0931+90.5069*100/temp_k+22.2940*log(temp_k/100))) # Weiss 1974
nlss$K1 <- with(nlss, 10^-((3404.71/temp_k)- 14.8435 + 0.032786*temp_k)) # Harned and Davis, 1943
nlss$K2 <- with(nlss, 10^-((2902.39/temp_k) - 6.4980 + 0.02379*temp_k)) # Harned and Scholes, 1941


nlss$OH <- with(nlss, Kw/Hplus)
```

## Save NLS

```{r remove-duplicate}
duplicated.id <- nlss$lake.id[which(duplicated(nlss$lake.id) == T)]
nlss[nlss$lake.id %in% duplicated.id, ]
unique.nlss <- nlss %>% group_by(lake.id, nation) %>% summarise_all(median)
```

```{r save-nlss, eval = F}
saveRDS(unique.nlss, "nlss.rds")

```



