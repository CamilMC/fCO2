---
title: "norway_fCO2"
author: "Camille Crapart"
date: "2023-01-23"
output: 
   bookdown::html_document2:
     code_folding: hide
     toc: true
     toc_float: true
     number_sections: true
     fig_caption: true

bibliography: C:\\Users\\raine\\Documents\\UiO\\Bibtex\\fCO2.bib
link-citations: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = T, message = T, warning = F, error = F, fig.align = "center", results = T, collapse = T, cache.lazy = F)
options(knitr.kable.NA="", knitr.table.format = "html")
```

```{r libraries}
library(readxl)

library(AquaEnv)
library(MASS)
library(mgcv)

library(dplyr)
library(ggplot2)
library(colorspace)

library(sf)
library(sp)

fCO2.atm.2020 <- 411.51 * 1e-6 # oct 2020
fCO2.atm.2019 <- 408.75 * 1e-6 # oct 2019
fCO2.atm.2004 <- 374.63 * 1e-6 # oct 2004
```

atm concentration of CO2: <https://climate.nasa.gov/vital-signs/carbon-dioxide/>, dataset on <https://gml.noaa.gov/webdata/ccgg/trends/co2/co2_mm_mlo.txt>

```{r cba-data}
cba.all <- readxl::read_xlsx("CBA_100Lakes_Master.xlsx")

ggplot(cba.all)+geom_point(aes(x = TOC, y = as.character(Lake_ID)))+geom_vline(xintercept = 45)
ggplot(cba.all)+geom_point(aes(x = Alkalinity, y = as.character(Lake_ID)))+geom_vline(xintercept = 0.7)
ggplot(cba.all)+geom_point(aes(x = pH_Kje, y = as.character(Lake_ID)))+
  geom_vline(xintercept = 5)

cor(cba.all$Alkalinity,cba.all$Ca*2, use = "pairwise.complete")

cba <- subset(cba.all, TOC < 40) %>% subset(Alkalinity < 0.7) 

bdg.niva <- readRDS("bdg.niva.rds") %>% dplyr::select(c("CBA_Lake_ID", "lake_area_km2","basin_area_km2"))

cba <- merge(cba,bdg.niva, by.x = "Lake_ID", by.y = "CBA_Lake_ID") 

nws.oct.2019 <- "NWS/Wind_WFDE5_CRU_201910_v2.1.nc" %>% raster::raster()
cba.spdf <- SpatialPointsDataFrame(coords = cba[,c("Long","Lat")], data =  cba[,c("Long","Lat")]) 
nws.cba <- raster::extract(nws.oct.2019, cba.spdf)

cba$nws_m.s <- nws.cba
```

```{r gather-cba}

cba.summer.ndvi.2015 <- readRDS("cba.summer.ndvi.2015.rds")

runoff.cba <- readRDS("runoff.cba.rds")

bogs.cba <- readRDS("CLC/bogs.cba.rds")
arable.cba <- readRDS("CLC/arable.cba.rds")
forest.cba <- readRDS("CLC/forest.cba.rds")
bare.cba <- readRDS("CLC/bare.cba.rds")

ndep.cba <- readRDS("Ndep/ndep.df.cba.rds")

annual.temp.cba <- readRDS("annual.temp.cba.rds")
annual.prec.cba <- readRDS("annual.prec.cba.rds")

cba <- cba %>% merge(cba.summer.ndvi.2015, by = "Lake_ID") %>% merge(runoff.cba, by = "Lake_ID") %>%
  merge(bogs.cba, by = "Lake_ID") %>% merge(arable.cba, by = "Lake_ID") %>% merge(forest.cba, by = "Lake_ID") %>%
  merge(bare.cba, by = "Lake_ID") %>% merge(ndep.cba, by = "Lake_ID") %>% 
  merge(annual.prec.cba, by = "Lake_ID") %>% merge(annual.temp.cba, by = "Lake_ID")
```

```{r N112}
n112.all <- read.table("Larsen/N112_subset_110909.txt", sep="", header = TRUE,na.strings = c(".", "NA"))

n112 <- n112.all %>% subset(ykoord > 6e6) %>% subset(is.na(TIC.ug) == F) %>% subset(is.na(alkendpoint) == F) %>% subset(alkendpoint > 0)
names(n112)

nws.oct.2004 <- "NWS/Wind_WFDE5_CRU_200410_v2.1.nc" %>% raster::raster()
n112.spdf <- SpatialPointsDataFrame(coords = n112[,c("xkoord","ykoord")], data = n112[,c("xkoord","ykoord")], proj4string = CRS("+proj=utm +zone=32 +ellps=WGS84 +datum=WGS84 +units=m +no_defs"))
n112.spdf.wgs <- n112.spdf %>% spTransform(CRS("+proj=longlat +datum=WGS84"))
nws.n112 <- raster::extract(nws.oct.2004, n112.spdf.wgs)

n112$nws_m.s <- nws.n112
```

```{r finnmark}
finnmark <- read_xlsx("finse/Finnmark2020_data.xlsx")

nws.oct.2019 <- "NWS/Wind_WFDE5_CRU_201910_v2.1.nc" %>% raster::raster()
finnmark.spdf <- SpatialPointsDataFrame(coords = finnmark[,c("Lon","Lat")], data =  finnmark[,c("Lon","Lat")]) 
nws.finnmark <- raster::extract(nws.oct.2019, finnmark.spdf)

finnmark$nws_m.s <- nws.finnmark
```

```{r norway}
norway <- data.frame(survey = c(rep("CBA_2019", dim(cba)[1]),rep("N112_2004",dim(n112)[1]),rep("finnmark",dim(finnmark)[1])))


norway$lake.id <- c(cba$Lake_ID,
                    n112$Vatnlnr,
                    finnmark$Sample)
  
norway$lake.name <- c(cba$Lake_name,
                      rep(NA,dim(n112)[1]),
                      finnmark$ID)

norway$TOC <- c(cba$TOC/12.011 * 1e-3, # mg/L to mol/L
                n112$TOC/12.011 * 1e-3, # mg/L to mol/L
                finnmark$TOC_mg.L /12.011 * 1e-3)

norway$TIC <- c(rep(NA, dim(cba)[1]),
                n112$TIC.ug/12.011 * 1e-6, # ug/L to mol/L
                rep(NA, dim(finnmark)[1]))

norway$Ca <- c(cba$Ca / 40.78 * 1e-3, #mg/L to mol/L
                rep(NA, dim(n112)[1]), # ug/L to mol/L
                as.numeric(finnmark$Ca_mg.L)/40.78 * 1e-3 *2)

norway$TN <- c(cba$TN / 14 * 1e-3, #mg/L to mol/L
                n112$TotN / 14 * 1e-6, # ug/L to mol/L
                finnmark$TN_mg.L/14 * 1e-3 *2)

norway$Fe <- c(cba$Fe / 55.845 * 1e-3, #mg/L to mol/L
                rep(NA, dim(n112)[1]),
                rep(NA, dim(finnmark)[1]))

norway$TA <- c(cba$Alkalinity * 1e-3, # convert from meq/L to mol/L
               n112$alkendpoint * 1e-6, # assumes ueq/L to mol/L,
               as.numeric(finnmark$Ca_mg.L) / 40.78 * 1e-3 *2)  #mg/L to mol/L to eq/L, assumes equivalence with TA

norway$temp_c <- c(cba$T,
                   n112$temp.situ,
                   finnmark$T_C)

norway$temp_k <- norway$temp_c + 273.15
  
norway$EC <- c(cba$EC_Kje,
               rep("NA",dim(n112)[1]),
               finnmark$EC_uS.cm) %>% as.numeric()

norway$IS <- 1.3e-5 * norway$EC

norway$fCO2.atm <- c(rep(fCO2.atm.2019, dim(cba)[1]),rep(rep(fCO2.atm.2004),dim(n112)[1]),rep(fCO2.atm.2020,dim(finnmark)[1]))

norway$pH <- c(cba$pH_Kje,
               n112$pH,
               finnmark$pH)

norway$Hplus <- 10^(-norway$pH)

norway$CO2 <- c(as.numeric(cba$CO2) * 1e-6, # from umol/L to mol/L
                n112$co2.umolar * 1e-6, # umol/L to mol/kg_solution
                as.numeric(finnmark$CO2_uM) * 1e-6) # uM to M


norway$long <- c(cba$Long,
                 n112.spdf.wgs@coords[,1],
                 finnmark$Lon)

norway$lat <- c(cba$Lat,
                 n112.spdf.wgs@coords[,2],
                 finnmark$Lat)

norway$lake.area <- c(cba$lake_area_km2,
                      n112$lake.area,
                     rep(NA,dim(finnmark)[1]))

norway$catchment.area <- c(cba$basin_area_km2,
                      n112$poly.area,
                     rep(NA,dim(finnmark)[1]))

norway$nws_m.s <- c(cba$nws_m.s,
                    n112$nws_m.s,
                    finnmark$nws_m.s)

norway$ndvi <- c(cba$NDVI,
                 n112$NDVI,
                 rep(NA,dim(finnmark)[1]))

norway$runoff <- c(cba$Runoff,
                 n112$runoff,
                 rep(NA,dim(finnmark)[1]))

norway$bog <- c(cba$Bog,
                 n112$bog,
                 rep(NA,dim(finnmark)[1]))

norway$arable <- c(cba$Arable,
                 n112$arable,
                 rep(NA,dim(finnmark)[1]))

norway$forest <- c(cba$Forest,
                 n112$forest,
                 rep(NA,dim(finnmark)[1]))

norway$Ndep <- c(cba$TNdep,
                 n112$Ndep,
                 rep(NA,dim(finnmark)[1]))

norway$temp.annual <- c(cba$temp,
                 n112$temp.ann,
                 rep(NA,dim(finnmark)[1]))

norway$prec.annual <- c(cba$precip,
                 rep(NA,dim(n112)[1]),
                 rep(NA,dim(finnmark)[1]))
```

```{r constants}

norway$Kw = with(norway, exp(148.9802 - 13847.26/temp_k - 23.6521*log(temp_k))) # Dickson and Riley, 1979

#norway$K0 <- with(norway, 10^-((-2622.38/temp_k) + 15.5873 - 0.0178471*temp_k)) #Harned and Davis, 1943
norway$K0 <- with(norway, exp(-58.0931+90.5069*100/temp_k+22.2940*log(temp_k/100))) # Weiss 1974
norway$K1 <- with(norway, 10^-((3404.71/temp_k)- 14.8435 + 0.032786*temp_k)) # Harned and Davis, 1943
norway$K2 <- with(norway, 10^-((2902.39/temp_k) - 6.4980 + 0.02379*temp_k)) # Harned and Scholes, 1941

```

Low ionic strength -\> activity coefficients are assumed to be 1 @Hemond2015

$TIC = [H_2CO_3] + [HCO_3^-]+[CO_3^{2-}]$

$[HCO_3^-] = K_1 \times [H_2CO_3] / [H^+]$

$[CO_3^{2-}] = K_2 \times [HCO_3^-] /[H^+] = K_2 / [H^+] \times K_1 \times [H_2CO_3] / [H^+]$

$TIC = [H_2CO_3] + K_1 \times [H_2CO_3]/[H^+] + K_2 /[H^+] \times K_1 \times [H_2CO_3] / [H^+]$

$TIC = [H_2CO_3] \times (1 + K_1 / [H^+] + K_1 \times K_2 / [H^+]^2 )$

$[H_2CO_3] = TIC \times 1/(1 + K_1/[H^+] + K_1 \times K_2 / [H^+]^2)$

And $[H_2CO_3] = pCO_2 \times K_0$, or $pCO_2 = [H_2CO_3] / K_0$

```{r carbonate-speciation-from-CO2}
nofin <- subset(norway, survey != "finnmark")
norway$H2CO3 <- norway$CO2 # in mol/L
norway$HCO3 <- with(norway, H2CO3 * K1 / Hplus)
norway$CO3 <- with(norway, K2 * HCO3 / Hplus)

norway$fCO2 <- with(norway, CO2 / K0)
norway$dfCO2 <- with(norway, fCO2 - fCO2.atm)

norway$OH <- with(norway, Kw/Hplus)

# Check
norway$DIC <- with(norway, H2CO3 + HCO3 + CO3)
norway$CA <- with(norway,  HCO3 + 2*CO3) 
norway$OA <- with(norway, TA - CA)

ggplot(norway, aes(x = log10(TOC), y = fCO2, col = survey))+
  geom_hline(yintercept = fCO2.atm.2019, col = "firebrick")+
  geom_hline(yintercept = fCO2.atm.2020, col = "dodgerblue3")+
  geom_hline(yintercept = fCO2.atm.2004, col = "orange")+
  scale_color_manual(values = c("firebrick","dodgerblue3","orange"))+
  geom_point()+
  theme_minimal()

ggplot(norway, aes(x = pH))+geom_point(aes(y = H2CO3, col = "H2CO3"))+
  geom_point(aes(y = HCO3, col = "HCO3"))+
  geom_point(aes(y = CO3, col = "CO3"))+
  scale_color_manual(values = c("firebrick","dodgerblue3","orange"))+
  theme_minimal()


ggplot(nofin, aes(x = pH))+geom_point(aes(y = H2CO3, col = "H2CO3"))+
  geom_point(aes(y = HCO3, col = "HCO3"))+
  geom_point(aes(y = CO3, col = "CO3"))+
  scale_color_manual(values = c("firebrick","dodgerblue3","orange"))+
  facet_grid(rows = vars(survey), scales = "free_y")+
  theme_minimal()

#ggplot(norway)+geom_point(aes(x=TA, y = CA, col = survey))+
#  scale_color_manual(values = c("firebrick","dodgerblue3","orange"))+
#  geom_abline(slope = 1, intercept = 0)+
#  theme_minimal()

ggplot(norway)+geom_point(aes(x=pH, y = fCO2, col = survey))+
  scale_color_manual(values = c("firebrick","dodgerblue3","orange"))+
  geom_abline(slope = 1, intercept = 0)+
  theme_minimal()

ggplot(norway)+
  geom_point(aes(x = log10(TOC), y = log10(fCO2), col = survey))+
  geom_line(aes(x = log10(TOC), y = log10(fCO2.atm), col = survey))+
  facet_grid(rows = vars(survey))+
  scale_color_manual(values = c("firebrick","dodgerblue3","orange"))+
  theme_minimal()
  

```

```{r carbonate-speciation-from-TIC, eval = F}
norway$H2CO3_tic <- with(norway, TIC*1/(1+(K1/Hplus)+(K1*K2/Hplus^2)))
norway$HCO3_tic <- with(norway, H2CO3_tic * K1 / Hplus)
norway$CO3_tic <- with(norway, K2 * HCO3_tic / Hplus)

norway$fCO2_tic <- with(norway, H2CO3_tic / K0)

# Check
norway$CA_tic <- with(norway, HCO3_tic + 2*CO3_tic)

ggplot(norway, aes(x = pH))+geom_point(aes(y = H2CO3_tic, col = "H2CO3"))+
  geom_point(aes(y = HCO3_tic, col = "HCO3"))+
  geom_point(aes(y = CO3_tic, col = "CO3"))+
  geom_point(aes(y = OH, col = "OH"))+
  scale_color_manual(values = c("firebrick","dodgerblue3","orange", "gray"))+
  theme_minimal()




ggplot(norway)+geom_point(aes(x=TA, y = CA_tic, col = survey))+
  scale_color_manual(values = c("firebrick","dodgerblue3","orange"))+
  geom_abline(slope = 1, intercept = 0)+
  theme_minimal()

ggplot(filter(norway, survey == "N112_2004"))+geom_point(aes(x=CA,y=CA_tic))+geom_abline(slope = 1, intercept = 0)+theme_minimal()

```

## fCO2 from TA

Theory: TA // CA, with concentrations in mol/L

$TA = [HCO_3^-]+2 \times [CO_3^{2-}] + [OH^-] - [H^+]$

@Liu2020, from @Millero1995

$[HCO_3^-] = [CO3^{2-}] \times [H^+] / K_2]$

So $TA = [CO3^{2-} \times [H^+] / K_2] + 2 \times [CO_3^{2-}] + [OH^-] - [H^+]$

And $[CO_3^{2-}] = (TA - [OH^-] + [H^+]) / ([H^+]/K_2 + 2)$

Then $[HCO_3^-] = [CO3^{2-} \times [H^+] / K_2]$

And $[H_2CO_3] = [HCO_3^-]\times [H^+] / K_1$

$fCO_2 = [H_2CO_3] / K_0$

```{r fCO2-ta}

nofin <- filter(norway, survey != "finnmark")

nofin$ta_CO3 <- with(nofin,(TA - OH + Hplus) / (Hplus/K2 +2)) # in mol/L
nofin$ta_HCO3 <- with(nofin, ta_CO3*Hplus/K2)
nofin$ta_H2CO3 <- with(nofin, ta_HCO3*Hplus/K1)
nofin$ta_fCO2 <- with(nofin,ta_H2CO3/K0)

nofin$ta_DIC <- with(nofin, ta_H2CO3 + ta_HCO3 + ta_CO3)

ggplot(nofin)+geom_point(aes(x = TA,y = TA-OH+Hplus))

ggplot(nofin)+geom_point(aes(x = fCO2, y = ta_fCO2, size = Hplus, col = survey))+
  scale_color_viridis_d()+
  annotate(x = 4e-3, y = 3e-2, geom="label", label = paste("r=",round(cor(nofin$fCO2,nofin$ta_fCO2, use = "pairwise.complete"),2)))+
  geom_abline(slope = 1, intercept = 0)+
  theme_minimal()

ggplot(filter(nofin, pH > 5.5))+geom_point(aes(x = fCO2, y = ta_fCO2, col = survey, size = Hplus, alpha = TOC))+
  scale_color_viridis_d()+
  scale_size(range = c(0.1,5))+
  annotate(x = 4e-3, y = 1e-2, geom="label", label = paste("r=",round(with(filter(nofin, pH > 5.5),cor(fCO2,ta_fCO2, use = "pairwise.complete")),2)))+
  geom_abline(slope = 1, intercept = 0)+
  theme_minimal()
```

```{r deviance}
nofin$fCO2_diff <- with(nofin, ta_fCO2 - fCO2) # calculated - measured

ggplot(nofin)+geom_point(aes(x = pH, y = fCO2_diff, col = survey, size = log10(TOC)))+theme_minimal()
ggplot(nofin)+geom_point(aes(x = log10(TOC), y = fCO2_diff, col = survey, size = log10(TA)))+theme_minimal()

```

```{r fix-pH-OA-with-Liu}
nofin$pH_Liu <- with(nofin, pH - (0.03+0.05*log10(IS)))
nofin$Hplus_Liu <- 10^(-nofin$pH_Liu)
nofin$OH_Liu <- with(nofin,Kw*Hplus_Liu)

nofin$OA_Liu <- 0.08 * nofin$TOC
nofin$TA_Liu <- with(nofin, TA-OA_Liu)

nofin$CO3_Liu <- with(nofin,(TA_Liu - OH_Liu + Hplus_Liu) / (Hplus_Liu/K2 +2)) # in mol/L
nofin$HCO3_Liu <- with(nofin, CO3_Liu*Hplus_Liu/K2)
nofin$H2CO3_Liu <- with(nofin, HCO3_Liu*Hplus_Liu/K1)
nofin$fCO2_Liu <- with(nofin,H2CO3_Liu/K0)

nofin$DIC_Liu <- with(nofin, H2CO3_Liu + HCO3_Liu + CO3_Liu)
nofin$CA_Liu <- with(nofin, HCO3_Liu + 2*CO3_Liu)

ggplot(nofin,aes(x = CA))+geom_point(aes(y = CA_Liu, col = survey))+
  labs(x = "CA calculated from CO2", y = "CA calculated from TA with Liu correction")+
  geom_abline(slope = 1, intercept = 0)+theme_minimal()

ggplot(nofin,aes(x = fCO2))+geom_point(aes(y = fCO2_Liu, col = survey))+

  geom_abline(slope = 1, intercept = 0)+theme_minimal()


ggplot(nofin)+geom_point(aes(x = fCO2, y = fCO2_Liu, col = pH_Liu, size = TOC))+
  scale_color_viridis_c()+
  labs(x = "fCO2 calculated from CO2", y = "fCO2 calculated from TA with Liu correction")+
  annotate(x = 4e-3, y = -2e-2, geom="label", label = paste("r=",round(cor(nofin$fCO2,nofin$fCO2_Liu, use = "pairwise.complete"),2)))+
  geom_abline(slope = 1, intercept = 0)+
  theme_minimal()

ggplot(filter(nofin, pH_Liu > 5.5))+geom_point(aes(x = fCO2, y = fCO2_Liu, col = pH_Liu, size = TOC))+
  scale_color_viridis_c()+
  labs(x = "fCO2 calculated from CO2", y = "fCO2 calculated from TA with Liu correction")+
  annotate(x = 4e-3, y = -5e-3, geom="label", label = paste("r=",with(filter(nofin, pH > 5.5),round(cor(fCO2,fCO2_Liu, use = "pairwise.complete"),2))))+
  geom_abline(slope = 1, intercept = 0)+
  theme_minimal()


```

# Model OA using Hruska

\@Hruska method

$CA = [HCO_3^-] + 2[CO_3^{2-}]$

$IA = [OH- + 2[SO_4{2-}] + [NO_3^-] + [CL^-] + [F^-] - [H^+] - 2[Ca^{2+}] - 2[Mg^{2+}] - [K^+] + [Na^+]$

$OA = [organic \; bases] - [organic \; acids]$

$TA = CA + IA + OA <=> OA = TA - CA - IA$

OA was titrated to end point 4.5.

```{r organic-acids, eval = F}
pKa1 <- 3.04
Ka1 <- 10^(-pKa1)

pKa2 <- 4.42
Ka2 <- 10^(-pKa2)

pKa3 <- 6.46
Ka3 <- 10^(-pKa3)

m <- 10.2*12.011*1e3*1e-6# ueq/mg to eq/mol, site density BUT THERE IS A 1e3 PB
nofin$RCOO <- with(nofin, (Ka1/Hplus + 2*Ka2/Hplus + 3*Ka3/Hplus)* m/3 * TOC)

nofin$RCOO_4.5 <- with(nofin, (Ka1/10^(-4.5) + 2*Ka2/10^(-4.5) + 3*Ka3/10^(-4.5))* m/3 * TOC)

nofin$OA <- with(nofin, RCOO-RCOO_4.5)

ggplot(nofin)+geom_point(aes(x = pH, y = RCOO, col = survey))
ggplot(nofin)+geom_point(aes(x = log10(RCOO), y = log10(fCO2), col = survey))

nofin$TAOA <- with(nofin, TA + OA - OH + Hplus) # RCOO from eq/L to mol/L

ggplot(filter(nofin,survey != "finnmark"),aes(x = CA))+
  geom_point(aes(y = TAOA, col = "CA from TA corrected by OA"))+
  geom_point(aes(y = TA -OH + Hplus, col = "CA from not corrected TA"))+
  scale_color_viridis_d()+
  labs(x = "CA from headspace", y = "CA calculated from TA")+
  annotate(x = 5e-4, y = 3e-3, geom = "label", label = paste("r TA,CA = ",round(with(filter(nofin,survey != "finnmark"),cor(CA, TA, use = "pairwise.complete")),2)))+
  annotate(x = 5e-4, y = 2.7e-3, geom = "label", label = paste("r (TA - OA),CA = ",round(with(filter(nofin,survey != "finnmark"),cor(CA, TAOA, use = "pairwise.complete")),2)))+
  geom_abline(slope = 1, intercept = 0)+
  theme_minimal()

```

```{r model-n, eval = F}
nofin$OA_m <- with(nofin, TA-HCO3-2*CO3-OH+Hplus)
Ktot <- Ka1 + 2*Ka2 + 3*Ka3
nofin$n <- with(nofin, OA_m / (Ktot * TOC / 3 * (1/Hplus - 1/10^(-4.5))))


ggplot(nofin, aes(x = pH, y = n))+geom_point()+geom_smooth()
ggplot(filter(nofin, pH > 5.5), aes(x = pH, y = n))+geom_point()+geom_smooth(method = "lm")

summary(lmn <- lm(n~pH, data = nofin))

nofin$n_pred <- predict(lmn)

nofin$RCOO_pred <- with(nofin, (Ka1/Hplus + 2*Ka2/Hplus + 3*Ka3/Hplus)* n_pred/3 * TOC)

nofin$OA_pred <- with(nofin, RCOO_pred-RCOO_4.5)

nofin$TAOA_pred <- with(nofin, TA + OA_pred - OH + Hplus) # RCOO from eq/L to mol/L

nofin$cta_CO3_pred <- with(nofin,(TA + RCOO_pred - OH + Hplus) / (Hplus/K2 +2)) # in mol/L
nofin$cta_HCO3_pred <- with(nofin, cta_CO3_pred*Hplus/K2)
nofin$cta_H2CO3_pred <- with(nofin, cta_HCO3_pred*Hplus/K1)
nofin$cta_fCO2_pred <- with(nofin,cta_H2CO3_pred/K0)

nofin$cta_DIC_pred <- with(nofin, cta_H2CO3_pred + cta_HCO3_pred + cta_CO3_pred)

```

```{r compare-loa-models, eval = F}


#2 
summary(lmoaM <- glm(CA  ~ TA + invHplus:TOC, data = nofin, family = Gamma(link = "identity")))

nofin$OA_pred <- predict(lmoaM, type = "response")
nofin$TAOA <- with(nofin, OA_pred - OH + Hplus)
nofin$cta_CO3 <- with(nofin,(TAOA) / (Hplus/K2 +2)) # in mol/L
nofin$cta_HCO3 <- with(nofin, cta_CO3*Hplus/K2)
nofin$cta_H2CO3 <- with(nofin, cta_HCO3*Hplus/K1)
nofin$cta_fCO2 <- with(nofin,cta_H2CO3/K0)

ggplot(nofin)+
  geom_point(aes(x = log10(fCO2*1e6), y = log10(ta_fCO2*1e6), col = "fCO2 from TA"))+
  geom_point(aes(x = log10(fCO2*1e6), y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"))+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
  geom_smooth(aes(x = log10(fCO2*1e6), y = log10(ta_fCO2*1e6), col = "fCO2 from TA"), method = "lm", se = F)+
  geom_smooth(aes(x = log10(fCO2*1e6), y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"), method = "lm", se = F)+
  annotate(x= 2.3, y = 2, geom = "text", label = "1:1 line")+
  facet_grid(rows = vars(survey))+
  labs(y = "log10(modelled fCO2, uatm)", x = "log10(measured fCO2, uatm)", col = "", title = "2")+
  scale_color_manual(values = c("firebrick","orange"))+
  theme_minimal()

# 3
summary(lmoaM <- glm(CA  ~ TA + invHplus:TOC + fCO2.atm, data = nofin, family = Gamma(link = "identity")))

nofin$OA_pred <- predict(lmoaM, type = "response")
nofin$TAOA <- with(nofin, OA_pred - OH + Hplus)
nofin$cta_CO3 <- with(nofin,(TAOA) / (Hplus/K2 +2)) # in mol/L
nofin$cta_HCO3 <- with(nofin, cta_CO3*Hplus/K2)
nofin$cta_H2CO3 <- with(nofin, cta_HCO3*Hplus/K1)
nofin$cta_fCO2 <- with(nofin,cta_H2CO3/K0)

ggplot(nofin)+
  geom_point(aes(x = log10(fCO2*1e6), y = log10(ta_fCO2*1e6), col = "fCO2 from TA"))+
  geom_point(aes(x = log10(fCO2*1e6), y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"))+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
  geom_smooth(aes(x = log10(fCO2*1e6), y = log10(ta_fCO2*1e6), col = "fCO2 from TA"), method = "lm", se = F)+
  geom_smooth(aes(x = log10(fCO2*1e6), y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"), method = "lm", se = F)+
  annotate(x= 2.3, y = 2, geom = "text", label = "1:1 line")+
  facet_grid(rows = vars(survey))+
  labs(y = "log10(modelled fCO2, uatm)", x = "log10(measured fCO2, uatm)", col = "", title = "3")+
  scale_color_manual(values = c("firebrick","orange"))+
  theme_minimal()

#4 
summary(lmoaM <- glm(CA  ~ TA + invHplus:TOC + fCO2.atm, data = nofin, family = gaussian(link = "identity")))

nofin$OA_pred <- predict(lmoaM, type = "response")
nofin$TAOA <- with(nofin, OA_pred - OH + Hplus)
nofin$cta_CO3 <- with(nofin,(TAOA) / (Hplus/K2 +2)) # in mol/L
nofin$cta_HCO3 <- with(nofin, cta_CO3*Hplus/K2)
nofin$cta_H2CO3 <- with(nofin, cta_HCO3*Hplus/K1)
nofin$cta_fCO2 <- with(nofin,cta_H2CO3/K0)

ggplot(nofin)+
  geom_point(aes(x = log10(fCO2*1e6), y = log10(ta_fCO2*1e6), col = "fCO2 from TA"))+
  geom_point(aes(x = log10(fCO2*1e6), y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"))+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
  geom_smooth(aes(x = log10(fCO2*1e6), y = log10(ta_fCO2*1e6), col = "fCO2 from TA"), method = "lm", se = F)+
  geom_smooth(aes(x = log10(fCO2*1e6), y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"), method = "lm", se = F)+
  annotate(x= 2.3, y = 2, geom = "text", label = "1:1 line")+
  facet_grid(rows = vars(survey))+
  labs(y = "log10(modelled fCO2, uatm)", x = "log10(measured fCO2, uatm)", col = "", title = "4")+
  scale_color_manual(values = c("firebrick","orange"))+
  theme_minimal()

#5
summary(lmoaM <- glm(CA  ~ TA + invHplus:TOC, data = subset(nofin, survey == "CBA_2019"), family = Gamma(link = "identity")))

nofin$OA_pred <- predict(lmoaM, newdata = nofin, type = "response")
nofin$TAOA <- with(nofin, OA_pred - OH + Hplus)
nofin$cta_CO3 <- with(nofin,(TAOA) / (Hplus/K2 +2)) # in mol/L
nofin$cta_HCO3 <- with(nofin, cta_CO3*Hplus/K2)
nofin$cta_H2CO3 <- with(nofin, cta_HCO3*Hplus/K1)
nofin$cta_fCO2 <- with(nofin,cta_H2CO3/K0)

ggplot(nofin)+
  geom_point(aes(x = log10(fCO2*1e6), y = log10(ta_fCO2*1e6), col = "fCO2 from TA"))+
  geom_point(aes(x = log10(fCO2*1e6), y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"))+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
  geom_smooth(aes(x = log10(fCO2*1e6), y = log10(ta_fCO2*1e6), col = "fCO2 from TA"), method = "lm", se = F)+
  geom_smooth(aes(x = log10(fCO2*1e6), y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"), method = "lm", se = F)+
  annotate(x= 2.3, y = 2, geom = "text", label = "1:1 line")+
  facet_grid(rows = vars(survey))+
  labs(y = "log10(modelled fCO2, uatm)", x = "log10(measured fCO2, uatm)", col = "", title = "5")+
  scale_color_manual(values = c("firebrick","orange"))+
  theme_minimal()


#6
summary(lmoaM <- glm(CA  ~ TA + invHplus:TOC, data = subset(nofin, survey == "N112_2004"), family = Gamma(link = "identity")))

nofin$OA_pred <- predict(lmoaM, newdata = nofin, type = "response")
nofin$TAOA <- with(nofin, OA_pred - OH + Hplus)
nofin$cta_CO3 <- with(nofin,(TAOA) / (Hplus/K2 +2)) # in mol/L
nofin$cta_HCO3 <- with(nofin, cta_CO3*Hplus/K2)
nofin$cta_H2CO3 <- with(nofin, cta_HCO3*Hplus/K1)
nofin$cta_fCO2 <- with(nofin,cta_H2CO3/K0)

ggplot(nofin)+
  geom_point(aes(x = log10(fCO2*1e6), y = log10(ta_fCO2*1e6), col = "fCO2 from TA"))+
  geom_point(aes(x = log10(fCO2*1e6), y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"))+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
  geom_smooth(aes(x = log10(fCO2*1e6), y = log10(ta_fCO2*1e6), col = "fCO2 from TA"), method = "lm", se = F)+
  geom_smooth(aes(x = log10(fCO2*1e6), y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"), method = "lm", se = F)+
  annotate(x= 2.3, y = 2, geom = "text", label = "1:1 line")+
  facet_grid(rows = vars(survey))+
  labs(y = "log10(modelled fCO2, uatm)", x = "log10(measured fCO2, uatm)", col = "", title = "6")+
  scale_color_manual(values = c("firebrick","orange"))+
  theme_minimal()

#7
summary(lmoaM <- glm(CA  ~ TA + invHplus:TOC, data = nofin, family = Gamma(link = "sqrt")))

nofin$OA_pred <- predict(lmoaM,newdata = nofin, type = "response")
nofin$TAOA <- with(nofin, OA_pred - OH + Hplus)
nofin$cta_CO3 <- with(nofin,(TAOA) / (Hplus/K2 +2)) # in mol/L
nofin$cta_HCO3 <- with(nofin, cta_CO3*Hplus/K2)
nofin$cta_H2CO3 <- with(nofin, cta_HCO3*Hplus/K1)
nofin$cta_fCO2 <- with(nofin,cta_H2CO3/K0)

ggplot(nofin)+
  geom_point(aes(x = log10(fCO2*1e6), y = log10(ta_fCO2*1e6), col = "fCO2 from TA"))+
  geom_point(aes(x = log10(fCO2*1e6), y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"))+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
  geom_smooth(aes(x = log10(fCO2*1e6), y = log10(ta_fCO2*1e6), col = "fCO2 from TA"), method = "lm", se = F)+
  geom_smooth(aes(x = log10(fCO2*1e6), y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"), method = "lm", se = F)+
  annotate(x= 2.3, y = 2, geom = "text", label = "1:1 line")+
  facet_grid(rows = vars(survey))+
  labs(y = "log10(modelled fCO2, uatm)", x = "log10(measured fCO2, uatm)", col = "", title = "6")+
  scale_color_manual(values = c("firebrick","orange"))+
  theme_minimal()


#8
summary(lmoaM <- glm(CA  ~ TA + invHplus:TOC, data = nofin, family = Gamma(link = "identity")))

nofin$OA_pred <- predict(lmoaM, type = "response")
nofin$TAOA <- with(nofin, OA_pred - OH + Hplus)
nofin$cta_CO3 <- with(nofin,(TAOA) / (Hplus/K2 +2)) # in mol/L
nofin$cta_HCO3 <- with(nofin, cta_CO3*Hplus/K2)
nofin$cta_H2CO3 <- with(nofin, cta_HCO3*Hplus/K1)
nofin$cta_fCO2 <- with(nofin,cta_H2CO3/K0)

ggplot(nofin)+
  geom_point(aes(x = log10(fCO2*1e6), y = log10(ta_fCO2*1e6), col = "fCO2 from TA"))+
  geom_point(aes(x = log10(fCO2*1e6), y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"))+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
  geom_smooth(aes(x = log10(fCO2*1e6), y = log10(ta_fCO2*1e6), col = "fCO2 from TA"), method = "lm", se = F)+
  geom_smooth(aes(x = log10(fCO2*1e6), y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"), method = "lm", se = F)+
  annotate(x= 2.3, y = 2, geom = "text", label = "1:1 line")+
  facet_grid(rows = vars(survey))+
  labs(y = "log10(modelled fCO2, uatm)", x = "log10(measured fCO2, uatm)", col = "", title = "8")+
  scale_color_manual(values = c("firebrick","orange"))+
  theme_minimal()

#9
summary(lmoaM <- glm(CA  ~ TA +invHplus:TOC, data = nofin, family = Gamma(link = "identity")))

nofin$OA_pred <- predict(lmoaM, type = "response")
nofin$TAOA <- with(nofin, OA_pred - OH + Hplus)
nofin$cta_CO3 <- with(nofin,(TAOA) / (Hplus/K2 +2)) # in mol/L
nofin$cta_HCO3 <- with(nofin, cta_CO3*Hplus/K2)
nofin$cta_H2CO3 <- with(nofin, cta_HCO3*Hplus/K1)
nofin$cta_fCO2 <- with(nofin,cta_H2CO3/K0)

ggplot(nofin)+
  geom_point(aes(x = log10(fCO2*1e6), y = log10(ta_fCO2*1e6), col = "fCO2 from TA"))+
  geom_point(aes(x = log10(fCO2*1e6), y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"))+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
  geom_smooth(aes(x = log10(fCO2*1e6), y = log10(ta_fCO2*1e6), col = "fCO2 from TA"), method = "gam", se = F)+
  geom_smooth(aes(x = log10(fCO2*1e6), y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"), method = "gam", se = F)+
  annotate(x= 2.3, y = 2, geom = "text", label = "1:1 line")+
  facet_grid(rows = vars(survey))+
  labs(y = "log10(modelled fCO2, uatm)", x = "log10(measured fCO2, uatm)", col = "", title = "9")+
  scale_color_manual(values = c("firebrick","orange"))+
  theme_minimal()

#10
summary(lmoaM <- glm(CA  ~ TA +invHplus:TOC, data = subset(nofin, TA < 0.07e-3), family = Gamma(link = "identity")))

nofin$OA_pred <- predict(lmoaM, newdata = nofin, type = "response")
nofin$TAOA <- with(nofin, OA_pred - OH + Hplus)
nofin$cta_CO3 <- with(nofin,(TAOA) / (Hplus/K2 +2)) # in mol/L
nofin$cta_HCO3 <- with(nofin, cta_CO3*Hplus/K2)
nofin$cta_H2CO3 <- with(nofin, cta_HCO3*Hplus/K1)
nofin$cta_fCO2 <- with(nofin,cta_H2CO3/K0)

ggplot(nofin)+
  geom_point(aes(x = log10(fCO2*1e6), y = log10(ta_fCO2*1e6), col = "fCO2 from TA"))+
  geom_point(aes(x = log10(fCO2*1e6), y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"))+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
  geom_smooth(aes(x = log10(fCO2*1e6), y = log10(ta_fCO2*1e6), col = "fCO2 from TA"), method = "lm", se = F)+
  geom_smooth(aes(x = log10(fCO2*1e6), y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"), method = "lm", se = F)+
  annotate(x= 2.3, y = 2, geom = "text", label = "1:1 line")+
  facet_grid(rows = vars(survey))+
  labs(y = "log10(modelled fCO2, uatm)", x = "log10(measured fCO2, uatm)", col = "", title = "10")+
  scale_color_manual(values = c("firebrick","orange"))+
  theme_minimal()

#11
summary(lmoaM <- glm(CA  ~ TA +invHplus:TOC, data = subset(nofin, TA > 0.07e-3), family = Gamma(link = "identity")))

nofin$OA_pred <- predict(lmoaM, newdata = nofin, type = "response")
nofin$TAOA <- with(nofin, OA_pred - OH + Hplus)
nofin$cta_CO3 <- with(nofin,(TAOA) / (Hplus/K2 +2)) # in mol/L
nofin$cta_HCO3 <- with(nofin, cta_CO3*Hplus/K2)
nofin$cta_H2CO3 <- with(nofin, cta_HCO3*Hplus/K1)
nofin$cta_fCO2 <- with(nofin,cta_H2CO3/K0)

ggplot(nofin)+
  geom_point(aes(x = log10(fCO2*1e6), y = log10(ta_fCO2*1e6), col = "fCO2 from TA"))+
  geom_point(aes(x = log10(fCO2*1e6), y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"))+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
  geom_smooth(aes(x = log10(fCO2*1e6), y = log10(ta_fCO2*1e6), col = "fCO2 from TA"), method = "lm", se = F)+
  geom_smooth(aes(x = log10(fCO2*1e6), y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"), method = "lm", se = F)+
  annotate(x= 2.3, y = 2, geom = "text", label = "1:1 line")+
  facet_grid(rows = vars(survey))+
  labs(y = "log10(modelled fCO2, uatm)", x = "log10(measured fCO2, uatm)", col = "", title = "11")+
  scale_color_manual(values = c("firebrick","orange"))+
  theme_minimal()
```


```{r model12}
#12
nofin$atmHCO3 <- with(nofin,fCO2.atm/Hplus*K1*K0)
nofin$invatmHCO3 <- 1/nofin$atmHCO3
nofin$invtemp <- 1/nofin$temp_k
nofin$invHplus <- 1/nofin$Hplus
nofin$invHplus2 <- 1/(nofin$Hplus^2)
nofin$OA2 <- nofin$OA^2 %>% sqrt()
nofin$CA.TOC <- nofin$CA / nofin$TOC
nofin$TOC2 <- nofin$TOC^2

summary(lmoaM <- glm(CA  ~ TA + invHplus:TOC, data = nofin, family = Gamma(link = "sqrt")))

nofin$OA_pred <- predict(lmoaM, newdata = nofin, type = "response")
nofin$TAOA <- with(nofin, OA_pred - OH + Hplus)
nofin$cta_CO3 <- with(nofin,(TAOA) / (Hplus/K2 +2)) # in mol/L
nofin$cta_HCO3 <- with(nofin, cta_CO3*Hplus/K2)
nofin$cta_H2CO3 <- with(nofin, cta_HCO3*Hplus/K1)
nofin$cta_fCO2 <- with(nofin,cta_H2CO3/K0)

ggplot(nofin)+
  geom_point(aes(x = log10(fCO2*1e6), y = log10(ta_fCO2*1e6), col = "fCO2 from TA"))+
  geom_point(aes(x = log10(fCO2*1e6), y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"))+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
  geom_smooth(aes(x = log10(fCO2*1e6), y = log10(ta_fCO2*1e6), col = "fCO2 from TA"), method = "lm", se = F)+
  geom_smooth(aes(x = log10(fCO2*1e6), y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"), method = "lm", se = F)+
  annotate(x= 2.3, y = 2, geom = "text", label = "1:1 line")+
  facet_grid(rows = vars(survey))+
  labs(y = "log10(modelled fCO2, uatm)", x = "log10(measured fCO2, uatm)", col = "", title = "12")+
  scale_color_manual(values = c("firebrick","orange"))+
  theme_minimal()

ggplot(nofin)+
  geom_point(aes(x = log10(fCO2*1e6), y = log10(ta_fCO2*1e6), col = "fCO2 from TA"))+
  geom_point(aes(x = log10(fCO2*1e6), y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"))+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
  geom_smooth(aes(x = log10(fCO2*1e6), y = log10(ta_fCO2*1e6), col = "fCO2 from TA"), method = "loess", se = T)+
  geom_smooth(aes(x = log10(fCO2*1e6), y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"), method = "loess", se = T)+
  annotate(x= 2.3, y = 2, geom = "text", label = "1:1 line")+
  labs(y = "log10(modelled fCO2, uatm)", x = "log10(measured fCO2, uatm)", col = "", title = "12")+
  scale_color_manual(values = c("firebrick","orange"))+
  theme_minimal()

ggplot(nofin, aes(x = log10(TA)))+
  geom_point(aes(y = log10(ta_fCO2*1e6), col = "fCO2 from TA"))+
  geom_point(aes(y = log10(fCO2*1e6), col = "Measured fCO2"))+
  geom_point(aes(y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"))+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
   geom_smooth(aes(y = log10(fCO2*1e6), col = "Measured fCO2"), method = "lm", se = T)+
  geom_smooth(aes(y = log10(ta_fCO2*1e6), col = "fCO2 from TA"), method = "lm", se = T)+
  geom_smooth(aes(y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"), method = "lm", se = T)+
  labs(y = "log10(fCO2, uatm)", x = "TA", col = "", title = "12")+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange"))+
  theme_minimal()

ggplot(nofin, aes(x = log10(TOC)))+
  geom_point(aes(y = log10(ta_fCO2*1e6), col = "fCO2 from TA"))+
  geom_point(aes(y = log10(fCO2*1e6), col = "Measured fCO2"))+
  geom_point(aes(y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"))+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
   geom_smooth(aes(y = log10(fCO2*1e6), col = "Measured fCO2"), method = "lm", se = T)+
  geom_smooth(aes(y = log10(ta_fCO2*1e6), col = "fCO2 from TA"), method = "lm", se = T)+
  geom_smooth(aes(y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"), method = "lm", se = T)+
  labs(y = "log10(fCO2, uatm)", x = "log10(TOC)", col = "", title = "12")+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange"))+
  theme_minimal()

ggplot(nofin, aes(x = pH))+
  geom_point(aes(y = log10(ta_fCO2*1e6), col = "fCO2 from TA"))+
  geom_point(aes(y = log10(fCO2*1e6), col = "Measured fCO2"))+
  geom_point(aes(y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"))+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
   geom_smooth(aes(y = log10(fCO2*1e6), col = "Measured fCO2"), method = "lm", se = T)+
  geom_smooth(aes(y = log10(ta_fCO2*1e6), col = "fCO2 from TA"), method = "lm", se = T)+
  geom_smooth(aes(y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"), method = "lm", se = T)+
  labs(y = "log10(fCO2, uatm)", x = "pH", col = "", title = "12")+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange"))+
  theme_minimal()

ggplot(nofin, aes(x = log10(lake.area)))+
  geom_point(aes(y = log10(ta_fCO2*1e6), col = "fCO2 from TA"))+
  geom_point(aes(y = log10(fCO2*1e6), col = "Measured fCO2"))+
  geom_point(aes(y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"))+
  geom_smooth(aes(y = log10(fCO2*1e6), col = "Measured fCO2"), method = "gam", se = T)+
  geom_smooth(aes(y = log10(ta_fCO2*1e6), col = "fCO2 from TA"), method = "gam", se = T)+
  geom_smooth(aes(y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"), method = "gam", se = T)+
  labs(y = "log10(fCO2, uatm)", x = "log10(lake area, km2)", col = "", title = "12")+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange"))+
#   facet_grid(rows = vars(survey))+
  theme_minimal()

ggplot(nofin, aes(x = log10(DIC/TOC)))+
  geom_point(aes(y = log10(ta_fCO2*1e6), col = "fCO2 from TA"))+
  geom_point(aes(y = log10(fCO2*1e6), col = "Measured fCO2"))+
  geom_point(aes(y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"))+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
  geom_smooth(aes(y = log10(fCO2*1e6), col = "Measured fCO2"), method = "lm", se = T)+
  geom_smooth(aes(y = log10(ta_fCO2*1e6), col = "fCO2 from TA"), method = "lm", se = T)+
  geom_smooth(aes(y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"), method = "lm", se = T)+
  labs(y = "log10(fCO2, uatm)", x = "log10(DIC/TOC)", col = "", title = "12")+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange"))+
  theme_minimal()

ggplot(nofin, aes(x = pH, y = DIC/TOC))+
  geom_point()+
  geom_smooth(method = "gam", se = T)+
  scale_color_manual(values = c("dodgerblue3","firebrick","orange"))+
  theme_minimal()


```



```{r modeloa}

nofin$sqrtTOC <- sqrt(nofin$TOC)
nofin$TOC2 <- nofin$TOC^2
nofin$invHplus <- 1/nofin$Hplus
nofin$invHplus2 <- 1/(nofin$Hplus)^2
nofin$invHplus3 <- 1/(nofin$Hplus)^3
nofin$atmHCO3 <- with(nofin, fCO2.atm/Hplus*K0*K1)
nofin$invTOC <- 1/nofin$TOC

summary(lmoaM <- glm(CA  ~ TA + invHplus:TOC, data = nofin, family = Gamma(link = "sqrt")))
#summary(lmoaMcba <- glm(CA  ~ TA + invHplus:TOC, data = subset(nofin, survey == "CBA_2019"), family = Gamma(link = "identity")))

saveRDS(lmoaM, "lmoaM.rds")

nofin$OA_pred <- predict(lmoaM, type = "response")

nofin$TAOA <- with(nofin, OA_pred - OH + Hplus)


nofin$cta_CO3 <- with(nofin,(TAOA) / (Hplus/K2 +2)) # in mol/L
nofin$cta_HCO3 <- with(nofin, cta_CO3*Hplus/K2)
nofin$cta_H2CO3 <- with(nofin, cta_HCO3*Hplus/K1)
nofin$cta_fCO2 <- with(nofin,cta_H2CO3/K0)

nofin$cta_DIC <- with(nofin, cta_H2CO3 + cta_HCO3 + cta_CO3)

ggplot(subset(nofin, survey == "N112_2004"),aes(x = CA))+
  geom_point(aes(y = TAOA, col = "CA from TA corrected by OA"))+
  geom_point(aes(y = TA -OH + Hplus, col = "CA from TA"))+
  scale_color_manual(values = c("firebrick","orange"))+
  labs(x = "CA calculated from CO2", y = "CA calculated from TA, TOC and pH")+
#  annotate(x = 5e-4, y = 3e-3, geom = "label", label = paste("r TA,CA = ",round(with(filter(nofin,survey != "finnmark"),cor(CA, TA, use = "pairwise.complete")),2)))+
#  annotate(x = 5e-4, y = 2.7e-3, geom = "label", label = paste("r (TA - OA),CA = ",round(with(filter(nofin,survey != "finnmark"),cor(CA, TAOA, use = "pairwise.complete")),2)))+
  geom_abline(slope = 1, intercept = 0)+
  theme_minimal()

ggplot(subset(nofin, survey == "CBA_2019"),aes(x = CA))+
  geom_point(aes(y = TAOA, col = "CA from TA corrected by OA"))+
  geom_point(aes(y = TA -OH + Hplus, col = "CA from TA"))+
  scale_color_manual(values = c("firebrick","orange"))+
  labs(x = "CA calculated from CO2", y = "CA calculated from TA, TOC and pH")+
#  annotate(x = 5e-4, y = 3e-3, geom = "label", label = paste("r TA,CA = ",round(with(filter(nofin,survey != "finnmark"),cor(CA, TA, use = "pairwise.complete")),2)))+
#  annotate(x = 5e-4, y = 2.7e-3, geom = "label", label = paste("r (TA - OA),CA = ",round(with(filter(nofin,survey != "finnmark"),cor(CA, TAOA, use = "pairwise.complete")),2)))+
  geom_abline(slope = 1, intercept = 0)+
  theme_minimal()

ggplot(nofin, aes(x = TA)) + geom_point(aes(y = CA, col = "measured CA"))+
  geom_point(aes(y = cta_HCO3 + 2* cta_CO3, col = "predicted CA from OA"))+
  scale_color_manual(values = c("firebrick", "orange"))+
  theme_minimal()



```




```{r estimate-fCO2-with-corTA, eval = F}

ggplot(nofin)+geom_point(aes(x = fCO2, y = cta_fCO2, col = pH, size = log10(TOC)))+
  scale_color_viridis_c()+
  annotate(x = 4e-3, y = 2e-2, geom="label", label = paste("r=",round(cor(nofin$fCO2,nofin$cta_fCO2, use = "pairwise.complete"),2)))+
  geom_abline(slope = 1, intercept = 0)+
  theme_minimal()

ggplot(nofin)+geom_point(aes(x = fCO2, y = cta_fCO2_pred, col = pH, size = log10(TOC)))+
  scale_color_viridis_c()+
  annotate(x = 4e-3, y = 2e-2, geom="label", label = paste("r=",round(cor(nofin$fCO2,nofin$cta_fCO2_pred, use = "pairwise.complete"),2)))+
  geom_abline(slope = 1, intercept = 0)+
  theme_minimal()

ggplot(nofin)+geom_point(aes(x = fCO2, y = cta_fCO2, col = survey, size = log10(TOC)))+
  scale_color_viridis_d()+
  annotate(x = 4e-3, y = 2e-2, geom="label", label = paste("r=",round(cor(nofin$fCO2,nofin$cta_fCO2, use = "pairwise.complete"),2)))+
  geom_abline(slope = 1, intercept = 0)+
  theme_minimal()

ggplot(filter(nofin, pH > 5.5), aes(x = log10(fCO2), y = log10(cta_fCO2)))+geom_point(aes(col = survey))+
  scale_color_viridis_d()+
  geom_abline(slope = 1, intercept = 0)+
  theme_minimal()

ggplot(filter(nofin), aes(x = log10(TOC), y = log10(cta_fCO2)))+
  geom_point()+
  scale_color_viridis_d()+
  geom_smooth(method = "glm")+
  facet_grid(rows = vars(survey))+
  theme_minimal()

ggplot(filter(nofin), aes(x = log10(TOC), y = log10(ta_fCO2)))+
  geom_point()+
  scale_color_viridis_d()+
  geom_smooth(method = "glm")+
  facet_grid(rows = vars(survey))+
  theme_minimal()

ggplot(filter(nofin), aes(x = log10(TOC), y = log10(fCO2)))+
  geom_point()+
  scale_color_viridis_d()+
  geom_smooth(method = "lm")+
  facet_grid(rows = vars(survey))+
  theme_minimal()


ggplot(filter(nofin, pH > 5.5))+geom_point( aes(x = log10(TOC), y = log10(ta_fCO2), col = "Indirect fCO2 from TA"))+
  geom_point(aes(x = log10(TOC), y = log10(fCO2), col = "Direct fCO2"))+
  scale_color_manual(values = c("firebrick", "dodgerblue3","orange"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()

ggplot(filter(nofin, pH > 5.5))+geom_point( aes(x = log10(TOC), y = log10(cta_fCO2), col = "Indirect fCO2"))+
  geom_point(aes(x = log10(TOC), y = log10(fCO2), col = "Direct fCO2"))+
  facet_grid(rows = vars(survey))+
  scale_color_manual(values = c("firebrick", "dodgerblue3","orange"))+
  theme_minimal()

ggplot(filter(nofin, pH > 5.5))+
  geom_point(aes(x = log10(TOC), y = log10(fCO2), col = "Direct fCO2"))+
geom_point(aes(x = log10(TOC), y = log10(cta_fCO2_pred), col = "fCO2 with pred OA"))+  
  scale_color_manual(values = c("firebrick", "dodgerblue3","orange"))+
  theme_minimal()


```

```{r model-log10fCO2-cat}
summary(glmfCO2 <- glm(log10(fCO2*1e6)~log10(TOC), data = nofin, family = Gamma(link = "identity")))
coef.glmfCO2 <- summary(glmfCO2)$coefficients
r2nofin <- with(summary(glmfCO2), 1 - deviance/null.deviance) %>% round(2)

ggplot(nofin)+geom_point(aes(x = log10(TOC), y = log10(fCO2*1e6), shape = survey))+
  geom_line(aes(x = log10(TOC), y = coef.glmfCO2[1]+log10(TOC)*coef.glmfCO2[2], col = "predict"))+
  geom_line(aes(x = log10(TOC), y = coef.glmfCO2[1]+coef.glmfCO2[3]+log10(TOC)*coef.glmfCO2[2]+coef.glmfCO2[4], col = "Std Error"), lty = 2)+
  geom_line(aes(x = log10(TOC), y = coef.glmfCO2[1]-coef.glmfCO2[3]+log10(TOC)*coef.glmfCO2[2]-coef.glmfCO2[4], col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  scale_shape_manual(values = c(1,16))+
  annotate(x = -2.75, y = 2.3, geom = "label", label = paste("Slope = ", round(coef.glmfCO2[2],2), "\n R2 = ", r2nofin))+
  theme(legend.position = "none")+
  labs(y = "log10(fCO2, uatm)", x = "log10(TOC, mol/L)", title = "CBA + N112 surveys")+
  theme_minimal()



summary(glmfCO2cba <- glm(log10(fCO2*1e6)~log10(TOC), data = subset(nofin, survey == "CBA_2019"), family = Gamma(link = "identity")))
summary.glmfCO2cba <- summary(glmfCO2cba)
coef.glmfCO2cba <- summary(glmfCO2cba)$coefficients
r2cba <- with(summary.glmfCO2cba, 1 - deviance/null.deviance) %>% round(2)

ggplot(subset(nofin, survey == "CBA_2019"))+geom_point(aes(x = log10(TOC), y = log10(fCO2*1e6)))+
  geom_line(aes(x = log10(TOC), y = coef.glmfCO2cba[1]+log10(TOC)*coef.glmfCO2cba[2], col = "predict"))+
  geom_line(aes(x = log10(TOC), y = coef.glmfCO2cba[1]+coef.glmfCO2cba[3]+log10(TOC)*coef.glmfCO2cba[2]+coef.glmfCO2cba[4], col = "Std Error"), lty = 2)+
  geom_line(aes(x = log10(TOC), y = coef.glmfCO2cba[1]-coef.glmfCO2cba[3]+log10(TOC)*coef.glmfCO2cba[2]-coef.glmfCO2cba[4], col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  annotate(x = -2.75, y = 2.3, geom = "label", label = paste("Slope = ", round(coef.glmfCO2cba[2],2), "\n R2 = ", r2cba))+
  theme(legend.position = "none")+
  labs(y = "log10(fCO2, uatm)", x = "log10(TOC, mol/L)", title = "CBA survey, 2019")+
  theme_minimal()

summary(glmfCO2n112 <- glm(log10(fCO2*1e6)~log10(TOC), data = subset(nofin, survey == "N112_2004"), family = Gamma(link = "identity")))
coef.glmfCO2n112 <- summary(glmfCO2n112)$coefficients
r2n112 <- with(summary(glmfCO2n112), 1 - deviance/null.deviance) %>% round(2)


ggplot(subset(nofin, survey == "N112_2004"))+geom_point(aes(x = log10(TOC), y = log10(fCO2*1e6)))+
  geom_line(aes(x = log10(TOC), y = coef.glmfCO2n112[1]+log10(TOC)*coef.glmfCO2n112[2], col = "predict"))+
  geom_line(aes(x = log10(TOC), y = coef.glmfCO2n112[1]+coef.glmfCO2n112[3]+log10(TOC)*coef.glmfCO2n112[2]+coef.glmfCO2n112[4], col = "Std Error"), lty = 2)+
  geom_line(aes(x = log10(TOC), y = coef.glmfCO2n112[1]-coef.glmfCO2n112[3]+log10(TOC)*coef.glmfCO2n112[2]-coef.glmfCO2n112[4], col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  annotate(x = -3, y = 2.7, geom = "label", label = paste("Slope = ", round(coef.glmfCO2n112[2],2), "\n R2 = ", r2n112))+
  theme(legend.position = "none")+
  labs(y = "log10(fCO2, uatm)", x = "log10(TOC, mol/L)", title = "N112 survey, 2004")+
  theme_minimal()

```

```{r model-fCO2-cat}
summary(glmfCO2 <- glm(fCO2~TOC, data = nofin, family = Gamma(link = "identity")))
coef.glmfCO2 <- summary(glmfCO2)$coefficients
r2nofin <- with(summary(glmfCO2), 1 - deviance/null.deviance) %>% round(2)

ggplot(nofin)+geom_point(aes(x = TOC, y = fCO2, shape = survey))+
  geom_line(aes(x = TOC, y = coef.glmfCO2[1]+TOC*coef.glmfCO2[2], col = "predict"))+
  geom_line(aes(x = TOC, y = coef.glmfCO2[1]+coef.glmfCO2[3]+TOC*(coef.glmfCO2[2]+coef.glmfCO2[4]), col = "Std Error"), lty = 2)+
  geom_line(aes(x = TOC, y = coef.glmfCO2[1]-coef.glmfCO2[3]+TOC*(coef.glmfCO2[2]-coef.glmfCO2[4]), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  scale_shape_manual(values = c(1,16))+
  annotate(x = 0.0005, y = 0.004, geom = "label", label = paste("Slope = ", round(coef.glmfCO2[2],2), "\n R2 = ", r2nofin))+
  theme(legend.position = "none")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "CBA + N112 surveys")+
  theme_minimal()


summary(glmfCO2cba <- glm(fCO2~TOC, data = subset(nofin, survey == "CBA_2019"), family = Gamma(link = "identity")))
summary.glmfCO2cba <- summary(glmfCO2cba)
coef.glmfCO2cba <- summary(glmfCO2cba)$coefficients
r2cba <- with(summary.glmfCO2cba, 1 - deviance/null.deviance) %>% round(2)

ggplot(subset(nofin, survey == "CBA_2019"))+geom_point(aes(x = TOC, y = fCO2))+
  geom_line(aes(x = TOC, y = coef.glmfCO2cba[1]+TOC*coef.glmfCO2cba[2], col = "predict"))+
  geom_line(aes(x = TOC, y = coef.glmfCO2cba[1]+coef.glmfCO2cba[3]+TOC*(coef.glmfCO2cba[2]+coef.glmfCO2cba[4]), col = "Std Error"), lty = 2)+
  geom_line(aes(x = TOC, y = coef.glmfCO2cba[1]-coef.glmfCO2cba[3]+TOC*(coef.glmfCO2cba[2]-coef.glmfCO2cba[4]), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  annotate(x = 0.0005, y = 0.004, geom = "label", label = paste("Slope = ", round(coef.glmfCO2cba[2],2), "\n R2 = ", r2cba))+
  theme(legend.position = "none")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "CBA survey, 2019")+
  theme_minimal()

summary(glmfCO2n112 <- glm(fCO2~TOC, data = subset(nofin, survey == "N112_2004"), family = Gamma(link = "identity")))
coef.glmfCO2n112 <- summary(glmfCO2n112)$coefficients
r2n112 <- with(summary(glmfCO2n112), 1 - deviance/null.deviance) %>% round(2)


ggplot(subset(nofin, survey == "N112_2004"))+geom_point(aes(x = TOC, y = fCO2))+
  geom_line(aes(x = TOC, y = coef.glmfCO2n112[1]+TOC*coef.glmfCO2n112[2], col = "predict"))+
  geom_line(aes(x = TOC, y = coef.glmfCO2n112[1]+coef.glmfCO2n112[3]+TOC*(coef.glmfCO2n112[2]+coef.glmfCO2n112[4]), col = "Std Error"), lty = 2)+
  geom_line(aes(x = TOC, y = coef.glmfCO2n112[1]-coef.glmfCO2n112[3]+TOC*(coef.glmfCO2n112[2]-coef.glmfCO2n112[4]), col = "Std Error"), lty = 2)+
  scale_color_manual(values = c("dodgerblue3", "firebrick"))+
  annotate(x = 0.0015, y = 0.001, geom = "label", label = paste("Slope = ", round(coef.glmfCO2n112[2],2), "\n R2 = ", r2n112))+
  theme(legend.position = "none")+
  labs(y = "fCO2, atm", x = "TOC, mol/L", title = "N112 survey, 2004")+
  theme_minimal()

```

```{r boxplots-for-presentation}
library(ggpubr)

bplot <- function(input,xlab){
  ggplot(nofin, aes(col = survey))+ 
  geom_boxplot(aes(x = xlab, y = input))+ 
  labs(x = "", y = "")+
  scale_color_manual(values = c("firebrick","dodgerblue3"))+
  theme_minimal()+
  theme(legend.position = "none")
}

b1 <- bplot(nofin$pH, "pH")
b2 <- bplot(nofin$TOC*12.011*1e3, "TOC in mg/L")
b3 <- bplot(nofin$TA*1e3, "TA, meq/L")
b4 <- bplot(log10(nofin$lake.area), "log10(Lake area), km2")
b5 <- bplot(nofin$DIC, "DIC in mol/L")
b6 <- bplot(nofin$fCO2/nofin$TOC, "TIC/TOC")


ggarrange(plotlist = list(b1,b2,b3,b4, b5, b6),ncol = 2, nrow = 3)
#  theme_minimal()
```

```{r boxplot-fCO2-alk, eval= T}
ggplot(nofin)+geom_boxplot(aes(y = "fCO2 \n headspace", x = log10(fCO2*1e6), col=  "headspace"))+
  geom_boxplot(aes(y = "fCO2 \n measured alkalinity", x = log10(ta_fCO2*1e6), col = "total"))+
  geom_boxplot(aes(y = "fCO2 \n organic alkalinity", x = log10(cta_fCO2*1e6), col = "organic"))+
  facet_grid(cols = vars(survey))+
  coord_flip()+theme_minimal(base_size = 15)+
  scale_color_manual(values = c("firebrick","dodgerblue3", "orange"))+
  theme(axis.text.x = element_text(angle = 45, hjust= 1), legend.position = "none")+
  labs(y = "", x = "log10(fCO2, uatm)")
```

alkalinity limit from @Wallin2014

```{r compare-fCO2-low-alk}

ggplot(data = subset(nofin, TA < 0.07e-3))+
  geom_boxplot(aes(x = "fCO2 \n headspace", y = log10(fCO2), col=  "headspace"))+
  geom_boxplot(aes(x = "fCO2 \n measured alkalinity", y = log10(ta_fCO2), col = "total"))+
  geom_boxplot(aes(x = "fCO2 \n organic alkalinity", y = log10(cta_fCO2), col = "organic"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  scale_color_manual(values = c("firebrick","dodgerblue3", "orange"))+
  theme(axis.text.x = element_text(angle = 45, hjust= 1), legend.position = "none")+
  labs(y = "", x = "log10(fCO2, atm)", title = "Alkalinity < 0.07 meq/L")

ggplot(data = subset(nofin, TA > 0.07e-3))+
  geom_boxplot(aes(x = "fCO2 \n headspace", y = log10(fCO2), col=  "headspace"))+
  geom_boxplot(aes(x = "fCO2 \n measured alkalinity", y = log10(ta_fCO2), col = "total"))+
  geom_boxplot(aes(x = "fCO2 \n organic alkalinity", y = log10(cta_fCO2), col = "organic"))+
  facet_grid(cols = vars(survey))+
  theme_minimal()+
  scale_color_manual(values = c("firebrick","dodgerblue3", "orange"))+
  theme(axis.text.x = element_text(angle = 45, hjust= 1), legend.position = "none")+
  labs(y = "", x = "log10(fCO2, atm)", title = "Alkalinity > 0.07 meq/L")
```

```{r boxplot-compare-alk-all-survey, eval = F}
ggplot(data = subset(nofin, TA < 0.7e-3))+
  geom_boxplot(aes(x = "fCO2 \n headspace", y = log10(fCO2), col=  "headspace"))+
  geom_boxplot(aes(x = "fCO2 \n measured alkalinity", y = log10(ta_fCO2), col = "total"))+
  geom_boxplot(aes(x = "fCO2 \n organic alkalinity", y = log10(cta_fCO2), col = "organic"))+
  theme_minimal()+
  scale_color_manual(values = c("firebrick","dodgerblue3", "orange"))+
  theme(axis.text.x = element_text(angle = 45, hjust= 1), legend.position = "none")+
  labs(y = "", x = "log10(fCO2) in atm", title = "Alkalinity < 0.7 meq/L")

ggplot(data = subset(nofin, TA > 0.7e-3))+
  geom_boxplot(aes(x = "fCO2 \n headspace", y = log10(fCO2), col=  "headspace"))+
  geom_boxplot(aes(x = "fCO2 \n measured alkalinity", y = log10(ta_fCO2), col = "total"))+
  geom_boxplot(aes(x = "fCO2 \n organic alkalinity", y = log10(cta_fCO2), col = "organic"))+
  theme_minimal()+
  scale_color_manual(values = c("firebrick","dodgerblue3", "orange"))+
  theme(axis.text.x = element_text(angle = 45, hjust= 1), legend.position = "none")+
  labs(y = "", x = "log10(fCO2) in atm", title = "Alkalinity > 0.7 meq/L")
```

```{r compare-fCO2}
ggplot(nofin)+geom_point( aes(x = log10(TOC), y = log10(ta_fCO2), col = "Indirect fCO2 from TA"))+
  geom_point(aes(x = log10(TOC), y = log10(fCO2), col = "Direct fCO2"))+
    geom_point(aes(x = log10(TOC), y = log10(cta_fCO2), col = "Indirect fCO2 from OA"))+
  scale_color_manual(values = c("firebrick", "dodgerblue3","orange"))+
  facet_grid(rows = vars(survey))+
  theme_minimal()
```

```{r compare-fCO2-survey}
ggplot(nofin)+
  geom_point(aes(x = log10(fCO2*1e6), y = log10(ta_fCO2*1e6), col = "fCO2 from TA"))+
  geom_point(aes(x = log10(fCO2*1e6), y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"))+
  geom_abline(slope = 1, intercept = 0, lty = 2)+
  geom_smooth(aes(x = log10(fCO2*1e6), y = log10(ta_fCO2*1e6), col = "fCO2 from TA"), method = "lm", se = F)+
  geom_smooth(aes(x = log10(fCO2*1e6), y = log10(cta_fCO2*1e6), col = "fCO2 from corrected TA"), method = "lm", se = F)+
  annotate(x= 2.3, y = 2, geom = "text", label = "1:1 line")+
  facet_grid(rows = vars(survey))+
  labs(y = "log10(modelled fCO2, uatm)", x = "log10(measured fCO2, uatm)", col = "")+
  scale_color_manual(values = c("firebrick","orange"))+
  theme_minimal()
```

```{r compare-diff-fCO2, eval = F}

ggplot(nofin, aes(x = log10(TA)))+
  geom_point(aes(y = ta_fCO2-fCO2, col = "fCO2 from TA"))+
  geom_point(aes(y = cta_fCO2-fCO2, col = "fCO2 from corrected TA"))+
 # geom_abline(slope = 1, intercept = 0)+
  geom_smooth(aes(y = ta_fCO2-fCO2, col = "fCO2 from TA"), method = "loess", se = F)+
  geom_smooth(aes(y = cta_fCO2-fCO2, col = "fCO2 from corrected TA"), method = "loess", se = F)+
  geom_vline(xintercept = log10(0.07*1e-3))+
    geom_vline(xintercept = log10(0.2*1e-3), lty = 2)+
  labs(x = "log10(TA), eq/L", y = "calculated fCO2 - measured fCO2, in atm, log10")+
 # annotate(x= -3.5, y = -3.7, geom = "text", label = "1:1 line")+
#  facet_grid(rows = vars(survey))+
  scale_color_manual(values = c("firebrick","orange"))+
  theme_minimal()

ggplot(nofin, aes(x = log10(TOC)))+
  geom_point(aes(y = ta_fCO2-fCO2, col = "fCO2 from TA"))+
  geom_point(aes(y = cta_fCO2-fCO2, col = "fCO2 from corrected TA"))+
 # geom_abline(slope = 1, intercept = 0)+
  geom_smooth(aes(y = ta_fCO2-fCO2, col = "fCO2 from TA"), method = "loess", se = F)+
  geom_smooth(aes(y = cta_fCO2-fCO2, col = "fCO2 from corrected TA"), method = "loess", se = F)+
  #geom_vline(xintercept = log10(0.07*1e-3))+
  labs(x = "log10(TOC), mol/L", y = "calculated fCO2 - measured fCO2, in atm")+
 # annotate(x= -3.5, y = -3.7, geom = "text", label = "1:1 line")+
#  facet_grid(rows = vars(survey))+
  scale_color_manual(values = c("firebrick","orange"))+
  theme_minimal()

ggplot(nofin, aes(x = pH))+
  geom_point(aes(y = ta_fCO2-fCO2, col = "fCO2 from TA"))+
  geom_point(aes(y = cta_fCO2-fCO2, col = "fCO2 from corrected TA"))+
 # geom_abline(slope = 1, intercept = 0)+
  geom_smooth(aes(y = ta_fCO2-fCO2, col = "fCO2 from TA"), method = "loess", se = F)+
  geom_smooth(aes(y = cta_fCO2-fCO2, col = "fCO2 from corrected TA"), method = "loess", se = F)+
  #geom_vline(xintercept = log10(0.07*1e-3))+
  labs(x = "pH", y = "calculated fCO2 - measured fCO2, in atm")+
 # annotate(x= -3.5, y = -3.7, geom = "text", label = "1:1 line")+
#  facet_grid(rows = vars(survey))+
  scale_color_manual(values = c("firebrick","orange"))+
  theme_minimal()

```

```{r deviance2, eval = F}
nofin$fCO2_diff2 <- with(nofin, cta_fCO2 - fCO2) # calculated - measured

ggplot(nofin)+geom_point(aes(x = pH, y = fCO2_diff2, col = survey, size = TA))+theme_minimal()

ggplot(nofin)+geom_point(aes(x = Hplus, y = fCO2_diff2, col = survey, size = TA))+theme_minimal()
ggplot(nofin)+geom_point(aes(x = log10(TOC), y = log10(fCO2_diff2), col = survey))+
  scale_color_manual(values = c("firebrick", "orange"))+theme_minimal()

summary(lmoa <- lm(log10(fCO2_diff2)~Hplus, nofin))

saveRDS(nofin, "nofin.rds")
```

# Includes Calcium?

@Gelberch <https://link.springer.com/content/pdf/10.1007/s002160050832.pdf>

calcium constants

# Evasion rate

wind speed <https://wcrp-cmip.github.io/CMIP6_CVs/docs/CMIP6_institution_id.html>

Data downloaded from Copernicus <https://cds.climate.copernicus.eu/cdsapp#!/dataset/derived-near-surface-meteorological-variables?tab=overview>

See part 1

Theory from @Hastie2018

$FCO_2 = A_{lake}*k*\Delta CO_2$

FCO2 in mol/day, Alake = lake area in m2, $\Delta CO_2$ in mol/m3 is the difference between water and air pCO2.

According to Vachon and Prairie 2013:

$k_{600} = 2.51 + 1.48*U_{10} + 0.39 * U_{10} * log_{10] A_{lake}$

with A in km2 and \<u in m/s

k has to be adjusted for temperature. @Vachon200:

$K_{600} = k_{CO2}*(\frac{600}{Sc_{CO2})^-n$

Get Sc for all lakes:

Schmidt number from http://www.diva-portal.org/smash/get/diva2:779938/FULLTEXT01.pdf


```{r schmidt}
#library(LakeMetabolizer)

nofin$Sc <- 1841*exp(-0.0549*nofin$temp_c) # @kokic2014

nofin$n <- NA
for(i in 1:length(nofin$n)){
  if(nofin$nws_m.s[i] < 3.7 & is.na(nofin$nws_m.s[i]) == F){
    nofin$n[i] = 2/3
  }else if(nofin$nws_m.s[i] > 3.7 & is.na(nofin$nws_m.s[i]) == F){
    nofin$n[i] = 1/2
  } else if(is.na(nofin$nws_m.s[i]) == T){
    nofin$n[i] = NA
  }
} # adjusted n from Vachon


nofin$k600 <- with(nofin, 2.51+1.48*nws_m.s+0.39*nws_m.s*log10(lake.area)) # lake.area already in km2
                    
nofin$kCO2 <- with(nofin, k600*(600/Sc)^n) #m/day

nofin$FCO2 <- with(nofin, lake.area*1e6*kCO2*((fCO2 - fCO2.atm)*K0*1e3)) #-> lake.area in m2, dCO2 in mol/m3, k in m/day -> mol/day. K0 is in mol/L <- mol/1e-3 m3

nofin$mgC.m2.day <- with(nofin, kCO2*(fCO2-fCO2.atm)*K0*1e3 * 12.011 * 1e3) # in mgC/m2/day

```

```{r maps}

ggplot()+
  borders(region = c("Norway"), fill = "seashell2", col = "white")+xlim(4,13)+ylim(58,63)+
  geom_point(data = filter(nofin, dfCO2 > 0), aes(x=long, y = lat, size = fCO2*1e6, col = survey, shape = "Supersaturated"))+
  geom_point(data = filter(nofin, dfCO2 < 0), aes(x=long, y = lat, size =fCO2*1e6, col = survey, shape = "Undersaturated"))+
  labs(size = "fCO2, uatm", col = "Survey", shape = "") +
  scale_color_manual(values = c("firebrick","dodgerblue4"))+
  scale_shape_manual(values = c(1,16))+
    scale_size(range = c(1,6), breaks = c(1000,2000,3000,4000))+
  theme_void(base_size = 15)
```

```{r map-mgC.m2.day, fig.dim = c(10,5)}
ggplot()+
  borders(region = c("Norway"), fill = "seashell3", col = "seashell3")+xlim(4,13)+ylim(58,63)+
  geom_point(data = subset(nofin, dfCO2 > 0), aes(x=long, y = lat, size =mgC.m2.day*1e-3, col = mgC.m2.day*1e-3), shape = 16)+
  geom_point(data = subset(nofin, dfCO2 < 0), aes(x=long, y = lat, size =mgC.m2.day*1e-3,col = mgC.m2.day*1e-3), shape = 1)+
  labs(col = "Carbon evasion\n in gC/m2/day", size = "Carbon evasion\n in gC/m2/day") +
  scale_color_continuous_divergingx(mid = 0, rev = T,  palette = "RdBu")+
  scale_size(range = c(1,6))+
  guides(color = guide_legend(), sice = guide_legend())+
 facet_grid(cols = vars(survey))+
  theme_void(base_size = 15)+
  theme(legend.position = "bottom", plot.background = element_rect(fill = "aliceblue", color = "aliceblue"))
```

```{r map-dCO2, eval = F}
ggplot()+
  geom_point(data = filter(nofin, dfCO2 > 0), aes(x=long, y = lat, size = dfCO2, col = survey, shape = "Supersaturated"))+
  geom_point(data = filter(nofin, dfCO2 < 0), aes(x=long, y = lat, size =dfCO2, col = survey, shape = "Undersaturated"))+
  borders(region = c("Norway"))+xlim(4,32)+ylim(58,72)+
  labs(size = "fCO2 - fCO2 atm", col = "Survey") +
  scale_color_manual(values = c("firebrick","dodgerblue3","orange"))+
  scale_shape_manual(values = c(16,1))+
    scale_size(range = c(0.1,3))+
  theme_void()

ggplot()+
  geom_point(data = filter(nofin, FCO2 > 0), aes(x=long, y = lat, size = FCO2, col = "Supersaturated", shape = survey))+
  geom_point(data = filter(nofin, FCO2 < 0), aes(x=long, y = lat, size =FCO2, col = "Undersaturated",shape = survey))+
  borders(region = c("Norway"))+ylim(58,63)+xlim(4,13)+
  labs(alpha = "CO2 evasion, mol/day (october)", col = "survey") + 
  scale_color_manual(values = c("firebrick","dodgerblue3","orange"))+
  scale_shape_manual(values = c(1,16))+
  theme_void()



ggplot(nofin)+geom_boxplot(aes(x = survey, y = dfCO2, col = survey))

ggplot(nofin)+geom_boxplot(aes(x = survey, y = log10(FCO2), col = survey))
ggplot(nofin)+geom_boxplot(aes(x = survey, y = pH, col = survey))
ggplot(nofin)+geom_boxplot(aes(x = survey, y = TOC, col = survey))
ggplot(nofin)+geom_boxplot(aes(x = survey, y = DIC, col = survey))
ggplot(nofin)+geom_boxplot(aes(x = survey, y = DIC/TOC, col = survey))
ggplot(nofin)+geom_boxplot(aes(x = survey, y = fCO2, col = survey))
ggplot(nofin)+geom_boxplot(aes(x = survey, y = fCO2/TOC, col = survey))

```


```{r fCO2-TOC-map}
ggplot()+
  borders(region = c("Norway"), fill = "seashell2", col = "white")+xlim(4,13)+ylim(58,63)+
  geom_point(data = filter(nofin, FCO2 > 0), aes(x=long, y = lat, size = fCO2/TOC, col = "Supersaturated", shape = survey))+
  geom_point(data = filter(nofin, FCO2 < 0), aes(x=long, y = lat, size =fCO2/TOC, col = "Undersaturated",shape = survey))+
  labs(alpha = "fCO2/TOC (october)", col = "survey") + 
  scale_color_manual(values = c("firebrick","dodgerblue3","orange"))+
  scale_shape_manual(values = c(1,16))+
  theme_void()

```

# Bedrock?

<https://geo.ngu.no/kart/berggrunn_mobil/>

# Model fCO2 with NDVI, runoff, Sdep

```{r model-fCO2}
ggplot(nofin)+geom_point(aes(x = ndvi, y = fCO2, col = survey))+theme_minimal()
ggplot(nofin)+geom_point(aes(x = runoff, y = fCO2, col = survey))+theme_minimal()
ggplot(nofin)+geom_point(aes(x = bog, y = fCO2, col = survey))+theme_minimal()
ggplot(nofin)+geom_point(aes(x = arable, y = fCO2, col = survey))+theme_minimal()
ggplot(nofin)+geom_point(aes(x = Ndep, y = fCO2, col = survey))+theme_minimal()
ggplot(nofin)+geom_point(aes(x = prec.annual, y = fCO2, col = survey))+theme_minimal()
ggplot(nofin)+geom_point(aes(x = temp.annual, y = fCO2, col = survey))+theme_minimal()
ggplot(nofin)+geom_point(aes(x = log10(lake.area), y = fCO2, col = survey))+theme_minimal()


plot(fCO2~ndvi+runoff+bog+arable+Ndep+prec.annual+temp.annual+log10(lake.area+bog), data = subset(nofin, survey == "CBA_2019"))
plot(log10(fCO2)~ndvi, data = subset(nofin, survey == "CBA_2019"))
plot(log10(fCO2)~log10(lake.area), data = subset(nofin, survey == "CBA_2019"))

summary(lm(log10(fCO2) ~ log10(lake.area), data = subset(nofin, survey == "CBA_2019"))) # 0.14
summary(lm(log10(fCO2) ~ ndvi, data = subset(nofin, survey == "CBA_2019"))) # 0.25
summary(lm(log10(fCO2) ~ runoff, data = subset(nofin, survey == "CBA_2019"))) # 0.07
summary(lm(log10(fCO2) ~ temp.annual, data = subset(nofin, survey == "CBA_2019"))) # 0.15
summary(lm(log10(fCO2) ~ prec.annual, data = subset(nofin, survey == "CBA_2019"))) # 0.007
summary(lm(log10(fCO2) ~ Ndep, data = subset(nofin, survey == "CBA_2019"))) # 0.12
summary(lm(log10(fCO2) ~ bog, data = subset(nofin, survey == "CBA_2019"))) # 0.004
summary(lm(log10(fCO2) ~ arable, data = subset(nofin, survey == "CBA_2019"))) # -0.0166

summary(lm(log10(fCO2)~ndvi+log10(lake.area), data = subset(nofin, survey == "CBA_2019"))) # 0.28

summary(lm(log10(fCO2)~TOC, data = subset(nofin, survey == "CBA_2019"))) # 0.15
summary(lm(log10(fCO2)~log10(TOC), data = subset(nofin, survey == "CBA_2019"))) # 0.23
summary(lm(log10(fCO2)~log10(TOC)*log10(lake.area), data = subset(nofin, survey == "CBA_2019"))) # 0.23

summary(glm(fCO2~TOC+lake.area, data = subset(nofin, survey == "CBA_2019"), family = Gamma(link = "log")))


summary(lm(pH~log10(TOC), data = subset(nofin, survey == "CBA_2019"))) # 0.11
summary(lm(log10(TA)~log10(TOC), data = nofin)) # 0.53
summary(lm(log10(TA)~log10(TOC)+log10(runoff)+log10(Ndep), data = nofin)) # 0.65
summary(lm(log10(TA)~log10(runoff)+log10(Ndep), data = nofin)) # 0.52
summary(lm(log10(DIC)~log10(TOC)+log10(runoff), data = nofin)) # 0.45


```

````{r glm}
summary(glmfCO2 <- glm((fCO2*1e6) ~ log10(lake.area), data = nofin, family = Gamma(link = "identity"))) # 0.06
r2glm <- with(summary(glmfCO2), 1 - deviance/null.deviance) %>% round(2)
r2glm

summary(glmfCO2 <- glm(fCO2 ~ ndvi, data = nofin, family = Gamma(link = "identity"))) # 0.19
r2glm <- with(summary(glmfCO2), 1 - deviance/null.deviance) %>% round(2)
r2glm

summary(glmfCO2 <- glm(log10(fCO2*1e6) ~ log10(runoff), data = subset(nofin, survey == "CBA_2019"), family = Gamma(link = "identity"))) # 0.15
r2glm <- with(summary(glmfCO2), 1 - deviance/null.deviance) %>% round(2)
r2glm

summary(glmfCO2 <- glm(fCO2 ~ temp.annual, data = nofin, family = Gamma(link = "identity"))) # 0.16
r2glm <- with(summary(glmfCO2), 1 - deviance/null.deviance) %>% round(2)
r2glm


summary(glm(log10(fCO2) ~ temp.annual, data = subset(nofin, survey == "CBA_2019"))) # 0.15
summary(glm(log10(fCO2) ~ prec.annual, data = subset(nofin, survey == "CBA_2019"))) # 0.007
summary(glm(log10(fCO2) ~ Ndep, data = subset(nofin, survey == "CBA_2019"))) # 0.12
summary(glm(log10(fCO2) ~ bog, data = subset(nofin, survey == "CBA_2019"))) # 0.004
summary(glm(log10(fCO2) ~ arable, data = subset(nofin, survey == "CBA_2019"))) # -0.0166

summary(glm(log10(fCO2)~ndvi+log10(lake.area), data = subset(nofin, survey == "CBA_2019"))) # 0.28

summary(glm(log10(fCO2)~TOC, data = subset(nofin, survey == "CBA_2019"))) # 0.15
summary(glm(log10(fCO2)~log10(TOC), data = subset(nofin, survey == "CBA_2019"))) # 0.23
summary(glm(log10(fCO2)~log10(TOC)*log10(lake.area), data = subset(nofin, survey == "CBA_2019"))) # 0.23

summary(glm(fCO2~TOC+lake.area, data = subset(nofin, survey == "CBA_2019"), family = Gamma(link = "log")))


summary(glm(pH~log10(TOC), data = subset(nofin, survey == "CBA_2019"))) # 0.11
summary(glm(log10(TA)~log10(TOC), data = nofin)) # 0.53
summary(glm(log10(TA)~log10(TOC)+log10(runoff)+log10(Ndep), data = nofin)) # 0.65
summary(glm(log10(TA)~log10(runoff)+log10(Ndep), data = nofin)) # 0.52
summary(glm(log10(DIC)~log10(TOC)+log10(runoff), data = nofin)) # 0.45


```


## Catchment data CBA

### NDVI

```{r ndvi-cba, eval = F}
# http://poles.tpdc.ac.cn/en/data/9775f2b4-7370-4e5e-a537-3482c9a83d88/
library(gimms)
ndvi.2015 <- downloadGimms(x= 2015,y=2015,dsn = "NDVI")
 
ndvi.max.2015 <- monthlyComposite(ndvi.2015,monthlyIndices(ndvi.2015))
#saveRDS(ndvi.max.2015,"ndvi.max.2015.rds")

#ndvi.max.2015 <- readRDS("ndvi.max.2015.rds") %>% raster()

# Makes the raster smaller, ensuring faster processing of the data
summer.scandinavia.2015 <- raster::crop(ndvi.max.2015,c(0,35,55,73))

# Re-introduces NA
summer.scan <- reclassify(summer.scandinavia.2015, cbind(-Inf, 0, NA), right=FALSE)

# Stack bands for summer
summer.mean.2015 <- raster::stack(summer.scan[[6]],summer.scan[[7]],summer.scan[[8]]) %>% mean()

# extract data
summer.ndvi.2015 <- raster::extract(summer.mean.2015,st_as_sf(dplyr::select(cba, c("Lake_ID","geometry"))), fun = mean, df = T, sp = T, na.rm = T)
names(summer.ndvi.2015) <- c("ebint","ndvi")
summer.ndvi.2015$NDVI <- floor(summer.ndvi.2015$ndvi/10)/1000

# save df
names(summer.ndvi.2015) <- c("Lake_ID","ndvi_raw","NDVI")
saveRDS(summer.ndvi.2015, "cba.summer.ndvi.2015.rds")
write.csv(summer.ndvi.2015,"cba.summer.ndvi.2015.csv")
```

### Runoff

```{r runoff-cba, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(1621:1980)) # runoff from 1985 to 2015
runoff.mean <- runoff.stack %>% mean() 

runoff.cba <- raster::extract(runoff.mean, st_as_sf(dplyr::select(cba, c("Lake_ID","geometry"))), fun = mean, df = T, sp = T, na.rm = T)
names(runoff.cba) <- c("Lake_ID","Runoff")
saveRDS(runoff.cba,"runoff.cba.rds")

ggplot(st_as_sf(runoff.cba))+geom_sf(aes(fill=Runoff,col=Runoff))

```

### CLC


The Land Cover data was downloaded from https://land.copernicus.eu/pan-european/corine-land-cover/clc2018. We used the 2018 version (last one available). 

The land cover data was downloaded as a raster (.tiff file), which included the legend recording the code for each land use. The raster and legend were assembled in QGIS before being imported as a shapefile in R. The codes (corresponding to the line in the extracted dataframe) of the categories of interest were:

Arable land:

* 12: non-irrigated arable land
* 16: fruit trees and berries plantations
* 18: pastures
* 19: annual crops associated with permanent crops
* 20: Complex cultivation patterns

Bogs:

* 36: peat bogs
* 35: inland marshes, excluded because all zeros in the studied area.

Forest:

* 23: Broad-leaved forest
* 24: Coniferous forest
* 25: Mixed forest

Bare:

31: Bare rocks
32: Sparsely vegetated areas
33: Burnt areas

```{r extract-land-cover, eval = F}
corine.2018 <- raster::raster("CLC/U2018_CLC2018_V2020_20u1.tif")
cba.corine <-st_as_sf(dplyr::select(cba, c("Lake_ID","geometry"))) %>% st_transform(crs(corine.2018))
cba.list <- split(cba.corine,seq(nrow(cba.corine)))

extract_corine <- function(x){
  clc <- extract(corine.2018,x)
  saveRDS(clc,file = paste("CLC/clc",x$Lake_ID,"rds",sep="."))
}

lapply(cba.list,extract_corine) 

clc.files <- list.files(path = "CLC/", pattern = "clc.*.rds", full.names = T)

list.clc <- sapply(clc.files,readRDS)
list.clc.cba <- sapply(list.clc, as.integer)

names.list <- stringr::str_extract(clc.files,"\\d+")
names(list.clc.cba) <- names.list

saveRDS(list.clc.cba,"CLC/list.clc.cba.rds")
```

```{r corine-tab-prop, eval = F}
list.clc.niva <- readRDS("CLC/list.clc.cba.rds")
clc.tab.cba <- sapply(list.clc.cba, function(x) tabulate(x,45)) %>% t()
clc.tab.area.cba <- clc.tab.cba*prod(res(corine.2018))
catchment.area <- rowSums(clc.tab.area.cba)
clc.tab.prop.cba <- sweep(clc.tab.area.cba,1,catchment.area, FUN = "/")
saveRDS(clc.tab.prop.cba,"CLC/clc.tab.prop.cba.rds")
```

```{r corine-select-categories, eval = F}
clc.tab.prop.cba <- readRDS("NIVA_test/CLC/clc.tab.prop.cba.rds") %>% as.data.frame()

bogs <- clc.tab.prop.cba[,36] %>% as.data.frame() %>% setNames("Bog") %>% tibble::rownames_to_column(var = "Lake_ID")
saveRDS(bogs,"CLC/bogs.cba.rds")
arable <- rowSums(clc.tab.prop.cba[,c(12,16,18,19,20)]) %>% as.data.frame() %>% setNames("Arable") %>% tibble::rownames_to_column(var = "Lake_ID")
saveRDS(arable,"CLC/arable.cba.rds")
forest <- rowSums(clc.tab.prop.cba[,c(23,24,25)]) %>% as.data.frame() %>% setNames("Forest") %>% tibble::rownames_to_column(var = "Lake_ID")
saveRDS(forest,"CLC/forest.cba.rds")
bare <- rowSums(clc.tab.prop.cba[,c(31,32,33)]) %>% as.data.frame() %>% setNames("Bare") %>% tibble::rownames_to_column(var = "Lake_ID")
saveRDS(bare,"CLC/bare.cba.rds")
```

### TNdep

The nitrogen and sulfur deposition data were extracted from the EMEP database (https://emep.int/mscw/mscw_moddata.html#Comp). The data from 2019 was used.

N-deposition (NOx and NH3) is the sum of: 
* Dry deposition of oxidized nitrogen per m2 grid DDEP_OXN_m2Grid, in mg/m2
* Wet deposition of oxidized nitrogen WDEP_OXN, in mg/m2 
* Dry deposition of oxidized nitrogen per m2 grid DDEP_RDN_m2Grid, in mg/m2
* Wet deposition of reduced nitrogen WDEP_RDN, in mg/m2

```{r extract-Ndep, eval = F}
EMEP_file <- "Ndep/EMEP01_rv4.42_year.2019met_2019emis.nc"

cba.poly <- st_as_sf(dplyr::select(cba, c("Lake_ID","geometry")))
  
woxn <- raster(EMEP_file, varname = "WDEP_OXN") 
doxn <- raster(EMEP_file, varname = "DDEP_OXN_m2Grid")
wrdn <- raster(EMEP_file, varname = "WDEP_RDN")
drdn <- raster(EMEP_file, varname = "DDEP_RDN_m2Grid")

woxn_df <- extract(woxn,cba.poly, sp = T, df = T, na.rm = T, fun = mean) 
names(woxn_df) <- c("Lake_ID","woxn")
woxn_u <- woxn_df %>% st_as_sf() %>% st_drop_geometry() %>% dplyr::distinct() 

doxn_df <- extract(doxn,cba.poly, sp = T, df = T, na.rm = T, fun = mean)
names(doxn_df) <- c("Lake_ID","doxn")
doxn_u <- doxn_df %>% st_as_sf() %>% st_drop_geometry() %>% dplyr::distinct() 

wrdn_df <- extract(wrdn,cba.poly, sp = T, df = T, na.rm = T, fun = mean)
names(wrdn_df) <- c("Lake_ID","wrdn")
wrdn_u <- wrdn_df %>% st_as_sf() %>% st_drop_geometry() %>% dplyr::distinct() 

drdn_df <- extract(drdn,cba.poly, sp = T, df = T, na.rm = T, fun = mean)
names(drdn_df) <- c("Lake_ID","drdn")
drdn_u <- drdn_df %>% st_as_sf() %>% st_drop_geometry()  %>% dplyr::distinct() 

ndep.df <- merge(woxn_u,doxn_u, by = "Lake_ID") %>% merge(wrdn_u, by = "Lake_ID") %>% merge(drdn_u, by = "Lake_ID")
ndep.df$TNdep <- rowSums(ndep.df[,c(2:5)])

saveRDS(ndep.df,"Ndep/ndep.df.cba.rds")
```

### Temperature and precipitation

```{r temp-prec, eval = F}
bio.fennoscandia <- raster::getData(name = "worldclim", var = "bio", res = 2.5)

cba.poly <- st_as_sf(dplyr::select(cba, c("Lake_ID","geometry")))

annual.temp <- raster::extract(bio.fennoscandia[[1]], cba.poly, fun = mean, df = T, sp = T)
names(annual.temp) <- c("Lake_ID", "temp")
saveRDS(annual.temp,"annual.temp.cba.rds")

annual.prec <- raster::extract(bio.fennoscandia$bio12, cba.poly, fun = mean, df = T, sp = T)
names(annual.prec) <- c("Lake_ID", "precip")
saveRDS(annual.prec,"annual.prec.cba.rds")
```

### slope

# Catchment data N112

## match n112 with nofa lakes

```{r match-n112}
# catchment.poly <- readRDS("catchment.poly.rds") %>% as_Spatial() %>% crop(extent(4,13,58,63))
# saveRDS(catchment.poly, "catchment.poly.sn.rds")

catchment.poly <- readRDS("catchment.poly.sn.rds")

ggplot()+geom_sf(data = st_as_sf(catchment.poly))+
  geom_sf(data = st_as_sf(n112.spdf.wgs), col = "firebrick")+
  xlim(4,10)+ylim(58,60)+
  theme_minimal()

n112.polygons <- sp::over(n112.spdf.wgs, catchment.poly)

catchments.nve <- st_read("NVEData/Nedborfelt/Nedborfelt_Sidenedborfelt.shp")

#n112.polygons <- sp::over(n112.spdf.wgs, as_Spatial(st_zm(catchments.nve)))

library(spdep)

n112.sf <- st_as_sf(n112.spdf.wgs) 

catchments.nve.spdf <- catchments.nve %>% st_transform(crs = st_crs(n112.sf))%>% st_make_valid() %>% st_zm() %>% as_Spatial()
catchments.nve.sf <- catchments.nve %>% st_transform(crs = st_crs(n112.sf))%>% st_make_valid() %>% st_zm()

n112.polygons <- sp::over(n112.spdf.wgs,catchments.nve.spdf)
n112.polygons <- st_within(n112.sf, catchments.nve.sf)


ggplot()+geom_sf(data = catchments.nve)+
 geom_sf(data = st_as_sf(n112.spdf.wgs), col = "firebrick")+
  theme_minimal()

lakes.nve <- st_read("NVEData/Innsjo/Innsjo_Innsjo.shp")
n112.lakes.poly <- merge(lakes.nve, n112, by.y= "Vatnlnr", by.x = "vatnLnr", all.x = F)

ggplot()+
  geom_sf(data = catchments.nve, fill = "white", col = "lightgray", alpha = 0.5) +
 geom_sf(data = n112.lakes.poly, fill = "firebrick", col = "firebrick", alpha = 0.5)+
  theme_minimal()

n112.cat.poly <- st_join(catchments.nve, n112.lakes.poly, join = st_contains, left = F)

ggplot()+geom_sf(data = n112.cat.poly)
```

```{r more-plots-lake-area}
ggplot(nofin)+geom_point(aes(x = log10(lake.area), y = fCO2/TOC, shape = survey, color = survey))+
  theme_minimal()

ggplot(nofin)+geom_boxplot(aes(x = "Lake area", y = log10(lake.area), color = survey))+
  facet_grid(cols = vars(survey))+
  theme_minimal()

```


### NDVI

```{r ndvi-n112, eval = F}
# http://poles.tpdc.ac.cn/en/data/9775f2b4-7370-4e5e-a537-3482c9a83d88/
library(gimms)
ndvi.2004 <- downloadGimms(x= 2004,y=2004,dsn = "NDVI", server = "nasanex", version = 0L)

ndvi.2004 <- downloadGimms(x= 2004,y=2004,dsn = "NDVI")

ndvi.2004.raster <- rasterizeGimms(ndvi.2004)
 
ndvi.max.2004 <- monthlyComposite(x = ndvi.2004.raster, indices = monthlyIndices(ndvi.2004, version = 0L))

#writeRaster(x = ndvi.max.2004, filename = "NDVI/ndvi.max.2004.nc", format = "CDF")


saveRDS(ndvi.max.2004,"NDVI/ndvi.max.2004.rds")

ndvi.max.2004 <- readRDS("ndvi.max.2004.rds")

ndvi.summer.2004 <- raster::subset(ndvi.max.2004, 6:8) 
summer.mean.2004 <- stackApply(x = ndvi.max.2004, indices = c(6:8), fun = mean, na.rm = T)

# Makes the raster smaller, ensuring faster processing of the data
summer.scandinavia.2004 <- raster::crop(ndvi.summer.2004,c(0,35,55,73))

# Re-introduces NA
summer.scan <- reclassify(ndvi.max.2004, cbind(-Inf, 0, NA), right=FALSE)

# Stack bands for summer
summer.mean.2004 <- raster::stack(summer.scan[[6]],summer.scan[[7]],summer.scan[[8]]) %>% mean()

# extract data
summer.ndvi.2004 <- raster::extract(summer.mean.2004,st_as_sf(dplyr::select(cba, c("Lake_ID","geometry"))), fun = mean, df = T, sp = T, na.rm = T)
names(summer.ndvi.2004) <- c("ebint","ndvi")
summer.ndvi.2004$NDVI <- floor(summer.ndvi.2004$ndvi/10)/1000

# save df
names(summer.ndvi.2004) <- c("Lake_ID","ndvi_raw","NDVI")
saveRDS(summer.ndvi.2004, "n112.summer.ndvi.2004.rds")
write.csv(summer.ndvi.2004,"n112.summer.ndvi.2004.csv")
```

### Runoff

```{r runoff-n112, eval = F}
runoff.raster <- "mrros_Lmon_CNRM-CM6-1-HR_historical_r1i1p1f2_gr_185001-201412.nc"

runoff.stack <- raster::stack(runoff.raster, bands = c(1490:1850)) # runoff from 1974 to 2004
runoff.mean <- runoff.stack %>% mean() 

runoff.n112 <- raster::extract(runoff.mean, st_zm(dplyr::select(n112.cat.poly, c("vatnLnr","geometry"))), fun = mean, df = T, sp = T, na.rm = T)
names(runoff.n112) <- c("Vatnlnr","Runoff")
saveRDS(runoff.n112,"runoff.n112.rds")

ggplot(st_as_sf(runoff.n112))+geom_sf(aes(fill=Runoff,col=Runoff))
```

### CLC


The Land Cover data was downloaded from https://land.copernicus.eu/pan-european/corine-land-cover/clc2018. We used the 2018 version (last one available). 

The land cover data was downloaded as a raster (.tiff file), which included the legend recording the code for each land use. The raster and legend were assembled in QGIS before being imported as a shapefile in R. The codes (corresponding to the line in the extracted dataframe) of the categories of interest were:

Arable land:

* 12: non-irrigated arable land
* 16: fruit trees and berries plantations
* 18: pastures
* 19: annual crops associated with permanent crops
* 20: Complex cultivation patterns

Bogs:

* 36: peat bogs
* 35: inland marshes, excluded because all zeros in the studied area.

Forest:

* 23: Broad-leaved forest
* 24: Coniferous forest
* 25: Mixed forest

Bare:

31: Bare rocks
32: Sparsely vegetated areas
33: Burnt areas

```{r extract-land-cover, eval = F}
corine.2004 <- raster::raster("CLC_2004/U2012_CLC2006_V2020_20u1.tif")
n112.corine <- dplyr::select(n112.cat.poly, c("vatnLnr","geometry")) %>% st_zm() %>% st_transform(crs(corine.2004))
n112.list <- split(n112.corine,seq(nrow(n112.corine)))

extract_corine <- function(x){
  clc <- extract(corine.2004,x)
  saveRDS(clc,file = paste("CLC_2004/clc",x$vatnLnr,"rds",sep="."))
}

lapply(n112.list,extract_corine) 

clc.files <- list.files(path = "CLC_2004/", pattern = "clc.*.rds", full.names = T)

list.clc <- sapply(clc.files,readRDS)
list.clc.n112 <- sapply(list.clc, as.integer)

names.list <- stringr::str_extract(clc.files,"\\d+")
names(list.clc.n112) <- names.list

saveRDS(list.clc.n112,"CLC/list.clc.n112.rds")
```

```{r corine-tab-prop, eval = F}
list.clc.n112 <- readRDS("CLC/list.clc.n112.rds")
clc.tab.n112 <- sapply(list.clc.n112, function(x) tabulate(x,45)) %>% t()
clc.tab.area.n112 <- clc.tab.n112*prod(res(corine.2004))
catchment.area <- rowSums(clc.tab.area.n112)
clc.tab.prop.n112 <- sweep(clc.tab.area.n112,1,catchment.area, FUN = "/")
saveRDS(clc.tab.prop.n112,"CLC/clc.tab.prop.n112.rds")
```

```{r corine-select-categories, eval = F}
clc.tab.prop.n112 <- readRDS("CLC/clc.tab.prop.n112.rds") %>% as.data.frame()

bogs <- clc.tab.prop.n112[,36] %>% as.data.frame() %>% setNames("Bog") %>% tibble::rownames_to_column(var = "Lake_ID")
saveRDS(bogs,"CLC_2004/bogs.n112.rds")
arable <- rowSums(clc.tab.prop.n112[,c(12,16,18,19,20)]) %>% as.data.frame() %>% setNames("Arable") %>% tibble::rownames_to_column(var = "Lake_ID")
saveRDS(arable,"CLC_2004/arable.n112.rds")
forest <- rowSums(clc.tab.prop.n112[,c(23,24,25)]) %>% as.data.frame() %>% setNames("Forest") %>% tibble::rownames_to_column(var = "Lake_ID")
saveRDS(forest,"CLC_2004/forest.n112.rds")
bare <- rowSums(clc.tab.prop.n112[,c(31,32,33)]) %>% as.data.frame() %>% setNames("Bare") %>% tibble::rownames_to_column(var = "Lake_ID")
saveRDS(bare,"CLC_2004/bare.n112.rds")
```

### TNdep

The nitrogen and sulfur deposition data were extracted from the EMEP database (https://emep.int/mscw/mscw_moddata.html#Comp). The data from 2019 was used.

N-deposition (NOx and NH3) is the sum of: 
* Dry deposition of oxidized nitrogen per m2 grid DDEP_OXN_m2Grid, in mg/m2
* Wet deposition of oxidized nitrogen WDEP_OXN, in mg/m2 
* Dry deposition of oxidized nitrogen per m2 grid DDEP_RDN_m2Grid, in mg/m2
* Wet deposition of reduced nitrogen WDEP_RDN, in mg/m2

```{r extract-Ndep-2004, eval = F}
EMEP_file <- "EMEP01_rv4.45_day.2004met_2004emis_rep2022.nc"

n112.poly <- dplyr::select(n112.cat.poly, c("vatnLnr","geometry")))
  
woxn <- raster(EMEP_file, varname = "WDEP_OXN") 
doxn <- raster(EMEP_file, varname = "DDEP_OXN_m2Grid")
wrdn <- raster(EMEP_file, varname = "WDEP_RDN")
drdn <- raster(EMEP_file, varname = "DDEP_RDN_m2Grid")

woxn_df <- extract(woxn,n112.cat.poly, sp = T, df = T, na.rm = T, fun = mean) 
names(woxn_df) <- c("Lake_ID","woxn")
woxn_u <- woxn_df %>% st_as_sf() %>% st_drop_geometry() %>% dplyr::distinct() 

doxn_df <- extract(doxn,n112.poly, sp = T, df = T, na.rm = T, fun = mean)
names(doxn_df) <- c("Lake_ID","doxn")
doxn_u <- doxn_df %>% st_as_sf() %>% st_drop_geometry() %>% dplyr::distinct() 

wrdn_df <- extract(wrdn,n112.poly, sp = T, df = T, na.rm = T, fun = mean)
names(wrdn_df) <- c("Lake_ID","wrdn")
wrdn_u <- wrdn_df %>% st_as_sf() %>% st_drop_geometry() %>% dplyr::distinct() 

drdn_df <- extract(drdn,n112.poly, sp = T, df = T, na.rm = T, fun = mean)
names(drdn_df) <- c("Lake_ID","drdn")
drdn_u <- drdn_df %>% st_as_sf() %>% st_drop_geometry()  %>% dplyr::distinct() 

ndep.df <- merge(woxn_u,doxn_u, by = "Lake_ID") %>% merge(wrdn_u, by = "Lake_ID") %>% merge(drdn_u, by = "Lake_ID")
ndep.df$TNdep <- rowSums(ndep.df[,c(2:5)])

saveRDS(ndep.df,"Ndep/ndep.df.n112.rds")
```

### Temperature and precipitation

```{r temp-prec, eval = F}
bio.fennoscandia <- raster::getData(name = "worldclim", var = "bio", res = 2.5)

n112.poly <- st_as_sf(dplyr::select(n112, c("Lake_ID","geometry")))

annual.temp <- raster::extract(bio.fennoscandia[[1]], n112.poly, fun = mean, df = T, sp = T)
names(annual.temp) <- c("Lake_ID", "temp")
saveRDS(annual.temp,"annual.temp.n112.rds")

annual.prec <- raster::extract(bio.fennoscandia$bio12, n112.poly, fun = mean, df = T, sp = T)
names(annual.prec) <- c("Lake_ID", "precip")
saveRDS(annual.prec,"annual.prec.n112.rds")
```
